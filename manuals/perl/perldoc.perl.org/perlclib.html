<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from perldoc.perl.org/perlclib by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 06 Aug 2025 16:20:51 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>perlclib - Interacting with standard C library functions - Perldoc Browser</title>
    <link rel="search" href="opensearch.xml" type="application/opensearchdescription+xml" title="Perldoc Browser">
    <link rel="canonical" href="perlclib.html">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/stackoverflow-light.min.css" rel="stylesheet">
    <link href="css/perldoc.css" rel="stylesheet">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KVNWBNT5FB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-KVNWBNT5FB');
      gtag('config', 'UA-50555-3');
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-md bg-dark" data-bs-theme="dark"><div class="container-fluid">
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="index.html"><img src="images/perl_camel_30.png" width="30" height="30" class="d-inline-block align-text-top" alt="Perl Camel Logo"> Perldoc Browser</a>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav me-auto">
      <li class="nav-item dropdown text-nowrap">
        <a class="nav-link dropdown-toggle" href="#" id="dropdownlink-stable" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">5.42.0</a>
        <div class="dropdown-menu" aria-labelledby="dropdownlink-stable">
          <a class="dropdown-item" href="perlclib.html">Latest</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item active" href="https://perldoc.perl.org/5.42.0/perlclib">5.42.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.3/perlclib">5.40.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.2/perlclib">5.40.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.1/perlclib">5.40.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.0/perlclib">5.40.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.5/perlclib">5.38.5</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.4/perlclib">5.38.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.3/perlclib">5.38.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.2/perlclib">5.38.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.1/perlclib">5.38.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.0/perlclib">5.38.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.36.3/perlclib">5.36.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.36.2/perlclib">5.36.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.36.1/perlclib">5.36.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.36.0/perlclib">5.36.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.34.3/perlclib">5.34.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.34.2/perlclib">5.34.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.34.1/perlclib">5.34.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.34.0/perlclib">5.34.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.32.1/perlclib">5.32.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.32.0/perlclib">5.32.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.30.3/perlclib">5.30.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.30.2/perlclib">5.30.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.30.1/perlclib">5.30.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.30.0/perlclib">5.30.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.28.3/perlclib">5.28.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.28.2/perlclib">5.28.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.28.1/perlclib">5.28.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.28.0/perlclib">5.28.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.26.3/perlclib">5.26.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.26.2/perlclib">5.26.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.26.1/perlclib">5.26.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.26.0/perlclib">5.26.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.4/perlclib">5.24.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.3/perlclib">5.24.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.2/perlclib">5.24.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.1/perlclib">5.24.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.0/perlclib">5.24.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.4/perlclib">5.22.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.3/perlclib">5.22.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.2/perlclib">5.22.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.1/perlclib">5.22.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.0/perlclib">5.22.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.20.3/perlclib">5.20.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.20.2/perlclib">5.20.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.20.1/perlclib">5.20.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.20.0/perlclib">5.20.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.4/perlclib">5.18.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.3/perlclib">5.18.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.2/perlclib">5.18.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.1/perlclib">5.18.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.0/perlclib">5.18.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.16.3/perlclib">5.16.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.16.2/perlclib">5.16.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.16.1/perlclib">5.16.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.16.0/perlclib">5.16.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.14.4/perlclib">5.14.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.14.3/perlclib">5.14.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.14.2/perlclib">5.14.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.14.1/perlclib">5.14.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.14.0/perlclib">5.14.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.12.5/perlclib">5.12.5</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.12.4/perlclib">5.12.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.12.3/perlclib">5.12.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.12.2/perlclib">5.12.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.12.1/perlclib">5.12.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.12.0/perlclib">5.12.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.10.1/perlclib">5.10.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.10.0/perlclib">5.10.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.9/perlclib">5.8.9</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.8/perlclib">5.8.8</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.7/perlclib">5.8.7</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.6/perlclib">5.8.6</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.5/perlclib">5.8.5</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.4/perlclib">5.8.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.3/perlclib">5.8.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.2/perlclib">5.8.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.1/perlclib">5.8.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.8.0/perlclib">5.8.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="5.6.2/perlclib.html">5.6.2</a>
          <a class="dropdown-item" href="5.6.1/perlclib.html">5.6.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.6.0/perlclib">5.6.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.005_04/perlclib">5.005_04</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.005_03/perlclib">5.005_03</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.005_02/perlclib">5.005_02</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.005_01/perlclib">5.005_01</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.005/perlclib">5.005</a>
        </div>
      </li>
      <li class="nav-item dropdown text-nowrap">
        <a class="nav-link dropdown-toggle" href="#" id="dropdownlink-dev" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dev</a>
        <div class="dropdown-menu" aria-labelledby="dropdownlink-dev">
          <a class="dropdown-item" href="https://perldoc.perl.org/blead/perlclib">blead</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.43.1/perlclib">5.43.1</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.42.0-RC3/perlclib">5.42.0-RC3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.42.0-RC2/perlclib">5.42.0-RC2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.42.0-RC1/perlclib">5.42.0-RC1</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.13/perlclib">5.41.13</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.12/perlclib">5.41.12</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.11/perlclib">5.41.11</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.10/perlclib">5.41.10</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.9/perlclib">5.41.9</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.8/perlclib">5.41.8</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.7/perlclib">5.41.7</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.6/perlclib">5.41.6</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.5/perlclib">5.41.5</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.4/perlclib">5.41.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.3/perlclib">5.41.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.2/perlclib">5.41.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.1/perlclib">5.41.1</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.3-RC1/perlclib">5.40.3-RC1</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.5-RC1/perlclib">5.38.5-RC1</a>
        </div>
      </li>
      <li class="nav-item dropdown text-nowrap">
        <a class="nav-link dropdown-toggle" href="#" id="dropdownlink-nav" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Documentation</a>
        <div class="dropdown-menu" aria-labelledby="dropdownlink-nav">
          <a class="dropdown-item" href="perl.html">Perl</a>
          <a class="dropdown-item" href="perlintro.html">Intro</a>
          <a class="dropdown-item" href="perl.html#Tutorials">Tutorials</a>
          <a class="dropdown-item" href="perlfaq.html">FAQs</a>
          <a class="dropdown-item" href="perl.html#Reference-Manual">Reference</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="perlop.html">Operators</a>
          <a class="dropdown-item" href="functions.html">Functions</a>
          <a class="dropdown-item" href="variables.html">Variables</a>
          <a class="dropdown-item" href="modules.html">Modules</a>
          <a class="dropdown-item" href="perlutil.html">Utilities</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="perldelta.html">Release Notes</a>
          <a class="dropdown-item" href="perlcommunity.html">Community</a>
          <a class="dropdown-item" href="perlhist.html">History</a>
        </div>
      </li>
    </ul>
    <ul class="navbar-nav">
      <button id="content-expand-button" type="button" class="btn btn-dark d-none d-lg-inline-block me-4">Expand</button>
      <script src="js/perldoc-expand-page.js"></script>
    </ul>
    <form class="form-inline" method="get" action="https://perldoc.perl.org/search">
      <input id="search-input" class="form-control me-3" type="search" name="q" placeholder="[S]earch" aria-label="Search" value="">
    </form>
    <script src="js/perldoc-focus-search.js"></script>
  </div>
</div></nav>

    <div id="wrapperlicious" class="container-fluid">
      <div id="perldocdiv">
        <div id="links">
          <a href="perlclib.html">perlclib</a>
          <div id="more">
            (<a href="https://perldoc.perl.org/perlclib.txt">source</a>,
            <a href="https://metacpan.org/pod/perlclib">CPAN</a>)
          </div>
        </div>
        <h1><a id="toc">CONTENTS</a></h1>
                  <ul>
              <li>
                <a class="text-decoration-none" href="#NAME">NAME</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#DESCRIPTION">DESCRIPTION</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#libc-functions-to-avoid">libc functions to avoid</a>
                            <ul>
              <li>
                <a class="text-decoration-none" href="#Conventions">Conventions</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#File-Operations">File Operations</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#File-Input-and-Output">File Input and Output</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#File-Positioning">File Positioning</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Memory-Management-and-String-Handling">Memory Management and String Handling</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Character-Class-Tests">Character Class Tests</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#stdlib.h-functions">stdlib.h functions</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Miscellaneous-functions">Miscellaneous functions</a>
              </li>
          </ul>

              </li>
              <li>
                <a class="text-decoration-none" href="#Dealing-with-locales">Dealing with locales</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Dealing-with-embedded-perls-and-threads">Dealing with embedded perls and threads</a>
                            <ul>
              <li>
                <a class="text-decoration-none" href="#Functions-always-unsuitable-for-use-under-multi-threads">Functions always unsuitable for use under multi-threads</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Functions-which-must-be-called-at-least-once-before-starting-threads">Functions which must be called at least once before starting threads</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Functions-that-are-thread-safe-when-called-with-appropriate-arguments">Functions that are thread-safe when called with appropriate arguments</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Functions-vulnerable-to-signals">Functions vulnerable to signals</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#General-issues-with-thread-safety">General issues with thread-safety</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Reentrant-equivalent-functions">Reentrant equivalent functions</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Functions-that-need-the-environment-to-be-constant">Functions that need the environment to be constant</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Locale-specific-issues">Locale-specific issues</a>
              </li>
          </ul>

              </li>
              <li>
                <a class="text-decoration-none" href="#SEE-ALSO">SEE ALSO</a>
              </li>
          </ul>

      <h1 id="NAME"><a class="permalink" href="#NAME">#</a>NAME</h1>

<p>perlclib - Interacting with standard C library functions</p>

<h1 id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">#</a>DESCRIPTION</h1>

<p>The perl interpreter is written in C; XS code also expands to C. Inevitably, this code will call some functions from the C library, <code>libc</code>. This document gives some guidance on interfacing with that library.</p>

<p>One thing Perl porters should note is that <i>perl</i> doesn&#39;t tend to use that much of the C standard library internally; you&#39;ll see very little use of, for example, the <i>ctype.h</i> functions in there. This is because Perl tends to reimplement or abstract standard library functions, so that we know exactly how they&#39;re going to operate.</p>

<h1 id="libc-functions-to-avoid"><a class="permalink" href="#libc-functions-to-avoid">#</a><a id="libc"></a>libc functions to avoid</h1>

<p>There are many many libc functions. Most of them are fair game to use, but some are not. Some of the possible reasons are:</p>

<ul>

<li><p>They likely will interfere with the perl interpreter&#39;s functioning, such as its bookkeeping, or signal handling, or memory allocation, or any number of harmful things.</p>

</li>
<li><p>They aren&#39;t implemented on all platforms, but there is an alternative that is.</p>

<p>Or they may be buggy or deprecated on some or all platforms.</p>

</li>
<li><p>They aren&#39;t suitable for multi-threaded operation, but there is an alternative that is, and is just as easily usable.</p>

<p>You may not expect your code to ever be used under threads, but code has a way of being adapted beyond our initial expectations. If it is just as easy to use something that can be used under threads, it&#39;s better to use that now, just in case.</p>

</li>
<li><p>In functions that deal with strings, complications may arise because the string may be encoded in different ways, for example in UTF-8. For these, it is likely better to place the string in a SV and use the Perl SV string handling functions that contain extensive logic to deal with this.</p>

</li>
<li><p>In functions that deal with numbers, complications may arise because the numbers get too big or small, and what those limits are depends on the current platform. Again, the Perl SV numeric data types have extensive logic to take care of these kinds of issues.</p>

</li>
<li><p>They are locale-aware, and your caller may not want this.</p>

</li>
</ul>

<p>The following commentary and tables give some functions in the first column that shouldn&#39;t be used in C or XS code, with the preferred alternative (if any) in the second column.</p>

<h2 id="Conventions"><a class="permalink" href="#Conventions">#</a>Conventions</h2>

<p>In the following tables:</p>

<dl>

<dt id="~"><a class="permalink" href="#~">#</a><a id="pod"></a><code>~</code></dt>
<dd>

<p>marks the function as deprecated; it should not be used regardless.</p>

</dd>
<dt id="t"><a class="permalink" href="#t">#</a><code>t</code></dt>
<dd>

<p>is a type.</p>

</dd>
<dt id="p"><a class="permalink" href="#p">#</a><code>p</code></dt>
<dd>

<p>is a pointer.</p>

</dd>
<dt id="n"><a class="permalink" href="#n">#</a><code>n</code></dt>
<dd>

<p>is a number.</p>

</dd>
<dt id="s"><a class="permalink" href="#s">#</a><code>s</code></dt>
<dd>

<p>is a string.</p>

</dd>
</dl>

<p><code>sv</code>, <code>av</code>, <code>hv</code>, etc. represent variables of their respective types.</p>

<h2 id="File-Operations"><a class="permalink" href="#File-Operations">#</a><a id="File"></a>File Operations</h2>

<p>Instead of the <i>stdio.h</i> functions, you should use the Perl abstraction layer. Instead of <code>FILE*</code> types, you need to be handling <code>PerlIO*</code> types. Don&#39;t forget that with the new PerlIO layered I/O abstraction <code>FILE*</code> types may not even be available. See also the <code>perlapio</code> documentation for more information about the following functions:</p>

<pre><code class="plaintext">Instead Of:                 Use:

stdin                       PerlIO_stdin()
stdout                      PerlIO_stdout()
stderr                      PerlIO_stderr()

fopen(fn, mode)             PerlIO_open(fn, mode)
freopen(fn, mode, stream)   PerlIO_reopen(fn, mode, perlio) (Dep-
                              recated)
fflush(stream)              PerlIO_flush(perlio)
fclose(stream)              PerlIO_close(perlio)</code></pre>

<h2 id="File-Input-and-Output"><a class="permalink" href="#File-Input-and-Output">#</a><a id="File1"></a>File Input and Output</h2>

<pre><code class="plaintext">Instead Of:                 Use:

fprintf(stream, fmt, ...)   PerlIO_printf(perlio, fmt, ...)

[f]getc(stream)             PerlIO_getc(perlio)
[f]putc(stream, n)          PerlIO_putc(perlio, n)
ungetc(n, stream)           PerlIO_ungetc(perlio, n)</code></pre>

<p>Note that the PerlIO equivalents of <code>fread</code> and <code>fwrite</code> are slightly different from their C library counterparts:</p>

<pre><code class="plaintext">fread(p, size, n, stream)   PerlIO_read(perlio, buf, numbytes)
fwrite(p, size, n, stream)  PerlIO_write(perlio, buf, numbytes)

fputs(s, stream)            PerlIO_puts(perlio, s)</code></pre>

<p>There is no equivalent to <code>fgets</code> (or the deprecated <code>gets</code>); one should use <code>sv_gets</code> instead:</p>

<pre><code class="plaintext">fgets(s, n, stream)         sv_gets(sv, perlio, append)</code></pre>

<h2 id="File-Positioning"><a class="permalink" href="#File-Positioning">#</a><a id="File2"></a>File Positioning</h2>

<pre><code class="plaintext">Instead Of:                 Use:

feof(stream)                PerlIO_eof(perlio)
fseek(stream, n, whence)    PerlIO_seek(perlio, n, whence)
rewind(stream)              PerlIO_rewind(perlio)

fgetpos(stream, p)          PerlIO_getpos(perlio, sv)
fsetpos(stream, p)          PerlIO_setpos(perlio, sv)

ferror(stream)              PerlIO_error(perlio)
clearerr(stream)            PerlIO_clearerr(perlio)</code></pre>

<h2 id="Memory-Management-and-String-Handling"><a class="permalink" href="#Memory-Management-and-String-Handling">#</a><a id="Memory"></a>Memory Management and String Handling</h2>

<pre><code class="plaintext">Instead Of:                    Use:

t* p = malloc(n)               Newx(p, n, t)
t* p = calloc(n, s)            Newxz(p, n, t)
p = realloc(p, n)              Renew(p, n, t)</code></pre>

<p>It is not portable to try to allocate 0 bytes; allocating 1 or more is portable. Never pass pointers between <code>Newx</code>, <code>Renew</code>, <code>Safefree</code> and <i>libc</i> equivalents <code>malloc</code>, <code>realloc</code>, <code>free</code>. They are not from the same memory pool or allocator. Either an instant or delayed <i>SEGV</i> will occur, or subtle memory leaks or subtle heap corruption.</p>

<pre><code class="plaintext">memcpy(dst, src, n)            Copy(src, dst, n, t)
memmove(dst, src, n)           Move(src, dst, n, t)
memcpy(dst, src, sizeof(t))    StructCopy(src, dst, t)</code></pre>

<p>Notice the different order of arguments to <code>Copy</code> and <code>Move</code> than used in <code>memcpy</code> and <code>memmove</code>.</p>

<pre><code class="plaintext">memset(dst, 0, n * sizeof(t))  Zero(dst, n, t)
memzero(dst, 0)                Zero(dst, n, char)
free(p)                        Safefree(p)

strdup(p)                      savepv(p)
strndup(p, n)                  savepvn(p, n) (Hey, strndup doesn&#39;t
                                              exist!)</code></pre>

<p>Sometimes instead of zeroing the allocated heap by using Newxz() you should consider &quot;poisoning&quot; the data. This means writing a bit pattern into it that should be illegal as pointers (and floating point numbers), and also hopefully surprising enough as integers, so that any code attempting to use the data without forethought will break sooner rather than later. Poisoning can be done using the Poison() macros, which have similar arguments to Zero():</p>

<pre><code class="plaintext">PoisonWith(dst, n, t, b)    scribble memory with byte b
PoisonNew(dst, n, t)        equal to PoisonWith(dst, n, t, 0xAB)
PoisonFree(dst, n, t)       equal to PoisonWith(dst, n, t, 0xEF)
Poison(dst, n, t)           equal to PoisonFree(dst, n, t)

strstr(big, little)            instr(big, little)
memmem(big, blen, little, len) ninstr(big, bigend, little, little_end)
strcmp(s1, s2)                 strLE(s1, s2) / strEQ(s1, s2)
                                             / strGT(s1,s2)
strncmp(s1, s2, n)             strnNE(s1, s2, n) / strnEQ(s1, s2, n)

memcmp(p1, p2, n)              memNE(p1, p2, n)
!memcmp(p1, p2, n)             memEQ(p1, p2, n)</code></pre>

<p>Most of the time, though, you&#39;ll want to be dealing with SVs internally instead of raw <code>char *</code> strings:</p>

<pre><code class="plaintext">strlen(s)                   sv_len(sv)
strcpy(dt, src)             sv_setpv(sv, s)
strncpy(dt, src, n)         sv_setpvn(sv, s, n)
strcat(dt, src)             sv_catpv(sv, s)
strncat(dt, src)            sv_catpvn(sv, s)</code></pre>

<p>If you do need raw strings, use these instead:</p>

<pre><code class="plaintext">my_strnlen(s, maxlen)
my_strlcpy(dt, src, sizeof(dt))
my_strlcat(dt, src, sizeof(dt))</code></pre>

<p>Similiarly, you can use SVs for creating strings from formats</p>

<pre><code class="plaintext">sprintf(s, fmt, ...)         sv_setpvf(sv, fmt, ...)
vsprintf(str, fmt, va_list)  sv_vsetpvf(sv, fmt, va_list)</code></pre>

<p>Or for raw strings,</p>

<pre><code class="plaintext">my_snprintf(dt, len, fmt, ...)
my_vsnprintf(dt, len, fmt, va_list)
vsprintf(str, fmt, va_list)  sv_vsnprintf(sv, fmt, va_list)</code></pre>

<p>Note also the existence of <code>sv_catpvf</code> and <code>sv_vcatpvfn</code>, combining concatenation with formatting; and <a href="perlapi.html#form"><code>Perl_form</code>()</a> for another form of formatted populating.</p>

<p>Note that glibc <code>printf()</code>, <code>sprintf()</code>, etc. are buggy before glibc version 2.17. They won&#39;t allow a <code>%.s</code> format with a precision to create a string that isn&#39;t valid UTF-8 if the current underlying locale of the program is UTF-8. What happens is that the <code>%s</code> and its operand are simply skipped without any notice. <a href="https://sourceware.org/bugzilla/show_bug.cgi?id=6530">https://sourceware.org/bugzilla/show_bug.cgi?id=6530</a>.</p>

<h2 id="Character-Class-Tests"><a class="permalink" href="#Character-Class-Tests">#</a><a id="Character"></a>Character Class Tests</h2>

<p>There are several types of character class tests that Perl implements. All are more fully described in <a href="perlapi.html#Character-classification">&quot;Character classification&quot; in perlapi</a> and <a href="perlapi.html#Character-case-changing">&quot;Character case changing&quot; in perlapi</a>.</p>

<p>The C library routines listed in the table below return values based on the current locale. Use the entries in the final column for that functionality. The other two columns always assume a POSIX (or C) locale. The entries in the ASCII column are only meaningful for ASCII inputs, returning FALSE for anything else. Use these only when you <b>know</b> that is what you want. The entries in the Latin1 column assume that the non-ASCII 8-bit characters are as Unicode defines them, the same as ISO-8859-1, often called Latin 1.</p>

<pre><code class="plaintext">Instead Of:  Use for ASCII:   Use for Latin1:      Use for locale:

isalnum(c)  isALPHANUMERIC(c) isALPHANUMERIC_L1(c) isALPHANUMERIC_LC(c)
isalpha(c)  isALPHA(c)        isALPHA_L1(c)        isALPHA_LC(u )
isascii(c)  isASCII(c)                             isASCII_LC(c)
isblank(c)  isBLANK(c)        isBLANK_L1(c)        isBLANK_LC(c)
iscntrl(c)  isCNTRL(c)        isCNTRL_L1(c)        isCNTRL_LC(c)
isdigit(c)  isDIGIT(c)        isDIGIT_L1(c)        isDIGIT_LC(c)
isgraph(c)  isGRAPH(c)        isGRAPH_L1(c)        isGRAPH_LC(c)
islower(c)  isLOWER(c)        isLOWER_L1(c)        isLOWER_LC(c)
isprint(c)  isPRINT(c)        isPRINT_L1(c)        isPRINT_LC(c)
ispunct(c)  isPUNCT(c)        isPUNCT_L1(c)        isPUNCT_LC(c)
isspace(c)  isSPACE(c)        isSPACE_L1(c)        isSPACE_LC(c)
isupper(c)  isUPPER(c)        isUPPER_L1(c)        isUPPER_LC(c)
isxdigit(c) isXDIGIT(c)       isXDIGIT_L1(c)       isXDIGIT_LC(c)

tolower(c)  toLOWER(c)        toLOWER_L1(c)
toupper(c)  toUPPER(c)</code></pre>

<p>For the corresponding functions like <code>iswupper()</code>, <i>etc.</i>, use <code>isUPPER_uvchr()</code> for non-locale; or <code>isUPPER_LC_uvchr()</code> for locale. And use <code>toLOWER_uvchr()</code> instead of <code>towlower()</code>, <i>etc.</i>. There are no direct equivalents for locale; best to put the string into an SV.</p>

<p>Don&#39;t use any of the functions like <code>isalnum_l()</code>. Those are non-portable, and interfere with Perl&#39;s internal handling.</p>

<p>To emphasize that you are operating only on ASCII characters, you can append <code>_A</code> to each of the macros in the ASCII column: <code>isALPHA_A</code>, <code>isDIGIT_A</code>, and so on.</p>

<p>(There is no entry in the Latin1 column for <code>isascii</code> even though there is an <code>isASCII_L1</code>, which is identical to <code>isASCII</code>; the latter name is clearer. There is no entry in the Latin1 column for <code>toupper</code> because the result can be non-Latin1. You have to use <code>toUPPER_uvchr</code>, as described in <a href="perlapi.html#Character-case-changing">&quot;Character case changing&quot; in perlapi</a>.)</p>

<p>Note that the libc caseless comparisons are crippled; Unicode provides a richer set, using the concept of folding. If you need more than equality/non-equality, it&#39;s probably best to store your strings in an SV and use SV functions to do the comparision. Similarly for collation.</p>

<h2 id="stdlib.h-functions"><a class="permalink" href="#stdlib.h-functions">#</a><a id="stdlib"></a><i>stdlib.h</i> functions</h2>

<pre><code class="plaintext">Instead Of:                 Use:

atof(s)                     my_atof(s) or Atof(s)
atoi(s)                     grok_atoUV(s, &amp;uv, &amp;e)
atol(s)                     grok_atoUV(s, &amp;uv, &amp;e)
strtod(s, &amp;p)               Strtod(s, &amp;p)
strtol(s, &amp;p, n)            Strtol(s, &amp;p, b)
strtoul(s, &amp;p, n)           Strtoul(s, &amp;p, b)</code></pre>

<p>But note that even the alternative functions are subject to locale; see <a href="#Dealing-with-locales">&quot;Dealing with locales&quot;</a>.</p>

<p>Typical use is to do range checks on <code>uv</code> before casting:</p>

<pre><code>int i; UV uv;
char* end_ptr = input_end;
if (grok_atoUV(input, &amp;uv, &amp;end_ptr)
    &amp;&amp; uv &lt;= INT_MAX)
  i = (int)uv;
  ... /* continue parsing from end_ptr */
} else {
  ... /* parse error: not a decimal integer in range 0 .. MAX_IV */
}</code></pre>

<p>Notice also the <code>grok_bin</code>, <code>grok_hex</code>, and <code>grok_oct</code> functions in <i>numeric.c</i> for converting strings representing numbers in the respective bases into <code>NV</code>s. Note that grok_atoUV() doesn&#39;t handle negative inputs, or leading whitespace (being purposefully strict).</p>

<h2 id="Miscellaneous-functions"><a class="permalink" href="#Miscellaneous-functions">#</a><a id="Miscellaneous"></a>Miscellaneous functions</h2>

<p>You should not even <b>want</b> to use <i>setjmp.h</i> functions, but if you think you do, use the <code>JMPENV</code> stack in <i>scope.h</i> instead.</p>

<pre><code>~asctime()              Perl_sv_strftime_tm()
~asctime_r()            Perl_sv_strftime_tm()
 chsize()               my_chsize()
~ctime()                Perl_sv_strftime_tm()
~ctime_r()              Perl_sv_strftime_tm()
~cuserid()              DO NOT USE; see its man page
 dirfd()                my_dirfd()
 duplocale()            Perl_setlocale()
~ecvt()                 my_snprintf()
~endgrent_r()           endgrent()
~endhostent_r()         endhostent()
~endnetent_r()          endnetent()
~endprotoent_r()        endprotoent()
~endpwent_r()           endpwent()
~endservent_r()         endservent()
~endutent()             endutxent()
 exit(n)                my_exit(n)
~fcvt()                 my_snprintf()
 freelocale()           Perl_setlocale()
~ftw()                  nftw()
 getenv(s)              PerlEnv_getenv(s)
~gethostbyaddr()        getaddrinfo()
~gethostbyname()        getnameinfo()
~getpass()              DO NOT USE; see its man page
~getpw()                getpwuid()
~getutent()             getutxent()
~getutid()              getutxid()
~getutline()            getutxline()
~gsignal()              DO NOT USE; see its man page
 localeconv()           Perl_localeconv()
 mblen()                mbrlen()
 mbtowc()               mbrtowc()
 newlocale()            Perl_setlocale()
 pclose()               my_pclose()
 popen()                my_popen()
~pututline()            pututxline()
~qecvt()                my_snprintf()
~qfcvt()                my_snprintf()
 querylocale()          Perl_setlocale()
 int rand()             double Drand01()
 srand(n)               { seedDrand01((Rand_seed_t)n);
                          PL_srand_called = TRUE; }
~readdir_r()            readdir()
 realloc()              saferealloc(), Renew() or Renewc()
~re_comp()              regcomp()
~re_exec()              regexec()
~rexec()                rcmd()
~rexec_af()             rcmd()
 setenv(s, val)         my_setenv(s, val)
~setgrent_r()           setgrent()
~sethostent_r()         sethostent()
 setlocale()            Perl_setlocale()
 setlocale_r()          Perl_setlocale()
~setnetent_r()          setnetent()
~setprotoent_r()        setprotoent()
~setpwent_r()           setpwent()
~setservent_r()         setservent()
~setutent()             setutxent()
 sigaction()            rsignal(signo, handler)
~siginterrupt()         rsignal() with the SA_RESTART flag instead
 signal(signo, handler) rsignal(signo, handler)
~ssignal()              DO NOT USE; see its man page
 strcasecmp()           a Perl foldEQ-family function
 strerror()             sv_string_from_errnum()
 strerror_l()           sv_string_from_errnum()
 strerror_r()           sv_string_from_errnum()
 strftime()             Perl_sv_strftime_tm()
 strtod()               my_strtod() or Strtod()
 system(s)              Don&#39;t. Look at pp_system or use my_popen.
~tempnam()              mkstemp()
~tmpnam()               mkstemp()
 tmpnam_r()             mkstemp()
 uselocale()            Perl_setlocale()
 vsnprintf()            my_vsnprintf()
 wctob()                wcrtomb()
 wctomb()               wcrtomb()
 wsetlocale()           Perl_setlocale()</code></pre>

<p>The Perl-furnished alternatives are documented in <a href="perlapi.html">perlapi</a>, which you should peruse anyway to see what all is available to you.</p>

<p>The lists are incomplete. Think when using an unlisted function if it seems likely to interfere with Perl.</p>

<h1 id="Dealing-with-locales"><a class="permalink" href="#Dealing-with-locales">#</a><a id="Dealing"></a>Dealing with locales</h1>

<p>Like it or not, your code will be executed in the context of a locale, as are all C language programs. See <a href="perllocale.html">perllocale</a>. Most libc calls are not affected by the locale, but a surprising number are:</p>

<pre><code class="nohighlight">addmntent()           getspent_r()        sethostent()
alphasort()           getspnam()          sethostent_r()
asctime()             getspnam_r()        setnetent()
asctime_r()           getwc()             setnetent_r()
asprintf()            getwchar()          setnetgrent()
atof()                glob()              setprotoent()
atoi()                gmtime()            setprotoent_r()
atol()                gmtime_r()          setpwent()
atoll()               grantpt()           setpwent_r()
btowc()               iconv_open()        setrpcent()
catopen()             inet_addr()         setservent()
ctime()               inet_aton()         setservent_r()
ctime_r()             inet_network()      setspent()
cuserid()             inet_ntoa()         sgetspent_r()
daylight              inet_ntop()         shm_open()
dirname()             inet_pton()         shm_unlink()
dprintf()             initgroups()        snprintf()
endaliasent()         innetgr()           sprintf()
endgrent()            iruserok()          sscanf()
endgrent_r()          iruserok_af()       strcasecmp()
endhostent()          isalnum()           strcasestr()
endhostent_r()        isalnum_l()         strcoll()
endnetent()           isalpha()           strerror()
endnetent_r()         isalpha_l()         strerror_l()
endprotoent()         isascii()           strerror_r()
endprotoent_r()       isascii_l()         strfmon()
endpwent()            isblank()           strfmon_l()
endpwent_r()          isblank_l()         strfromd()
endrpcent()           iscntrl()           strfromf()
endservent()          iscntrl_l()         strfroml()
endservent_r()        isdigit()           strftime()
endspent()            isdigit_l()         strftime_l()
err()                 isgraph()           strncasecmp()
error()               isgraph_l()         strptime()
error_at_line()       islower()           strsignal()
errx()                islower_l()         strtod()
fgetwc()              isprint()           strtof()
fgetwc_unlocked()     isprint_l()         strtoimax()
fgetws()              ispunct()           strtol()
fgetws_unlocked()     ispunct_l()         strtold()
fnmatch()             isspace()           strtoll()
forkpty()             isspace_l()         strtoq()
fprintf()             isupper()           strtoul()
fputwc()              isupper_l()         strtoull()
fputwc_unlocked()     iswalnum()          strtoumax()
fputws()              iswalnum_l()        strtouq()
fputws_unlocked()     iswalpha()          strverscmp()
fscanf()              iswalpha_l()        strxfrm()
fwprintf()            iswblank()          swprintf()
fwscanf()             iswblank_l()        swscanf()
getaddrinfo()         iswcntrl()          syslog()
getaliasbyname_r()    iswcntrl_l()        timegm()
getaliasent_r()       iswdigit()          timelocal()
getdate()             iswdigit_l()        timezone
getdate_r()           iswgraph()          tolower()
getfsent()            iswgraph_l()        tolower_l()
getfsfile()           iswlower()          toupper()
getfsspec()           iswlower_l()        toupper_l()
getgrent()            iswprint()          towctrans()
getgrent_r()          iswprint_l()        towlower()
getgrgid()            iswpunct()          towlower_l()
getgrgid_r()          iswpunct_l()        towupper()
getgrnam()            iswspace()          towupper_l()
getgrnam_r()          iswspace_l()        tzname
getgrouplist()        iswupper()          tzset()
gethostbyaddr()       iswupper_l()        ungetwc()
gethostbyaddr_r()     iswxdigit()         vasprintf()
gethostbyname()       iswxdigit_l()       vdprintf()
gethostbyname2()      isxdigit()          verr()
gethostbyname2_r()    isxdigit_l()        verrx()
gethostbyname_r()     localeconv()        versionsort()
gethostent()          localtime()         vfprintf()
gethostent_r()        localtime_r()       vfscanf()
gethostid()           MB_CUR_MAX          vfwprintf()
getlogin()            mblen()             vprintf()
getlogin_r()          mbrlen()            vscanf()
getmntent()           mbrtowc()           vsnprintf()
getmntent_r()         mbsinit()           vsprintf()
getnameinfo()         mbsnrtowcs()        vsscanf()
getnetbyaddr()        mbsrtowcs()         vswprintf()
getnetbyaddr_r()      mbstowcs()          vsyslog()
getnetbyname()        mbtowc()            vwarn()
getnetbyname_r()      mktime()            vwarnx()
getnetent()           nan()               vwprintf()
getnetent_r()         nanf()              warn()
getnetgrent()         nanl()              warnx()
getnetgrent_r()       nl_langinfo()       wcrtomb()
getprotobyname()      openpty()           wcscasecmp()
getprotobyname_r()    printf()            wcschr()
getprotobynumber()    psiginfo()          wcscoll()
getprotobynumber_r()  psignal()           wcsftime()
getprotoent()         putpwent()          wcsncasecmp()
getprotoent_r()       putspent()          wcsnrtombs()
getpw()               putwc()             wcsrchr()
getpwent()            putwchar()          wcsrtombs()
getpwent_r()          regcomp()           wcstod()
getpwnam()            regexec()           wcstof()
getpwnam_r()          res_nclose()        wcstoimax()
getpwuid()            res_ninit()         wcstold()
getpwuid_r()          res_nquery()        wcstombs()
getrpcbyname_r()      res_nquerydomain()  wcstoumax()
getrpcbynumber_r()    res_nsearch()       wcswidth()
getrpcent_r()         res_nsend()         wcsxfrm()
getrpcport()          rpmatch()           wctob()
getservbyname()       ruserok()           wctomb()
getservbyname_r()     ruserok_af()        wctrans()
getservbyport()       scandir()           wctype()
getservbyport_r()     scanf()             wcwidth()
getservent()          setaliasent()       wordexp()
getservent_r()        setgrent()          wprintf()
getspent()            setgrent_r()        wscanf()</code></pre>

<p>(The list doesn&#39;t include functions that manipulate the locale, such as <code>setlocale()</code>.)</p>

<p>If any of these functions are called directly or indirectly from your code, you are affected by the current locale.</p>

<p>The first thing to know about this list is that there are better alternatives to many of the functions, which it&#39;s highly likely that you should be using instead. See <a href="#libc-functions-to-avoid">&quot;libc functions to avoid&quot;</a> above. This includes using Perl IO <a href="perlapio.html">perlapio</a>.</p>

<p>The second thing to know is that Perl is documented to not pay attention to the current locale except for code executed within the scope of a <span style="white-space: nowrap;"><code>use locale</code></span> statement. If you violate that, you may be creating bugs, depending on the application.</p>

<p>The next thing to know is that many of these functions depend only on the locale in regards to numeric values. Your code is likely to have been written expecting that the decimal point (radix) character is a dot (U+002E: FULL STOP), and that strings of integer numbers are not separated into groups (1,000,000 in an American locale means a million; your code is likely not expecting the commas.) The good news is that normally (as of Perl v5.22), your code will get called with the locale set so those expectations are met. Explicit action has to be taken to change this (described a little ways below). This is accomplished by Perl not actually switching into a locale that doesn&#39;t conform to these expectations, except when explicitly told to do so. The Perl input/output and formatting routines do this switching for you automatically, if appropriate, and then switch back. If, for some reason, you need to do it yourself, the easiest way from C and XS code is to use the macro <a href="perlapi.html#WITH_LC_NUMERIC_SET_TO_NEEDED">&quot;<code>WITH_LC_NUMERIC_SET_TO_NEEDED</code>&quot; in perlapi</a>. You can wrap this macro around an entire block of code that you want to be executed in the correct environment. The bottom line is that your code is likely to work as expected in this regard without you having to take any action.</p>

<p>This leaves the remaining functions. Your code will get called with all but the numeric locale portions set to the underlying locale. Often, the locale is of not much import to your code, and you also won&#39;t have to take any action; things will just work out. But you should examine the man pages of the ones you use to verify this. Often, Perl has better ways of doing the same functionality. Consider using SVs and their access routines rather than calling the low level functions that, for example, find how many bytes are in a UTF-8 encoded character.</p>

<p>You can determine if you have been called from within the scope of a <span style="white-space: nowrap;"><code>use locale</code></span> by using the boolen macro <a href="perlapi.html#IN_LOCALE">&quot;<code>IN_LOCALE</code>&quot; in perlapi</a>.</p>

<p>If you need to not be in the underlying locale, you can call <a href="perlapi.html#Perl_setlocale">&quot;<code>Perl_setlocale</code>&quot; in perlapi</a> to change it temporarily to the one you need (likely the &quot;C&quot; locale), and then change it back before returning. This can be <b>very</b> problematic on threaded perls on some platforms. See <a href="#Dealing-with-embedded-perls-and-threads">&quot;Dealing with embedded perls and threads&quot;</a>.</p>

<p>A problem with changing the locale of a single category is that mojibake can arise on some platforms if the <code>LC_CTYPE</code> category and the changed one are not the same. On the platforms that that isn&#39;t an issue, the preprocessor directive <code>LIBC_HANDLES_MISMATCHED_CTYPE</code> will be defined. Otherwise, you may have to change more than one category to correctly accomplish your task. And, there will be many locale combinations where the mojibake likely won&#39;t happen, so you won&#39;t be confronted with this until the code gets executed in the field by someone who doesn&#39;t speak your language very well.</p>

<p>Earlier we mentioned that explicit action is required to have your code get called with the numeric portions of the locale not meeting the typical expectations of having a dot for the radix character and no punctuation separating groups of digits. That action is to call the function <a href="perlapi.html#switch_to_global_locale">&quot;<code>switch_to_global_locale</code>&quot; in perlapi</a>.</p>

<p><code>switch_to_global_locale()</code> was written initially to cope with the <code>Tk</code> library, but is general enough for other similar situations. <code>Tk</code> changes the global locale to match its expectations (later versions of it allow this to be turned off). This presents a conflict with Perl thinking it also controls the locale. Calling this function tells Perl to yield control. Calling <a href="perlapi.html#sync_locale">&quot;<code>sync_locale</code>&quot; in perlapi</a> tells Perl to take control again, accepting whatever the locale has been changed to in the interim. If your code is called during that interim, all portions of the locale will be the raw underlying values. Should you need to manipulate numbers, you are on your own with regard to the radix character and grouping. If you find yourself in this situation, it is generally best to make the interval between the calls to these two functions as short as possible, and avoid calculations until after perl has control again.</p>

<p>It is important for perl to know about all the possible locale categories on the platform, even if they aren&#39;t apparently used in your program. Perl knows all of the Linux ones. If your platform has others, you can submit an issue at <a href="https://github.com/Perl/perl5/issues">https://github.com/Perl/perl5/issues</a> for inclusion of it in the next release. In the meantime, it is possible to edit the Perl source to teach it about the category, and then recompile. Search for instances of, say, <code>LC_PAPER</code> in the source, and use that as a template to add the omitted one.</p>

<p>There are further complications under multi-threaded operation. Keep on reading.</p>

<h1 id="Dealing-with-embedded-perls-and-threads"><a class="permalink" href="#Dealing-with-embedded-perls-and-threads">#</a><a id="Dealing1"></a>Dealing with embedded perls and threads</h1>

<p>It is possible to embed a Perl interpreter within a larger program. See <a href="perlembed.html">perlembed</a>.</p>

<p>MULTIPLICITY is the way this is accomplished internally; it is described in <a href="perlguts.html#How-multiple-interpreters-and-concurrency-are-supported">&quot;How multiple interpreters and concurrency are supported&quot; in perlguts</a>. Multiple Perl interpreters may be embedded.</p>

<p>It is also possible to compile perl to support threading. See <a href="perlthrtut.html">perlthrtut</a>. Perl&#39;s implementation of threading requires MULTIPLICITY, but not the other way around.</p>

<p>MULTIPLICITY without threading means that only one thing runs at a time, so there are no concurrency issues, but each component or instance can affect the global state, potentially interfering with the execution of other instances. This can happen if one instance:</p>

<ul>

<li><p>changes the current working directory</p>

</li>
<li><p>changes the process&#39;s environment</p>

</li>
<li><p>changes the global locale the process is operating under</p>

</li>
<li><p>writes to shared memory or to a shared file</p>

</li>
<li><p>uses a shared file descriptor (including a database iterator)</p>

</li>
<li><p>raises a signal that functions in other instances are sensitive to</p>

</li>
</ul>

<p>If your code doesn&#39;t do any of these things, nor depends on any of their values, then Congratulations!!, you don&#39;t have to worry about MULTIPLICITY or threading. But wait, a surprising number of libc functions do depend on data global to the process in some way that may not be immediately obvious. For example, calling <code><a href="http://man.he.net/man3/strtok">strtok(3)</a></code> changes the global state of a process, and thus needs special attention.</p>

<p>The section 3 libc uses that we know about that have MULTIPLICITY and/or multi-thread issues are:</p>

<pre><code class="nohighlight">addmntent()             getrpcent_r()        re_exec()
alphasort()             getrpcport()         regcomp()
asctime()               getservbyname()      regerror()
asctime_r()             getservbyname_r()    regexec()
asprintf()              getservbyport()      res_nclose()
atof()                  getservbyport_r()    res_ninit()
atoi()                  getservent()         res_nquery()
atol()                  getservent_r()       res_nquerydomain()
atoll()                 getspent()           res_nsearch()
basename()              getspent_r()         res_nsend()
btowc()                 getspnam()           rexec()
catgets()               getspnam_r()         rexec_af()
catopen()               getttyent()          rpmatch()
clearenv()              getttynam()          ruserok()
clearerr_unlocked()     getusershell()       ruserok_af()
crypt()                 getutent()           scandir()
crypt_gensalt()         getutid()            scanf()
crypt_r()               getutline()          secure_getenv()
ctermid()               getutxent()          seed48()
ctermid_r()             getutxid()           seed48_r()
ctime()                 getutxline()         setaliasent()
ctime_r()               getwc()              setcontext()
cuserid()               getwchar()           setenv()
daylight                getwchar_unlocked()  setfsent()
dbm_clearerr()          getwc_unlocked()     setgrent()
dbm_close()             glob()               setgrent_r()
dbm_delete()            gmtime()             sethostent()
dbm_error()             gmtime_r()           sethostent_r()
dbm_fetch()             grantpt()            sethostid()
dbm_firstkey()          hcreate()            setkey()
dbm_nextkey()           hcreate_r()          setlocale()
dbm_open()              hdestroy()           setlocale_r()
dbm_store()             hdestroy_r()         setlogmask()
dirname()               hsearch()            setnetent()
dlerror()               hsearch_r()          setnetent_r()
dprintf()               iconv()              setnetgrent()
drand48()               iconv_open()         setprotoent()
drand48_r()             inet_addr()          setprotoent_r()
ecvt()                  inet_aton()          setpwent()
encrypt()               inet_network()       setpwent_r()
endaliasent()           inet_ntoa()          setrpcent()
endfsent()              inet_ntop()          setservent()
endgrent()              inet_pton()          setservent_r()
endgrent_r()            initgroups()         setspent()
endhostent()            initstate_r()        setstate_r()
endhostent_r()          innetgr()            setttyent()
endnetent()             iruserok()           setusershell()
endnetent_r()           iruserok_af()        setutent()
endnetgrent()           isalnum()            setutxent()
endprotoent()           isalnum_l()          sgetspent()
endprotoent_r()         isalpha()            sgetspent_r()
endpwent()              isalpha_l()          shm_open()
endpwent_r()            isascii()            shm_unlink()
endrpcent()             isascii_l()          siginterrupt()
endservent()            isblank()            sleep()
endservent_r()          isblank_l()          snprintf()
endspent()              iscntrl()            sprintf()
endttyent()             iscntrl_l()          srand48()
endusershell()          isdigit()            srand48_r()
endutent()              isdigit_l()          srandom_r()
endutxent()             isgraph()            sscanf()
erand48()               isgraph_l()          ssignal()
erand48_r()             islower()            strcasecmp()
err()                   islower_l()          strcasestr()
error()                 isprint()            strcoll()
error_at_line()         isprint_l()          strerror()
errx()                  ispunct()            strerror_l()
ether_aton()            ispunct_l()          strerror_r()
ether_ntoa()            isspace()            strfmon()
execlp()                isspace_l()          strfmon_l()
execvp()                isupper()            strfromd()
execvpe()               isupper_l()          strfromf()
exit()                  iswalnum()           strfroml()
__fbufsize()            iswalnum_l()         strftime()
fcloseall()             iswalpha()           strftime_l()
fcvt()                  iswalpha_l()         strncasecmp()
fflush_unlocked()       iswblank()           strptime()
fgetc_unlocked()        iswblank_l()         strsignal()
fgetgrent()             iswcntrl()           strtod()
fgetpwent()             iswcntrl_l()         strtof()
fgetspent()             iswdigit()           strtoimax()
fgets_unlocked()        iswdigit_l()         strtok()
fgetwc()                iswgraph()           strtol()
fgetwc_unlocked()       iswgraph_l()         strtold()
fgetws()                iswlower()           strtoll()
fgetws_unlocked()       iswlower_l()         strtoq()
fnmatch()               iswprint()           strtoul()
forkpty()               iswprint_l()         strtoull()
__fpending()            iswpunct()           strtoumax()
fprintf()               iswpunct_l()         strtouq()
__fpurge()              iswspace()           strverscmp()
fputc_unlocked()        iswspace_l()         strxfrm()
fputs_unlocked()        iswupper()           swapcontext()
fputwc()                iswupper_l()         swprintf()
fputwc_unlocked()       iswxdigit()          swscanf()
fputws()                iswxdigit_l()        sysconf()
fputws_unlocked()       isxdigit()           syslog()
fread_unlocked()        isxdigit_l()         system()
fscanf()                jrand48()            tdelete()
__fsetlocking()         jrand48_r()          tempnam()
fts_children()          l64a()               tfind()
fts_read()              lcong48()            timegm()
ftw()                   lcong48_r()          timelocal()
fwprintf()              lgamma()             timezone
fwrite_unlocked()       lgammaf()            tmpnam()
fwscanf()               lgammal()            tmpnam_r()
gamma()                 localeconv()         tolower()
gammaf()                localtime()          tolower_l()
gammal()                localtime_r()        toupper()
getaddrinfo()           login()              toupper_l()
getaliasbyname()        login_tty()          towctrans()
getaliasbyname_r()      logout()             towlower()
getaliasent()           logwtmp()            towlower_l()
getaliasent_r()         lrand48()            towupper()
getchar_unlocked()      lrand48_r()          towupper_l()
getcontext()            makecontext()        tsearch()
getc_unlocked()         mallinfo()           ttyname()
get_current_dir_name()  MB_CUR_MAX           ttyname_r()
getdate()               mblen()              ttyslot()
getdate_r()             mbrlen()             twalk()
getenv()                mbrtowc()            twalk_r()
getfsent()              mbsinit()            tzname
getfsfile()             mbsnrtowcs()         tzset()
getfsspec()             mbsrtowcs()          ungetwc()
getgrent()              mbstowcs()           unsetenv()
getgrent_r()            mbtowc()             updwtmp()
getgrgid()              mcheck()             utmpname()
getgrgid_r()            mcheck_check_all()   va_arg()
getgrnam()              mcheck_pedantic()    valloc()
getgrnam_r()            mktime()             vasprintf()
getgrouplist()          mprobe()             vdprintf()
gethostbyaddr()         mrand48()            verr()
gethostbyaddr_r()       mrand48_r()          verrx()
gethostbyname()         mtrace()             versionsort()
gethostbyname2()        muntrace()           vfprintf()
gethostbyname2_r()      nan()                vfscanf()
gethostbyname_r()       nanf()               vfwprintf()
gethostent()            nanl()               vprintf()
gethostent_r()          newlocale()          vscanf()
gethostid()             nftw()               vsnprintf()
getlogin()              nl_langinfo()        vsprintf()
getlogin_r()            nrand48()            vsscanf()
getmntent()             nrand48_r()          vswprintf()
getmntent_r()           openpty()            vsyslog()
getnameinfo()           perror()             vwarn()
getnetbyaddr()          posix_fallocate()    vwarnx()
getnetbyaddr_r()        printf()             vwprintf()
getnetbyname()          profil()             warn()
getnetbyname_r()        psiginfo()           warnx()
getnetent()             psignal()            wcrtomb()
getnetent_r()           ptsname()            wcscasecmp()
getnetgrent()           putchar_unlocked()   wcschr()
getnetgrent_r()         putc_unlocked()      wcscoll()
getopt()                putenv()             wcsftime()
getopt_long()           putpwent()           wcsncasecmp()
getopt_long_only()      putspent()           wcsnrtombs()
getpass()               pututline()          wcsrchr()
getprotobyname()        pututxline()         wcsrtombs()
getprotobyname_r()      putwc()              wcstod()
getprotobynumber()      putwchar()           wcstof()
getprotobynumber_r()    putwchar_unlocked()  wcstoimax()
getprotoent()           putwc_unlocked()     wcstold()
getprotoent_r()         pvalloc()            wcstombs()
getpw()                 qecvt()              wcstoumax()
getpwent()              qfcvt()              wcswidth()
getpwent_r()            querylocale()        wcsxfrm()
getpwnam()              rand()               wctob()
getpwnam_r()            random_r()           wctomb()
getpwuid()              rcmd()               wctrans()
getpwuid_r()            rcmd_af()            wctype()
getrpcbyname()          readdir()            wcwidth()
getrpcbyname_r()        readdir64()          wordexp()
getrpcbynumber()        readdir64_r()        wprintf()
getrpcbynumber_r()      readdir_r()          wscanf()
getrpcent()             re_comp()            wsetlocale()</code></pre>

<p>(If you know of additional functions that are unsafe on some platform or another, notify us via filing a bug report at <a href="https://github.com/Perl/perl5/issues">https://github.com/Perl/perl5/issues</a>.)</p>

<p>Some of these are safe under MULTIPLICITY, problematic only under threading. If a use doesn&#39;t appear in the above list, we think it is MULTIPLICITY and thread-safe on all platforms.</p>

<p>All the uses listed above are function calls, except for these:</p>

<pre><code class="plaintext">daylight  MB_CUR_MAX  timezone  tzname</code></pre>

<p>There are three main approaches to coping with issues involving these constructs, each suitable for different circumstances:</p>

<ul>

<li><p>Don&#39;t use them. Some of them have preferred alternatives. Use the list above in <a href="#libc-functions-to-avoid">&quot;libc functions to avoid&quot;</a> to replace your uses with ones that are thread-friendly. For example I/O, should be done via <a href="perlapio.html">perlapio</a>.</p>

<p>If you must use them, many, but not all, of them will be ok as long as their use is confined to a single thread that has no interaction with conflicting uses in other threads. You will need to closely examine their man pages for this, and be aware that vendor documentation is often imprecise.</p>

</li>
<li><p>Do all your business before any other code can change things. If you make changes, change back before returning.</p>

</li>
<li><p>Save the result of a query of global information to a per-instance area before allowing another instance to execute. Then you can work on it at your leisure. This might be an automatic C variable for non-pointers, or something as described above in <code><a href="perlxs.html#Safely-Storing-Static-Data-in-XS">&quot;Safely Storing Static Data in XS&quot; in perlxs</a></code>.</p>

</li>
</ul>

<p>Without threading, you don&#39;t have to worry about being interrupted by the system giving control to another thread. With threading, you will have to uses mutexes, and be concerned with the possibility of deadlock.</p>

<h2 id="Functions-always-unsuitable-for-use-under-multi-threads"><a class="permalink" href="#Functions-always-unsuitable-for-use-under-multi-threads">#</a><a id="Functions"></a>Functions always unsuitable for use under multi-threads</h2>

<p>A few functions are considered totally unsuited for use in a multi-thread environment. These must be called only during single-thread operation.</p>

<pre><code> endusershell()    @getaliasent()      muntrace()   rexec()
 ether_aton()      @getrpcbyname()     profil()     rexec_af()
 ether_ntoa()      @getrpcbynumber()   rcmd()       setusershell()
 fts_children()    @getrpcent()        rcmd_af()    ttyslot()
 fts_read()         getusershell()     re_comp()
@getaliasbyname()   mtrace()           re_exec()</code></pre>

<p><code>@</code> above marks the functions for which there are preferred alternatives available on some platforms, and those alternatives may be suitable for multi-thread use.</p>

<h2 id="Functions-which-must-be-called-at-least-once-before-starting-threads"><a class="permalink" href="#Functions-which-must-be-called-at-least-once-before-starting-threads">#</a><a id="Functions1"></a>Functions which must be called at least once before starting threads</h2>

<p>Some functions perform initialization on their first call that must be done while still in a single-thread environment, but subsequent calls are thread-safe when executed in a critical section. Therefore, they must be called at least once before switching to multi-threads:</p>

<pre><code class="plaintext">getutent()  getutline()  getutxid()    mallinfo()  valloc()
getutid()   getutxent()  getutxline()  pvalloc()</code></pre>

<h2 id="Functions-that-are-thread-safe-when-called-with-appropriate-arguments"><a class="permalink" href="#Functions-that-are-thread-safe-when-called-with-appropriate-arguments">#</a><a id="Functions2"></a>Functions that are thread-safe when called with appropriate arguments</h2>

<p>Some of the functions are thread-safe if called with arguments that comply with certain (easily met) restrictions. These are:</p>

<pre><code class="plaintext">ctermid()        mbrlen()      mbsrtowcs()  wcrtomb()
cuserid()        mbrtowc()     tmpnam()     wcsnrtombs()
error_at_line()  mbsnrtowcs()  va_arg()     wcsrtombs()</code></pre>

<p>See the man pages of each for details. (For completeness, the list includes functions that you shouldn&#39;t be using anyway because of other reasons.)</p>

<h2 id="Functions-vulnerable-to-signals"><a class="permalink" href="#Functions-vulnerable-to-signals">#</a><a id="Functions3"></a>Functions vulnerable to signals</h2>

<p>Some functions are vulnerable to asynchronous signals. These are:</p>

<pre><code class="plaintext">getlogin()    getutid()    getutxid()    login()   pututline()  updwtmp()
getlogin_r()  getutline()  getutxline()  logout()  pututxline() wordexp()
getutent()    getutxent()  glob()        logwtmp() sleep()</code></pre>

<p>Some libc&#39;s implement &#39;system()&#39; thread-safely. But in others, it also has signal issues.</p>

<h2 id="General-issues-with-thread-safety"><a class="permalink" href="#General-issues-with-thread-safety">#</a><a id="General"></a>General issues with thread-safety</h2>

<p>Some libc functions use and/or modify a global state, such as a database. The libc functions presume that there is only one instance at a time operating on that database. Unpredictable results occur if more than one does, even if the database is not changed. For example, typically there is a global iterator for such a data base and that iterator is maintained by libc, so that each new read from any instance advances it, meaning that no instance will see all the entries. The only way to make these thread-safe is to have an exclusive lock on a mutex from the open call through the close. You are advised to not use such databases from more than one instance at a time.</p>

<p>Other examples of functions that use a global state include pseudo-random number generators. Some libc implementations of &#39;rand()&#39;, for example, may share the data across threads; and others may have per-thread data. The shared ones will have unreproducible results, as the threads will vary in their timings and interactions. This may be what you want; or it may not be. (This particular function is a candidate to be removed from the POSIX Standard because of these issues.)</p>

<p>Functions that output to a stream also are considered thread-unsafe when locking is not done. But the typical consequences are just that the data is output in an unpredictable order; that outcome may be totally acceptable to you.</p>

<p>Since the current working directory is global to a process, all instances depend on it. One instance doing a chdir(2) affects all the other instances. In a multi-threaded environment, any libc call that expects the directory to not change for the duration of its execution will have undefined results if another thread interrupts it at just the wrong time and changes the directory. The man pages only list one such call, nftw(). But there may be other issues lurking.</p>

<h2 id="Reentrant-equivalent-functions"><a class="permalink" href="#Reentrant-equivalent-functions">#</a><a id="Reentrant"></a>Reentrant equivalent functions</h2>

<p>Some functions that are problematic with regard to MULTIPLICITY have reentrant versions (on some or all platforms) that are better suited, with fewer (perhaps no) races when run under threads.</p>

<p>Some of these reentrant functions that are available on all platforms should always be used anyway; they are in the lists directly under <a href="#libc-functions-to-avoid">&quot;libc functions to avoid&quot;</a>.</p>

<p>Others may not be available on some platforms, or have issues that make them undesirable to use even when they are available. Or it may just be more complicated and tedious to use the reentrant version. For these, perl has a mechanism for automatically substituting that reentrant version when available and desirable, while hiding the complications from your code. This feature is enabled by default for code in the Perl core and its extensions. To enable it in other XS modules,</p>

<pre><code class="plaintext">#define PERL_REENTRANT</code></pre>

<p>It is simpler for you to use the unpreferred version in your code, and rely on this feature to do the better thing, in part because no substitution is done if the alternative is not available or desirable on the platform, nor if threads aren&#39;t enabled. You just write as if there weren&#39;t threads, and you get the better behavior without having to think about it.</p>

<p>On some platforms the safer library functions may fail if the result buffer is too small (for example the user group databases may be rather large, and the reentrant functions may have to carry around a full snapshot of those databases). Perl will start with a small buffer, but keep retrying and growing the result buffer until the result fits. If this limitless growing sounds bad for security or memory consumption reasons you can recompile Perl with <code>PERL_REENTRANT_MAXSIZE</code> #defined to the maximum number of bytes you will allow.</p>

<p>Below is a list of the non-reentrant functions and their reentrant alternatives. This substitution is done even on functions that you shouldn&#39;t be using in the first place. These are marked by a <code>*</code>. You should instead use the alternate given in the lists directly under <a href="#libc-functions-to-avoid">&quot;libc functions to avoid&quot;</a>.</p>

<p>Even so, some of the preferred alternatives are considered obsolete or otherwise unwise to use on some platforms. These are marked with a &#39;?&#39;. Also, some alternatives aren&#39;t Perl-defined functions and aren&#39;t in the POSIX Standard, so won&#39;t be widely available. These are marked with &#39;~&#39;. (Remember that the automatic substitution only happens when they are available and desirable, so you can just use the unpreferred alternative.)</p>

<pre><code class="plaintext">*asctime()             ?asctime_r()
 crypt()               ~crypt_r()
 ctermid()             ~ctermid_r()
*ctime()               ?ctime_r()
 endgrent()           ?~endgrent_r()
 endhostent()         ?~endhostent_r()
 endnetent()          ?~endnetent_r()
 endprotoent()        ?~endprotoent_r()
 endpwent()           ?~endpwent_r()
 endservent()         ?~endservent_r()
 getgrent()            ~getgrent_r()
 getgrgid()             getgrgid_r()
 getgrnam()             getgrnam_r()
 gethostbyaddr()       ~gethostbyaddr_r()
 gethostbyname()       ~gethostbyname_r()
 gethostent()          ~gethostent_r()
 getlogin()             getlogin_r()
 getnetbyaddr()        ~getnetbyaddr_r()
 getnetbyname()        ~getnetbyname_r()
 getnetent()           ~getnetent_r()
 getprotobyname()      ~getprotobyname_r()
 getprotobynumber()    ~getprotobynumber_r()
 getprotoent()         ~getprotoent_r()
 getpwent()            ~getpwent_r()
 getpwnam()             getpwnam_r()
 getpwuid()             getpwuid_r()
 getservbyname()       ~getservbyname_r()
 getservbyport()       ~getservbyport_r()
 getservent()          ~getservent_r()
 getspnam()            ~getspnam_r()
 gmtime()               gmtime_r()
 localtime()            localtime_r()
 readdir()             ?readdir_r()
 readdir64()           ~readdir64_r()
 setgrent()           ?~setgrent_r()
 sethostent()         ?~sethostent_r()
*setlocale()          ?~setlocale_r()
 setnetent()          ?~setnetent_r()
 setprotoent()        ?~setprotoent_r()
 setpwent()           ?~setpwent_r()
 setservent()         ?~setservent_r()
*strerror()             strerror_r()
*tmpnam()              ~tmpnam_r()
 ttyname()              ttyname_r()</code></pre>

<p>The Perl-furnished items are documented in perlapi.</p>

<p>The bottom line is:</p>

<dl>

<dt id="For-items-marked-*"><a class="permalink" href="#For-items-marked-*">#</a><a id="For"></a><a id="For-items-marked"></a>For items marked <code>*</code></dt>
<dd>

<p>Replace all uses of these with the preferred alternative given in the lists directly under <a href="#libc-functions-to-avoid">&quot;libc functions to avoid&quot;</a>.</p>

</dd>
<dt id="For-the-remaining-items"><a class="permalink" href="#For-the-remaining-items">#</a><a id="For1"></a>For the remaining items</dt>
<dd>

<p>If you really need to use these functions, you have two choices:</p>

<dl>

<dt id="If-you-#define-PERL_REENTRANT"><a class="permalink" href="#If-you-%23define-PERL_REENTRANT">#</a><a id="If"></a><a id="If-you-define-PERL_REENTRANT"></a>If you #define PERL_REENTRANT</dt>
<dd>

<p>Use the function in the first column as-is, and let perl do the work of substituting the function in the right column if available on the platform, and it is deemed suitable for use.</p>

<p>You should look at the man pages for both versions to find any other gotchas.</p>

</dd>
<dt id="If-you-don&#39;t-enable-automatic-substitution"><a class="permalink" href="#If-you-don&#39;t-enable-automatic-substitution">#</a><a id="If1"></a><a id="If-you-dont-enable-automatic-substitution"></a>If you don&#39;t enable automatic substitution</dt>
<dd>

<p>You should examine the application&#39;s code to determine if the column 1 function presents a real problem under threads given the circumstances it is used in. You can go directly to the column 2 replacement, but beware of the ones that are marked. Some of those may be nonexistent or flaky on some platforms.</p>

</dd>
</dl>

</dd>
</dl>

<h2 id="Functions-that-need-the-environment-to-be-constant"><a class="permalink" href="#Functions-that-need-the-environment-to-be-constant">#</a><a id="Functions4"></a>Functions that need the environment to be constant</h2>

<p>Since the environment is global to a process, all instances depend on it. One instance changing the environment affects all the other instances. Under threads, any libc call that expects the environment to not change for the duration of its execution will have undefined results if another thread interrupts it at just the wrong time and changes it. These are the functions that the man pages list as being sensitive to that.</p>

<pre><code class="plaintext">catopen()               gethostbyname2()    newlocale()
ctime()                 gethostbyname2_r()  regerror()
ctime_r()               gethostbyname_r()   secure_getenv()
endhostent()            gethostent()        sethostent()
endhostent_r()          gethostent_r()      sethostent_r()
endnetent()             gethostid()         setlocale()
endnetent_r()           getnameinfo()       setlocale_r()
execlp()                getnetbyname()      setnetent()
execvp()                getnetent()         setnetent_r()
execvpe()               getopt()            strftime()
fnmatch()               getopt_long()       strptime()
getaddrinfo()           getopt_long_only()  sysconf()
get_current_dir_name()  getrpcport()        syslog()
getdate()               glob()              tempnam()
getdate_r()             gmtime()            timegm()
getenv()                gmtime_r()          timelocal()
gethostbyaddr()         localtime()         tzset()
gethostbyaddr_r()       localtime_r()       vsyslog()
gethostbyname()         mktime()</code></pre>

<p>Many of these functions are problematic under threads for other reasons as well. See the man pages for any you use.</p>

<p>Perl defines mutexes <code>ENV_READ_LOCK</code> and <code>ENV_READ_UNLOCK</code> with which to wrap calls to these functions. You need to consider the possibility of deadlock. It is expected that a different mechanism will be in place and preferred for Perl v5.42.</p>

<h2 id="Locale-specific-issues"><a class="permalink" href="#Locale-specific-issues">#</a><a id="Locale"></a>Locale-specific issues</h2>

<p>C language programs originally had a single locale global to the entire process. This was later found to be inadequate for many purposes, so later extensions changed that, first with Windows, and then POSIX 2008. In Windows, you can change any thread at any time to operate either with a per-thread locale, or with the global one, using a special new libc function. In POSIX, the original API operates only on the global locale, but there is an entirely new API to manipulate either per-thread locales or the global one. As with Windows (but using the new API), a thread can be switched at any time to operate on the global locale, or a per-thread one.</p>

<p>When one instance changes the global locale, all other instances using the global locale are affected. Almost all the locale-related functions in the list directly under <a href="#Dealing-with-embedded-perls-and-threads">&quot;Dealing with embedded perls and threads&quot;</a> have undefined behavior if another thread interrupts their execution and changes the locale. Under threads, another thread could do exactly that.</p>

<p>But, on systems that have per-thread locales, starting with Perl v5.28, perl uses them after initialization; the global locale is not used except if XS code has called <code>switch_to_global_locale()</code>. Doing so affects only the thread that called it. If a maximum of one instance is using the global locale, no other instances are affected, the locale of concurrently executing functions in other threads is not changed, and this becomes a non-issue. The C preprocessor symbol <code>USE_THREAD_SAFE_LOCALE</code> will be defined if per-thread locales are available and perl has been compiled to use them. The implementation of per-thread locales on some platforms, like most *BSD-based ones, is so buggy that the perl hints files for them deliberately turn off the possibility of using them.</p>

<p>The converse is that on systems with only a global locale, having different threads using different locales is not likely to work well; and changing the locale is dangerous, often leading to crashes.</p>

<p>Perl has extensive code to work as well as possible on both types of systems. You should always use <code>Perl_setlocale()</code> to change and query the locale, as it portably works across the range of possibilities.</p>

<h1 id="SEE-ALSO"><a class="permalink" href="#SEE-ALSO">#</a><a id="SEE"></a>SEE ALSO</h1>

<p><a href="perlapi.html">perlapi</a>, <a href="perlapio.html">perlapio</a>, <a href="perlguts.html">perlguts</a>, <a href="perlxs.html">perlxs</a></p>


      </div>
      <div id="footer">
        <p>Perldoc Browser is maintained by Dan Book (<a href="https://metacpan.org/author/DBOOK">DBOOK</a>). Please contact him via the <a href="https://github.com/Grinnz/perldoc-browser/issues">GitHub issue tracker</a> or <a href="mailto:dbook@cpan.org">email</a> regarding any issues with the site itself, search, or rendering of documentation.</p>

<p>The Perl documentation is maintained by the Perl 5 Porters in the development of Perl. Please contact them via the <a href="https://github.com/Perl/perl5/issues">Perl issue tracker</a>, the <a href="https://lists.perl.org/list/perl5-porters.html">mailing list</a>, or <a href="https://kiwiirc.com/client/irc.perl.org/p5p">IRC</a> to report any issues with the contents or format of the documentation.</p>


      </div>
    </div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/highlight.pack.js"></script>
    <script>hljs.highlightAll();</script>
  </body>

<!-- Mirrored from perldoc.perl.org/perlclib by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 06 Aug 2025 16:20:51 GMT -->
</html>
