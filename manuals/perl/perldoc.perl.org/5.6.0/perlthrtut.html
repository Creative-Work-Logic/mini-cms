<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from perldoc.perl.org/5.6.0/perlthrtut by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 06 Aug 2025 16:20:46 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>perlthrtut - tutorial on threads in Perl - Perldoc Browser</title>
    <link rel="search" href="../opensearch.xml" type="application/opensearchdescription+xml" title="Perldoc Browser">
    <link rel="canonical" href="../perlthrtut.html">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/stackoverflow-light.min.css" rel="stylesheet">
    <link href="../css/perldoc.css" rel="stylesheet">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KVNWBNT5FB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-KVNWBNT5FB');
      gtag('config', 'UA-50555-3');
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-md bg-dark" data-bs-theme="dark"><div class="container-fluid">
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="../index.html"><img src="../images/perl_camel_30.png" width="30" height="30" class="d-inline-block align-text-top" alt="Perl Camel Logo"> Perldoc Browser</a>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav me-auto">
      <li class="nav-item dropdown text-nowrap">
        <a class="nav-link dropdown-toggle" href="#" id="dropdownlink-stable" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">5.6.0</a>
        <div class="dropdown-menu" aria-labelledby="dropdownlink-stable">
          <a class="dropdown-item" href="../perlthrtut.html">Latest</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.42.0/perlthrtut">5.42.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.3/perlthrtut">5.40.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.2/perlthrtut">5.40.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.1/perlthrtut">5.40.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.0/perlthrtut">5.40.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.5/perlthrtut">5.38.5</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.4/perlthrtut">5.38.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.3/perlthrtut">5.38.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.2/perlthrtut">5.38.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.1/perlthrtut">5.38.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.0/perlthrtut">5.38.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.36.3/perlthrtut">5.36.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.36.2/perlthrtut">5.36.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.36.1/perlthrtut">5.36.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.36.0/perlthrtut">5.36.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.34.3/perlthrtut">5.34.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.34.2/perlthrtut">5.34.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.34.1/perlthrtut">5.34.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.34.0/perlthrtut">5.34.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.32.1/perlthrtut">5.32.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.32.0/perlthrtut">5.32.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.30.3/perlthrtut">5.30.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.30.2/perlthrtut">5.30.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.30.1/perlthrtut">5.30.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.30.0/perlthrtut">5.30.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.28.3/perlthrtut">5.28.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.28.2/perlthrtut">5.28.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.28.1/perlthrtut">5.28.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.28.0/perlthrtut">5.28.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.26.3/perlthrtut">5.26.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.26.2/perlthrtut">5.26.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.26.1/perlthrtut">5.26.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.26.0/perlthrtut">5.26.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.4/perlthrtut">5.24.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.3/perlthrtut">5.24.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.2/perlthrtut">5.24.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.1/perlthrtut">5.24.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.24.0/perlthrtut">5.24.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.4/perlthrtut">5.22.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.3/perlthrtut">5.22.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.2/perlthrtut">5.22.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.1/perlthrtut">5.22.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.22.0/perlthrtut">5.22.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.20.3/perlthrtut">5.20.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.20.2/perlthrtut">5.20.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.20.1/perlthrtut">5.20.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.20.0/perlthrtut">5.20.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.4/perlthrtut">5.18.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.3/perlthrtut">5.18.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.2/perlthrtut">5.18.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.1/perlthrtut">5.18.1</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.18.0/perlthrtut">5.18.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="../5.16.3/perlthrtut.html">5.16.3</a>
          <a class="dropdown-item" href="../5.16.2/perlthrtut.html">5.16.2</a>
          <a class="dropdown-item" href="../5.16.1/perlthrtut.html">5.16.1</a>
          <a class="dropdown-item" href="../5.16.0/perlthrtut.html">5.16.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="../5.14.4/perlthrtut.html">5.14.4</a>
          <a class="dropdown-item" href="../5.14.3/perlthrtut.html">5.14.3</a>
          <a class="dropdown-item" href="../5.14.2/perlthrtut.html">5.14.2</a>
          <a class="dropdown-item" href="../5.14.1/perlthrtut.html">5.14.1</a>
          <a class="dropdown-item" href="../5.14.0/perlthrtut.html">5.14.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="../5.12.5/perlthrtut.html">5.12.5</a>
          <a class="dropdown-item" href="../5.12.4/perlthrtut.html">5.12.4</a>
          <a class="dropdown-item" href="../5.12.3/perlthrtut.html">5.12.3</a>
          <a class="dropdown-item" href="../5.12.2/perlthrtut.html">5.12.2</a>
          <a class="dropdown-item" href="../5.12.1/perlthrtut.html">5.12.1</a>
          <a class="dropdown-item" href="../5.12.0/perlthrtut.html">5.12.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="../5.10.1/perlthrtut.html">5.10.1</a>
          <a class="dropdown-item" href="../5.10.0/perlthrtut.html">5.10.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="../5.8.9/perlthrtut.html">5.8.9</a>
          <a class="dropdown-item" href="../5.8.8/perlthrtut.html">5.8.8</a>
          <a class="dropdown-item" href="../5.8.7/perlthrtut.html">5.8.7</a>
          <a class="dropdown-item" href="../5.8.6/perlthrtut.html">5.8.6</a>
          <a class="dropdown-item" href="../5.8.5/perlthrtut.html">5.8.5</a>
          <a class="dropdown-item" href="../5.8.4/perlthrtut.html">5.8.4</a>
          <a class="dropdown-item" href="../5.8.3/perlthrtut.html">5.8.3</a>
          <a class="dropdown-item" href="../5.8.2/perlthrtut.html">5.8.2</a>
          <a class="dropdown-item" href="../5.8.1/perlthrtut.html">5.8.1</a>
          <a class="dropdown-item" href="../5.8.0/perlthrtut.html">5.8.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="../5.6.2/perlthrtut.html">5.6.2</a>
          <a class="dropdown-item" href="../5.6.1/perlthrtut.html">5.6.1</a>
          <a class="dropdown-item active" href="perlthrtut.html">5.6.0</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="../5.005_04/perlthrtut.html">5.005_04</a>
          <a class="dropdown-item" href="../5.005_03/perlthrtut.html">5.005_03</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.005_02/perlthrtut">5.005_02</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.005_01/perlthrtut">5.005_01</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.005/perlthrtut">5.005</a>
        </div>
      </li>
      <li class="nav-item dropdown text-nowrap">
        <a class="nav-link dropdown-toggle" href="#" id="dropdownlink-dev" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dev</a>
        <div class="dropdown-menu" aria-labelledby="dropdownlink-dev">
          <a class="dropdown-item" href="https://perldoc.perl.org/blead/perlthrtut">blead</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.43.1/perlthrtut">5.43.1</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.42.0-RC3/perlthrtut">5.42.0-RC3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.42.0-RC2/perlthrtut">5.42.0-RC2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.42.0-RC1/perlthrtut">5.42.0-RC1</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.13/perlthrtut">5.41.13</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.12/perlthrtut">5.41.12</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.11/perlthrtut">5.41.11</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.10/perlthrtut">5.41.10</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.9/perlthrtut">5.41.9</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.8/perlthrtut">5.41.8</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.7/perlthrtut">5.41.7</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.6/perlthrtut">5.41.6</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.5/perlthrtut">5.41.5</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.4/perlthrtut">5.41.4</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.3/perlthrtut">5.41.3</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.2/perlthrtut">5.41.2</a>
          <a class="dropdown-item" href="https://perldoc.perl.org/5.41.1/perlthrtut">5.41.1</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.40.3-RC1/perlthrtut">5.40.3-RC1</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="https://perldoc.perl.org/5.38.5-RC1/perlthrtut">5.38.5-RC1</a>
        </div>
      </li>
      <li class="nav-item dropdown text-nowrap">
        <a class="nav-link dropdown-toggle" href="#" id="dropdownlink-nav" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Documentation</a>
        <div class="dropdown-menu" aria-labelledby="dropdownlink-nav">
          <a class="dropdown-item" href="perl.html">Perl</a>
          <a class="dropdown-item" href="perlintro.html">Intro</a>
          <a class="dropdown-item" href="perl.html#Tutorials">Tutorials</a>
          <a class="dropdown-item" href="perlfaq.html">FAQs</a>
          <a class="dropdown-item" href="perl.html#Reference-Manual">Reference</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="perlop.html">Operators</a>
          <a class="dropdown-item" href="functions.html">Functions</a>
          <a class="dropdown-item" href="variables.html">Variables</a>
          <a class="dropdown-item" href="modules.html">Modules</a>
          <a class="dropdown-item" href="perlutil.html">Utilities</a>
          <hr class="dropdown-divider">
          <a class="dropdown-item" href="perldelta.html">Release Notes</a>
          <a class="dropdown-item" href="perlcommunity.html">Community</a>
          <a class="dropdown-item" href="perlhist.html">History</a>
        </div>
      </li>
    </ul>
    <ul class="navbar-nav">
      <button id="content-expand-button" type="button" class="btn btn-dark d-none d-lg-inline-block me-4">Expand</button>
      <script src="../js/perldoc-expand-page.js"></script>
    </ul>
    <form class="form-inline" method="get" action="https://perldoc.perl.org/5.6.0/search">
      <input id="search-input" class="form-control me-3" type="search" name="q" placeholder="[S]earch" aria-label="Search" value="">
    </form>
    <script src="../js/perldoc-focus-search.js"></script>
  </div>
</div></nav>

    <div id="wrapperlicious" class="container-fluid">
      <div id="perldocdiv">
        <div id="links">
          <a href="perlthrtut.html">perlthrtut</a>
          <div id="more">
            (<a href="https://perldoc.perl.org/5.6.0/perlthrtut.txt">source</a>,
            <a href="https://metacpan.org/pod/perlthrtut">CPAN</a>)
          </div>
        </div>
        <div class="leading-notice">
          You are viewing the version of this documentation from Perl 5.6.0.
            <a href="../perlthrtut.html">View the latest version</a>
        </div>
        <h1><a id="toc">CONTENTS</a></h1>
                  <ul>
              <li>
                <a class="text-decoration-none" href="#NAME">NAME</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#DESCRIPTION">DESCRIPTION</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#What-Is-A-Thread-Anyway?">What Is A Thread Anyway?</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Threaded-Program-Models">Threaded Program Models</a>
                            <ul>
              <li>
                <a class="text-decoration-none" href="#Boss/Worker">Boss/Worker</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Work-Crew">Work Crew</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Pipeline">Pipeline</a>
              </li>
          </ul>

              </li>
              <li>
                <a class="text-decoration-none" href="#Native-threads">Native threads</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#What-kind-of-threads-are-perl-threads?">What kind of threads are perl threads?</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Threadsafe-Modules">Threadsafe Modules</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Thread-Basics">Thread Basics</a>
                            <ul>
              <li>
                <a class="text-decoration-none" href="#Basic-Thread-Support">Basic Thread Support</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Creating-Threads">Creating Threads</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Giving-up-control">Giving up control</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Waiting-For-A-Thread-To-Exit">Waiting For A Thread To Exit</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Errors-In-Threads">Errors In Threads</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Ignoring-A-Thread">Ignoring A Thread</a>
              </li>
          </ul>

              </li>
              <li>
                <a class="text-decoration-none" href="#Threads-And-Data">Threads And Data</a>
                            <ul>
              <li>
                <a class="text-decoration-none" href="#Shared-And-Unshared-Data">Shared And Unshared Data</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Thread-Pitfall:-Races">Thread Pitfall: Races</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Controlling-access:-lock()">Controlling access: lock()</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Thread-Pitfall:-Deadlocks">Thread Pitfall: Deadlocks</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Queues:-Passing-Data-Around">Queues: Passing Data Around</a>
              </li>
          </ul>

              </li>
              <li>
                <a class="text-decoration-none" href="#Threads-And-Code">Threads And Code</a>
                            <ul>
              <li>
                <a class="text-decoration-none" href="#Semaphores:-Synchronizing-Data-Access">Semaphores: Synchronizing Data Access</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Attributes:-Restricting-Access-To-Subroutines">Attributes: Restricting Access To Subroutines</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Subroutine-Locks">Subroutine Locks</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Methods">Methods</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Locking-A-Subroutine">Locking A Subroutine</a>
              </li>
          </ul>

              </li>
              <li>
                <a class="text-decoration-none" href="#General-Thread-Utility-Routines">General Thread Utility Routines</a>
                            <ul>
              <li>
                <a class="text-decoration-none" href="#What-Thread-Am-I-In?">What Thread Am I In?</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Thread-IDs">Thread IDs</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Are-These-Threads-The-Same?">Are These Threads The Same?</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#What-Threads-Are-Running?">What Threads Are Running?</a>
              </li>
          </ul>

              </li>
              <li>
                <a class="text-decoration-none" href="#A-Complete-Example">A Complete Example</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Conclusion">Conclusion</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Bibliography">Bibliography</a>
                            <ul>
              <li>
                <a class="text-decoration-none" href="#Introductory-Texts">Introductory Texts</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#OS-Related-References">OS-Related References</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Other-References">Other References</a>
              </li>
          </ul>

              </li>
              <li>
                <a class="text-decoration-none" href="#Acknowledgements">Acknowledgements</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#AUTHOR">AUTHOR</a>
              </li>
              <li>
                <a class="text-decoration-none" href="#Copyrights">Copyrights</a>
              </li>
          </ul>

      <h1 id="NAME"><a class="permalink" href="#NAME">#</a>NAME</h1>

<p>perlthrtut - tutorial on threads in Perl</p>

<h1 id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">#</a>DESCRIPTION</h1>

<pre><code class="plaintext">WARNING: Threading is an experimental feature.  Both the interface
and implementation are subject to change drastically.  In fact, this
documentation describes the flavor of threads that was in version
5.005.  Perl 5.6.0 and later have the beginnings of support for
interpreter threads, which (when finished) is expected to be
significantly different from what is described here.  The information
contained here may therefore soon be obsolete.  Use at your own risk!</code></pre>

<p>One of the most prominent new features of Perl 5.005 is the inclusion of threads. Threads make a number of things a lot easier, and are a very useful addition to your bag of programming tricks.</p>

<h1 id="What-Is-A-Thread-Anyway?"><a class="permalink" href="#What-Is-A-Thread-Anyway?">#</a><a id="What"></a><a id="What-Is-A-Thread-Anyway"></a>What Is A Thread Anyway?</h1>

<p>A thread is a flow of control through a program with a single execution point.</p>

<p>Sounds an awful lot like a process, doesn&#39;t it? Well, it should. Threads are one of the pieces of a process. Every process has at least one thread and, up until now, every process running Perl had only one thread. With 5.005, though, you can create extra threads. We&#39;re going to show you how, when, and why.</p>

<h1 id="Threaded-Program-Models"><a class="permalink" href="#Threaded-Program-Models">#</a><a id="Threaded"></a>Threaded Program Models</h1>

<p>There are three basic ways that you can structure a threaded program. Which model you choose depends on what you need your program to do. For many non-trivial threaded programs you&#39;ll need to choose different models for different pieces of your program.</p>

<h2 id="Boss/Worker"><a class="permalink" href="#Boss/Worker">#</a><a id="Boss"></a><a id="Boss-Worker"></a>Boss/Worker</h2>

<p>The boss/worker model usually has one `boss&#39; thread and one or more `worker&#39; threads. The boss thread gathers or generates tasks that need to be done, then parcels those tasks out to the appropriate worker thread.</p>

<p>This model is common in GUI and server programs, where a main thread waits for some event and then passes that event to the appropriate worker threads for processing. Once the event has been passed on, the boss thread goes back to waiting for another event.</p>

<p>The boss thread does relatively little work. While tasks aren&#39;t necessarily performed faster than with any other method, it tends to have the best user-response times.</p>

<h2 id="Work-Crew"><a class="permalink" href="#Work-Crew">#</a><a id="Work"></a>Work Crew</h2>

<p>In the work crew model, several threads are created that do essentially the same thing to different pieces of data. It closely mirrors classical parallel processing and vector processors, where a large array of processors do the exact same thing to many pieces of data.</p>

<p>This model is particularly useful if the system running the program will distribute multiple threads across different processors. It can also be useful in ray tracing or rendering engines, where the individual threads can pass on interim results to give the user visual feedback.</p>

<h2 id="Pipeline"><a class="permalink" href="#Pipeline">#</a>Pipeline</h2>

<p>The pipeline model divides up a task into a series of steps, and passes the results of one step on to the thread processing the next. Each thread does one thing to each piece of data and passes the results to the next thread in line.</p>

<p>This model makes the most sense if you have multiple processors so two or more threads will be executing in parallel, though it can often make sense in other contexts as well. It tends to keep the individual tasks small and simple, as well as allowing some parts of the pipeline to block (on I/O or system calls, for example) while other parts keep going. If you&#39;re running different parts of the pipeline on different processors you may also take advantage of the caches on each processor.</p>

<p>This model is also handy for a form of recursive programming where, rather than having a subroutine call itself, it instead creates another thread. Prime and Fibonacci generators both map well to this form of the pipeline model. (A version of a prime number generator is presented later on.)</p>

<h1 id="Native-threads"><a class="permalink" href="#Native-threads">#</a><a id="Native"></a>Native threads</h1>

<p>There are several different ways to implement threads on a system. How threads are implemented depends both on the vendor and, in some cases, the version of the operating system. Often the first implementation will be relatively simple, but later versions of the OS will be more sophisticated.</p>

<p>While the information in this section is useful, it&#39;s not necessary, so you can skip it if you don&#39;t feel up to it.</p>

<p>There are three basic categories of threads-user-mode threads, kernel threads, and multiprocessor kernel threads.</p>

<p>User-mode threads are threads that live entirely within a program and its libraries. In this model, the OS knows nothing about threads. As far as it&#39;s concerned, your process is just a process.</p>

<p>This is the easiest way to implement threads, and the way most OSes start. The big disadvantage is that, since the OS knows nothing about threads, if one thread blocks they all do. Typical blocking activities include most system calls, most I/O, and things like sleep().</p>

<p>Kernel threads are the next step in thread evolution. The OS knows about kernel threads, and makes allowances for them. The main difference between a kernel thread and a user-mode thread is blocking. With kernel threads, things that block a single thread don&#39;t block other threads. This is not the case with user-mode threads, where the kernel blocks at the process level and not the thread level.</p>

<p>This is a big step forward, and can give a threaded program quite a performance boost over non-threaded programs. Threads that block performing I/O, for example, won&#39;t block threads that are doing other things. Each process still has only one thread running at once, though, regardless of how many CPUs a system might have.</p>

<p>Since kernel threading can interrupt a thread at any time, they will uncover some of the implicit locking assumptions you may make in your program. For example, something as simple as <code>$a = $a + 2</code> can behave unpredictably with kernel threads if $a is visible to other threads, as another thread may have changed $a between the time it was fetched on the right hand side and the time the new value is stored.</p>

<p>Multiprocessor Kernel Threads are the final step in thread support. With multiprocessor kernel threads on a machine with multiple CPUs, the OS may schedule two or more threads to run simultaneously on different CPUs.</p>

<p>This can give a serious performance boost to your threaded program, since more than one thread will be executing at the same time. As a tradeoff, though, any of those nagging synchronization issues that might not have shown with basic kernel threads will appear with a vengeance.</p>

<p>In addition to the different levels of OS involvement in threads, different OSes (and different thread implementations for a particular OS) allocate CPU cycles to threads in different ways.</p>

<p>Cooperative multitasking systems have running threads give up control if one of two things happen. If a thread calls a yield function, it gives up control. It also gives up control if the thread does something that would cause it to block, such as perform I/O. In a cooperative multitasking implementation, one thread can starve all the others for CPU time if it so chooses.</p>

<p>Preemptive multitasking systems interrupt threads at regular intervals while the system decides which thread should run next. In a preemptive multitasking system, one thread usually won&#39;t monopolize the CPU.</p>

<p>On some systems, there can be cooperative and preemptive threads running simultaneously. (Threads running with realtime priorities often behave cooperatively, for example, while threads running at normal priorities behave preemptively.)</p>

<h1 id="What-kind-of-threads-are-perl-threads?"><a class="permalink" href="#What-kind-of-threads-are-perl-threads?">#</a><a id="What1"></a><a id="What-kind-of-threads-are-perl-threads"></a>What kind of threads are perl threads?</h1>

<p>If you have experience with other thread implementations, you might find that things aren&#39;t quite what you expect. It&#39;s very important to remember when dealing with Perl threads that Perl Threads Are Not X Threads, for all values of X. They aren&#39;t POSIX threads, or DecThreads, or Java&#39;s Green threads, or Win32 threads. There are similarities, and the broad concepts are the same, but if you start looking for implementation details you&#39;re going to be either disappointed or confused. Possibly both.</p>

<p>This is not to say that Perl threads are completely different from everything that&#39;s ever come before--they&#39;re not. Perl&#39;s threading model owes a lot to other thread models, especially POSIX. Just as Perl is not C, though, Perl threads are not POSIX threads. So if you find yourself looking for mutexes, or thread priorities, it&#39;s time to step back a bit and think about what you want to do and how Perl can do it.</p>

<h1 id="Threadsafe-Modules"><a class="permalink" href="#Threadsafe-Modules">#</a><a id="Threadsafe"></a>Threadsafe Modules</h1>

<p>The addition of threads has changed Perl&#39;s internals substantially. There are implications for people who write modules--especially modules with XS code or external libraries. While most modules won&#39;t encounter any problems, modules that aren&#39;t explicitly tagged as thread-safe should be tested before being used in production code.</p>

<p>Not all modules that you might use are thread-safe, and you should always assume a module is unsafe unless the documentation says otherwise. This includes modules that are distributed as part of the core. Threads are a beta feature, and even some of the standard modules aren&#39;t thread-safe.</p>

<p>If you&#39;re using a module that&#39;s not thread-safe for some reason, you can protect yourself by using semaphores and lots of programming discipline to control access to the module. Semaphores are covered later in the article. Perl Threads Are Different</p>

<h1 id="Thread-Basics"><a class="permalink" href="#Thread-Basics">#</a><a id="Thread"></a>Thread Basics</h1>

<p>The core Thread module provides the basic functions you need to write threaded programs. In the following sections we&#39;ll cover the basics, showing you what you need to do to create a threaded program. After that, we&#39;ll go over some of the features of the Thread module that make threaded programming easier.</p>

<h2 id="Basic-Thread-Support"><a class="permalink" href="#Basic-Thread-Support">#</a><a id="Basic"></a>Basic Thread Support</h2>

<p>Thread support is a Perl compile-time option-it&#39;s something that&#39;s turned on or off when Perl is built at your site, rather than when your programs are compiled. If your Perl wasn&#39;t compiled with thread support enabled, then any attempt to use threads will fail.</p>

<p>Remember that the threading support in 5.005 is in beta release, and should be treated as such. You should expect that it may not function entirely properly, and the thread interface may well change some before it is a fully supported, production release. The beta version shouldn&#39;t be used for mission-critical projects. Having said that, threaded Perl is pretty nifty, and worth a look.</p>

<p>Your programs can use the Config module to check whether threads are enabled. If your program can&#39;t run without them, you can say something like:</p>

<pre><code>$Config{usethreads} or die &quot;Recompile Perl with threads to run this program.&quot;;</code></pre>

<p>A possibly-threaded program using a possibly-threaded module might have code like this:</p>

<pre><code>use Config; 
use MyMod; 

if ($Config{usethreads}) { 
    # We have threads 
    require MyMod_threaded; 
    import MyMod_threaded; 
} else { 
    require MyMod_unthreaded; 
    import MyMod_unthreaded; 
} </code></pre>

<p>Since code that runs both with and without threads is usually pretty messy, it&#39;s best to isolate the thread-specific code in its own module. In our example above, that&#39;s what MyMod_threaded is, and it&#39;s only imported if we&#39;re running on a threaded Perl.</p>

<h2 id="Creating-Threads"><a class="permalink" href="#Creating-Threads">#</a><a id="Creating"></a>Creating Threads</h2>

<p>The Thread package provides the tools you need to create new threads. Like any other module, you need to tell Perl you want to use it; use Thread imports all the pieces you need to create basic threads.</p>

<p>The simplest, straightforward way to create a thread is with new():</p>

<pre><code>use Thread; 

$thr = new Thread \&amp;sub1;

sub sub1 { 
    print &quot;In the thread\n&quot;; 
}</code></pre>

<p>The new() method takes a reference to a subroutine and creates a new thread, which starts executing in the referenced subroutine. Control then passes both to the subroutine and the caller.</p>

<p>If you need to, your program can pass parameters to the subroutine as part of the thread startup. Just include the list of parameters as part of the <code>Thread::new</code> call, like this:</p>

<pre><code>use Thread; 
$Param3 = &quot;foo&quot;; 
$thr = new Thread \&amp;sub1, &quot;Param 1&quot;, &quot;Param 2&quot;, $Param3; 
$thr = new Thread \&amp;sub1, @ParamList; 
$thr = new Thread \&amp;sub1, qw(Param1 Param2 $Param3);

sub sub1 { 
    my @InboundParameters = @_; 
    print &quot;In the thread\n&quot;; 
    print &quot;got parameters &gt;&quot;, join(&quot;&lt;&gt;&quot;, @InboundParameters), &quot;&lt;\n&quot;; 
}</code></pre>

<p>The subroutine runs like a normal Perl subroutine, and the call to new Thread returns whatever the subroutine returns.</p>

<p>The last example illustrates another feature of threads. You can spawn off several threads using the same subroutine. Each thread executes the same subroutine, but in a separate thread with a separate environment and potentially separate arguments.</p>

<p>The other way to spawn a new thread is with async(), which is a way to spin off a chunk of code like eval(), but into its own thread:</p>

<pre><code>use Thread qw(async);

$LineCount = 0; 

$thr = async { 
    while(&lt;&gt;) {$LineCount++} 	 
    print &quot;Got $LineCount lines\n&quot;;
}; 

print &quot;Waiting for the linecount to end\n&quot;; 
$thr-&gt;join; 
print &quot;All done\n&quot;;</code></pre>

<p>You&#39;ll notice we did a use Thread qw(async) in that example. async is not exported by default, so if you want it, you&#39;ll either need to import it before you use it or fully qualify it as Thread::async. You&#39;ll also note that there&#39;s a semicolon after the closing brace. That&#39;s because async() treats the following block as an anonymous subroutine, so the semicolon is necessary.</p>

<p>Like eval(), the code executes in the same context as it would if it weren&#39;t spun off. Since both the code inside and after the async start executing, you need to be careful with any shared resources. Locking and other synchronization techniques are covered later.</p>

<h2 id="Giving-up-control"><a class="permalink" href="#Giving-up-control">#</a><a id="Giving"></a>Giving up control</h2>

<p>There are times when you may find it useful to have a thread explicitly give up the CPU to another thread. Your threading package might not support preemptive multitasking for threads, for example, or you may be doing something compute-intensive and want to make sure that the user-interface thread gets called frequently. Regardless, there are times that you might want a thread to give up the processor.</p>

<p>Perl&#39;s threading package provides the yield() function that does this. yield() is pretty straightforward, and works like this:</p>

<pre><code>use Thread qw(yield async); 
async { 
    my $foo = 50; 
    while ($foo--) { print &quot;first async\n&quot; }
    yield; 
    $foo = 50; 
    while ($foo--) { print &quot;first async\n&quot; } 
}; 
async { 
    my $foo = 50; 
    while ($foo--) { print &quot;second async\n&quot; }
    yield; 
    $foo = 50; 
    while ($foo--) { print &quot;second async\n&quot; } 
};</code></pre>

<h2 id="Waiting-For-A-Thread-To-Exit"><a class="permalink" href="#Waiting-For-A-Thread-To-Exit">#</a><a id="Waiting"></a>Waiting For A Thread To Exit</h2>

<p>Since threads are also subroutines, they can return values. To wait for a thread to exit and extract any scalars it might return, you can use the join() method.</p>

<pre><code>use Thread; 
$thr = new Thread \&amp;sub1;

@ReturnData = $thr-&gt;join; 
print &quot;Thread returned @ReturnData&quot;; 

sub sub1 { return &quot;Fifty-six&quot;, &quot;foo&quot;, 2; }</code></pre>

<p>In the example above, the join() method returns as soon as the thread ends. In addition to waiting for a thread to finish and gathering up any values that the thread might have returned, join() also performs any OS cleanup necessary for the thread. That cleanup might be important, especially for long-running programs that spawn lots of threads. If you don&#39;t want the return values and don&#39;t want to wait for the thread to finish, you should call the detach() method instead. detach() is covered later in the article.</p>

<h2 id="Errors-In-Threads"><a class="permalink" href="#Errors-In-Threads">#</a><a id="Errors"></a>Errors In Threads</h2>

<p>So what happens when an error occurs in a thread? Any errors that could be caught with eval() are postponed until the thread is joined. If your program never joins, the errors appear when your program exits.</p>

<p>Errors deferred until a join() can be caught with eval():</p>

<pre><code>use Thread qw(async); 
$thr = async {$b = 3/0};   # Divide by zero error
$foo = eval {$thr-&gt;join}; 
if ($@) { 
    print &quot;died with error $@\n&quot;; 
} else { 
    print &quot;Hey, why aren&#39;t you dead?\n&quot;; 
}</code></pre>

<p>eval() passes any results from the joined thread back unmodified, so if you want the return value of the thread, this is your only chance to get them.</p>

<h2 id="Ignoring-A-Thread"><a class="permalink" href="#Ignoring-A-Thread">#</a><a id="Ignoring"></a>Ignoring A Thread</h2>

<p>join() does three things: it waits for a thread to exit, cleans up after it, and returns any data the thread may have produced. But what if you&#39;re not interested in the thread&#39;s return values, and you don&#39;t really care when the thread finishes? All you want is for the thread to get cleaned up after when it&#39;s done.</p>

<p>In this case, you use the detach() method. Once a thread is detached, it&#39;ll run until it&#39;s finished, then Perl will clean up after it automatically.</p>

<pre><code>use Thread; 
$thr = new Thread \&amp;sub1; # Spawn the thread

$thr-&gt;detach; # Now we officially don&#39;t care any more

sub sub1 { 
    $a = 0; 
    while (1) { 
        $a++; 
        print &quot;\$a is $a\n&quot;; 
        sleep 1; 
    } 
}</code></pre>

<p>Once a thread is detached, it may not be joined, and any output that it might have produced (if it was done and waiting for a join) is lost.</p>

<h1 id="Threads-And-Data"><a class="permalink" href="#Threads-And-Data">#</a><a id="Threads"></a>Threads And Data</h1>

<p>Now that we&#39;ve covered the basics of threads, it&#39;s time for our next topic: data. Threading introduces a couple of complications to data access that non-threaded programs never need to worry about.</p>

<h2 id="Shared-And-Unshared-Data"><a class="permalink" href="#Shared-And-Unshared-Data">#</a><a id="Shared"></a>Shared And Unshared Data</h2>

<p>The single most important thing to remember when using threads is that all threads potentially have access to all the data anywhere in your program. While this is true with a nonthreaded Perl program as well, it&#39;s especially important to remember with a threaded program, since more than one thread can be accessing this data at once.</p>

<p>Perl&#39;s scoping rules don&#39;t change because you&#39;re using threads. If a subroutine (or block, in the case of async()) could see a variable if you weren&#39;t running with threads, it can see it if you are. This is especially important for the subroutines that create, and makes <code>my</code> variables even more important. Remember--if your variables aren&#39;t lexically scoped (declared with <code>my</code>) you&#39;re probably sharing them between threads.</p>

<h2 id="Thread-Pitfall:-Races"><a class="permalink" href="#Thread-Pitfall:-Races">#</a><a id="Thread1"></a>Thread Pitfall: Races</h2>

<p>While threads bring a new set of useful tools, they also bring a number of pitfalls. One pitfall is the race condition:</p>

<pre><code>use Thread; 
$a = 1; 
$thr1 = Thread-&gt;new(\&amp;sub1); 
$thr2 = Thread-&gt;new(\&amp;sub2); 

sleep 10; 
print &quot;$a\n&quot;;

sub sub1 { $foo = $a; $a = $foo + 1; }
sub sub2 { $bar = $a; $a = $bar + 1; }</code></pre>

<p>What do you think $a will be? The answer, unfortunately, is &quot;it depends.&quot; Both sub1() and sub2() access the global variable $a, once to read and once to write. Depending on factors ranging from your thread implementation&#39;s scheduling algorithm to the phase of the moon, $a can be 2 or 3.</p>

<p>Race conditions are caused by unsynchronized access to shared data. Without explicit synchronization, there&#39;s no way to be sure that nothing has happened to the shared data between the time you access it and the time you update it. Even this simple code fragment has the possibility of error:</p>

<pre><code>use Thread qw(async); 
$a = 2; 
async{ $b = $a; $a = $b + 1; }; 
async{ $c = $a; $a = $c + 1; };</code></pre>

<p>Two threads both access $a. Each thread can potentially be interrupted at any point, or be executed in any order. At the end, $a could be 3 or 4, and both $b and $c could be 2 or 3.</p>

<p>Whenever your program accesses data or resources that can be accessed by other threads, you must take steps to coordinate access or risk data corruption and race conditions.</p>

<h2 id="Controlling-access:-lock()"><a class="permalink" href="#Controlling-access:-lock()">#</a><a id="Controlling"></a><a id="Controlling-access:-lock"></a>Controlling access: lock()</h2>

<p>The lock() function takes a variable (or subroutine, but we&#39;ll get to that later) and puts a lock on it. No other thread may lock the variable until the locking thread exits the innermost block containing the lock. Using lock() is straightforward:</p>

<pre><code>use Thread qw(async); 
$a = 4; 
$thr1 = async { 
    $foo = 12; 
    { 
        lock ($a); # Block until we get access to $a 
        $b = $a; 
        $a = $b * $foo; 
    } 
    print &quot;\$foo was $foo\n&quot;;
}; 
$thr2 = async { 
    $bar = 7; 
    { 
        lock ($a); # Block until we can get access to $a
        $c = $a; 
        $a = $c * $bar; 
    } 
    print &quot;\$bar was $bar\n&quot;;
}; 
$thr1-&gt;join; 
$thr2-&gt;join; 
print &quot;\$a is $a\n&quot;;</code></pre>

<p>lock() blocks the thread until the variable being locked is available. When lock() returns, your thread can be sure that no other thread can lock that variable until the innermost block containing the lock exits.</p>

<p>It&#39;s important to note that locks don&#39;t prevent access to the variable in question, only lock attempts. This is in keeping with Perl&#39;s longstanding tradition of courteous programming, and the advisory file locking that flock() gives you. Locked subroutines behave differently, however. We&#39;ll cover that later in the article.</p>

<p>You may lock arrays and hashes as well as scalars. Locking an array, though, will not block subsequent locks on array elements, just lock attempts on the array itself.</p>

<p>Finally, locks are recursive, which means it&#39;s okay for a thread to lock a variable more than once. The lock will last until the outermost lock() on the variable goes out of scope.</p>

<h2 id="Thread-Pitfall:-Deadlocks"><a class="permalink" href="#Thread-Pitfall:-Deadlocks">#</a><a id="Thread2"></a>Thread Pitfall: Deadlocks</h2>

<p>Locks are a handy tool to synchronize access to data. Using them properly is the key to safe shared data. Unfortunately, locks aren&#39;t without their dangers. Consider the following code:</p>

<pre><code>use Thread qw(async yield); 
$a = 4; 
$b = &quot;foo&quot;; 
async { 
    lock($a); 
    yield; 
    sleep 20; 
    lock ($b); 
}; 
async { 
    lock($b); 
    yield; 
    sleep 20; 
    lock ($a); 
};</code></pre>

<p>This program will probably hang until you kill it. The only way it won&#39;t hang is if one of the two async() routines acquires both locks first. A guaranteed-to-hang version is more complicated, but the principle is the same.</p>

<p>The first thread spawned by async() will grab a lock on $a then, a second or two later, try to grab a lock on $b. Meanwhile, the second thread grabs a lock on $b, then later tries to grab a lock on $a. The second lock attempt for both threads will block, each waiting for the other to release its lock.</p>

<p>This condition is called a deadlock, and it occurs whenever two or more threads are trying to get locks on resources that the others own. Each thread will block, waiting for the other to release a lock on a resource. That never happens, though, since the thread with the resource is itself waiting for a lock to be released.</p>

<p>There are a number of ways to handle this sort of problem. The best way is to always have all threads acquire locks in the exact same order. If, for example, you lock variables $a, $b, and $c, always lock $a before $b, and $b before $c. It&#39;s also best to hold on to locks for as short a period of time to minimize the risks of deadlock.</p>

<h2 id="Queues:-Passing-Data-Around"><a class="permalink" href="#Queues:-Passing-Data-Around">#</a><a id="Queues"></a>Queues: Passing Data Around</h2>

<p>A queue is a special thread-safe object that lets you put data in one end and take it out the other without having to worry about synchronization issues. They&#39;re pretty straightforward, and look like this:</p>

<pre><code>use Thread qw(async); 
use Thread::Queue;

my $DataQueue = new Thread::Queue; 
$thr = async { 
    while ($DataElement = $DataQueue-&gt;dequeue) { 
        print &quot;Popped $DataElement off the queue\n&quot;;
    } 
}; 

$DataQueue-&gt;enqueue(12); 
$DataQueue-&gt;enqueue(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;); 
$DataQueue-&gt;enqueue(\$thr); 
sleep 10; 
$DataQueue-&gt;enqueue(undef);</code></pre>

<p>You create the queue with new Thread::Queue. Then you can add lists of scalars onto the end with enqueue(), and pop scalars off the front of it with dequeue(). A queue has no fixed size, and can grow as needed to hold everything pushed on to it.</p>

<p>If a queue is empty, dequeue() blocks until another thread enqueues something. This makes queues ideal for event loops and other communications between threads.</p>

<h1 id="Threads-And-Code"><a class="permalink" href="#Threads-And-Code">#</a><a id="Threads1"></a>Threads And Code</h1>

<p>In addition to providing thread-safe access to data via locks and queues, threaded Perl also provides general-purpose semaphores for coarser synchronization than locks provide and thread-safe access to entire subroutines.</p>

<h2 id="Semaphores:-Synchronizing-Data-Access"><a class="permalink" href="#Semaphores:-Synchronizing-Data-Access">#</a><a id="Semaphores"></a>Semaphores: Synchronizing Data Access</h2>

<p>Semaphores are a kind of generic locking mechanism. Unlike lock, which gets a lock on a particular scalar, Perl doesn&#39;t associate any particular thing with a semaphore so you can use them to control access to anything you like. In addition, semaphores can allow more than one thread to access a resource at once, though by default semaphores only allow one thread access at a time.</p>

<dl>

<dt id="Basic-semaphores"><a class="permalink" href="#Basic-semaphores">#</a><a id="Basic1"></a>Basic semaphores</dt>
<dd>

<p>Semaphores have two methods, down and up. down decrements the resource count, while up increments it. down calls will block if the semaphore&#39;s current count would decrement below zero. This program gives a quick demonstration:</p>

<pre><code>use Thread qw(yield); 
use Thread::Semaphore; 
my $semaphore = new Thread::Semaphore; 
$GlobalVariable = 0;

$thr1 = new Thread \&amp;sample_sub, 1; 
$thr2 = new Thread \&amp;sample_sub, 2; 
$thr3 = new Thread \&amp;sample_sub, 3;

sub sample_sub { 
    my $SubNumber = shift @_; 
    my $TryCount = 10; 
    my $LocalCopy; 
    sleep 1; 
    while ($TryCount--) { 
        $semaphore-&gt;down; 
        $LocalCopy = $GlobalVariable; 
        print &quot;$TryCount tries left for sub $SubNumber (\$GlobalVariable is $GlobalVariable)\n&quot;; 
        yield; 
        sleep 2; 
        $LocalCopy++; 
        $GlobalVariable = $LocalCopy; 
        $semaphore-&gt;up; 
    } 
}</code></pre>

<p>The three invocations of the subroutine all operate in sync. The semaphore, though, makes sure that only one thread is accessing the global variable at once.</p>

</dd>
<dt id="Advanced-Semaphores"><a class="permalink" href="#Advanced-Semaphores">#</a><a id="Advanced"></a>Advanced Semaphores</dt>
<dd>

<p>By default, semaphores behave like locks, letting only one thread down() them at a time. However, there are other uses for semaphores.</p>

<p>Each semaphore has a counter attached to it. down() decrements the counter and up() increments the counter. By default, semaphores are created with the counter set to one, down() decrements by one, and up() increments by one. If down() attempts to decrement the counter below zero, it blocks until the counter is large enough. Note that while a semaphore can be created with a starting count of zero, any up() or down() always changes the counter by at least one. $semaphore-&gt;down(0) is the same as $semaphore-&gt;down(1).</p>

<p>The question, of course, is why would you do something like this? Why create a semaphore with a starting count that&#39;s not one, or why decrement/increment it by more than one? The answer is resource availability. Many resources that you want to manage access for can be safely used by more than one thread at once.</p>

<p>For example, let&#39;s take a GUI driven program. It has a semaphore that it uses to synchronize access to the display, so only one thread is ever drawing at once. Handy, but of course you don&#39;t want any thread to start drawing until things are properly set up. In this case, you can create a semaphore with a counter set to zero, and up it when things are ready for drawing.</p>

<p>Semaphores with counters greater than one are also useful for establishing quotas. Say, for example, that you have a number of threads that can do I/O at once. You don&#39;t want all the threads reading or writing at once though, since that can potentially swamp your I/O channels, or deplete your process&#39; quota of filehandles. You can use a semaphore initialized to the number of concurrent I/O requests (or open files) that you want at any one time, and have your threads quietly block and unblock themselves.</p>

<p>Larger increments or decrements are handy in those cases where a thread needs to check out or return a number of resources at once.</p>

</dd>
</dl>

<h2 id="Attributes:-Restricting-Access-To-Subroutines"><a class="permalink" href="#Attributes:-Restricting-Access-To-Subroutines">#</a><a id="Attributes"></a>Attributes: Restricting Access To Subroutines</h2>

<p>In addition to synchronizing access to data or resources, you might find it useful to synchronize access to subroutines. You may be accessing a singular machine resource (perhaps a vector processor), or find it easier to serialize calls to a particular subroutine than to have a set of locks and sempahores.</p>

<p>One of the additions to Perl 5.005 is subroutine attributes. The Thread package uses these to provide several flavors of serialization. It&#39;s important to remember that these attributes are used in the compilation phase of your program so you can&#39;t change a subroutine&#39;s behavior while your program is actually running.</p>

<h2 id="Subroutine-Locks"><a class="permalink" href="#Subroutine-Locks">#</a><a id="Subroutine"></a>Subroutine Locks</h2>

<p>The basic subroutine lock looks like this:</p>

<pre><code>sub test_sub :locked { 
}</code></pre>

<p>This ensures that only one thread will be executing this subroutine at any one time. Once a thread calls this subroutine, any other thread that calls it will block until the thread in the subroutine exits it. A more elaborate example looks like this:</p>

<pre><code>use Thread qw(yield); 

new Thread \&amp;thread_sub, 1; 
new Thread \&amp;thread_sub, 2; 
new Thread \&amp;thread_sub, 3; 
new Thread \&amp;thread_sub, 4;

sub sync_sub :locked { 
    my $CallingThread = shift @_; 
    print &quot;In sync_sub for thread $CallingThread\n&quot;;
    yield; 
    sleep 3; 
    print &quot;Leaving sync_sub for thread $CallingThread\n&quot;; 
}

sub thread_sub { 
    my $ThreadID = shift @_; 
    print &quot;Thread $ThreadID calling sync_sub\n&quot;;
    sync_sub($ThreadID); 
    print &quot;$ThreadID is done with sync_sub\n&quot;; 
}</code></pre>

<p>The <code>locked</code> attribute tells perl to lock sync_sub(), and if you run this, you can see that only one thread is in it at any one time.</p>

<h2 id="Methods"><a class="permalink" href="#Methods">#</a>Methods</h2>

<p>Locking an entire subroutine can sometimes be overkill, especially when dealing with Perl objects. When calling a method for an object, for example, you want to serialize calls to a method, so that only one thread will be in the subroutine for a particular object, but threads calling that subroutine for a different object aren&#39;t blocked. The method attribute indicates whether the subroutine is really a method.</p>

<pre><code>use Thread;

sub tester { 
    my $thrnum = shift @_; 
    my $bar = new Foo; 
    foreach (1..10) { 	
        print &quot;$thrnum calling per_object\n&quot;; 
        $bar-&gt;per_object($thrnum); 	
        print &quot;$thrnum out of per_object\n&quot;; 
        yield; 
        print &quot;$thrnum calling one_at_a_time\n&quot;;
        $bar-&gt;one_at_a_time($thrnum); 	
        print &quot;$thrnum out of one_at_a_time\n&quot;; 
        yield; 
    } 
}

foreach my $thrnum (1..10) { 
    new Thread \&amp;tester, $thrnum; 
}

package Foo; 
sub new { 
    my $class = shift @_; 
    return bless [@_], $class; 
}

sub per_object :locked :method { 
    my ($class, $thrnum) = @_; 
    print &quot;In per_object for thread $thrnum\n&quot;; 
    yield; 
    sleep 2; 
    print &quot;Exiting per_object for thread $thrnum\n&quot;; 
}

sub one_at_a_time :locked { 
    my ($class, $thrnum) = @_; 
    print &quot;In one_at_a_time for thread $thrnum\n&quot;;     
    yield; 
    sleep 2; 
    print &quot;Exiting one_at_a_time for thread $thrnum\n&quot;; 
}</code></pre>

<p>As you can see from the output (omitted for brevity; it&#39;s 800 lines) all the threads can be in per_object() simultaneously, but only one thread is ever in one_at_a_time() at once.</p>

<h2 id="Locking-A-Subroutine"><a class="permalink" href="#Locking-A-Subroutine">#</a><a id="Locking"></a>Locking A Subroutine</h2>

<p>You can lock a subroutine as you would lock a variable. Subroutine locks work the same as specifying a <code>locked</code> attribute for the subroutine, and block all access to the subroutine for other threads until the lock goes out of scope. When the subroutine isn&#39;t locked, any number of threads can be in it at once, and getting a lock on a subroutine doesn&#39;t affect threads already in the subroutine. Getting a lock on a subroutine looks like this:</p>

<pre><code>lock(\&amp;sub_to_lock);</code></pre>

<p>Simple enough. Unlike the <code>locked</code> attribute, which is a compile time option, locking and unlocking a subroutine can be done at runtime at your discretion. There is some runtime penalty to using lock(\&amp;sub) instead of the <code>locked</code> attribute, so make sure you&#39;re choosing the proper method to do the locking.</p>

<p>You&#39;d choose lock(\&amp;sub) when writing modules and code to run on both threaded and unthreaded Perl, especially for code that will run on 5.004 or earlier Perls. In that case, it&#39;s useful to have subroutines that should be serialized lock themselves if they&#39;re running threaded, like so:</p>

<pre><code>package Foo; 
use Config; 
$Running_Threaded = 0;

BEGIN { $Running_Threaded = $Config{&#39;usethreads&#39;} }

sub sub1 { lock(\&amp;sub1) if $Running_Threaded }</code></pre>

<p>This way you can ensure single-threadedness regardless of which version of Perl you&#39;re running.</p>

<h1 id="General-Thread-Utility-Routines"><a class="permalink" href="#General-Thread-Utility-Routines">#</a><a id="General"></a>General Thread Utility Routines</h1>

<p>We&#39;ve covered the workhorse parts of Perl&#39;s threading package, and with these tools you should be well on your way to writing threaded code and packages. There are a few useful little pieces that didn&#39;t really fit in anyplace else.</p>

<h2 id="What-Thread-Am-I-In?"><a class="permalink" href="#What-Thread-Am-I-In?">#</a><a id="What2"></a><a id="What-Thread-Am-I-In"></a>What Thread Am I In?</h2>

<p>The Thread-&gt;self method provides your program with a way to get an object representing the thread it&#39;s currently in. You can use this object in the same way as the ones returned from the thread creation.</p>

<h2 id="Thread-IDs"><a class="permalink" href="#Thread-IDs">#</a><a id="Thread3"></a>Thread IDs</h2>

<p>tid() is a thread object method that returns the thread ID of the thread the object represents. Thread IDs are integers, with the main thread in a program being 0. Currently Perl assigns a unique tid to every thread ever created in your program, assigning the first thread to be created a tid of 1, and increasing the tid by 1 for each new thread that&#39;s created.</p>

<h2 id="Are-These-Threads-The-Same?"><a class="permalink" href="#Are-These-Threads-The-Same?">#</a><a id="Are"></a><a id="Are-These-Threads-The-Same"></a>Are These Threads The Same?</h2>

<p>The equal() method takes two thread objects and returns true if the objects represent the same thread, and false if they don&#39;t.</p>

<h2 id="What-Threads-Are-Running?"><a class="permalink" href="#What-Threads-Are-Running?">#</a><a id="What3"></a><a id="What-Threads-Are-Running"></a>What Threads Are Running?</h2>

<p>Thread-&gt;list returns a list of thread objects, one for each thread that&#39;s currently running. Handy for a number of things, including cleaning up at the end of your program:</p>

<pre><code># Loop through all the threads 
foreach $thr (Thread-&gt;list) { 
    # Don&#39;t join the main thread or ourselves 
    if ($thr-&gt;tid &amp;&amp; !Thread::equal($thr, Thread-&gt;self)) { 
        $thr-&gt;join; 
    } 
}</code></pre>

<p>The example above is just for illustration. It isn&#39;t strictly necessary to join all the threads you create, since Perl detaches all the threads before it exits.</p>

<h1 id="A-Complete-Example"><a class="permalink" href="#A-Complete-Example">#</a><a id="A"></a>A Complete Example</h1>

<p>Confused yet? It&#39;s time for an example program to show some of the things we&#39;ve covered. This program finds prime numbers using threads.</p>

<pre><code>1  #!/usr/bin/perl -w
2  # prime-pthread, courtesy of Tom Christiansen
3
4  use strict;
5
6  use Thread;
7  use Thread::Queue;
8
9  my $stream = new Thread::Queue;
10 my $kid    = new Thread(\&amp;check_num, $stream, 2);
11
12 for my $i ( 3 .. 1000 ) {
13     $stream-&gt;enqueue($i);
14 } 
15
16 $stream-&gt;enqueue(undef);
17 $kid-&gt;join();
18
19 sub check_num {
20     my ($upstream, $cur_prime) = @_;
21     my $kid;
22     my $downstream = new Thread::Queue;
23     while (my $num = $upstream-&gt;dequeue) {
24         next unless $num % $cur_prime;
25         if ($kid) {
26            $downstream-&gt;enqueue($num);
27          	} else {
28            print &quot;Found prime $num\n&quot;;
29	              $kid = new Thread(\&amp;check_num, $downstream, $num);
30         }
31     } 
32     $downstream-&gt;enqueue(undef) if $kid;
33     $kid-&gt;join()		if $kid;
34 }</code></pre>

<p>This program uses the pipeline model to generate prime numbers. Each thread in the pipeline has an input queue that feeds numbers to be checked, a prime number that it&#39;s responsible for, and an output queue that it funnels numbers that have failed the check into. If the thread has a number that&#39;s failed its check and there&#39;s no child thread, then the thread must have found a new prime number. In that case, a new child thread is created for that prime and stuck on the end of the pipeline.</p>

<p>This probably sounds a bit more confusing than it really is, so lets go through this program piece by piece and see what it does. (For those of you who might be trying to remember exactly what a prime number is, it&#39;s a number that&#39;s only evenly divisible by itself and 1)</p>

<p>The bulk of the work is done by the check_num() subroutine, which takes a reference to its input queue and a prime number that it&#39;s responsible for. After pulling in the input queue and the prime that the subroutine&#39;s checking (line 20), we create a new queue (line 22) and reserve a scalar for the thread that we&#39;re likely to create later (line 21).</p>

<p>The while loop from lines 23 to line 31 grabs a scalar off the input queue and checks against the prime this thread is responsible for. Line 24 checks to see if there&#39;s a remainder when we modulo the number to be checked against our prime. If there is one, the number must not be evenly divisible by our prime, so we need to either pass it on to the next thread if we&#39;ve created one (line 26) or create a new thread if we haven&#39;t.</p>

<p>The new thread creation is line 29. We pass on to it a reference to the queue we&#39;ve created, and the prime number we&#39;ve found.</p>

<p>Finally, once the loop terminates (because we got a 0 or undef in the queue, which serves as a note to die), we pass on the notice to our child and wait for it to exit if we&#39;ve created a child (Lines 32 and 37).</p>

<p>Meanwhile, back in the main thread, we create a queue (line 9) and the initial child thread (line 10), and pre-seed it with the first prime: 2. Then we queue all the numbers from 3 to 1000 for checking (lines 12-14), then queue a die notice (line 16) and wait for the first child thread to terminate (line 17). Because a child won&#39;t die until its child has died, we know that we&#39;re done once we return from the join.</p>

<p>That&#39;s how it works. It&#39;s pretty simple; as with many Perl programs, the explanation is much longer than the program.</p>

<h1 id="Conclusion"><a class="permalink" href="#Conclusion">#</a>Conclusion</h1>

<p>A complete thread tutorial could fill a book (and has, many times), but this should get you well on your way. The final authority on how Perl&#39;s threads behave is the documention bundled with the Perl distribution, but with what we&#39;ve covered in this article, you should be well on your way to becoming a threaded Perl expert.</p>

<h1 id="Bibliography"><a class="permalink" href="#Bibliography">#</a>Bibliography</h1>

<p>Here&#39;s a short bibliography courtesy of Jürgen Christoffel:</p>

<h2 id="Introductory-Texts"><a class="permalink" href="#Introductory-Texts">#</a><a id="Introductory"></a>Introductory Texts</h2>

<p>Birrell, Andrew D. An Introduction to Programming with Threads. Digital Equipment Corporation, 1989, DEC-SRC Research Report #35 online as http://www.research.digital.com/SRC/staff/birrell/bib.html (highly recommended)</p>

<p>Robbins, Kay. A., and Steven Robbins. Practical Unix Programming: A Guide to Concurrency, Communication, and Multithreading. Prentice-Hall, 1996.</p>

<p>Lewis, Bill, and Daniel J. Berg. Multithreaded Programming with Pthreads. Prentice Hall, 1997, ISBN 0-13-443698-9 (a well-written introduction to threads).</p>

<p>Nelson, Greg (editor). Systems Programming with Modula-3. Prentice Hall, 1991, ISBN 0-13-590464-1.</p>

<p>Nichols, Bradford, Dick Buttlar, and Jacqueline Proulx Farrell. Pthreads Programming. O&#39;Reilly &amp; Associates, 1996, ISBN 156592-115-1 (covers POSIX threads).</p>

<h2 id="OS-Related-References"><a class="permalink" href="#OS-Related-References">#</a><a id="OS"></a>OS-Related References</h2>

<p>Boykin, Joseph, David Kirschen, Alan Langerman, and Susan LoVerso. Programming under Mach. Addison-Wesley, 1994, ISBN 0-201-52739-1.</p>

<p>Tanenbaum, Andrew S. Distributed Operating Systems. Prentice Hall, 1995, ISBN 0-13-143934-0 (great textbook).</p>

<p>Silberschatz, Abraham, and Peter B. Galvin. Operating System Concepts, 4th ed. Addison-Wesley, 1995, ISBN 0-201-59292-4</p>

<h2 id="Other-References"><a class="permalink" href="#Other-References">#</a><a id="Other"></a>Other References</h2>

<p>Arnold, Ken and James Gosling. The Java Programming Language, 2nd ed. Addison-Wesley, 1998, ISBN 0-201-31006-6.</p>

<p>Le Sergent, T. and B. Berthomieu. &quot;Incremental MultiThreaded Garbage Collection on Virtually Shared Memory Architectures&quot; in Memory Management: Proc. of the International Workshop IWMM 92, St. Malo, France, September 1992, Yves Bekkers and Jacques Cohen, eds. Springer, 1992, ISBN 3540-55940-X (real-life thread applications).</p>

<h1 id="Acknowledgements"><a class="permalink" href="#Acknowledgements">#</a>Acknowledgements</h1>

<p>Thanks (in no particular order) to Chaim Frenkel, Steve Fink, Gurusamy Sarathy, Ilya Zakharevich, Benjamin Sugars, Jürgen Christoffel, Joshua Pritikin, and Alan Burlison, for their help in reality-checking and polishing this article. Big thanks to Tom Christiansen for his rewrite of the prime number generator.</p>

<h1 id="AUTHOR"><a class="permalink" href="#AUTHOR">#</a>AUTHOR</h1>

<p>Dan Sugalski &lt;sugalskd@ous.edu&gt;</p>

<h1 id="Copyrights"><a class="permalink" href="#Copyrights">#</a>Copyrights</h1>

<p>This article originally appeared in The Perl Journal #10, and is copyright 1998 The Perl Journal. It appears courtesy of Jon Orwant and The Perl Journal. This document may be distributed under the same terms as Perl itself.</p>

<div class="pod-errors"><p>1 POD Error</p><div class="pod-errors-detail"><p>The following errors were encountered while parsing the POD:</p><dl><dt><a class="permalink" href="#">#</a>Around line 1000:</dt><dd><p>Non-ASCII character seen before =encoding in &#39;Jürgen&#39;. Assuming CP1252</p></dd></dl></div></div>


      </div>
      <div id="footer">
        <p>Perldoc Browser is maintained by Dan Book (<a href="https://metacpan.org/author/DBOOK">DBOOK</a>). Please contact him via the <a href="https://github.com/Grinnz/perldoc-browser/issues">GitHub issue tracker</a> or <a href="mailto:dbook@cpan.org">email</a> regarding any issues with the site itself, search, or rendering of documentation.</p>

<p>The Perl documentation is maintained by the Perl 5 Porters in the development of Perl. Please contact them via the <a href="https://github.com/Perl/perl5/issues">Perl issue tracker</a>, the <a href="https://lists.perl.org/list/perl5-porters.html">mailing list</a>, or <a href="https://kiwiirc.com/client/irc.perl.org/p5p">IRC</a> to report any issues with the contents or format of the documentation.</p>


      </div>
    </div>
    <script src="../js/bootstrap.bundle.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.highlightAll();</script>
  </body>

<!-- Mirrored from perldoc.perl.org/5.6.0/perlthrtut by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 06 Aug 2025 16:20:46 GMT -->
</html>
