 <!DOCTYPE html>
		<html
			class="layout layout-holy-grail   show-table-of-contents conceptual show-breadcrumb default-focus"
			lang="en-us"
			dir="ltr"
			data-authenticated="false"
			data-auth-status-determined="false"
			data-target="docs"
			x-ms-format-detection="none"
		>
			
		
<!-- Mirrored from learn.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-9.0 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 06 Aug 2025 14:53:03 GMT -->
<head>
			<title>Integration tests in ASP.NET Core | Microsoft Learn</title>
			<meta charset="utf-8" />
			<meta name="viewport" content="width=device-width, initial-scale=1.0" />
			<meta name="color-scheme" content="light dark" />

			<meta name="description" content="Learn how integration tests ensure that an app&#39;s components function correctly at the infrastructure level, including the database, file system, and network." />
			<link rel="canonical" href="integration-tests553c.html?view=aspnetcore-9.0" /> 

			<!-- Non-customizable open graph and sharing-related metadata -->
			<meta name="twitter:card" content="summary" />
			<meta name="twitter:site" content="@MicrosoftLearn" />
			<meta property="og:type" content="website" />
			<meta property="og:image:alt" content="Integration tests in ASP.NET Core | Microsoft Learn" />
			<meta property="og:image" content="https://learn.microsoft.com/dotnet/media/dotnet-logo.png" />
			<!-- Page specific open graph and sharing-related metadata -->
			<meta property="og:title" content="Integration tests in ASP.NET Core" />
			<meta property="og:url" content="integration-tests553c.html?view=aspnetcore-9.0" />
			<meta property="og:description" content="Learn how integration tests ensure that an app&#39;s components function correctly at the infrastructure level, including the database, file system, and network." />
			<meta name="platform_id" content="a725fe2a-b11f-6664-eb77-2adc94d55792" /> <meta name="scope" content="ASP.NET Core" />
			<meta name="locale" content="en-us" />
			 <meta name="adobe-target" content="true" />
			<meta name="uhfHeaderId" content="MSDocsHeader-AspNet" />

			<meta name="page_type" content="conceptual" />

			<!--page specific meta tags-->
			

			<!-- custom meta tags -->
			
		<meta name="breadcrumb_path" content="/aspnet/core/breadcrumb/toc.json" />
	
		<meta name="feedback_system" content="OpenSource" />
	
		<meta name="feedback_product_url" content="https://github.com/dotnet/aspnetcore/blob/main/CONTRIBUTING.md" />
	
		<meta name="ms.service" content="aspnet-core" />
	
		<meta name="ms.topic" content="conceptual" />
	
		<meta name="zone_pivot_group_filename" content="core/zone-pivot-groups.json" />
	
		<meta name="ms.subservice" content="testing" />
	
		<meta name="author" content="tdykstra" />
	
		<meta name="monikerRange" content="&gt;= aspnetcore-3.1" />
	
		<meta name="ms.author" content="tdykstra" />
	
		<meta name="ms.custom" content="mvc" />
	
		<meta name="ms.date" content="2025-03-24T00:00:00Z" />
	
		<meta name="uid" content="test/integration-tests" />
	
		<meta name="zone_pivot_groups" content="unit-testing-framework" />
	
		<meta name="document_id" content="77889d43-fedb-f8b4-8fea-379ec946555c" />
	
		<meta name="document_version_independent_id" content="f499b131-8b14-7e10-1728-543fdd5a5656" />
	
		<meta name="updated_at" content="2025-05-15T18:59:00Z" />
	
		<meta name="original_content_git_url" content="https://github.com/dotnet/AspNetCore.Docs/blob/live/aspnetcore/test/integration-tests.md" />
	
		<meta name="gitcommit" content="https://github.com/dotnet/AspNetCore.Docs/blob/236aded05b44cc9984e9094fbf5c934afcdbdea5/aspnetcore/test/integration-tests.md" />
	
		<meta name="git_commit_id" content="236aded05b44cc9984e9094fbf5c934afcdbdea5" />
	
		<meta name="monikers" content="aspnetcore-3.1" />
	
		<meta name="monikers" content="aspnetcore-5.0" />
	
		<meta name="monikers" content="aspnetcore-6.0" />
	
		<meta name="monikers" content="aspnetcore-7.0" />
	
		<meta name="monikers" content="aspnetcore-8.0" />
	
		<meta name="monikers" content="aspnetcore-9.0" />
	
		<meta name="monikers" content="aspnetcore-10.0" />
	
		<meta name="default_moniker" content="aspnetcore-9.0" />
	
		<meta name="site_name" content="Docs" />
	
		<meta name="depot_name" content="MSDN.aspnet-core-conceptual" />
	
		<meta name="schema" content="Conceptual" />
	
		<meta name="toc_rel" content="../toc.json" />
	
		<meta name="pdf_url_template" content="https://learn.microsoft.com/pdfstore/en-us/MSDN.aspnet-core-conceptual/{branchName}{pdfName}" />
	
		<meta name="feedback_help_link_type" content="" />
	
		<meta name="feedback_help_link_url" content="" />
	
		<meta name="word_count" content="22562" />
	
		<meta name="config_moniker_range" content="&gt;= aspnetcore-1.0" />
	
		<meta name="asset_id" content="test/integration-tests" />
	
		<meta name="moniker_range_name" content="dd7b9de2e2e080a77b76aef7078b3e55" />
	
		<meta name="item_type" content="Content" />
	
		<meta name="source_path" content="aspnetcore/test/integration-tests.md" />
	
		<meta name="previous_tlsh_hash" content="DABC8DB3960EC260BFC29F0BA5BA6E0066F0D08A6AB4BB84163579A295491F775F55A8B7DF5B738B6372438309D5750F66E6F73AD03C23A72910D8FCC25C10825BD83BB6D4" />
	
		<meta name="github_feedback_content_git_url" content="https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/test/integration-tests.md" />
	 
		<meta name="cmProducts" content="https://authoring-docs-microsoft.poolparty.biz/devrel/d452572f-6212-498f-9050-ca4a9e50a425" data-source="generated" />
	
		<meta name="cmProducts" content="https://authoring-docs-microsoft.poolparty.biz/devrel/97159432-14a9-4307-a469-d2f2c75f0e33" data-source="generated" />
	
		<meta name="cmProducts" content="https://authoring-docs-microsoft.poolparty.biz/devrel/9bdc1705-9b40-49d6-8377-caa0b71fda66" data-source="generated" />
	
		<meta name="spProducts" content="https://authoring-docs-microsoft.poolparty.biz/devrel/a12e40b7-59a2-4437-96e2-166ce622b864" data-source="generated" />
	
		<meta name="spProducts" content="https://authoring-docs-microsoft.poolparty.biz/devrel/50565c62-5f6b-4687-be38-323113c72c2e" data-source="generated" />
	
		<meta name="spProducts" content="https://authoring-docs-microsoft.poolparty.biz/devrel/686ed158-d915-41e9-9760-efa46ba88f6d" data-source="generated" />
	

			<!-- assets and js globals -->
			
			<link rel="stylesheet" href="https://learn.microsoft.com/static/assets/0.4.03137.7032-e8b681c0/styles/site-ltr.css" />
			<link rel="preconnect" href="http://mscom.demdex.net/" crossorigin />
						<link rel="dns-prefetch" href="http://target.microsoft.com/" />
						<link rel="dns-prefetch" href="http://microsoftmscompoc.tt.omtrdc.net/" />
						<link
							rel="preload"
							as="script"
							href="https://learn.microsoft.com/static/third-party/adobe-target/at-js/2.9.0/at.js"
							integrity="sha384-1/viVM50hgc33O2gOgkWz3EjiD/Fy/ld1dKYXJRUyjNYVEjSUGcSN+iPiQF7e4cu"
							crossorigin="anonymous"
							id="adobe-target-script"
							type="application/javascript"
						/>
			<script src="https://wcpstatic.microsoft.com/mscc/lib/v2/wcp-consent.js"></script>
			<script src="https://js.monitor.azure.com/scripts/c/ms.jsll-4.min.js"></script>
			<script src="https://learn.microsoft.com/_themes/docs.theme/master/en-us/_themes/global/deprecation.js"></script>

			<!-- msdocs global object -->
			<script id="msdocs-script">
		var msDocs = {
  "environment": {
    "accessLevel": "online",
    "azurePortalHostname": "portal.azure.com",
    "reviewFeatures": false,
    "supportLevel": "production",
    "systemContent": true,
    "siteName": "learn",
    "legacyHosting": false
  },
  "data": {
    "contentLocale": "en-us",
    "contentDir": "ltr",
    "userLocale": "en-us",
    "userDir": "ltr",
    "pageTemplate": "Conceptual",
    "brand": "",
    "context": {},
    "standardFeedback": false,
    "showFeedbackReport": false,
    "feedbackHelpLinkType": "",
    "feedbackHelpLinkUrl": "",
    "feedbackSystem": "OpenSource",
    "feedbackGitHubRepo": "dotnet/AspNetCore.Docs",
    "feedbackProductUrl": "https://github.com/dotnet/aspnetcore/blob/main/CONTRIBUTING.md",
    "extendBreadcrumb": false,
    "isEditDisplayable": true,
    "isPrivateUnauthorized": false,
    "hideViewSource": false,
    "isPermissioned": false,
    "hasRecommendations": true,
    "contributors": [
      {
        "name": "tdykstra",
        "url": "https://github.com/tdykstra"
      },
      {
        "name": "jonorogers",
        "url": "https://github.com/jonorogers"
      },
      {
        "name": "danroth27",
        "url": "https://github.com/danroth27"
      },
      {
        "name": "benhopkinstech",
        "url": "https://github.com/benhopkinstech"
      },
      {
        "name": "timdeschryver",
        "url": "https://github.com/timdeschryver"
      },
      {
        "name": "BusHero",
        "url": "https://github.com/BusHero"
      },
      {
        "name": "Rick-Anderson",
        "url": "https://github.com/Rick-Anderson"
      },
      {
        "name": "serpent5",
        "url": "https://github.com/serpent5"
      },
      {
        "name": "rufer7",
        "url": "https://github.com/rufer7"
      },
      {
        "name": "knumat",
        "url": "https://github.com/knumat"
      },
      {
        "name": "jvandertil",
        "url": "https://github.com/jvandertil"
      },
      {
        "name": "GitHubPang",
        "url": "https://github.com/GitHubPang"
      },
      {
        "name": "guardrex",
        "url": "https://github.com/guardrex"
      },
      {
        "name": "v-haiboz",
        "url": "https://github.com/v-haiboz"
      },
      {
        "name": "ziali088",
        "url": "https://github.com/ziali088"
      },
      {
        "name": "GabrielMajeri",
        "url": "https://github.com/GabrielMajeri"
      },
      {
        "name": "Loupeznik",
        "url": "https://github.com/Loupeznik"
      },
      {
        "name": "carlreinke",
        "url": "https://github.com/carlreinke"
      },
      {
        "name": "scottaddie",
        "url": "https://github.com/scottaddie"
      },
      {
        "name": "DCtheGeek",
        "url": "https://github.com/DCtheGeek"
      },
      {
        "name": "HaoK",
        "url": "https://github.com/HaoK"
      },
      {
        "name": "michal-ciechan",
        "url": "https://github.com/michal-ciechan"
      },
      {
        "name": "Steborino",
        "url": "https://github.com/Steborino"
      },
      {
        "name": "JamesNK",
        "url": "https://github.com/JamesNK"
      },
      {
        "name": "v-thepet",
        "url": "https://github.com/v-thepet"
      },
      {
        "name": "nschonni",
        "url": "https://github.com/nschonni"
      },
      {
        "name": "flcdrg",
        "url": "https://github.com/flcdrg"
      }
    ],
    "openSourceFeedbackIssueUrl": "https://github.com/dotnet/aspnetcore.docs/issues/new?template=customer-feedback.yml",
    "openSourceFeedbackIssueTitle": "",
    "openSourceFeedbackIssueLabels": "Source - Docs.ms,:watch: Not Triaged"
  },
  "functions": {}
};;
	</script>

			<!-- base scripts, msdocs global should be before this -->
			<script src="https://learn.microsoft.com/static/assets/0.4.03137.7032-e8b681c0/scripts/en-us/index-docs.js"></script>
			

			<!-- json-ld -->
			
		</head>
	
			<body
				id="body"
				data-bi-name="body"
				class="layout-body "
				lang="en-us"
				dir="ltr"
			>
				<header class="layout-body-header">
		<div class="header-holder has-default-focus">
			
		<a
			href="#main"
			
			style="z-index: 1070"
			class="outline-color-text visually-hidden-until-focused position-fixed inner-focus focus-visible top-0 left-0 right-0 padding-xs text-align-center background-color-body"
			
		>
			Skip to main content
		</a>
	
		<a
			href="#"
			data-skip-to-ask-learn
			style="z-index: 1070"
			class="outline-color-text visually-hidden-until-focused position-fixed inner-focus focus-visible top-0 left-0 right-0 padding-xs text-align-center background-color-body"
			hidden
		>
			Skip to Ask Learn chat experience
		</a>
	

			<div hidden id="cookie-consent-holder" data-test-id="cookie-consent-container"></div>
			<!-- Unsupported browser warning -->
			<div
				id="unsupported-browser"
				style="background-color: white; color: black; padding: 16px; border-bottom: 1px solid grey;"
				hidden
			>
				<div style="max-width: 800px; margin: 0 auto;">
					<p style="font-size: 24px">This browser is no longer supported.</p>
					<p style="font-size: 16px; margin-top: 16px;">
						Upgrade to Microsoft Edge to take advantage of the latest features, security updates, and technical support.
					</p>
					<div style="margin-top: 12px;">
						<a
							href="https://go.microsoft.com/fwlink/p/?LinkID=2092881"
							style="background-color: #0078d4; border: 1px solid #0078d4; color: white; padding: 6px 12px; border-radius: 2px; display: inline-block;"
						>
							Download Microsoft Edge
						</a>
						<a
							href="https://learn.microsoft.com/en-us/lifecycle/faq/internet-explorer-microsoft-edge"
							style="background-color: white; padding: 6px 12px; border: 1px solid #505050; color: #171717; border-radius: 2px; display: inline-block;"
						>
							More info about Internet Explorer and Microsoft Edge
						</a>
					</div>
				</div>
			</div>
			<!-- site header -->
			<header
				id="ms--site-header"
				data-test-id="site-header-wrapper"
				role="banner"
				itemscope="itemscope"
				itemtype="http://schema.org/Organization"
			>
				<div
					id="ms--mobile-nav"
					class="site-header display-none-tablet padding-inline-none gap-none"
					data-bi-name="mobile-header"
					data-test-id="mobile-header"
				></div>
				<div
					id="ms--primary-nav"
					class="site-header display-none display-flex-tablet"
					data-bi-name="L1-header"
					data-test-id="primary-header"
				></div>
				<div
					id="ms--secondary-nav"
					class="site-header display-none display-flex-tablet"
					data-bi-name="L2-header"
					data-test-id="secondary-header"
				></div>
			</header>
			
		<!-- banner -->
		<div data-banner>
			<div id="disclaimer-holder"></div>
			
		</div>
		<!-- banner end -->
	
		</div>
	</header>
				 <section
					id="layout-body-menu"
					class="layout-body-menu display-flex"
					data-bi-name="menu"
			  >
					<div
		id="left-container"
		class="left-container display-none display-block-tablet padding-inline-sm padding-bottom-sm width-full"
	>
		<nav
			id="affixed-left-container"
			class="margin-top-sm-tablet position-sticky display-flex flex-direction-column"
			aria-label="Primary"
		></nav>
	</div>
			  </section>

				<main
					id="main"
					role="main"
					class="layout-body-main "
					data-bi-name="content"
					lang="en-us"
					dir="ltr"
				>
					
			<div
		id="ms--content-header"
		class="content-header default-focus border-bottom-none"
		data-bi-name="content-header"
	>
		<div class="content-header-controls margin-xxs margin-inline-sm-tablet">
			<button
				type="button"
				class="contents-button button button-sm margin-right-xxs"
				data-bi-name="contents-expand"
				aria-haspopup="true"
				data-contents-button
			>
				<span class="icon" aria-hidden="true"><span class="docon docon-menu"></span></span>
				<span class="contents-expand-title"> Table of contents </span>
			</button>
			<button
				type="button"
				class="ap-collapse-behavior ap-expanded button button-sm"
				data-bi-name="ap-collapse"
				aria-controls="action-panel"
			>
				<span class="icon" aria-hidden="true"><span class="docon docon-exit-mode"></span></span>
				<span>Exit editor mode</span>
			</button>
		</div>
	</div>
			<div data-main-column class="padding-sm padding-top-none padding-top-sm-tablet">
				<div>
					
		<div id="article-header" class="background-color-body margin-bottom-xs display-none-print">
			<div class="display-flex align-items-center justify-content-space-between">
				
		<details
			id="article-header-breadcrumbs-overflow-popover"
			class="popover"
			data-for="article-header-breadcrumbs"
		>
			<summary
				class="button button-clear button-primary button-sm inner-focus"
				aria-label="All breadcrumbs"
			>
				<span class="icon">
					<span class="docon docon-more"></span>
				</span>
			</summary>
			<div id="article-header-breadcrumbs-overflow" class="popover-content padding-none"></div>
		</details>

		<bread-crumbs
			id="article-header-breadcrumbs"
			data-test-id="article-header-breadcrumbs"
			class="overflow-hidden flex-grow-1 margin-right-sm margin-right-md-tablet margin-right-lg-desktop margin-left-negative-xxs padding-left-xxs"
		></bread-crumbs>
	 
		<div
			id="article-header-page-actions"
			class="opacity-none margin-left-auto display-flex flex-wrap-no-wrap align-items-stretch"
		>
			
		<button
			class="button button-sm border-none inner-focus display-none-tablet flex-shrink-0 "
			data-bi-name="ask-learn-assistant-entry"
			data-test-id="ask-learn-assistant-modal-entry-mobile"
			data-ask-learn-modal-entry
			type="button"
			style="min-width: max-content;"
			aria-expanded="false"
			aria-label="Ask Learn"
			hidden
		>
			<span class="icon font-size-lg" aria-hidden="true">
				<span class="docon docon-chat-sparkle-fill gradient-ask-learn-logo"></span>
			</span>
		</button>
		<button
			class="button button-sm display-none display-inline-flex-tablet display-none-desktop flex-shrink-0 margin-right-xxs border-color-ask-learn "
			data-bi-name="ask-learn-assistant-entry"
			data-test-id="ask-learn-assistant-modal-entry-tablet"
			data-ask-learn-modal-entry
			type="button"
			style="min-width: max-content;"
			aria-expanded="false"
			hidden
		>
			<span class="icon font-size-lg" aria-hidden="true">
				<span class="docon docon-chat-sparkle-fill gradient-ask-learn-logo"></span>
			</span>
			<span>Ask Learn</span>
		</button>
		<button
			class="button button-sm display-none flex-shrink-0 display-inline-flex-desktop margin-right-xxs	border-color-ask-learn "
			data-bi-name="ask-learn-assistant-entry"
			data-test-id="ask-learn-assistant-flyout-entry"
			data-ask-learn-flyout-entry
			data-flyout-button="toggle"
			type="button"
			style="min-width: max-content;"
			aria-expanded="false"
			aria-controls="ask-learn-flyout"
			hidden
		>
			<span class="icon font-size-lg" aria-hidden="true">
				<span class="docon docon-chat-sparkle-fill gradient-ask-learn-logo"></span>
			</span>
			<span>Ask Learn</span>
		</button>
	 
		<button
			type="button"
			id="ms--focus-mode-button"
			data-focus-mode
			data-bi-name="focus-mode-entry"
			class="button button-sm flex-shrink-0 margin-right-xxs display-none display-inline-flex-desktop"
		>
			<span class="icon font-size-lg" aria-hidden="true">
				<span class="docon docon-glasses"></span>
			</span>
			<span>Focus mode</span>
		</button>
	 

			<details class="popover popover-right" id="article-header-page-actions-overflow">
				<summary
					class="justify-content-flex-start button button-clear button-sm button-primary inner-focus"
					aria-label="More actions"
					title="More actions"
				>
					<span class="icon" aria-hidden="true">
						<span class="docon docon-more-vertical"></span>
					</span>
				</summary>
				<div class="popover-content">
					
		<button
			data-page-action-item="overflow-mobile"
			type="button"
			class="button-block button-sm has-inner-focus button button-clear display-none-tablet justify-content-flex-start text-align-left"
			data-bi-name="contents-expand"
			data-contents-button
			data-popover-close
		>
			<span class="icon">
				<span class="docon docon-editor-list-bullet" aria-hidden="true"></span>
			</span>
			<span class="contents-expand-title">Table of contents</span>
		</button>
	 
		<a
			id="lang-link-overflow"
			class="button-sm has-inner-focus button button-clear button-block justify-content-flex-start text-align-left"
			data-bi-name="language-toggle"
			data-page-action-item="overflow-all"
			data-check-hidden="true"
			data-read-in-link
			href="#"
			hidden
		>
			<span class="icon" aria-hidden="true" data-read-in-link-icon>
				<span class="docon docon-locale-globe"></span>
			</span>
			<span data-read-in-link-text>Read in English</span>
		</a>
	 
		<button
			type="button"
			class="collection button button-clear button-sm button-block justify-content-flex-start text-align-left inner-focus"
			data-list-type="collection"
			data-bi-name="collection"
			data-page-action-item="overflow-all"
			data-check-hidden="true"
			data-popover-close
		>
			<span class="icon" aria-hidden="true">
				<span class="docon docon-circle-addition"></span>
			</span>
			<span class="collection-status">Add</span>
		</button>
	
					
		<button
			type="button"
			class="collection button button-block button-clear button-sm justify-content-flex-start text-align-left inner-focus"
			data-list-type="plan"
			data-bi-name="plan"
			data-page-action-item="overflow-all"
			data-check-hidden="true"
			data-popover-close
			hidden
		>
			<span class="icon" aria-hidden="true">
				<span class="docon docon-circle-addition"></span>
			</span>
			<span class="plan-status">Add to plan</span>
		</button>
	  
		<a
			data-contenteditbtn
			class="button button-clear button-block button-sm inner-focus justify-content-flex-start text-align-left text-decoration-none"
			data-bi-name="edit"
			
			href="https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/test/integration-tests.md"
			data-original_content_git_url="https://github.com/dotnet/AspNetCore.Docs/blob/live/aspnetcore/test/integration-tests.md"
			data-original_content_git_url_template="{repo}/blob/{branch}/aspnetcore/test/integration-tests.md"
			data-pr_repo=""
			data-pr_branch=""
		>
			<span class="icon" aria-hidden="true">
				<span class="docon docon-edit-outline"></span>
			</span>
			<span>Edit</span>
		</a>
	
					
		<hr class="margin-block-xxs" />
		<h4 class="font-size-sm padding-left-xxs">Share via</h4>
		
					<a
						class="button button-clear button-sm inner-focus button-block justify-content-flex-start text-align-left text-decoration-none share-facebook"
						data-bi-name="facebook"
						data-page-action-item="overflow-all"
						href="#"
					>
						<span class="icon color-primary" aria-hidden="true">
							<span class="docon docon-facebook-share"></span>
						</span>
						<span>Facebook</span>
					</a>

					<a
						href="#"
						class="button button-clear button-sm inner-focus button-block justify-content-flex-start text-align-left text-decoration-none share-twitter"
						data-bi-name="twitter"
						data-page-action-item="overflow-all"
					>
						<span class="icon color-text" aria-hidden="true">
							<span class="docon docon-xlogo-share"></span>
						</span>
						<span>x.com</span>
					</a>

					<a
						href="#"
						class="button button-clear button-sm inner-focus button-block justify-content-flex-start text-align-left text-decoration-none share-linkedin"
						data-bi-name="linkedin"
						data-page-action-item="overflow-all"
					>
						<span class="icon color-primary" aria-hidden="true">
							<span class="docon docon-linked-in-logo"></span>
						</span>
						<span>LinkedIn</span>
					</a>
					<a
						href="#"
						class="button button-clear button-sm inner-focus button-block justify-content-flex-start text-align-left text-decoration-none share-email"
						data-bi-name="email"
						data-page-action-item="overflow-all"
					>
						<span class="icon color-primary" aria-hidden="true">
							<span class="docon docon-mail-message"></span>
						</span>
						<span>Email</span>
					</a>
			  
	 
		<hr class="margin-block-xxs" />
		<button
			class="button button-block button-clear button-sm justify-content-flex-start text-align-left inner-focus"
			type="button"
			data-bi-name="print"
			data-page-action-item="overflow-all"
			data-popover-close
			data-print-page
			data-check-hidden="true"
		>
			<span class="icon color-primary" aria-hidden="true">
				<span class="docon docon-print"></span>
			</span>
			<span>Print</span>
		</button>
	
				</div>
			</details>
		</div>
	
			</div>
		</div>
	
					<!-- azure disclaimer -->
					
					<!-- privateUnauthorizedTemplate is hidden by default -->
					
		<div unauthorized-private-section data-bi-name="permission-content-unauthorized-private" hidden>
			<hr class="hr margin-top-xs margin-bottom-sm" />
			<div class="notification notification-info">
				<div class="notification-content">
					<p class="margin-top-none notification-title">
						<span class="icon">
							<span class="docon docon-exclamation-circle-solid" aria-hidden="true"></span>
						</span>
						<span>Note</span>
					</p>
					<p class="margin-top-none authentication-determined not-authenticated">
						Access to this page requires authorization. You can try <a class="docs-sign-in" href="#" data-bi-name="permission-content-sign-in">signing in</a> or <a  class="docs-change-directory" data-bi-name="permisson-content-change-directory">changing directories</a>.
					</p>
					<p class="margin-top-none authentication-determined authenticated">
						Access to this page requires authorization. You can try <a class="docs-change-directory" data-bi-name="permisson-content-change-directory">changing directories</a>.
					</p>
				</div>
			</div>
		</div>
	
					<div class="content"><h1 id="integration-tests-in-aspnet-core">Integration tests in ASP.NET Core</h1></div>
					
		<div
			id="article-metadata"
			class="page-metadata-container display-flex gap-xxs justify-content-space-between align-items-center flex-wrap-wrap"
		>
			
		<div class="margin-block-xxs">
			<ul class="metadata page-metadata" data-bi-name="page info" lang="en-us" dir="ltr">
				  <li class="visibility-hidden-visual-diff">
			<local-time
				format="twoDigitNumeric"
				datetime="2025-03-25T11:49:00.000Z"
				data-article-date-source="calculated"
				class="is-invisible"
			>
				2025-03-25
			</local-time>
		</li>  
			</ul>
		</div>
	 
				<div
					id="user-feedback"
					class="margin-block-xxs display-none display-none-print"
					hidden
					data-hide-on-archived
				>
					
		<button
			id="user-feedback-button"
			data-test-id="conceptual-feedback-button"
			class="button button-sm button-clear button-primary display-none"
			type="button"
			data-bi-name="user-feedback-button"
			data-user-feedback-button
			hidden
		>
			<span class="icon" aria-hidden="true">
				<span class="docon docon-like"></span>
			</span>
			<span>Feedback</span>
		</button>
	
				</div>
		  
		</div>
	 
		<nav
			id="center-doc-outline"
			class="doc-outline is-hidden-desktop display-none-print margin-bottom-sm"
			data-bi-name="intopic toc"
			aria-label="In this article"
		>
			<h2 id="ms--in-this-article" class="title is-6 margin-block-xs">
				In this article
			</h2>
		</nav>
	
					<div class="content"><p>By <a href="https://jvandertil.nl/" data-linktype="external">Jos van der Til</a>, <a href="https://martincostello.com/" data-linktype="external">Martin Costello</a>, and <a href="https://github.com/javiercn" data-linktype="external">Javier Calvarro Nelson</a>.</p>
<p>Integration tests ensure that an app's components function correctly at a level that includes the app's supporting infrastructure, such as the database, file system, and network. ASP.NET Core supports integration tests using a unit test framework with a test web host and an in-memory test server.</p>
<div data-moniker="aspnetcore-10.0">
<p>This article assumes a basic understanding of unit tests. If unfamiliar with test concepts, see the <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">Testing in .NET</a> article and its linked content.</p>
<p><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/10.x/IntegrationTestsSample" data-linktype="external">View or download sample code</a> (<a href="../overview553c.html?view=aspnetcore-9.0#how-to-download-a-sample" data-linktype="relative-path">how to download</a>)</p>
<p>The sample app is a Razor Pages app and assumes a basic understanding of Razor Pages. If you're unfamiliar with Razor Pages, see the following articles:</p>
<ul>
<li><a href="../razor-pages/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Introduction to Razor Pages</a></li>
<li><a href="../tutorials/razor-pages/razor-pages-start553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Get started with Razor Pages</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests</a></li>
</ul>
<p><strong>For testing SPAs</strong>, we recommend a tool such as <a href="https://playwright.dev/dotnet/" data-linktype="external">Playwright for .NET</a>, which can automate a browser.</p>
<h2 id="introduction-to-integration-tests">Introduction to integration tests</h2>
<p>Integration tests evaluate an app's components on a broader level than <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">unit tests</a>. Unit tests are used to test isolated software components, such as individual class methods. Integration tests confirm that two or more app components work together to produce an expected result, possibly including every component required to fully process a request.</p>
<p>These broader tests are used to test the app's infrastructure and whole framework, often including the following components:</p>
<ul>
<li>Database</li>
<li>File system</li>
<li>Network appliances</li>
<li>Request-response pipeline</li>
</ul>
<p>Unit tests use fabricated components, known as <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-best-practices#lets-speak-the-same-language" data-linktype="absolute-path"><em>fakes</em> or <em>mock objects</em></a>, in place of infrastructure components.</p>
<p>In contrast to unit tests, integration tests:</p>
<ul>
<li>Use the actual components that the app uses in production.</li>
<li>Require more code and data processing.</li>
<li>Take longer to run.</li>
</ul>
<p>Therefore, limit the use of integration tests to the most important infrastructure scenarios. If a behavior can be tested using either a unit test or an integration test, choose the unit test.</p>
<p>In discussions of integration tests, the tested project is frequently called the <em><strong>System Under Test</strong></em>, or "<strong>SUT</strong>" for short. "SUT" is used throughout this article to refer to the ASP.NET Core app being tested.</p>
<p><em><strong>Don't write integration tests for every permutation</strong></em> of data and file access with databases and file systems. Regardless of how many places across an app interact with databases and file systems, a focused set of read, write, update, and delete integration tests are usually capable of adequately testing database and file system components. Use unit tests for routine tests of method logic that interact with these components. In unit tests, the use of infrastructure fakes or mocks result in faster test execution.</p>
<h2 id="aspnet-core-integration-tests">ASP.NET Core integration tests</h2>
<p>Integration tests in ASP.NET Core require the following:</p>
<ul>
<li>A test project is used to contain and execute the tests. The test project has a reference to the SUT.</li>
<li>The test project creates a test web host for the SUT and uses a test server client to handle requests and responses with the SUT.</li>
<li>A test runner is used to execute the tests and report the test results.</li>
</ul>
<p>Integration tests follow a sequence of events that include the usual <em>Arrange</em>, <em>Act</em>, and <em>Assert</em> test steps:</p>
<ol>
<li>The SUT's web host is configured.</li>
<li>A test server client is created to submit requests to the app.</li>
<li>The <em>Arrange</em> test step is executed: The test app prepares a request.</li>
<li>The <em>Act</em> test step is executed: The client submits the request and receives the response.</li>
<li>The <em>Assert</em> test step is executed: The <em>actual</em> response is validated as a <em>pass</em> or <em>fail</em> based on an <em>expected</em> response.</li>
<li>The process continues until all of the tests are executed.</li>
<li>The test results are reported.</li>
</ol>
<p>Usually, the test web host is configured differently than the app's normal web host for the test runs. For example, a different database or different app settings might be used for the tests.</p>
<p>Infrastructure components, such as the test web host and in-memory test server (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>), are provided or managed by the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external">Microsoft.AspNetCore.Mvc.Testing</a> package. Use of this package streamlines test creation and execution.</p>
<p>The <code>Microsoft.AspNetCore.Mvc.Testing</code> package handles the following tasks:</p>
<ul>
<li>Copies the dependencies file (<code>.deps</code>) from the SUT into the test project's <code>bin</code> directory.</li>
<li>Sets the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> to the SUT's project root so that static files and pages/views are found when the tests are executed.</li>
<li>Provides the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path">WebApplicationFactory</a> class to streamline bootstrapping the SUT with <code>TestServer</code>.</li>
</ul>
<p>The <a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">unit tests</a> documentation describes how to set up a test project and test runner, along with detailed instructions on how to run tests and recommendations for how to name tests and test classes.</p>
<p><strong>Separate unit tests from integration tests into different projects</strong>. Separating the tests:</p>
<ul>
<li>Helps ensure that infrastructure testing components aren't accidentally included in the unit tests.</li>
<li>Allows control over which set of tests are run.</li>
</ul>
<p>There's virtually no difference between the configuration for tests of Razor Pages apps and MVC apps. The only difference is in how the tests are named. In a Razor Pages app, tests of page endpoints are usually named after the page model class (for example, <code>IndexPageTests</code> to test component integration for the Index page). In an MVC app, tests are usually organized by controller classes and named after the controllers they test (for example, <code>HomeControllerTests</code> to test component integration for the Home controller).</p>
<h2 id="test-app-prerequisites">Test app prerequisites</h2>
<p>The test project must:</p>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package.</li>
<li>Specify the Web SDK in the project file (<code>&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;</code>).</li>
</ul>
<p>These prerequisites can be seen in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/10.x/IntegrationTestsSample" data-linktype="external">sample app</a>. Inspect the <code>tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj</code> file. The sample app uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework and the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser library, so the sample app also references:</p>
<ul>
<li><a href="https://www.nuget.org/packages/AngleSharp" data-linktype="external"><code>AngleSharp</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit" data-linktype="external"><code>xunit</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a></li>
</ul>
<p>In apps that use <a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a> version 2.4.2 or later, the test project must reference the <a href="https://www.nuget.org/packages/Microsoft.NET.Test.Sdk" data-linktype="external"><code>Microsoft.NET.Test.Sdk</code></a> package.</p>
<p>Entity Framework Core is also used in the tests. See the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/10.x/IntegrationTestsSample/src/RazorPagesProject/RazorPagesProject.csproj" data-linktype="external">project file in GitHub</a>.</p>
<h2 id="sut-environment">SUT environment</h2>
<p>If the SUT's <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-9.0" data-linktype="relative-path">environment</a> isn't set, the environment defaults to Development.</p>
<h2 id="basic-tests-with-the-default-webapplicationfactory">Basic tests with the default WebApplicationFactory</h2>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" class="no-loc" data-linktype="absolute-path">WebApplicationFactory&lt;TEntryPoint&gt;</a> is used to create a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> for the integration tests. <code>TEntryPoint</code> is the entry point class of the SUT, usually <code>Program.cs</code>.</p>
<p>Test classes implement a <em>class fixture</em> interface (<a href="https://xunit.net/docs/shared-context#class-fixture" data-linktype="external"><code>IClassFixture</code></a>) to indicate the class contains tests and provide shared object instances across the tests in the class.</p>
<p>The following test class, <code>BasicTests</code>, uses the <code>WebApplicationFactory</code> to bootstrap the SUT and provide an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> to a test method, <code>Get_EndpointsReturnSuccessAndCorrectContentType</code>. The method verifies the response status code is successful (200-299) and the <code>Content-Type</code> header is <code>text/html; charset=utf-8</code> for several app pages.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> creates an instance of <code>HttpClient</code> that automatically follows redirects and handles cookies.</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">public class BasicTests 
    : IClassFixture&lt;WebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly WebApplicationFactory&lt;Program&gt; _factory;

    public BasicTests(WebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
    }

    [Theory]
    [InlineData("/")]
    [InlineData("/Index")]
    [InlineData("/About")]
    [InlineData("/Privacy")]
    [InlineData("/Contact")]
    public async Task Get_EndpointsReturnSuccessAndCorrectContentType(string url)
    {
        // Arrange
        var client = _factory.CreateClient();

        // Act
        var response = await client.GetAsync(url);

        // Assert
        response.EnsureSuccessStatusCode(); // Status Code 200-299
        Assert.Equal("text/html; charset=utf-8", 
            response.Content.Headers.ContentType.ToString());
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestClass]
public class BasicTests
{
    private static CustomWebApplicationFactory&lt;Program&gt; _factory;

    [ClassInitialize]
    public static void AssemblyInitialize(TestContext _)
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
    }

    [ClassCleanup(ClassCleanupBehavior.EndOfClass)]
    public static void AssemblyCleanup(TestContext _)
    {
        _factory.Dispose();
    }

    [TestMethod]
    [DataRow("/")]
    [DataRow("/Index")]
    [DataRow("/About")]
    [DataRow("/Privacy")]
    [DataRow("/Contact")]
    public async Task Get_EndpointsReturnSuccessAndCorrectContentType(string url)
    {
        // Arrange
        var client = _factory.CreateClient();

        // Act
        var response = await client.GetAsync(url);

        // Assert
        response.EnsureSuccessStatusCode(); // Status Code 200-299
        Assert.AreEqual("text/html; charset=utf-8",
            response.Content.Headers.ContentType.ToString());
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">public class BasicTests
{
    private CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [SetUp]
    public void SetUp()
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
    }

    [TearDown]
    public void TearDown()
    {
        _factory.Dispose();
    }

    [DatapointSource]
    public string[] values = ["/", "/Index", "/About", "/Privacy", "/Contact"];

    [Theory]
    public async Task Get_EndpointsReturnSuccessAndCorrectContentType(string url)
    {
        // Arrange
        var client = _factory.CreateClient();

        // Act
        var response = await client.GetAsync(url);

        // Assert
        response.EnsureSuccessStatusCode(); // Status Code 200-299
        Assert.That(response.Content.Headers.ContentType.ToString(), Is.EqualTo("text/html; charset=utf-8"));
    }
}
</code></pre>
</div>
<p>By default, non-essential cookies aren't preserved across requests when the <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0" data-linktype="relative-path">General Data Protection Regulation consent policy</a> is enabled. To preserve non-essential cookies, such as those used by the TempData provider, mark them as essential in your tests. For instructions on marking a cookie as essential, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0#essential-cookies" data-linktype="relative-path">Essential cookies</a>.</p>
<p><a name="asap7"></a></p>
<h2 id="anglesharp-vs-application-parts-for-antiforgery-checks">AngleSharp vs <code>Application Parts</code> for antiforgery checks</h2>
<p>This article uses the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser to handle the antiforgery checks by loading pages and parsing the HTML. For testing the endpoints of controller and Razor Pages views at a lower-level, without caring about how they render in the browser, consider using <code>Application Parts</code>. The <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/advanced/app-parts?view=aspnetcore-9.0" data-linktype="relative-path">Application Parts</a> approach injects a controller or Razor Page into the app that can be used to make JSON requests to get the required values. For more information, see the blog <a href="https://blog.martincostello.com/integration-testing-antiforgery-with-application-parts/" data-linktype="external">Integration Testing ASP.NET Core Resources Protected with Antiforgery Using Application Parts</a> and <a href="https://github.com/martincostello/antiforgery-testing-application-part" data-linktype="external">associated GitHub repo</a> by <a href="https://github.com/martincostello" data-linktype="external">Martin Costello</a>. <!--See https://github.com/dotnet/AspNetCore.Docs/issues/18860 --></p>
<h2 id="customize-webapplicationfactory">Customize WebApplicationFactory</h2>
<p>Web host configuration can be created independently of the test classes by inheriting from <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" class="no-loc" data-linktype="absolute-path">WebApplicationFactory&lt;TEntryPoint&gt;</a> to create one or more custom factories:</p>
<ol>
<li><p>Inherit from <code>WebApplicationFactory</code> and override <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost" class="no-loc" data-linktype="absolute-path">ConfigureWebHost</a>. The <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> allows the configuration of the service collection with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder.configureservices" data-linktype="absolute-path"><code>IWebHostBuilder.ConfigureServices</code></a></p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType == 
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<p>Database seeding in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/10.x/IntegrationTestsSample" data-linktype="external">sample app</a> is performed by the <code>InitializeDbForTests</code> method. The method is described in the <a href="#test-app-organization" data-linktype="self-bookmark">Integration tests sample: Test app organization</a> section.</p>
<p>The SUT's database context is registered in <code>Program.cs</code>. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Program.cs</code> code is executed. To use a different database for the tests than the app's database, the app's database context must be replaced in <code>builder.ConfigureServices</code>.</p>
<p>The sample app finds the service descriptor for the database context and uses the descriptor to remove the service registration. The factory then adds a new <code>ApplicationDbContext</code> that uses an in-memory database for the tests..</p>
<p>To connect to a different database, change the <code>DbConnection</code>. To use a SQL Server test database:</p>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/" data-linktype="external"><code>Microsoft.EntityFrameworkCore.SqlServer</code></a> NuGet package in the project file.</li>
<li>Call <code>UseInMemoryDatabase</code>.</li>
</ul>
</li>
</ol>
<!--
    [!code-csharp[](~/../AspNetCore.Docs.Samples/test/integration-tests/10.x/IntegrationTestsSample/src/RazorPagesProject/Program.cs?name=snippet_all)]
-->
<ol start="2">
<li><p>Use the custom <code>CustomWebApplicationFactory</code> in test classes. The following example uses the factory in the <code>IndexPageTests</code> class:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">public class IndexPageTests :
    IClassFixture&lt;CustomWebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly HttpClient _client;
    private readonly CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    public IndexPageTests(
        CustomWebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
        _client = factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestClass]
public class IndexPageTests
{
    private static HttpClient _client;
    private static CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [ClassInitialize]
    public static void AssemblyInitialize(TestContext _)
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
        _client = _factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }

    [ClassCleanup(ClassCleanupBehavior.EndOfClass)]
    public static void AssemblyCleanup(TestContext _)
    {
        _factory.Dispose();
    }
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">public class IndexPageTests
{

    private HttpClient _client;
    private CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [SetUp]
    public void SetUp()
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
        _client = _factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }

    [TearDown]
    public void TearDown()
    {
        _factory.Dispose();
        _client.Dispose();
    }
</code></pre>
</div>
<p>The sample app's client is configured to prevent the <code>HttpClient</code> from following redirects. As explained later in the <a href="#mock-authentication" data-linktype="self-bookmark">Mock authentication</a> section, this permits tests to check the result of the app's first response. The first response is a redirect in many of these tests with a <code>Location</code> header.</p>
</li>
<li><p>A typical test uses the <code>HttpClient</code> and helper methods to process the request and the response:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteAllMessagesHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("button[id='deleteAllBtn']"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestMethod]
public async Task Post_DeleteAllMessagesHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("button[id='deleteAllBtn']"));

    // Assert
    Assert.AreEqual(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.AreEqual(HttpStatusCode.Redirect, response.StatusCode);
    Assert.AreEqual("/", response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">[Test]
public async Task Post_DeleteAllMessagesHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("button[id='deleteAllBtn']"));

    // Assert
    Assert.That(defaultPage.StatusCode, Is.EqualTo(HttpStatusCode.OK));
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.Redirect));
    Assert.That(response.Headers.Location.OriginalString, Is.EqualTo("/"));
}
</code></pre>
</div>
</li>
</ol>
<p>Any POST request to the SUT must satisfy the antiforgery check that's automatically made by the app's <a href="../security/data-protection/introduction553c.html?view=aspnetcore-9.0" data-linktype="relative-path">data protection antiforgery system</a>. In order to arrange for a test's POST request, the test app must:</p>
<ol>
<li>Make a request for the page.</li>
<li>Parse the antiforgery cookie and request validation token from the response.</li>
<li>Make the POST request with the antiforgery cookie and request validation token in place.</li>
</ol>
<p>The <code>SendAsync</code> helper extension methods (<code>Helpers/HttpClientExtensions.cs</code>) and the <code>GetDocumentAsync</code> helper method (<code>Helpers/HtmlHelpers.cs</code>) in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/10.x/IntegrationTestsSample/" data-linktype="external">sample app</a> use the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser to handle the antiforgery check with the following methods:</p>
<ul>
<li><code>GetDocumentAsync</code>: Receives the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpresponsemessage" class="no-loc" data-linktype="absolute-path">HttpResponseMessage</a> and returns an <code>IHtmlDocument</code>. <code>GetDocumentAsync</code> uses a factory that prepares a <em>virtual response</em> based on the original <code>HttpResponseMessage</code>. For more information, see the <a href="https://github.com/AngleSharp/AngleSharp#documentation" data-linktype="external">AngleSharp documentation</a>.</li>
<li><code>SendAsync</code> extension methods for the <code>HttpClient</code> compose an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httprequestmessage" class="no-loc" data-linktype="absolute-path">HttpRequestMessage</a> and call <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient.sendasync#system-net-http-httpclient-sendasync(system-net-http-httprequestmessage)" class="no-loc" data-linktype="absolute-path">SendAsync(HttpRequestMessage)</a> to submit requests to the SUT. Overloads for <code>SendAsync</code> accept the HTML form (<code>IHtmlFormElement</code>) and the following:
<ul>
<li>Submit button of the form (<code>IHtmlElement</code>)</li>
<li>Form values collection (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
<li>Submit button (<code>IHtmlElement</code>) and form values (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
</ul>
</li>
</ul>
<p><a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> is a <strong>third-party parsing library used for demonstration purposes</strong> in this article and the sample app. AngleSharp isn't supported or required for integration testing of ASP.NET Core apps. Other parsers can be used, such as the <a href="https://html-agility-pack.net/" data-linktype="external">Html Agility Pack (HAP)</a>. Another approach is to write code to handle the antiforgery system's request verification token and antiforgery cookie directly. See <a href="#asap7" data-linktype="self-bookmark">AngleSharp vs <code>Application Parts</code> for antiforgery checks</a> in this article for more information.</p>
<p>The <a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#in-memory-as-a-database-fake" data-linktype="absolute-path">EF-Core in-memory database provider</a> can be used for limited and basic testing, however the <em><strong><a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#sqlite-as-a-database-fake" data-linktype="absolute-path">SQLite provider</a> is the recommended choice for in-memory testing</strong></em>.</p>
<p>See <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup?view=aspnetcore-9.0#IStartupFilter" data-linktype="relative-path">Extend Startup with startup filters</a> which shows how to configure middleware using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.istartupfilter" class="no-loc" data-linktype="absolute-path">IStartupFilter</a>, which is useful when a test requires a custom service or middleware.</p>
<h2 id="customize-the-client-with-withwebhostbuilder">Customize the client with WithWebHostBuilder</h2>
<p>When additional configuration is required within a test method, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder" class="no-loc" data-linktype="absolute-path">WithWebHostBuilder</a> creates a new <code>WebApplicationFactory</code> with an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> that is further customized by configuration.</p>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/10.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests" data-linktype="external">sample code</a> calls <code>WithWebHostBuilder</code> to replace configured services with test stubs. For more information and example usage, see <a href="#inject-mock-services" data-linktype="self-bookmark">Inject mock services</a> in this article.</p>
<p>The <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> test method of the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/10.x/IntegrationTestsSample" data-linktype="external">sample app</a> demonstrates the use of <code>WithWebHostBuilder</code>. This test performs a record delete in the database by triggering a form submission in the SUT.</p>
<p>Because another test in the <code>IndexPageTests</code> class performs an operation that deletes all of the records in the database and may run before the <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> method, the database is reseeded in this test method to ensure that a record is present for the SUT to delete. Selecting the first delete button of the <code>messages</code> form in the SUT is simulated in the request to the SUT:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteMessageHandler_ReturnsRedirectToRoot()
{
    // Arrange
    using (var scope = _factory.Services.CreateScope())
    {
        var scopedServices = scope.ServiceProvider;
        var db = scopedServices.GetRequiredService&lt;ApplicationDbContext&gt;();

        Utilities.ReinitializeDbForTests(db);
    }

    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("form[id='messages']")
            .QuerySelector("div[class='panel-body']")
            .QuerySelector("button"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestMethod]
public async Task Post_DeleteMessageHandler_ReturnsRedirectToRoot()
{
    // Arrange
    using (var scope = _factory.Services.CreateScope())
    {
        var scopedServices = scope.ServiceProvider;
        var db = scopedServices.GetRequiredService&lt;ApplicationDbContext&gt;();

        Utilities.ReinitializeDbForTests(db);
    }

    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("form[id='messages']")
            .QuerySelector("div[class='panel-body']")
            .QuerySelector("button"));

    // Assert
    Assert.AreEqual(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.AreEqual(HttpStatusCode.Redirect, response.StatusCode);
    Assert.AreEqual("/", response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">[Test]
public async Task Post_DeleteMessageHandler_ReturnsRedirectToRoot()
{
    // Arrange
    using (var scope = _factory.Services.CreateScope())
    {
        var scopedServices = scope.ServiceProvider;
        var db = scopedServices.GetRequiredService&lt;ApplicationDbContext&gt;();

        Utilities.ReinitializeDbForTests(db);
    }

    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("form[id='messages']")
            .QuerySelector("div[class='panel-body']")
            .QuerySelector("button"));

    // Assert
    Assert.That(defaultPage.StatusCode, Is.EqualTo(HttpStatusCode.OK));
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.Redirect));
    Assert.That(response.Headers.Location.OriginalString, Is.EqualTo("/"));
}
</code></pre>
</div>
<h2 id="client-options">Client options</h2>
<p>See the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> page for defaults and available options when creating <code>HttpClient</code> instances.</p>
<p>Create the <code>WebApplicationFactoryClientOptions</code> class and pass it to the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> method:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">public class IndexPageTests :
    IClassFixture&lt;CustomWebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly HttpClient _client;
    private readonly CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    public IndexPageTests(
        CustomWebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
        _client = factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestClass]
public class IndexPageTests
{
    private static HttpClient _client;
    private static CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [ClassInitialize]
    public static void AssemblyInitialize(TestContext _)
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
        _client = _factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }

    [ClassCleanup(ClassCleanupBehavior.EndOfClass)]
    public static void AssemblyCleanup(TestContext _)
    {
        _factory.Dispose();
    }
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">public class IndexPageTests
{

    private HttpClient _client;
    private CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [SetUp]
    public void SetUp()
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
        _client = _factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }

    [TearDown]
    public void TearDown()
    {
        _factory.Dispose();
        _client.Dispose();
    }
</code></pre>
</div>
<p><strong><em>NOTE:</em></strong> To avoid HTTPS redirection warnings in logs when using HTTPS Redirection Middleware, set <code>BaseAddress = new Uri("https://localhost")</code></p>
<h2 id="inject-mock-services">Inject mock services</h2>
<p>Services can be overridden in a test with a call to <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> on the host builder. To scope the overridden services to the test itself, the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder" class="no-loc" data-linktype="absolute-path">WithWebHostBuilder</a> method is used to retrieve a host builder. This can be seen in the following tests:</p>
<ul>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/10.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs#L166-L173" data-linktype="external">Get_QuoteService_ProvidesQuoteInPage</a></li>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/10.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs#L35-L38" data-linktype="external">Get_GithubProfilePageCanGetAGithubUser</a></li>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/10.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs#L105-L117" data-linktype="external">Get_SecurePageIsReturnedForAnAuthenticatedUser</a></li>
</ul>
<p>The sample SUT includes a scoped service that returns a quote. The quote is embedded in a hidden field on the Index page when the Index page is requested.</p>
<p><code>Services/IQuoteService.cs</code>:</p>
<pre><code class="lang-csharp">public interface IQuoteService
{
    Task&lt;string&gt; GenerateQuote();
}
</code></pre>
<p><code>Services/QuoteService.cs</code>:</p>
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Dr. Who: Planet of Evil
// https://www.bbc.co.uk/programmes/p00pyrx6
public class QuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult&lt;string&gt;(
            "Come on, Sarah. We've an appointment in London, " +
            "and we're already 30,000 years late.");
    }
}
</code></pre>
<p><code>Program.cs</code>:</p>
<pre><code class="lang-csharp">services.AddScoped&lt;IQuoteService, QuoteService&gt;();
</code></pre>
<p><code>Pages/Index.cshtml.cs</code>:</p>
<pre><code class="lang-csharp" highlight-lines="4,9,20,26">public class IndexModel : PageModel
{
    private readonly ApplicationDbContext _db;
    private readonly IQuoteService _quoteService;

    public IndexModel(ApplicationDbContext db, IQuoteService quoteService)
    {
        _db = db;
        _quoteService = quoteService;
    }

    [BindProperty]
    public Message Message { get; set; }

    public IList&lt;Message&gt; Messages { get; private set; }

    [TempData]
    public string MessageAnalysisResult { get; set; }

    public string Quote { get; private set; }

    public async Task OnGetAsync()
    {
        Messages = await _db.GetMessagesAsync();

        Quote = await _quoteService.GenerateQuote();
    }
</code></pre>
<p><code>Pages/Index.cs</code>:</p>
<pre><code class="lang-cshtml">&lt;input id="quote" type="hidden" value="@Model.Quote"&gt;
</code></pre>
<p>The following markup is generated when the SUT app is run:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Come on, Sarah. We&amp;#x27;ve an appointment in 
    London, and we&amp;#x27;re already 30,000 years late."&gt;
</code></pre>
<p>To test the service and quote injection in an integration test, a mock service is injected into the SUT by the test. The mock service replaces the app's <code>QuoteService</code> with a service provided by the test app, called <code>TestQuoteService</code>:</p>
<p><code>IntegrationTests.IndexPageTests.cs</code>:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Pyramids of Mars
// https://www.bbc.co.uk/programmes/p00pys55
public class TestQuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult(
            "Something's interfering with time, Mr. Scarman, " +
            "and time is my business.");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Pyramids of Mars
// https://www.bbc.co.uk/programmes/p00pys55
public class TestQuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult(
            "Something's interfering with time, Mr. Scarman, " +
            "and time is my business.");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Pyramids of Mars
// https://www.bbc.co.uk/programmes/p00pys55
public class TestQuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult(
            "Something's interfering with time, Mr. Scarman, " +
            "and time is my business.");
    }
}
</code></pre>
</div>
<p><code>ConfigureTestServices</code> is called, and the scoped service is registered:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp" highlight-lines="7-10,17,20-21">[Fact]
public async Task Get_QuoteService_ProvidesQuoteInPage()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddScoped&lt;IQuoteService, TestQuoteService&gt;();
            });
        })
        .CreateClient();

    //Act
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);
    var quoteElement = content.QuerySelector("#quote");

    // Assert
    Assert.Equal("Something's interfering with time, Mr. Scarman, " +
        "and time is my business.", quoteElement.Attributes["value"].Value);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp" highlight-lines="7-10,17,20-21">[TestMethod]
public async Task Get_QuoteService_ProvidesQuoteInPage()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddScoped&lt;IQuoteService, TestQuoteService&gt;();
            });
        })
        .CreateClient();

    //Act
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);
    var quoteElement = content.QuerySelector("#quote");

    // Assert
    Assert.AreEqual("Something's interfering with time, Mr. Scarman, " +
        "and time is my business.", quoteElement.Attributes["value"].Value);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp" highlight-lines="7-10,17,20-22">[Test]
public async Task Get_QuoteService_ProvidesQuoteInPage()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddScoped&lt;IQuoteService, TestQuoteService&gt;();
            });
        })
        .CreateClient();

    //Act
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);
    var quoteElement = content.QuerySelector("#quote");

    // Assert
    Assert.That(quoteElement.Attributes["value"].Value, Is.EqualTo(
        "Something's interfering with time, Mr. Scarman, " +
        "and time is my business."));
}
</code></pre>
</div>
<p>The markup produced during the test's execution reflects the quote text supplied by <code>TestQuoteService</code>, thus the assertion passes:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Something&amp;#x27;s interfering with time, 
    Mr. Scarman, and time is my business."&gt;
</code></pre>
<h2 id="mock-authentication">Mock authentication</h2>
<p>Tests in the <code>AuthTests</code> class check that a secure endpoint:</p>
<ul>
<li>Redirects an unauthenticated user to the app's sign in page.</li>
<li>Returns content for an authenticated user.</li>
</ul>
<p>In the SUT, the <code>/SecurePage</code> page uses an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage" class="no-loc" data-linktype="absolute-path">AuthorizePage</a> convention to apply an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter" class="no-loc" data-linktype="absolute-path">AuthorizeFilter</a> to the page. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authorization/razor-pages-authorization?view=aspnetcore-9.0#require-authorization-to-access-a-page" data-linktype="relative-path">Razor Pages authorization conventions</a>.</p>
<pre><code class="lang-csharp">services.AddRazorPages(options =&gt;
{
    options.Conventions.AuthorizePage("/SecurePage");
});
</code></pre>
<p>In the <code>Get_SecurePageRedirectsAnUnauthenticatedUser</code> test, a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> is set to disallow redirects by setting <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect#microsoft-aspnetcore-mvc-testing-webapplicationfactoryclientoptions-allowautoredirect" class="no-loc" data-linktype="absolute-path">AllowAutoRedirect</a> to <code>false</code>:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">[Fact]
public async Task Get_SecurePageRedirectsAnUnauthenticatedUser()
{
    // Arrange
    var client = _factory.CreateClient(
        new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });

    // Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.StartsWith("http://localhost/Identity/Account/Login",
        response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestMethod]
public async Task Get_SecurePageRedirectsAnUnauthenticatedUser()
{
    // Arrange
    var client = _factory.CreateClient(
        new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });

    // Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.AreEqual(HttpStatusCode.Redirect, response.StatusCode);
    StringAssert.StartsWith(response.Headers.Location.OriginalString, "http://localhost/Identity/Account/Login");
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">[Test]
public async Task Get_SecurePageRedirectsAnUnauthenticatedUser()
{
    // Arrange
    var client = _factory.CreateClient(
        new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });

    // Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.Redirect));
    Assert.That(response.Headers.Location.OriginalString, Does.StartWith("http://localhost/Identity/Account/Login"));
}
</code></pre>
</div>
<p>By disallowing the client to follow the redirect, the following checks can be made:</p>
<ul>
<li>The status code returned by the SUT can be checked against the expected <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-redirect" class="no-loc" data-linktype="absolute-path">HttpStatusCode.Redirect</a> result, not the final status code after the redirect to the sign in page, which would be <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-ok" class="no-loc" data-linktype="absolute-path">HttpStatusCode.OK</a>.</li>
<li>The <code>Location</code> header value in the response headers is checked to confirm that it starts with <code>http://localhost/Identity/Account/Login</code>, not the final sign in page response, where the <code>Location</code> header wouldn't be present.</li>
</ul>
<p>The test app can mock an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a> in <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> in order to test aspects of authentication and authorization. A minimal scenario returns an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticateresult.success" class="no-loc" data-linktype="absolute-path">AuthenticateResult.Success</a>:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp" highlight-lines="11-18">public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options,
        ILoggerFactory logger, UrlEncoder encoder)
        : base(options, logger, encoder)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[] { new Claim(ClaimTypes.Name, "Test user") };
        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "TestScheme");

        var result = AuthenticateResult.Success(ticket);

        return Task.FromResult(result);
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp" highlight-lines="11-18">public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options,
        ILoggerFactory logger, UrlEncoder encoder)
        : base(options, logger, encoder)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[] { new Claim(ClaimTypes.Name, "Test user") };
        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "TestScheme");

        var result = AuthenticateResult.Success(ticket);

        return Task.FromResult(result);
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp" highlight-lines="11-18">public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options,
        ILoggerFactory logger, UrlEncoder encoder)
        : base(options, logger, encoder)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[] { new Claim(ClaimTypes.Name, "Test user") };
        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "TestScheme");

        var result = AuthenticateResult.Success(ticket);

        return Task.FromResult(result);
    }
}
</code></pre>
</div>
<p>The <code>TestAuthHandler</code> is called to authenticate a user when the authentication scheme is set to <code>TestScheme</code> where <code>AddAuthentication</code> is registered for <code>ConfigureTestServices</code>. It's important for the <code>TestScheme</code> scheme to match the scheme your app expects. Otherwise, authentication won't work.</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp" highlight-lines="7-12">[Fact]
public async Task Get_SecurePageIsReturnedForAnAuthenticatedUser()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddAuthentication(defaultScheme: "TestScheme")
                    .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                        "TestScheme", options =&gt; { });
            });
        })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false,
        });

    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue(scheme: "TestScheme");

    //Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.OK, response.StatusCode);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp" highlight-lines="7-12">[TestMethod]
public async Task Get_SecurePageIsReturnedForAnAuthenticatedUser()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
    {
        builder.ConfigureTestServices(services =&gt;
        {
            services.AddAuthentication(defaultScheme: "TestScheme")
                .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                    "TestScheme", options =&gt; { });
        });
    })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false,
        });

    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue(scheme: "TestScheme");

    //Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.AreEqual(HttpStatusCode.OK, response.StatusCode);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp" highlight-lines="7-12">[Test]
public async Task Get_SecurePageIsReturnedForAnAuthenticatedUser()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
    {
        builder.ConfigureTestServices(services =&gt;
        {
            services.AddAuthentication(defaultScheme: "TestScheme")
                .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                    "TestScheme", options =&gt; { });
        });
    })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false,
        });

    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue(scheme: "TestScheme");

    //Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.OK));
}
</code></pre>
</div>
<p>For more information on <code>WebApplicationFactoryClientOptions</code>, see the <a href="#client-options" data-linktype="self-bookmark">Client options</a> section.</p>
<h3 id="basic-tests-for-authentication-middleware">Basic tests for authentication middleware</h3>
<p>See <a href="https://github.com/blowdart/idunno.Authentication/tree/dev/test/idunno.Authentication.Basic.Test" data-linktype="external">this GitHub repository</a> for basic tests of authentication middleware. It contains a <a href="https://github.com/blowdart/idunno.Authentication/blob/dev/test/idunno.Authentication.Basic.Test/BasicAuthenticationTests.cs#L331" data-linktype="external">test server</a> that’s specific to the test scenario.</p>
<h2 id="set-the-environment">Set the environment</h2>
<p>Set the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-9.0" data-linktype="relative-path">environment</a> in the custom application factory:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp" highlight-lines="36">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType == 
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp" highlight-lines="36">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp" highlight-lines="36">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<h2 id="how-the-test-infrastructure-infers-the-app-content-root-path">How the test infrastructure infers the app content root path</h2>
<p>The <code>WebApplicationFactory</code> constructor infers the app <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> path by searching for a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryContentRootAttribute</a> on the assembly containing the integration tests with a key equal to the <code>TEntryPoint</code> assembly <code>System.Reflection.Assembly.FullName</code>. In case an attribute with the correct key isn't found, <code>WebApplicationFactory</code> falls back to searching for a solution file (<em>.sln</em>) and appends the <code>TEntryPoint</code> assembly name to the solution directory. The app root directory (the content root path) is used to discover views and content files.</p>
<h2 id="disable-shadow-copying">Disable shadow copying</h2>
<p>Shadow copying causes the tests to execute in a different directory than the output directory. If your tests rely on loading files relative to <code>Assembly.Location</code> and you encounter issues, you might have to disable shadow copying.</p>
<p>To disable shadow copying when using xUnit, create a <code>xunit.runner.json</code> file in your test project directory, with the <a href="https://xunit.net/docs/configuration-files#shadowCopy" data-linktype="external">correct configuration setting</a>:</p>
<pre><code class="lang-json">{
  "shadowCopy": false
}
</code></pre>
<h2 id="disposal-of-objects">Disposal of objects</h2>
<div class="zone has-pivot" data-pivot="xunit">
<p>After the tests of the <code>IClassFixture</code> implementation are executed, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> are disposed when xUnit disposes of the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path"><code>WebApplicationFactory</code></a>. If objects instantiated by the developer require disposal, dispose of them in the <code>IClassFixture</code> implementation. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose" data-linktype="absolute-path">Implementing a Dispose method</a>.</p>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<p>After the tests of the <code>TestClass</code> are executed, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> are disposed when MSTest disposes of the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path"><code>WebApplicationFactory</code></a> in the <code>ClassCleanup</code> method. If objects instantiated by the developer require disposal, dispose of them in the <code>ClassCleanup</code> method. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose" data-linktype="absolute-path">Implementing a Dispose method</a>.</p>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<p>After the tests of the test class are executed, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> are disposed when NUnit disposes of the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path"><code>WebApplicationFactory</code></a> in the <code>TearDown</code> method. If objects instantiated by the developer require disposal, dispose of them in the <code>TearDown</code> method. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose" data-linktype="absolute-path">Implementing a Dispose method</a>.</p>
</div>
<h2 id="integration-tests-sample">Integration tests sample</h2>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/10.x/IntegrationTestsSample" data-linktype="external">sample app</a> is composed of two apps:</p>
<table>
<thead>
<tr>
<th>App</th>
<th>Project directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Message app (the SUT)</td>
<td><code>src/RazorPagesProject</code></td>
<td>Allows a user to add, delete one, delete all, and analyze messages.</td>
</tr>
<tr>
<td>Test app</td>
<td><code>tests/RazorPagesProject.Tests</code></td>
<td>Used to integration test the SUT.</td>
</tr>
</tbody>
</table>
<p>The tests can be run using the built-in test features of an IDE, such as <a href="https://visualstudio.microsoft.com/" data-linktype="external">Visual Studio</a>. If using <a href="https://code.visualstudio.com/" data-linktype="external">Visual Studio Code</a> or the command line, execute the following command at a command prompt in the <code>tests/RazorPagesProject.Tests</code> directory:</p>
<pre><code class="lang-console">dotnet test
</code></pre>
<h3 id="message-app-sut-organization">Message app (SUT) organization</h3>
<p>The SUT is a Razor Pages message system with the following characteristics:</p>
<ul>
<li>The Index page of the app (<code>Pages/Index.cshtml</code> and <code>Pages/Index.cshtml.cs</code>) provides a UI and page model methods to control the addition, deletion, and analysis of messages (average words per message).</li>
<li>A message is described by the <code>Message</code> class (<code>Data/Message.cs</code>) with two properties: <code>Id</code> (key) and <code>Text</code> (message). The <code>Text</code> property is required and limited to 200 characters.</li>
<li>Messages are stored using <a href="https://learn.microsoft.com/en-us/ef/core/providers/in-memory/" data-linktype="absolute-path">Entity Framework's in-memory database</a>†.</li>
<li>The app contains a data access layer (DAL) in its database context class, <code>AppDbContext</code> (<code>Data/AppDbContext.cs</code>).</li>
<li>If the database is empty on app startup, the message store is initialized with three messages.</li>
<li>The app includes a <code>/SecurePage</code> that can only be accessed by an authenticated user.</li>
</ul>
<p>†The EF article, <a href="https://learn.microsoft.com/en-us/ef/core/miscellaneous/testing/in-memory" data-linktype="absolute-path">Test with InMemory</a>, explains how to use an in-memory database for tests with MSTest. This topic uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework. Test concepts and test implementations across different test frameworks are similar but not identical.</p>
<p>Although the app doesn't use the repository pattern and isn't an effective example of the <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" data-linktype="external">Unit of Work (UoW) pattern</a>, Razor Pages supports these patterns of development. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design" data-linktype="absolute-path">Designing the infrastructure persistence layer</a> and <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic</a> (the sample implements the repository pattern).</p>
<h3 id="test-app-organization">Test app organization</h3>
<p>The test app is a console app inside the <code>tests/RazorPagesProject.Tests</code> directory.</p>
<table>
<thead>
<tr>
<th>Test app directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuthTests</code></td>
<td>Contains test methods for:<ul><li>Accessing a secure page by an unauthenticated user.</li><li>Accessing a secure page by an authenticated user with a mock <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a>.</li><li>Obtaining a GitHub user profile and checking the profile's user login.</li></ul></td>
</tr>
<tr>
<td><code>BasicTests</code></td>
<td>Contains a test method for routing and content type.</td>
</tr>
<tr>
<td><code>IntegrationTests</code></td>
<td>Contains the integration tests for the Index page using custom <code>WebApplicationFactory</code> class.</td>
</tr>
<tr>
<td><code>Helpers/Utilities</code></td>
<td><ul><li><code>Utilities.cs</code> contains the <code>InitializeDbForTests</code> method used to seed the database with test data.</li><li><code>HtmlHelpers.cs</code> provides a method to return an AngleSharp <code>IHtmlDocument</code> for use by the test methods.</li><li><code>HttpClientExtensions.cs</code> provide overloads for <code>SendAsync</code> to submit requests to the SUT.</li></ul></td>
</tr>
</tbody>
</table>
<p>The test framework is <a href="https://xunit.net/" data-linktype="external">xUnit</a>. Integration tests are conducted using the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost" class="no-loc" data-linktype="absolute-path">Microsoft.AspNetCore.TestHost</a>, which includes the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>. Because the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package is used to configure the test host and test server, the <code>TestHost</code> and <code>TestServer</code> packages don't require direct package references in the test app's project file or developer configuration in the test app.</p>
<p>Integration tests usually require a small dataset in the database prior to the test execution. For example, a delete test calls for a database record deletion, so the database must have at least one record for the delete request to succeed.</p>
<p>The sample app seeds the database with three messages in <code>Utilities.cs</code> that tests can use when they execute:</p>
<pre><code class="lang-csharp">public static void InitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.AddRange(GetSeedingMessages());
    db.SaveChanges();
}

public static void ReinitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.RemoveRange(db.Messages);
    InitializeDbForTests(db);
}

public static List&lt;Message&gt; GetSeedingMessages()
{
    return new List&lt;Message&gt;()
    {
        new Message(){ Text = "TEST RECORD: You're standing on my scarf." },
        new Message(){ Text = "TEST RECORD: Would you like a jelly baby?" },
        new Message(){ Text = "TEST RECORD: To the rational mind, " +
            "nothing is inexplicable; only unexplained." }
    };
}
</code></pre>
<p>The SUT's database context is registered in <code>Program.cs</code>. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Program.cs</code> code is executed. To use a different database for the tests, the app's database context must be replaced in <code>builder.ConfigureServices</code>. For more information, see the <a href="#customize-webapplicationfactory" data-linktype="self-bookmark">Customize WebApplicationFactory</a> section.</p>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">Unit tests</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests in ASP.NET Core</a></li>
<li><a href="../fundamentals/middleware/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">ASP.NET Core Middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic in ASP.NET Core</a></li>
<li><a href="https://github.com/blowdart/idunno.Authentication/tree/dev/test/idunno.Authentication.Basic.Test" data-linktype="external">Basic tests for authentication middleware</a></li>
</ul>
</div>
<div data-moniker="aspnetcore-3.1 aspnetcore-5.0">
<p>This topic assumes a basic understanding of unit tests. If unfamiliar with test concepts, see the <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">Unit Testing in .NET Core and .NET Standard</a> topic and its linked content.</p>
<p><a href="https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/test/integration-tests/samples" data-linktype="external">View or download sample code</a> (<a href="../overview553c.html?view=aspnetcore-9.0#how-to-download-a-sample" data-linktype="relative-path">how to download</a>)</p>
<p>The sample app is a Razor Pages app and assumes a basic understanding of Razor Pages. If unfamiliar with Razor Pages, see the following topics:</p>
<ul>
<li><a href="../razor-pages/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Introduction to Razor Pages</a></li>
<li><a href="../tutorials/razor-pages/razor-pages-start553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Get started with Razor Pages</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests</a></li>
</ul>
<div class="NOTE">
<p>Note</p>
<p>For testing SPAs, we recommend a tool such as <a href="https://playwright.dev/dotnet/" data-linktype="external">Playwright for .NET</a>, which can automate a browser.</p>
</div>
<h2 id="introduction-to-integration-tests">Introduction to integration tests</h2>
<p>Integration tests evaluate an app's components on a broader level than <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">unit tests</a>. Unit tests are used to test isolated software components, such as individual class methods. Integration tests confirm that two or more app components work together to produce an expected result, possibly including every component required to fully process a request.</p>
<p>These broader tests are used to test the app's infrastructure and whole framework, often including the following components:</p>
<ul>
<li>Database</li>
<li>File system</li>
<li>Network appliances</li>
<li>Request-response pipeline</li>
</ul>
<p>Unit tests use fabricated components, known as <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-best-practices#lets-speak-the-same-language" data-linktype="absolute-path"><em>fakes</em> or <em>mock objects</em></a>, in place of infrastructure components.</p>
<p>In contrast to unit tests, integration tests:</p>
<ul>
<li>Use the actual components that the app uses in production.</li>
<li>Require more code and data processing.</li>
<li>Take longer to run.</li>
</ul>
<p>Therefore, limit the use of integration tests to the most important infrastructure scenarios. If a behavior can be tested using either a unit test or an integration test, choose the unit test.</p>
<p>In discussions of integration tests, the tested project is frequently called the <em><strong>System Under Test</strong></em>, or "<strong>SUT</strong>" for short. "SUT" is used throughout this article to refer to the ASP.NET Core app being tested.</p>
<p><em><strong>Don't write integration tests for every permutation</strong></em> of data and file access with databases and file systems. Regardless of how many places across an app interact with databases and file systems, a focused set of read, write, update, and delete integration tests are usually capable of adequately testing database and file system components. Use unit tests for routine tests of method logic that interact with these components. In unit tests, the use of infrastructure fakes or mocks result in faster test execution.</p>
<h2 id="aspnet-core-integration-tests">ASP.NET Core integration tests</h2>
<p>Integration tests in ASP.NET Core require the following:</p>
<ul>
<li>A test project is used to contain and execute the tests. The test project has a reference to the SUT.</li>
<li>The test project creates a test web host for the SUT and uses a test server client to handle requests and responses with the SUT.</li>
<li>A test runner is used to execute the tests and report the test results.</li>
</ul>
<p>Integration tests follow a sequence of events that include the usual <em>Arrange</em>, <em>Act</em>, and <em>Assert</em> test steps:</p>
<ol>
<li>The SUT's web host is configured.</li>
<li>A test server client is created to submit requests to the app.</li>
<li>The <em>Arrange</em> test step is executed: The test app prepares a request.</li>
<li>The <em>Act</em> test step is executed: The client submits the request and receives the response.</li>
<li>The <em>Assert</em> test step is executed: The <em>actual</em> response is validated as a <em>pass</em> or <em>fail</em> based on an <em>expected</em> response.</li>
<li>The process continues until all of the tests are executed.</li>
<li>The test results are reported.</li>
</ol>
<p>Usually, the test web host is configured differently than the app's normal web host for the test runs. For example, a different database or different app settings might be used for the tests.</p>
<p>Infrastructure components, such as the test web host and in-memory test server (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>), are provided or managed by the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external">Microsoft.AspNetCore.Mvc.Testing</a> package. Use of this package streamlines test creation and execution.</p>
<p>The <code>Microsoft.AspNetCore.Mvc.Testing</code> package handles the following tasks:</p>
<ul>
<li>Copies the dependencies file (<code>.deps</code>) from the SUT into the test project's <code>bin</code> directory.</li>
<li>Sets the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> to the SUT's project root so that static files and pages/views are found when the tests are executed.</li>
<li>Provides the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path">WebApplicationFactory</a> class to streamline bootstrapping the SUT with <code>TestServer</code>.</li>
</ul>
<p>The <a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">unit tests</a> documentation describes how to set up a test project and test runner, along with detailed instructions on how to run tests and recommendations for how to name tests and test classes.</p>
<p><strong>Separate unit tests from integration tests into different projects</strong>. Separating the tests:</p>
<ul>
<li>Helps ensure that infrastructure testing components aren't accidentally included in the unit tests.</li>
<li>Allows control over which set of tests are run.</li>
</ul>
<p>There's virtually no difference between the configuration for tests of Razor Pages apps and MVC apps. The only difference is in how the tests are named. In a Razor Pages app, tests of page endpoints are usually named after the page model class (for example, <code>IndexPageTests</code> to test component integration for the Index page). In an MVC app, tests are usually organized by controller classes and named after the controllers they test (for example, <code>HomeControllerTests</code> to test component integration for the Home controller).</p>
<h2 id="test-app-prerequisites">Test app prerequisites</h2>
<p>The test project must:</p>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package.</li>
<li>Specify the Web SDK in the project file (<code>&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;</code>).</li>
</ul>
<p>These prerequisites can be seen in the <a href="https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/test/integration-tests/samples/" data-linktype="external">sample app</a>. Inspect the <code>tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj</code> file. The sample app uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework and the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser library, so the sample app also references:</p>
<ul>
<li><a href="https://www.nuget.org/packages/AngleSharp" data-linktype="external"><code>AngleSharp</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit" data-linktype="external"><code>xunit</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a></li>
</ul>
<p>In apps that use <a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a> version 2.4.2 or later, the test project must reference the <a href="https://www.nuget.org/packages/Microsoft.NET.Test.Sdk" data-linktype="external"><code>Microsoft.NET.Test.Sdk</code></a> package.</p>
<p>Entity Framework Core is also used in the tests. The app references:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore" data-linktype="external"><code>Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore</code></a></li>
<li><a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Identity.EntityFrameworkCore" data-linktype="external"><code>Microsoft.AspNetCore.Identity.EntityFrameworkCore</code></a></li>
<li><a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore" data-linktype="external"><code>Microsoft.EntityFrameworkCore</code></a></li>
<li><a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.InMemory" data-linktype="external"><code>Microsoft.EntityFrameworkCore.InMemory</code></a></li>
<li><a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.Tools" data-linktype="external"><code>Microsoft.EntityFrameworkCore.Tools</code></a></li>
</ul>
<h2 id="sut-environment">SUT environment</h2>
<p>If the SUT's <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-9.0" data-linktype="relative-path">environment</a> isn't set, the environment defaults to Development.</p>
<h2 id="basic-tests-with-the-default-webapplicationfactory">Basic tests with the default WebApplicationFactory</h2>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" class="no-loc" data-linktype="absolute-path">WebApplicationFactory&lt;TEntryPoint&gt;</a> is used to create a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> for the integration tests. <code>TEntryPoint</code> is the entry point class of the SUT, usually the <code>Startup</code> class.</p>
<p>Test classes implement a <em>class fixture</em> interface (<a href="https://xunit.net/docs/shared-context#class-fixture" data-linktype="external"><code>IClassFixture</code></a>) to indicate the class contains tests and provide shared object instances across the tests in the class.</p>
<p>The following test class, <code>BasicTests</code>, uses the <code>WebApplicationFactory</code> to bootstrap the SUT and provide an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> to a test method, <code>Get_EndpointsReturnSuccessAndCorrectContentType</code>. The method checks if the response status code is successful (status codes in the range 200-299) and the <code>Content-Type</code> header is <code>text/html; charset=utf-8</code> for several app pages.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> creates an instance of <code>HttpClient</code> that automatically follows redirects and handles cookies.</p>
<pre><code class="lang-csharp">public class BasicTests 
    : IClassFixture&lt;WebApplicationFactory&lt;RazorPagesProject.Startup&gt;&gt;
{
    private readonly WebApplicationFactory&lt;RazorPagesProject.Startup&gt; _factory;

    public BasicTests(WebApplicationFactory&lt;RazorPagesProject.Startup&gt; factory)
    {
        _factory = factory;
    }

    [Theory]
    [InlineData("/")]
    [InlineData("/Index")]
    [InlineData("/About")]
    [InlineData("/Privacy")]
    [InlineData("/Contact")]
    public async Task Get_EndpointsReturnSuccessAndCorrectContentType(string url)
    {
        // Arrange
        var client = _factory.CreateClient();

        // Act
        var response = await client.GetAsync(url);

        // Assert
        response.EnsureSuccessStatusCode(); // Status Code 200-299
        Assert.Equal("text/html; charset=utf-8", 
            response.Content.Headers.ContentType.ToString());
    }
}
</code></pre>
<p>By default, non-essential cookies aren't preserved across requests when the <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0" data-linktype="relative-path">GDPR consent policy</a> is enabled. To preserve non-essential cookies, such as those used by the TempData provider, mark them as essential in your tests. For instructions on marking a cookie as essential, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0#essential-cookies" data-linktype="relative-path">Essential cookies</a>.</p>
<h2 id="customize-webapplicationfactory">Customize WebApplicationFactory</h2>
<p>Web host configuration can be created independently of the test classes by inheriting from <code>WebApplicationFactory</code> to create one or more custom factories:</p>
<ol>
<li><p>Inherit from <code>WebApplicationFactory</code> and override <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost" class="no-loc" data-linktype="absolute-path">ConfigureWebHost</a>. The <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> allows the configuration of the service collection with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.istartup.configureservices" class="no-loc" data-linktype="absolute-path">ConfigureServices</a>:</p>
<pre><code class="lang-csharp">public class CustomWebApplicationFactory&lt;TStartup&gt;
    : WebApplicationFactory&lt;TStartup&gt; where TStartup: class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var descriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbContextOptions&lt;ApplicationDbContext&gt;));

            services.Remove(descriptor);

            services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;
            {
                options.UseInMemoryDatabase("InMemoryDbForTesting");
            });

            var sp = services.BuildServiceProvider();

            using (var scope = sp.CreateScope())
            {
                var scopedServices = scope.ServiceProvider;
                var db = scopedServices.GetRequiredService&lt;ApplicationDbContext&gt;();
                var logger = scopedServices
                    .GetRequiredService&lt;ILogger&lt;CustomWebApplicationFactory&lt;TStartup&gt;&gt;&gt;();

                db.Database.EnsureCreated();

                try
                {
                    Utilities.InitializeDbForTests(db);
                }
                catch (Exception ex)
                {
                    logger.LogError(ex, "An error occurred seeding the " +
                        "database with test messages. Error: {Message}", ex.Message);
                }
            }
        });
    }
}
</code></pre>
<p>Database seeding in the <a href="https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/test/integration-tests/samples" data-linktype="external">sample app</a> is performed by the <code>InitializeDbForTests</code> method. The method is described in the <a href="#test-app-organization" data-linktype="self-bookmark">Integration tests sample: Test app organization</a> section.</p>
<p>The SUT's database context is registered in its <code>Startup.ConfigureServices</code> method. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Startup.ConfigureServices</code> code is executed. The execution order is a breaking change for the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-9.0" data-linktype="relative-path">Generic Host</a> with the release of ASP.NET Core 3.0. To use a different database for the tests than the app's database, the app's database context must be replaced in <code>builder.ConfigureServices</code>.</p>
<p>For SUTs that still use the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/web-host?view=aspnetcore-9.0" data-linktype="relative-path">Web Host</a>, the test app's <code>builder.ConfigureServices</code> callback is executed <em>before</em> the SUT's <code>Startup.ConfigureServices</code> code. The test app's <code>builder.ConfigureTestServices</code> callback is executed <em>after</em>.</p>
<p>The sample app finds the service descriptor for the database context and uses the descriptor to remove the service registration. Next, the factory adds a new <code>ApplicationDbContext</code> that uses an in-memory database for the tests.</p>
<p>To connect to a different database than the in-memory database, change the <code>UseInMemoryDatabase</code> call to connect the context to a different database. To use a SQL Server test database:</p>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/" data-linktype="external"><code>Microsoft.EntityFrameworkCore.SqlServer</code></a> NuGet package in the project file.</li>
<li>Call <code>UseSqlServer</code> with a connection string to the database.</li>
</ul>
<pre><code class="lang-csharp">services.AddDbContext&lt;ApplicationDbContext&gt;((options, context) =&gt; 
{
    context.UseSqlServer(
        Configuration.GetConnectionString("TestingDbConnectionString"));
});
</code></pre>
</li>
<li><p>Use the custom <code>CustomWebApplicationFactory</code> in test classes. The following example uses the factory in the <code>IndexPageTests</code> class:</p>
<pre><code class="lang-csharp">public class IndexPageTests : 
    IClassFixture&lt;CustomWebApplicationFactory&lt;RazorPagesProject.Startup&gt;&gt;
{
    private readonly HttpClient _client;
    private readonly CustomWebApplicationFactory&lt;RazorPagesProject.Startup&gt; 
        _factory;

    public IndexPageTests(
        CustomWebApplicationFactory&lt;RazorPagesProject.Startup&gt; factory)
    {
        _factory = factory;
        _client = factory.CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false
            });
    }
</code></pre>
<p>The sample app's client is configured to prevent the <code>HttpClient</code> from following redirects. As explained later in the <a href="#mock-authentication" data-linktype="self-bookmark">Mock authentication</a> section, this permits tests to check the result of the app's first response. The first response is a redirect in many of these tests with a <code>Location</code> header.</p>
</li>
<li><p>A typical test uses the <code>HttpClient</code> and helper methods to process the request and the response:</p>
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteAllMessagesHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("button[id='deleteAllBtn']"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre></li>
</ol>
<p>Any POST request to the SUT must satisfy the antiforgery check that's automatically made by the app's <a href="../security/data-protection/introduction553c.html?view=aspnetcore-9.0" data-linktype="relative-path">data protection antiforgery system</a>. In order to arrange for a test's POST request, the test app must:</p>
<ol>
<li>Make a request for the page.</li>
<li>Parse the antiforgery cookie and request validation token from the response.</li>
<li>Make the POST request with the antiforgery cookie and request validation token in place.</li>
</ol>
<p>The <code>SendAsync</code> helper extension methods (<code>Helpers/HttpClientExtensions.cs</code>) and the <code>GetDocumentAsync</code> helper method (<code>Helpers/HtmlHelpers.cs</code>) in the <a href="https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/test/integration-tests/samples/" data-linktype="external">sample app</a> use the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser to handle the antiforgery check with the following methods:</p>
<ul>
<li><code>GetDocumentAsync</code>: Receives the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpresponsemessage" class="no-loc" data-linktype="absolute-path">HttpResponseMessage</a> and returns an <code>IHtmlDocument</code>. <code>GetDocumentAsync</code> uses a factory that prepares a <em>virtual response</em> based on the original <code>HttpResponseMessage</code>. For more information, see the <a href="https://github.com/AngleSharp/AngleSharp#documentation" data-linktype="external">AngleSharp documentation</a>.</li>
<li><code>SendAsync</code> extension methods for the <code>HttpClient</code> compose an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httprequestmessage" class="no-loc" data-linktype="absolute-path">HttpRequestMessage</a> and call <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient.sendasync#system-net-http-httpclient-sendasync(system-net-http-httprequestmessage)" class="no-loc" data-linktype="absolute-path">SendAsync(HttpRequestMessage)</a> to submit requests to the SUT. Overloads for <code>SendAsync</code> accept the HTML form (<code>IHtmlFormElement</code>) and the following:
<ul>
<li>Submit button of the form (<code>IHtmlElement</code>)</li>
<li>Form values collection (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
<li>Submit button (<code>IHtmlElement</code>) and form values (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
</ul>
</li>
</ul>
<div class="NOTE">
<p>Note</p>
<p><a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> is a third-party parsing library used for demonstration purposes in this topic and the sample app. AngleSharp isn't supported or required for integration testing of ASP.NET Core apps. Other parsers can be used, such as the <a href="https://html-agility-pack.net/" data-linktype="external">Html Agility Pack (HAP)</a>. Another approach is to write code to handle the antiforgery system's request verification token and antiforgery cookie directly.</p>
</div>
<div class="NOTE">
<p>Note</p>
<p>The <a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#in-memory-as-a-database-fake" data-linktype="absolute-path">EF-Core in-memory database provider</a> can be used for limited and basic testing, however the <a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#sqlite-as-a-database-fake" data-linktype="absolute-path">SQLite provider</a> is the recommended choice for in-memory testing.</p>
</div>
<h2 id="customize-the-client-with-withwebhostbuilder">Customize the client with WithWebHostBuilder</h2>
<p>When additional configuration is required within a test method, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder" class="no-loc" data-linktype="absolute-path">WithWebHostBuilder</a> creates a new <code>WebApplicationFactory</code> with an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> that is further customized by configuration.</p>
<p>The <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> test method of the <a href="https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/test/integration-tests/samples" data-linktype="external">sample app</a> demonstrates the use of <code>WithWebHostBuilder</code>. This test performs a record delete in the database by triggering a form submission in the SUT.</p>
<p>Because another test in the <code>IndexPageTests</code> class performs an operation that deletes all of the records in the database and may run before the <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> method, the database is reseeded in this test method to ensure that a record is present for the SUT to delete. Selecting the first delete button of the <code>messages</code> form in the SUT is simulated in the request to the SUT:</p>
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteMessageHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureServices(services =&gt;
            {
                var serviceProvider = services.BuildServiceProvider();

                using (var scope = serviceProvider.CreateScope())
                {
                    var scopedServices = scope.ServiceProvider;
                    var db = scopedServices
                        .GetRequiredService&lt;ApplicationDbContext&gt;();
                    var logger = scopedServices
                        .GetRequiredService&lt;ILogger&lt;IndexPageTests&gt;&gt;();

                    try
                    {
                        Utilities.ReinitializeDbForTests(db);
                    }
                    catch (Exception ex)
                    {
                        logger.LogError(ex, "An error occurred seeding " +
                            "the database with test messages. Error: {Message}", 
                            ex.Message);
                    }
                }
            });
        })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("form[id='messages']")
            .QuerySelector("div[class='panel-body']")
            .QuerySelector("button"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre><h2 id="client-options">Client options</h2>
<p>The following table shows the default <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> available when creating <code>HttpClient</code> instances.</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect#microsoft-aspnetcore-mvc-testing-webapplicationfactoryclientoptions-allowautoredirect" class="no-loc" data-linktype="absolute-path">AllowAutoRedirect</a></td>
<td>Gets or sets whether or not <code>HttpClient</code> instances should automatically follow redirect responses.</td>
<td><code>true</code></td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.baseaddress#microsoft-aspnetcore-mvc-testing-webapplicationfactoryclientoptions-baseaddress" class="no-loc" data-linktype="absolute-path">BaseAddress</a></td>
<td>Gets or sets the base address of <code>HttpClient</code> instances.</td>
<td><code>http://localhost</code></td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.handlecookies#microsoft-aspnetcore-mvc-testing-webapplicationfactoryclientoptions-handlecookies" class="no-loc" data-linktype="absolute-path">HandleCookies</a></td>
<td>Gets or sets whether <code>HttpClient</code> instances should handle cookies.</td>
<td><code>true</code></td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.maxautomaticredirections#microsoft-aspnetcore-mvc-testing-webapplicationfactoryclientoptions-maxautomaticredirections" class="no-loc" data-linktype="absolute-path">MaxAutomaticRedirections</a></td>
<td>Gets or sets the maximum number of redirect responses that <code>HttpClient</code> instances should follow.</td>
<td>7</td>
</tr>
</tbody>
</table>
<p>Create the <code>WebApplicationFactoryClientOptions</code> class and pass it to the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> method (default values are shown in the code example):</p>
<pre><code class="lang-csharp">// Default client option values are shown
var clientOptions = new WebApplicationFactoryClientOptions();
clientOptions.AllowAutoRedirect = true;
clientOptions.BaseAddress = new Uri("http://localhost");
clientOptions.HandleCookies = true;
clientOptions.MaxAutomaticRedirections = 7;

_client = _factory.CreateClient(clientOptions);
</code></pre>
<h2 id="inject-mock-services">Inject mock services</h2>
<p>Services can be overridden in a test with a call to <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> on the host builder. <strong>To inject mock services, the SUT must have a <code>Startup</code> class with a <code>Startup.ConfigureServices</code> method.</strong></p>
<p>The sample SUT includes a scoped service that returns a quote. The quote is embedded in a hidden field on the Index page when the Index page is requested.</p>
<p><code>Services/IQuoteService.cs</code>:</p>
<pre><code class="lang-csharp">public interface IQuoteService
{
    Task&lt;string&gt; GenerateQuote();
}
</code></pre>
<p><code>Services/QuoteService.cs</code>:</p>
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Dr. Who: Planet of Evil
// https://www.bbc.co.uk/programmes/p00pyrx6
public class QuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult&lt;string&gt;(
            "Come on, Sarah. We've an appointment in London, " +
            "and we're already 30,000 years late.");
    }
}
</code></pre>
<p><code>Startup.cs</code>:</p>
<pre><code class="lang-csharp">services.AddScoped&lt;IQuoteService, QuoteService&gt;();
</code></pre>
<p><code>Pages/Index.cshtml.cs</code>:</p>
<pre><code class="lang-csharp" highlight-lines="4,9,20,26">public class IndexModel : PageModel
{
    private readonly ApplicationDbContext _db;
    private readonly IQuoteService _quoteService;

    public IndexModel(ApplicationDbContext db, IQuoteService quoteService)
    {
        _db = db;
        _quoteService = quoteService;
    }

    [BindProperty]
    public Message Message { get; set; }

    public IList&lt;Message&gt; Messages { get; private set; }

    [TempData]
    public string MessageAnalysisResult { get; set; }

    public string Quote { get; private set; }

    public async Task OnGetAsync()
    {
        Messages = await _db.GetMessagesAsync();

        Quote = await _quoteService.GenerateQuote();
    }
</code></pre>
<p><code>Pages/Index.cs</code>:</p>
<pre><code class="lang-cshtml">&lt;input id="quote" type="hidden" value="@Model.Quote"&gt;
</code></pre>
<p>The following markup is generated when the SUT app is run:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Come on, Sarah. We&amp;#x27;ve an appointment in 
    London, and we&amp;#x27;re already 30,000 years late."&gt;
</code></pre>
<p>To test the service and quote injection in an integration test, a mock service is injected into the SUT by the test. The mock service replaces the app's <code>QuoteService</code> with a service provided by the test app, called <code>TestQuoteService</code>:</p>
<p><code>IntegrationTests.IndexPageTests.cs</code>:</p>
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Pyramids of Mars
// https://www.bbc.co.uk/programmes/p00pys55
public class TestQuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult&lt;string&gt;(
            "Something's interfering with time, Mr. Scarman, " +
            "and time is my business.");
    }
}
</code></pre>
<p><code>ConfigureTestServices</code> is called, and the scoped service is registered:</p>
<pre><code class="lang-csharp" highlight-lines="7-10,17,20-21">[Fact]
public async Task Get_QuoteService_ProvidesQuoteInPage()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddScoped&lt;IQuoteService, TestQuoteService&gt;();
            });
        })
        .CreateClient();

    //Act
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);
    var quoteElement = content.QuerySelector("#quote");

    // Assert
    Assert.Equal("Something's interfering with time, Mr. Scarman, " +
        "and time is my business.", quoteElement.Attributes["value"].Value);
}
</code></pre>
<p>The markup produced during the test's execution reflects the quote text supplied by <code>TestQuoteService</code>, thus the assertion passes:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Something&amp;#x27;s interfering with time, 
    Mr. Scarman, and time is my business."&gt;
</code></pre>
<h2 id="mock-authentication">Mock authentication</h2>
<p>Tests in the <code>AuthTests</code> class check that a secure endpoint:</p>
<ul>
<li>Redirects an unauthenticated user to the app's Login page.</li>
<li>Returns content for an authenticated user.</li>
</ul>
<p>In the SUT, the <code>/SecurePage</code> page uses an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage" class="no-loc" data-linktype="absolute-path">AuthorizePage</a> convention to apply an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter" class="no-loc" data-linktype="absolute-path">AuthorizeFilter</a> to the page. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authorization/razor-pages-authorization?view=aspnetcore-9.0#require-authorization-to-access-a-page" data-linktype="relative-path">Razor Pages authorization conventions</a>.</p>
<pre><code class="lang-csharp">services.AddRazorPages(options =&gt;
{
    options.Conventions.AuthorizePage("/SecurePage");
});
</code></pre>
<p>In the <code>Get_SecurePageRedirectsAnUnauthenticatedUser</code> test, a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> is set to disallow redirects by setting <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect#microsoft-aspnetcore-mvc-testing-webapplicationfactoryclientoptions-allowautoredirect" class="no-loc" data-linktype="absolute-path">AllowAutoRedirect</a> to <code>false</code>:</p>
<pre><code class="lang-csharp">[Fact]
public async Task Get_SecurePageRedirectsAnUnauthenticatedUser()
{
    // Arrange
    var client = _factory.CreateClient(
        new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });

    // Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.StartsWith("http://localhost/Identity/Account/Login", 
        response.Headers.Location.OriginalString);
}
</code></pre>
<p>By disallowing the client to follow the redirect, the following checks can be made:</p>
<ul>
<li>The status code returned by the SUT can be checked against the expected <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-redirect" class="no-loc" data-linktype="absolute-path">HttpStatusCode.Redirect</a> result, not the final status code after the redirect to the Login page, which would be <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-ok" class="no-loc" data-linktype="absolute-path">HttpStatusCode.OK</a>.</li>
<li>The <code>Location</code> header value in the response headers is checked to confirm that it starts with <code>http://localhost/Identity/Account/Login</code>, not the final Login page response, where the <code>Location</code> header wouldn't be present.</li>
</ul>
<p>The test app can mock an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a> in <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> in order to test aspects of authentication and authorization. A minimal scenario returns an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticateresult.success" class="no-loc" data-linktype="absolute-path">AuthenticateResult.Success</a>:</p>
<pre><code class="lang-csharp" highlight-lines="11-18">public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options, 
        ILoggerFactory logger, UrlEncoder encoder, ISystemClock clock)
        : base(options, logger, encoder, clock)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[] { new Claim(ClaimTypes.Name, "Test user") };
        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "Test");

        var result = AuthenticateResult.Success(ticket);

        return Task.FromResult(result);
    }
}
</code></pre>
<p>The <code>TestAuthHandler</code> is called to authenticate a user when the authentication scheme is set to <code>Test</code> where <code>AddAuthentication</code> is registered for <code>ConfigureTestServices</code>. It's important for the <code>Test</code> scheme to match the scheme your app expects. Otherwise, authentication won't work.</p>
<pre><code class="lang-csharp" highlight-lines="7-12">[Fact]
public async Task Get_SecurePageIsReturnedForAnAuthenticatedUser()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddAuthentication("Test")
                    .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                        "Test", options =&gt; {});
            });
        })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false,
        });

    client.DefaultRequestHeaders.Authorization = 
        new AuthenticationHeaderValue("Test");

    //Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.OK, response.StatusCode);
}
</code></pre>
<p>For more information on <code>WebApplicationFactoryClientOptions</code>, see the <a href="#client-options" data-linktype="self-bookmark">Client options</a> section.</p>
<h2 id="set-the-environment">Set the environment</h2>
<p>By default, the SUT's host and app environment is configured to use the Development environment. To override the SUT's environment when using <code>IHostBuilder</code>:</p>
<ul>
<li>Set the <code>ASPNETCORE_ENVIRONMENT</code> environment variable (for example, <code>Staging</code>, <code>Production</code>, or other custom value, such as <code>Testing</code>).</li>
<li>Override <code>CreateHostBuilder</code> in the test app to read environment variables prefixed with <code>ASPNETCORE</code>.</li>
</ul>
<pre><code class="lang-csharp">protected override IHostBuilder CreateHostBuilder() =&gt;
    base.CreateHostBuilder()
        .ConfigureHostConfiguration(
            config =&gt; config.AddEnvironmentVariables("ASPNETCORE"));
</code></pre>
<p>If the SUT uses the Web Host (<code>IWebHostBuilder</code>), override <code>CreateWebHostBuilder</code>:</p>
<pre><code class="lang-csharp">protected override IWebHostBuilder CreateWebHostBuilder() =&gt;
    base.CreateWebHostBuilder().UseEnvironment("Testing");
</code></pre>
<h2 id="how-the-test-infrastructure-infers-the-app-content-root-path">How the test infrastructure infers the app content root path</h2>
<p>The <code>WebApplicationFactory</code> constructor infers the app <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> path by searching for a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryContentRootAttribute</a> on the assembly containing the integration tests with a key equal to the <code>TEntryPoint</code> assembly <code>System.Reflection.Assembly.FullName</code>. In case an attribute with the correct key isn't found, <code>WebApplicationFactory</code> falls back to searching for a solution file (<em>.sln</em>) and appends the <code>TEntryPoint</code> assembly name to the solution directory. The app root directory (the content root path) is used to discover views and content files.</p>
<h2 id="disable-shadow-copying">Disable shadow copying</h2>
<p>Shadow copying causes the tests to execute in a different directory than the output directory. If your tests rely on loading files relative to <code>Assembly.Location</code> and you encounter issues, you might have to disable shadow copying.</p>
<p>To disable shadow copying when using xUnit, create a <code>xunit.runner.json</code> file in your test project directory, with the <a href="https://xunit.net/docs/configuration-files#shadowCopy" data-linktype="external">correct configuration setting</a>:</p>
<pre><code class="lang-json">{
  "shadowCopy": false
}
</code></pre>
<h2 id="disposal-of-objects">Disposal of objects</h2>
<p>After the tests of the <code>IClassFixture</code> implementation are executed, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> are disposed when xUnit disposes of the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path"><code>WebApplicationFactory</code></a>. If objects instantiated by the developer require disposal, dispose of them in the <code>IClassFixture</code> implementation. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose" data-linktype="absolute-path">Implementing a Dispose method</a>.</p>
<h2 id="integration-tests-sample">Integration tests sample</h2>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/test/integration-tests/samples" data-linktype="external">sample app</a> is composed of two apps:</p>
<table>
<thead>
<tr>
<th>App</th>
<th>Project directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Message app (the SUT)</td>
<td><code>src/RazorPagesProject</code></td>
<td>Allows a user to add, delete one, delete all, and analyze messages.</td>
</tr>
<tr>
<td>Test app</td>
<td><code>tests/RazorPagesProject.Tests</code></td>
<td>Used to integration test the SUT.</td>
</tr>
</tbody>
</table>
<p>The tests can be run using the built-in test features of an IDE, such as <a href="https://visualstudio.microsoft.com/" data-linktype="external">Visual Studio</a>. If using <a href="https://code.visualstudio.com/" data-linktype="external">Visual Studio Code</a> or the command line, execute the following command at a command prompt in the <code>tests/RazorPagesProject.Tests</code> directory:</p>
<pre><code class="lang-console">dotnet test
</code></pre>
<h3 id="message-app-sut-organization">Message app (SUT) organization</h3>
<p>The SUT is a Razor Pages message system with the following characteristics:</p>
<ul>
<li>The Index page of the app (<code>Pages/Index.cshtml</code> and <code>Pages/Index.cshtml.cs</code>) provides a UI and page model methods to control the addition, deletion, and analysis of messages (average words per message).</li>
<li>A message is described by the <code>Message</code> class (<code>Data/Message.cs</code>) with two properties: <code>Id</code> (key) and <code>Text</code> (message). The <code>Text</code> property is required and limited to 200 characters.</li>
<li>Messages are stored using <a href="https://learn.microsoft.com/en-us/ef/core/providers/in-memory/" data-linktype="absolute-path">Entity Framework's in-memory database</a>†.</li>
<li>The app contains a data access layer (DAL) in its database context class, <code>AppDbContext</code> (<code>Data/AppDbContext.cs</code>).</li>
<li>If the database is empty on app startup, the message store is initialized with three messages.</li>
<li>The app includes a <code>/SecurePage</code> that can only be accessed by an authenticated user.</li>
</ul>
<p>†The EF topic, <a href="https://learn.microsoft.com/en-us/ef/core/miscellaneous/testing/in-memory" data-linktype="absolute-path">Test with InMemory</a>, explains how to use an in-memory database for tests with MSTest. This topic uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework. Test concepts and test implementations across different test frameworks are similar but not identical.</p>
<p>Although the app doesn't use the repository pattern and isn't an effective example of the <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" data-linktype="external">Unit of Work (UoW) pattern</a>, Razor Pages supports these patterns of development. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design" data-linktype="absolute-path">Designing the infrastructure persistence layer</a> and <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic</a> (the sample implements the repository pattern).</p>
<h3 id="test-app-organization">Test app organization</h3>
<p>The test app is a console app inside the <code>tests/RazorPagesProject.Tests</code> directory.</p>
<table>
<thead>
<tr>
<th>Test app directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuthTests</code></td>
<td>Contains test methods for:<ul><li>Accessing a secure page by an unauthenticated user.</li><li>Accessing a secure page by an authenticated user with a mock <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a>.</li><li>Obtaining a GitHub user profile and checking the profile's user login.</li></ul></td>
</tr>
<tr>
<td><code>BasicTests</code></td>
<td>Contains a test method for routing and content type.</td>
</tr>
<tr>
<td><code>IntegrationTests</code></td>
<td>Contains the integration tests for the Index page using custom <code>WebApplicationFactory</code> class.</td>
</tr>
<tr>
<td><code>Helpers/Utilities</code></td>
<td><ul><li><code>Utilities.cs</code> contains the <code>InitializeDbForTests</code> method used to seed the database with test data.</li><li><code>HtmlHelpers.cs</code> provides a method to return an AngleSharp <code>IHtmlDocument</code> for use by the test methods.</li><li><code>HttpClientExtensions.cs</code> provide overloads for <code>SendAsync</code> to submit requests to the SUT.</li></ul></td>
</tr>
</tbody>
</table>
<p>The test framework is <a href="https://xunit.net/" data-linktype="external">xUnit</a>. Integration tests are conducted using the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost" class="no-loc" data-linktype="absolute-path">Microsoft.AspNetCore.TestHost</a>, which includes the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>. Because the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package is used to configure the test host and test server, the <code>TestHost</code> and <code>TestServer</code> packages don't require direct package references in the test app's project file or developer configuration in the test app.</p>
<p>Integration tests usually require a small dataset in the database prior to the test execution. For example, a delete test calls for a database record deletion, so the database must have at least one record for the delete request to succeed.</p>
<p>The sample app seeds the database with three messages in <code>Utilities.cs</code> that tests can use when they execute:</p>
<pre><code class="lang-csharp">public static void InitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.AddRange(GetSeedingMessages());
    db.SaveChanges();
}

public static void ReinitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.RemoveRange(db.Messages);
    InitializeDbForTests(db);
}

public static List&lt;Message&gt; GetSeedingMessages()
{
    return new List&lt;Message&gt;()
    {
        new Message(){ Text = "TEST RECORD: You're standing on my scarf." },
        new Message(){ Text = "TEST RECORD: Would you like a jelly baby?" },
        new Message(){ Text = "TEST RECORD: To the rational mind, " +
            "nothing is inexplicable; only unexplained." }
    };
}
</code></pre>
<p>The SUT's database context is registered in its <code>Startup.ConfigureServices</code> method. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Startup.ConfigureServices</code> code is executed. To use a different database for the tests, the app's database context must be replaced in <code>builder.ConfigureServices</code>. For more information, see the <a href="#customize-webapplicationfactory" data-linktype="self-bookmark">Customize WebApplicationFactory</a> section.</p>
<p>For SUTs that still use the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/web-host?view=aspnetcore-9.0" data-linktype="relative-path">Web Host</a>, the test app's <code>builder.ConfigureServices</code> callback is executed <em>before</em> the SUT's <code>Startup.ConfigureServices</code> code. The test app's <code>builder.ConfigureTestServices</code> callback is executed <em>after</em>.</p>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">Unit tests</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests in ASP.NET Core</a></li>
<li><a href="../fundamentals/middleware/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">ASP.NET Core Middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic in ASP.NET Core</a></li>
</ul>
</div>
<div data-moniker="aspnetcore-6.0 aspnetcore-7.0">
<p>This article assumes a basic understanding of unit tests. If unfamiliar with test concepts, see the <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">Testing in .NET</a> article and its linked content.</p>
<p><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/7.x/IntegrationTestsSample" data-linktype="external">View or download sample code</a> (<a href="../overview553c.html?view=aspnetcore-9.0#how-to-download-a-sample" data-linktype="relative-path">how to download</a>)</p>
<p>The sample app is a Razor Pages app and assumes a basic understanding of Razor Pages. If you're unfamiliar with Razor Pages, see the following articles:</p>
<ul>
<li><a href="../razor-pages/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Introduction to Razor Pages</a></li>
<li><a href="../tutorials/razor-pages/razor-pages-start553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Get started with Razor Pages</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests</a></li>
</ul>
<p><strong>For testing SPAs</strong>, we recommend a tool such as <a href="https://playwright.dev/dotnet/" data-linktype="external">Playwright for .NET</a>, which can automate a browser.</p>
<h2 id="introduction-to-integration-tests">Introduction to integration tests</h2>
<p>Integration tests evaluate an app's components on a broader level than <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">unit tests</a>. Unit tests are used to test isolated software components, such as individual class methods. Integration tests confirm that two or more app components work together to produce an expected result, possibly including every component required to fully process a request.</p>
<p>These broader tests are used to test the app's infrastructure and whole framework, often including the following components:</p>
<ul>
<li>Database</li>
<li>File system</li>
<li>Network appliances</li>
<li>Request-response pipeline</li>
</ul>
<p>Unit tests use fabricated components, known as <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-best-practices#lets-speak-the-same-language" data-linktype="absolute-path"><em>fakes</em> or <em>mock objects</em></a>, in place of infrastructure components.</p>
<p>In contrast to unit tests, integration tests:</p>
<ul>
<li>Use the actual components that the app uses in production.</li>
<li>Require more code and data processing.</li>
<li>Take longer to run.</li>
</ul>
<p>Therefore, limit the use of integration tests to the most important infrastructure scenarios. If a behavior can be tested using either a unit test or an integration test, choose the unit test.</p>
<p>In discussions of integration tests, the tested project is frequently called the <em><strong>System Under Test</strong></em>, or "<strong>SUT</strong>" for short. "SUT" is used throughout this article to refer to the ASP.NET Core app being tested.</p>
<p><em><strong>Don't write integration tests for every permutation</strong></em> of data and file access with databases and file systems. Regardless of how many places across an app interact with databases and file systems, a focused set of read, write, update, and delete integration tests are usually capable of adequately testing database and file system components. Use unit tests for routine tests of method logic that interact with these components. In unit tests, the use of infrastructure fakes or mocks result in faster test execution.</p>
<h2 id="aspnet-core-integration-tests">ASP.NET Core integration tests</h2>
<p>Integration tests in ASP.NET Core require the following:</p>
<ul>
<li>A test project is used to contain and execute the tests. The test project has a reference to the SUT.</li>
<li>The test project creates a test web host for the SUT and uses a test server client to handle requests and responses with the SUT.</li>
<li>A test runner is used to execute the tests and report the test results.</li>
</ul>
<p>Integration tests follow a sequence of events that include the usual <em>Arrange</em>, <em>Act</em>, and <em>Assert</em> test steps:</p>
<ol>
<li>The SUT's web host is configured.</li>
<li>A test server client is created to submit requests to the app.</li>
<li>The <em>Arrange</em> test step is executed: The test app prepares a request.</li>
<li>The <em>Act</em> test step is executed: The client submits the request and receives the response.</li>
<li>The <em>Assert</em> test step is executed: The <em>actual</em> response is validated as a <em>pass</em> or <em>fail</em> based on an <em>expected</em> response.</li>
<li>The process continues until all of the tests are executed.</li>
<li>The test results are reported.</li>
</ol>
<p>Usually, the test web host is configured differently than the app's normal web host for the test runs. For example, a different database or different app settings might be used for the tests.</p>
<p>Infrastructure components, such as the test web host and in-memory test server (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>), are provided or managed by the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external">Microsoft.AspNetCore.Mvc.Testing</a> package. Use of this package streamlines test creation and execution.</p>
<p>The <code>Microsoft.AspNetCore.Mvc.Testing</code> package handles the following tasks:</p>
<ul>
<li>Copies the dependencies file (<code>.deps</code>) from the SUT into the test project's <code>bin</code> directory.</li>
<li>Sets the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> to the SUT's project root so that static files and pages/views are found when the tests are executed.</li>
<li>Provides the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path">WebApplicationFactory</a> class to streamline bootstrapping the SUT with <code>TestServer</code>.</li>
</ul>
<p>The <a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">unit tests</a> documentation describes how to set up a test project and test runner, along with detailed instructions on how to run tests and recommendations for how to name tests and test classes.</p>
<p><strong>Separate unit tests from integration tests into different projects</strong>. Separating the tests:</p>
<ul>
<li>Helps ensure that infrastructure testing components aren't accidentally included in the unit tests.</li>
<li>Allows control over which set of tests are run.</li>
</ul>
<p>There's virtually no difference between the configuration for tests of Razor Pages apps and MVC apps. The only difference is in how the tests are named. In a Razor Pages app, tests of page endpoints are usually named after the page model class (for example, <code>IndexPageTests</code> to test component integration for the Index page). In an MVC app, tests are usually organized by controller classes and named after the controllers they test (for example, <code>HomeControllerTests</code> to test component integration for the Home controller).</p>
<h2 id="test-app-prerequisites">Test app prerequisites</h2>
<p>The test project must:</p>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package.</li>
<li>Specify the Web SDK in the project file (<code>&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;</code>).</li>
</ul>
<p>These prerequisites can be seen in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/7.x/IntegrationTestsSample" data-linktype="external">sample app</a>. Inspect the <code>tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj</code> file. The sample app uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework and the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser library, so the sample app also references:</p>
<ul>
<li><a href="https://www.nuget.org/packages/AngleSharp" data-linktype="external"><code>AngleSharp</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit" data-linktype="external"><code>xunit</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a></li>
</ul>
<p>In apps that use <a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a> version 2.4.2 or later, the test project must reference the <a href="https://www.nuget.org/packages/Microsoft.NET.Test.Sdk" data-linktype="external"><code>Microsoft.NET.Test.Sdk</code></a> package.</p>
<p>Entity Framework Core is also used in the tests. See the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/7.x/IntegrationTestsSample/src/RazorPagesProject/RazorPagesProject.csproj" data-linktype="external">project file in GitHub</a>.</p>
<h2 id="sut-environment">SUT environment</h2>
<p>If the SUT's <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-9.0" data-linktype="relative-path">environment</a> isn't set, the environment defaults to Development.</p>
<h2 id="basic-tests-with-the-default-webapplicationfactory">Basic tests with the default WebApplicationFactory</h2>
<p>Expose the implicitly defined <code>Program</code> class to the test project by doing one of the following:</p>
<ul>
<li><p>Expose internal types from the web app to the test project. This can be done in the SUT project's file (<code>.csproj</code>):</p>
<pre><code class="lang-xml">&lt;ItemGroup&gt;
     &lt;InternalsVisibleTo Include="MyTestProject" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
</li>
<li><p>Make the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/7.x/IntegrationTestsSample/src/RazorPagesProject/Program.cs" data-linktype="external"><code>Program</code> class public using a partial class</a> declaration:</p>
<pre><code class="lang-diff">var builder = WebApplication.CreateBuilder(args);
// ... Configure services, routes, etc.
app.Run();
+ public partial class Program { }
</code></pre>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/7.x/IntegrationTestsSample" data-linktype="external">sample app</a> uses the <code>Program</code> partial class approach.</p>
</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" class="no-loc" data-linktype="absolute-path">WebApplicationFactory&lt;TEntryPoint&gt;</a> is used to create a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> for the integration tests. <code>TEntryPoint</code> is the entry point class of the SUT, usually <code>Program.cs</code>.</p>
<p>Test classes implement a <em>class fixture</em> interface (<a href="https://xunit.net/docs/shared-context#class-fixture" data-linktype="external"><code>IClassFixture</code></a>) to indicate the class contains tests and provide shared object instances across the tests in the class.</p>
<p>The following test class, <code>BasicTests</code>, uses the <code>WebApplicationFactory</code> to bootstrap the SUT and provide an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> to a test method, <code>Get_EndpointsReturnSuccessAndCorrectContentType</code>. The method verifies the response status code is successful (200-299) and the <code>Content-Type</code> header is <code>text/html; charset=utf-8</code> for several app pages.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> creates an instance of <code>HttpClient</code> that automatically follows redirects and handles cookies.</p>
<pre><code class="lang-csharp">public class BasicTests 
    : IClassFixture&lt;WebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly WebApplicationFactory&lt;Program&gt; _factory;

    public BasicTests(WebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
    }

    [Theory]
    [InlineData("/")]
    [InlineData("/Index")]
    [InlineData("/About")]
    [InlineData("/Privacy")]
    [InlineData("/Contact")]
    public async Task Get_EndpointsReturnSuccessAndCorrectContentType(string url)
    {
        // Arrange
        var client = _factory.CreateClient();

        // Act
        var response = await client.GetAsync(url);

        // Assert
        response.EnsureSuccessStatusCode(); // Status Code 200-299
        Assert.Equal("text/html; charset=utf-8", 
            response.Content.Headers.ContentType.ToString());
    }
}
</code></pre>
<p>By default, non-essential cookies aren't preserved across requests when the <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0" data-linktype="relative-path">General Data Protection Regulation consent policy</a> is enabled. To preserve non-essential cookies, such as those used by the TempData provider, mark them as essential in your tests. For instructions on marking a cookie as essential, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0#essential-cookies" data-linktype="relative-path">Essential cookies</a>.</p>
<p><a name="asap7"></a></p>
<h2 id="anglesharp-vs-application-parts-for-antiforgery-checks">AngleSharp vs <code>Application Parts</code> for antiforgery checks</h2>
<p>This article uses the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser to handle the antiforgery checks by loading pages and parsing the HTML. For testing the endpoints of controller and Razor Pages views at a lower-level, without caring about how they render in the browser, consider using <code>Application Parts</code>. The <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/advanced/app-parts?view=aspnetcore-9.0" data-linktype="relative-path">Application Parts</a> approach injects a controller or Razor Page into the app that can be used to make JSON requests to get the required values. For more information, see the blog <a href="https://blog.martincostello.com/integration-testing-antiforgery-with-application-parts/" data-linktype="external">Integration Testing ASP.NET Core Resources Protected with Antiforgery Using Application Parts</a> and <a href="https://github.com/martincostello/antiforgery-testing-application-part" data-linktype="external">associated GitHub repo</a> by <a href="https://github.com/martincostello" data-linktype="external">Martin Costello</a>. <!--See https://github.com/dotnet/AspNetCore.Docs/issues/18860 --></p>
<h2 id="customize-webapplicationfactory">Customize WebApplicationFactory</h2>
<p>Web host configuration can be created independently of the test classes by inheriting from <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" class="no-loc" data-linktype="absolute-path">WebApplicationFactory&lt;TEntryPoint&gt;</a> to create one or more custom factories:</p>
<ol>
<li><p>Inherit from <code>WebApplicationFactory</code> and override <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost" class="no-loc" data-linktype="absolute-path">ConfigureWebHost</a>. The <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> allows the configuration of the service collection with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder.configureservices" data-linktype="absolute-path"><code>IWebHostBuilder.ConfigureServices</code></a></p>
<pre><code class="lang-csharp">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbContextOptions&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
<p>Database seeding in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/7.x/IntegrationTestsSample" data-linktype="external">sample app</a> is performed by the <code>InitializeDbForTests</code> method. The method is described in the <a href="#test-app-organization" data-linktype="self-bookmark">Integration tests sample: Test app organization</a> section.</p>
<p>The SUT's database context is registered in <code>Program.cs</code>. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Program.cs</code> code is executed. To use a different database for the tests than the app's database, the app's database context must be replaced in <code>builder.ConfigureServices</code>.</p>
<p>The sample app finds the service descriptor for the database context and uses the descriptor to remove the service registration. The factory then adds a new <code>ApplicationDbContext</code> that uses an in-memory database for the tests..</p>
<p>To connect to a different database, change the <code>DbConnection</code>. To use a SQL Server test database:</p>
</li>
</ol>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/" data-linktype="external"><code>Microsoft.EntityFrameworkCore.SqlServer</code></a> NuGet package in the project file.</li>
<li>Call <code>UseInMemoryDatabase</code>.</li>
</ul>
<!--
    [!code-csharp[](~/../AspNetCore.Docs.Samples/test/integration-tests/7.x/IntegrationTestsSample/src/RazorPagesProject/Program.cs?name=snippet_all)]
-->
<ol start="2">
<li><p>Use the custom <code>CustomWebApplicationFactory</code> in test classes. The following example uses the factory in the <code>IndexPageTests</code> class:</p>
<pre><code class="lang-csharp">public class IndexPageTests :
    IClassFixture&lt;CustomWebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly HttpClient _client;
    private readonly CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    public IndexPageTests(
        CustomWebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
        _client = factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }
</code></pre>
<p>The sample app's client is configured to prevent the <code>HttpClient</code> from following redirects. As explained later in the <a href="#mock-authentication" data-linktype="self-bookmark">Mock authentication</a> section, this permits tests to check the result of the app's first response. The first response is a redirect in many of these tests with a <code>Location</code> header.</p>
</li>
<li><p>A typical test uses the <code>HttpClient</code> and helper methods to process the request and the response:</p>
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteAllMessagesHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("button[id='deleteAllBtn']"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre></li>
</ol>
<p>Any POST request to the SUT must satisfy the antiforgery check that's automatically made by the app's <a href="../security/data-protection/introduction553c.html?view=aspnetcore-9.0" data-linktype="relative-path">data protection antiforgery system</a>. In order to arrange for a test's POST request, the test app must:</p>
<ol>
<li>Make a request for the page.</li>
<li>Parse the antiforgery cookie and request validation token from the response.</li>
<li>Make the POST request with the antiforgery cookie and request validation token in place.</li>
</ol>
<p>The <code>SendAsync</code> helper extension methods (<code>Helpers/HttpClientExtensions.cs</code>) and the <code>GetDocumentAsync</code> helper method (<code>Helpers/HtmlHelpers.cs</code>) in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/7.x/IntegrationTestsSample/" data-linktype="external">sample app</a> use the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser to handle the antiforgery check with the following methods:</p>
<ul>
<li><code>GetDocumentAsync</code>: Receives the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpresponsemessage" class="no-loc" data-linktype="absolute-path">HttpResponseMessage</a> and returns an <code>IHtmlDocument</code>. <code>GetDocumentAsync</code> uses a factory that prepares a <em>virtual response</em> based on the original <code>HttpResponseMessage</code>. For more information, see the <a href="https://github.com/AngleSharp/AngleSharp#documentation" data-linktype="external">AngleSharp documentation</a>.</li>
<li><code>SendAsync</code> extension methods for the <code>HttpClient</code> compose an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httprequestmessage" class="no-loc" data-linktype="absolute-path">HttpRequestMessage</a> and call <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient.sendasync#system-net-http-httpclient-sendasync(system-net-http-httprequestmessage)" class="no-loc" data-linktype="absolute-path">SendAsync(HttpRequestMessage)</a> to submit requests to the SUT. Overloads for <code>SendAsync</code> accept the HTML form (<code>IHtmlFormElement</code>) and the following:
<ul>
<li>Submit button of the form (<code>IHtmlElement</code>)</li>
<li>Form values collection (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
<li>Submit button (<code>IHtmlElement</code>) and form values (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
</ul>
</li>
</ul>
<p><a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> is a <strong>third-party parsing library used for demonstration purposes</strong> in this article and the sample app. AngleSharp isn't supported or required for integration testing of ASP.NET Core apps. Other parsers can be used, such as the <a href="https://html-agility-pack.net/" data-linktype="external">Html Agility Pack (HAP)</a>. Another approach is to write code to handle the antiforgery system's request verification token and antiforgery cookie directly. See <a href="#asap7" data-linktype="self-bookmark">AngleSharp vs <code>Application Parts</code> for antiforgery checks</a> in this article for more information.</p>
<p>The <a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#in-memory-as-a-database-fake" data-linktype="absolute-path">EF-Core in-memory database provider</a> can be used for limited and basic testing, however the <em><strong><a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#sqlite-as-a-database-fake" data-linktype="absolute-path">SQLite provider</a> is the recommended choice for in-memory testing</strong></em>.</p>
<p>See <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup?view=aspnetcore-9.0#IStartupFilter" data-linktype="relative-path">Extend Startup with startup filters</a> which shows how to configure middleware using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.istartupfilter" class="no-loc" data-linktype="absolute-path">IStartupFilter</a>, which is useful when a test requires a custom service or middleware.</p>
<h2 id="customize-the-client-with-withwebhostbuilder">Customize the client with WithWebHostBuilder</h2>
<p>When additional configuration is required within a test method, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder" class="no-loc" data-linktype="absolute-path">WithWebHostBuilder</a> creates a new <code>WebApplicationFactory</code> with an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> that is further customized by configuration.</p>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/7.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests" data-linktype="external">sample code</a> calls <code>WithWebHostBuilder</code> to replace configured services with test stubs. For more information and example usage, see <a href="#inject-mock-services" data-linktype="self-bookmark">Inject mock services</a> in this article.</p>
<p>The <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> test method of the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/7.x/IntegrationTestsSample" data-linktype="external">sample app</a> demonstrates the use of <code>WithWebHostBuilder</code>. This test performs a record delete in the database by triggering a form submission in the SUT.</p>
<p>Because another test in the <code>IndexPageTests</code> class performs an operation that deletes all of the records in the database and may run before the <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> method, the database is reseeded in this test method to ensure that a record is present for the SUT to delete. Selecting the first delete button of the <code>messages</code> form in the SUT is simulated in the request to the SUT:</p>
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteMessageHandler_ReturnsRedirectToRoot()
{
    // Arrange
    using (var scope = _factory.Services.CreateScope())
    {
        var scopedServices = scope.ServiceProvider;
        var db = scopedServices.GetRequiredService&lt;ApplicationDbContext&gt;();

        Utilities.ReinitializeDbForTests(db);
    }

    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("form[id='messages']")
            .QuerySelector("div[class='panel-body']")
            .QuerySelector("button"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre><h2 id="client-options">Client options</h2>
<p>See the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> page for defaults and available options when creating <code>HttpClient</code> instances.</p>
<p>Create the <code>WebApplicationFactoryClientOptions</code> class and pass it to the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> method:</p>
<pre><code class="lang-csharp">public class IndexPageTests :
    IClassFixture&lt;CustomWebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly HttpClient _client;
    private readonly CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    public IndexPageTests(
        CustomWebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
        _client = factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }
</code></pre>
<p><em><strong>NOTE:</strong></em> To avoid HTTPS redirection warnings in logs when using HTTPS Redirection Middleware, set <code>BaseAddress = new Uri("https://localhost")</code></p>
<h2 id="inject-mock-services">Inject mock services</h2>
<p>Services can be overridden in a test with a call to <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> on the host builder. To scope the overridden services to the test itself, the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder" class="no-loc" data-linktype="absolute-path">WithWebHostBuilder</a> method is used to retrieve a host builder. This can be seen in the following tests:</p>
<ul>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/7.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs#L166-L173" data-linktype="external">Get_QuoteService_ProvidesQuoteInPage</a></li>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/7.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs#L35-L38" data-linktype="external">Get_GithubProfilePageCanGetAGithubUser</a></li>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/7.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs#L105-L117" data-linktype="external">Get_SecurePageIsReturnedForAnAuthenticatedUser</a></li>
</ul>
<p>The sample SUT includes a scoped service that returns a quote. The quote is embedded in a hidden field on the Index page when the Index page is requested.</p>
<p><code>Services/IQuoteService.cs</code>:</p>
<pre><code class="lang-csharp">public interface IQuoteService
{
    Task&lt;string&gt; GenerateQuote();
}
</code></pre>
<p><code>Services/QuoteService.cs</code>:</p>
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Dr. Who: Planet of Evil
// https://www.bbc.co.uk/programmes/p00pyrx6
public class QuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult&lt;string&gt;(
            "Come on, Sarah. We've an appointment in London, " +
            "and we're already 30,000 years late.");
    }
}
</code></pre>
<p><code>Program.cs</code>:</p>
<pre><code class="lang-csharp">services.AddScoped&lt;IQuoteService, QuoteService&gt;();
</code></pre>
<p><code>Pages/Index.cshtml.cs</code>:</p>
<pre><code class="lang-csharp" highlight-lines="4,9,20,26">public class IndexModel : PageModel
{
    private readonly ApplicationDbContext _db;
    private readonly IQuoteService _quoteService;

    public IndexModel(ApplicationDbContext db, IQuoteService quoteService)
    {
        _db = db;
        _quoteService = quoteService;
    }

    [BindProperty]
    public Message Message { get; set; }

    public IList&lt;Message&gt; Messages { get; private set; }

    [TempData]
    public string MessageAnalysisResult { get; set; }

    public string Quote { get; private set; }

    public async Task OnGetAsync()
    {
        Messages = await _db.GetMessagesAsync();

        Quote = await _quoteService.GenerateQuote();
    }
</code></pre>
<p><code>Pages/Index.cs</code>:</p>
<pre><code class="lang-cshtml">&lt;input id="quote" type="hidden" value="@Model.Quote"&gt;
</code></pre>
<p>The following markup is generated when the SUT app is run:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Come on, Sarah. We&amp;#x27;ve an appointment in 
    London, and we&amp;#x27;re already 30,000 years late."&gt;
</code></pre>
<p>To test the service and quote injection in an integration test, a mock service is injected into the SUT by the test. The mock service replaces the app's <code>QuoteService</code> with a service provided by the test app, called <code>TestQuoteService</code>:</p>
<p><code>IntegrationTests.IndexPageTests.cs</code>:</p>
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Pyramids of Mars
// https://www.bbc.co.uk/programmes/p00pys55
public class TestQuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult(
            "Something's interfering with time, Mr. Scarman, " +
            "and time is my business.");
    }
}
</code></pre>
<p><code>ConfigureTestServices</code> is called, and the scoped service is registered:</p>
<pre><code class="lang-csharp" highlight-lines="7-10,17,20-21">[Fact]
public async Task Get_QuoteService_ProvidesQuoteInPage()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddScoped&lt;IQuoteService, TestQuoteService&gt;();
            });
        })
        .CreateClient();

    //Act
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);
    var quoteElement = content.QuerySelector("#quote");

    // Assert
    Assert.Equal("Something's interfering with time, Mr. Scarman, " +
        "and time is my business.", quoteElement.Attributes["value"].Value);
}
</code></pre>
<p>The markup produced during the test's execution reflects the quote text supplied by <code>TestQuoteService</code>, thus the assertion passes:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Something&amp;#x27;s interfering with time, 
    Mr. Scarman, and time is my business."&gt;
</code></pre>
<h2 id="mock-authentication">Mock authentication</h2>
<p>Tests in the <code>AuthTests</code> class check that a secure endpoint:</p>
<ul>
<li>Redirects an unauthenticated user to the app's sign in page.</li>
<li>Returns content for an authenticated user.</li>
</ul>
<p>In the SUT, the <code>/SecurePage</code> page uses an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage" class="no-loc" data-linktype="absolute-path">AuthorizePage</a> convention to apply an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter" class="no-loc" data-linktype="absolute-path">AuthorizeFilter</a> to the page. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authorization/razor-pages-authorization?view=aspnetcore-9.0#require-authorization-to-access-a-page" data-linktype="relative-path">Razor Pages authorization conventions</a>.</p>
<pre><code class="lang-csharp">services.AddRazorPages(options =&gt;
{
    options.Conventions.AuthorizePage("/SecurePage");
});
</code></pre>
<p>In the <code>Get_SecurePageRedirectsAnUnauthenticatedUser</code> test, a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> is set to disallow redirects by setting <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect#microsoft-aspnetcore-mvc-testing-webapplicationfactoryclientoptions-allowautoredirect" class="no-loc" data-linktype="absolute-path">AllowAutoRedirect</a> to <code>false</code>:</p>
<pre><code class="lang-csharp">[Fact]
public async Task Get_SecurePageRedirectsAnUnauthenticatedUser()
{
    // Arrange
    var client = _factory.CreateClient(
        new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });

    // Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.StartsWith("http://localhost/Identity/Account/Login",
        response.Headers.Location.OriginalString);
}
</code></pre>
<p>By disallowing the client to follow the redirect, the following checks can be made:</p>
<ul>
<li>The status code returned by the SUT can be checked against the expected <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-redirect" class="no-loc" data-linktype="absolute-path">HttpStatusCode.Redirect</a> result, not the final status code after the redirect to the sign in page, which would be <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-ok" class="no-loc" data-linktype="absolute-path">HttpStatusCode.OK</a>.</li>
<li>The <code>Location</code> header value in the response headers is checked to confirm that it starts with <code>http://localhost/Identity/Account/Login</code>, not the final sign in page response, where the <code>Location</code> header wouldn't be present.</li>
</ul>
<p>The test app can mock an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a> in <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> in order to test aspects of authentication and authorization. A minimal scenario returns an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticateresult.success" class="no-loc" data-linktype="absolute-path">AuthenticateResult.Success</a>:</p>
<pre><code class="lang-csharp" highlight-lines="11-18">public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options,
        ILoggerFactory logger, UrlEncoder encoder, ISystemClock clock)
        : base(options, logger, encoder, clock)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[] { new Claim(ClaimTypes.Name, "Test user") };
        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "TestScheme");

        var result = AuthenticateResult.Success(ticket);

        return Task.FromResult(result);
    }
}
</code></pre>
<p>The <code>TestAuthHandler</code> is called to authenticate a user when the authentication scheme is set to <code>TestScheme</code> where <code>AddAuthentication</code> is registered for <code>ConfigureTestServices</code>. It's important for the <code>TestScheme</code> scheme to match the scheme your app expects. Otherwise, authentication won't work.</p>
<pre><code class="lang-csharp" highlight-lines="7-12">[Fact]
public async Task Get_SecurePageIsReturnedForAnAuthenticatedUser()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddAuthentication(defaultScheme: "TestScheme")
                    .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                        "TestScheme", options =&gt; { });
            });
        })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false,
        });

    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue(scheme: "TestScheme");

    //Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.OK, response.StatusCode);
}
</code></pre>
<p>For more information on <code>WebApplicationFactoryClientOptions</code>, see the <a href="#client-options" data-linktype="self-bookmark">Client options</a> section.</p>
<h3 id="basic-tests-for-authentication-middleware">Basic tests for authentication middleware</h3>
<p>See <a href="https://github.com/blowdart/idunno.Authentication/tree/dev/test/idunno.Authentication.Basic.Test" data-linktype="external">this GitHub repository</a> for basic tests of authentication middleware. It contains a <a href="https://github.com/blowdart/idunno.Authentication/blob/dev/test/idunno.Authentication.Basic.Test/BasicAuthenticationTests.cs#L331" data-linktype="external">test server</a> that’s specific to the test scenario.</p>
<h2 id="set-the-environment">Set the environment</h2>
<p>Set the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-9.0" data-linktype="relative-path">environment</a> in the custom application factory:</p>
<pre><code class="lang-csharp" highlight-lines="36">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbContextOptions&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre><h2 id="how-the-test-infrastructure-infers-the-app-content-root-path">How the test infrastructure infers the app content root path</h2>
<p>The <code>WebApplicationFactory</code> constructor infers the app <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> path by searching for a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryContentRootAttribute</a> on the assembly containing the integration tests with a key equal to the <code>TEntryPoint</code> assembly <code>System.Reflection.Assembly.FullName</code>. In case an attribute with the correct key isn't found, <code>WebApplicationFactory</code> falls back to searching for a solution file (<em>.sln</em>) and appends the <code>TEntryPoint</code> assembly name to the solution directory. The app root directory (the content root path) is used to discover views and content files.</p>
<h2 id="disable-shadow-copying">Disable shadow copying</h2>
<p>Shadow copying causes the tests to execute in a different directory than the output directory. If your tests rely on loading files relative to <code>Assembly.Location</code> and you encounter issues, you might have to disable shadow copying.</p>
<p>To disable shadow copying when using xUnit, create a <code>xunit.runner.json</code> file in your test project directory, with the <a href="https://xunit.net/docs/configuration-files#shadowCopy" data-linktype="external">correct configuration setting</a>:</p>
<pre><code class="lang-json">{
  "shadowCopy": false
}
</code></pre>
<h2 id="disposal-of-objects">Disposal of objects</h2>
<p>After the tests of the <code>IClassFixture</code> implementation are executed, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> are disposed when xUnit disposes of the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path"><code>WebApplicationFactory</code></a>. If objects instantiated by the developer require disposal, dispose of them in the <code>IClassFixture</code> implementation. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose" data-linktype="absolute-path">Implementing a Dispose method</a>.</p>
<h2 id="integration-tests-sample">Integration tests sample</h2>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/7.x/IntegrationTestsSample" data-linktype="external">sample app</a> is composed of two apps:</p>
<table>
<thead>
<tr>
<th>App</th>
<th>Project directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Message app (the SUT)</td>
<td><code>src/RazorPagesProject</code></td>
<td>Allows a user to add, delete one, delete all, and analyze messages.</td>
</tr>
<tr>
<td>Test app</td>
<td><code>tests/RazorPagesProject.Tests</code></td>
<td>Used to integration test the SUT.</td>
</tr>
</tbody>
</table>
<p>The tests can be run using the built-in test features of an IDE, such as <a href="https://visualstudio.microsoft.com/" data-linktype="external">Visual Studio</a>. If using <a href="https://code.visualstudio.com/" data-linktype="external">Visual Studio Code</a> or the command line, execute the following command at a command prompt in the <code>tests/RazorPagesProject.Tests</code> directory:</p>
<pre><code class="lang-console">dotnet test
</code></pre>
<h3 id="message-app-sut-organization">Message app (SUT) organization</h3>
<p>The SUT is a Razor Pages message system with the following characteristics:</p>
<ul>
<li>The Index page of the app (<code>Pages/Index.cshtml</code> and <code>Pages/Index.cshtml.cs</code>) provides a UI and page model methods to control the addition, deletion, and analysis of messages (average words per message).</li>
<li>A message is described by the <code>Message</code> class (<code>Data/Message.cs</code>) with two properties: <code>Id</code> (key) and <code>Text</code> (message). The <code>Text</code> property is required and limited to 200 characters.</li>
<li>Messages are stored using <a href="https://learn.microsoft.com/en-us/ef/core/providers/in-memory/" data-linktype="absolute-path">Entity Framework's in-memory database</a>†.</li>
<li>The app contains a data access layer (DAL) in its database context class, <code>AppDbContext</code> (<code>Data/AppDbContext.cs</code>).</li>
<li>If the database is empty on app startup, the message store is initialized with three messages.</li>
<li>The app includes a <code>/SecurePage</code> that can only be accessed by an authenticated user.</li>
</ul>
<p>†The EF article, <a href="https://learn.microsoft.com/en-us/ef/core/miscellaneous/testing/in-memory" data-linktype="absolute-path">Test with InMemory</a>, explains how to use an in-memory database for tests with MSTest. This topic uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework. Test concepts and test implementations across different test frameworks are similar but not identical.</p>
<p>Although the app doesn't use the repository pattern and isn't an effective example of the <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" data-linktype="external">Unit of Work (UoW) pattern</a>, Razor Pages supports these patterns of development. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design" data-linktype="absolute-path">Designing the infrastructure persistence layer</a> and <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic</a> (the sample implements the repository pattern).</p>
<h3 id="test-app-organization">Test app organization</h3>
<p>The test app is a console app inside the <code>tests/RazorPagesProject.Tests</code> directory.</p>
<table>
<thead>
<tr>
<th>Test app directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuthTests</code></td>
<td>Contains test methods for:<ul><li>Accessing a secure page by an unauthenticated user.</li><li>Accessing a secure page by an authenticated user with a mock <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a>.</li><li>Obtaining a GitHub user profile and checking the profile's user login.</li></ul></td>
</tr>
<tr>
<td><code>BasicTests</code></td>
<td>Contains a test method for routing and content type.</td>
</tr>
<tr>
<td><code>IntegrationTests</code></td>
<td>Contains the integration tests for the Index page using custom <code>WebApplicationFactory</code> class.</td>
</tr>
<tr>
<td><code>Helpers/Utilities</code></td>
<td><ul><li><code>Utilities.cs</code> contains the <code>InitializeDbForTests</code> method used to seed the database with test data.</li><li><code>HtmlHelpers.cs</code> provides a method to return an AngleSharp <code>IHtmlDocument</code> for use by the test methods.</li><li><code>HttpClientExtensions.cs</code> provide overloads for <code>SendAsync</code> to submit requests to the SUT.</li></ul></td>
</tr>
</tbody>
</table>
<p>The test framework is <a href="https://xunit.net/" data-linktype="external">xUnit</a>. Integration tests are conducted using the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost" class="no-loc" data-linktype="absolute-path">Microsoft.AspNetCore.TestHost</a>, which includes the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>. Because the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package is used to configure the test host and test server, the <code>TestHost</code> and <code>TestServer</code> packages don't require direct package references in the test app's project file or developer configuration in the test app.</p>
<p>Integration tests usually require a small dataset in the database prior to the test execution. For example, a delete test calls for a database record deletion, so the database must have at least one record for the delete request to succeed.</p>
<p>The sample app seeds the database with three messages in <code>Utilities.cs</code> that tests can use when they execute:</p>
<pre><code class="lang-csharp">public static void InitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.AddRange(GetSeedingMessages());
    db.SaveChanges();
}

public static void ReinitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.RemoveRange(db.Messages);
    InitializeDbForTests(db);
}

public static List&lt;Message&gt; GetSeedingMessages()
{
    return new List&lt;Message&gt;()
    {
        new Message(){ Text = "TEST RECORD: You're standing on my scarf." },
        new Message(){ Text = "TEST RECORD: Would you like a jelly baby?" },
        new Message(){ Text = "TEST RECORD: To the rational mind, " +
            "nothing is inexplicable; only unexplained." }
    };
}
</code></pre>
<p>The SUT's database context is registered in <code>Program.cs</code>. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Program.cs</code> code is executed. To use a different database for the tests, the app's database context must be replaced in <code>builder.ConfigureServices</code>. For more information, see the <a href="#customize-webapplicationfactory" data-linktype="self-bookmark">Customize WebApplicationFactory</a> section.</p>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">Unit tests</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests in ASP.NET Core</a></li>
<li><a href="../fundamentals/middleware/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">ASP.NET Core Middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic in ASP.NET Core</a></li>
<li><a href="https://github.com/blowdart/idunno.Authentication/tree/dev/test/idunno.Authentication.Basic.Test" data-linktype="external">Basic tests for authentication middleware</a></li>
</ul>
</div>
<div data-moniker="aspnetcore-8.0">
<p>This article assumes a basic understanding of unit tests. If unfamiliar with test concepts, see the <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">Testing in .NET</a> article and its linked content.</p>
<p><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/8.x/IntegrationTestsSample" data-linktype="external">View or download sample code</a> (<a href="../overview553c.html?view=aspnetcore-9.0#how-to-download-a-sample" data-linktype="relative-path">how to download</a>)</p>
<p>The sample app is a Razor Pages app and assumes a basic understanding of Razor Pages. If you're unfamiliar with Razor Pages, see the following articles:</p>
<ul>
<li><a href="../razor-pages/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Introduction to Razor Pages</a></li>
<li><a href="../tutorials/razor-pages/razor-pages-start553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Get started with Razor Pages</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests</a></li>
</ul>
<p><strong>For testing SPAs</strong>, we recommend a tool such as <a href="https://playwright.dev/dotnet/" data-linktype="external">Playwright for .NET</a>, which can automate a browser.</p>
<h2 id="introduction-to-integration-tests">Introduction to integration tests</h2>
<p>Integration tests evaluate an app's components on a broader level than <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">unit tests</a>. Unit tests are used to test isolated software components, such as individual class methods. Integration tests confirm that two or more app components work together to produce an expected result, possibly including every component required to fully process a request.</p>
<p>These broader tests are used to test the app's infrastructure and whole framework, often including the following components:</p>
<ul>
<li>Database</li>
<li>File system</li>
<li>Network appliances</li>
<li>Request-response pipeline</li>
</ul>
<p>Unit tests use fabricated components, known as <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-best-practices#lets-speak-the-same-language" data-linktype="absolute-path"><em>fakes</em> or <em>mock objects</em></a>, in place of infrastructure components.</p>
<p>In contrast to unit tests, integration tests:</p>
<ul>
<li>Use the actual components that the app uses in production.</li>
<li>Require more code and data processing.</li>
<li>Take longer to run.</li>
</ul>
<p>Therefore, limit the use of integration tests to the most important infrastructure scenarios. If a behavior can be tested using either a unit test or an integration test, choose the unit test.</p>
<p>In discussions of integration tests, the tested project is frequently called the <em><strong>System Under Test</strong></em>, or "<strong>SUT</strong>" for short. "SUT" is used throughout this article to refer to the ASP.NET Core app being tested.</p>
<p><em><strong>Don't write integration tests for every permutation</strong></em> of data and file access with databases and file systems. Regardless of how many places across an app interact with databases and file systems, a focused set of read, write, update, and delete integration tests are usually capable of adequately testing database and file system components. Use unit tests for routine tests of method logic that interact with these components. In unit tests, the use of infrastructure fakes or mocks result in faster test execution.</p>
<h2 id="aspnet-core-integration-tests">ASP.NET Core integration tests</h2>
<p>Integration tests in ASP.NET Core require the following:</p>
<ul>
<li>A test project is used to contain and execute the tests. The test project has a reference to the SUT.</li>
<li>The test project creates a test web host for the SUT and uses a test server client to handle requests and responses with the SUT.</li>
<li>A test runner is used to execute the tests and report the test results.</li>
</ul>
<p>Integration tests follow a sequence of events that include the usual <em>Arrange</em>, <em>Act</em>, and <em>Assert</em> test steps:</p>
<ol>
<li>The SUT's web host is configured.</li>
<li>A test server client is created to submit requests to the app.</li>
<li>The <em>Arrange</em> test step is executed: The test app prepares a request.</li>
<li>The <em>Act</em> test step is executed: The client submits the request and receives the response.</li>
<li>The <em>Assert</em> test step is executed: The <em>actual</em> response is validated as a <em>pass</em> or <em>fail</em> based on an <em>expected</em> response.</li>
<li>The process continues until all of the tests are executed.</li>
<li>The test results are reported.</li>
</ol>
<p>Usually, the test web host is configured differently than the app's normal web host for the test runs. For example, a different database or different app settings might be used for the tests.</p>
<p>Infrastructure components, such as the test web host and in-memory test server (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>), are provided or managed by the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external">Microsoft.AspNetCore.Mvc.Testing</a> package. Use of this package streamlines test creation and execution.</p>
<p>The <code>Microsoft.AspNetCore.Mvc.Testing</code> package handles the following tasks:</p>
<ul>
<li>Copies the dependencies file (<code>.deps</code>) from the SUT into the test project's <code>bin</code> directory.</li>
<li>Sets the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> to the SUT's project root so that static files and pages/views are found when the tests are executed.</li>
<li>Provides the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path">WebApplicationFactory</a> class to streamline bootstrapping the SUT with <code>TestServer</code>.</li>
</ul>
<p>The <a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">unit tests</a> documentation describes how to set up a test project and test runner, along with detailed instructions on how to run tests and recommendations for how to name tests and test classes.</p>
<p><strong>Separate unit tests from integration tests into different projects</strong>. Separating the tests:</p>
<ul>
<li>Helps ensure that infrastructure testing components aren't accidentally included in the unit tests.</li>
<li>Allows control over which set of tests are run.</li>
</ul>
<p>There's virtually no difference between the configuration for tests of Razor Pages apps and MVC apps. The only difference is in how the tests are named. In a Razor Pages app, tests of page endpoints are usually named after the page model class (for example, <code>IndexPageTests</code> to test component integration for the Index page). In an MVC app, tests are usually organized by controller classes and named after the controllers they test (for example, <code>HomeControllerTests</code> to test component integration for the Home controller).</p>
<h2 id="test-app-prerequisites">Test app prerequisites</h2>
<p>The test project must:</p>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package.</li>
<li>Specify the Web SDK in the project file (<code>&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;</code>).</li>
</ul>
<p>These prerequisites can be seen in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/8.x/IntegrationTestsSample" data-linktype="external">sample app</a>. Inspect the <code>tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj</code> file. The sample app uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework and the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser library, so the sample app also references:</p>
<ul>
<li><a href="https://www.nuget.org/packages/AngleSharp" data-linktype="external"><code>AngleSharp</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit" data-linktype="external"><code>xunit</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a></li>
</ul>
<p>In apps that use <a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a> version 2.4.2 or later, the test project must reference the <a href="https://www.nuget.org/packages/Microsoft.NET.Test.Sdk" data-linktype="external"><code>Microsoft.NET.Test.Sdk</code></a> package.</p>
<p>Entity Framework Core is also used in the tests. See the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/8.x/IntegrationTestsSample/src/RazorPagesProject/RazorPagesProject.csproj" data-linktype="external">project file in GitHub</a>.</p>
<h2 id="sut-environment">SUT environment</h2>
<p>If the SUT's <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-9.0" data-linktype="relative-path">environment</a> isn't set, the environment defaults to Development.</p>
<h2 id="basic-tests-with-the-default-webapplicationfactory">Basic tests with the default WebApplicationFactory</h2>
<p>Expose the implicitly defined <code>Program</code> class to the test project by doing one of the following:</p>
<ul>
<li><p>Expose internal types from the web app to the test project. This can be done in the SUT project's file (<code>.csproj</code>):</p>
<pre><code class="lang-xml">&lt;ItemGroup&gt;
     &lt;InternalsVisibleTo Include="MyTestProject" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
</li>
<li><p>Make the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/8.x/IntegrationTestsSample/src/RazorPagesProject/Program.cs" data-linktype="external"><code>Program</code> class public using a partial class</a> declaration:</p>
<pre><code class="lang-diff">var builder = WebApplication.CreateBuilder(args);
// ... Configure services, routes, etc.
app.Run();
+ public partial class Program { }
</code></pre>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/8.x/IntegrationTestsSample" data-linktype="external">sample app</a> uses the <code>Program</code> partial class approach.</p>
</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" class="no-loc" data-linktype="absolute-path">WebApplicationFactory&lt;TEntryPoint&gt;</a> is used to create a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> for the integration tests. <code>TEntryPoint</code> is the entry point class of the SUT, usually <code>Program.cs</code>.</p>
<p>Test classes implement a <em>class fixture</em> interface (<a href="https://xunit.net/docs/shared-context#class-fixture" data-linktype="external"><code>IClassFixture</code></a>) to indicate the class contains tests and provide shared object instances across the tests in the class.</p>
<p>The following test class, <code>BasicTests</code>, uses the <code>WebApplicationFactory</code> to bootstrap the SUT and provide an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> to a test method, <code>Get_EndpointsReturnSuccessAndCorrectContentType</code>. The method verifies the response status code is successful (200-299) and the <code>Content-Type</code> header is <code>text/html; charset=utf-8</code> for several app pages.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> creates an instance of <code>HttpClient</code> that automatically follows redirects and handles cookies.</p>
<pre><code class="lang-csharp">public class BasicTests 
    : IClassFixture&lt;WebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly WebApplicationFactory&lt;Program&gt; _factory;

    public BasicTests(WebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
    }

    [Theory]
    [InlineData("/")]
    [InlineData("/Index")]
    [InlineData("/About")]
    [InlineData("/Privacy")]
    [InlineData("/Contact")]
    public async Task Get_EndpointsReturnSuccessAndCorrectContentType(string url)
    {
        // Arrange
        var client = _factory.CreateClient();

        // Act
        var response = await client.GetAsync(url);

        // Assert
        response.EnsureSuccessStatusCode(); // Status Code 200-299
        Assert.Equal("text/html; charset=utf-8", 
            response.Content.Headers.ContentType.ToString());
    }
}
</code></pre>
<p>By default, non-essential cookies aren't preserved across requests when the <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0" data-linktype="relative-path">General Data Protection Regulation consent policy</a> is enabled. To preserve non-essential cookies, such as those used by the TempData provider, mark them as essential in your tests. For instructions on marking a cookie as essential, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0#essential-cookies" data-linktype="relative-path">Essential cookies</a>.</p>
<p><a name="asap7"></a></p>
<h2 id="anglesharp-vs-application-parts-for-antiforgery-checks">AngleSharp vs <code>Application Parts</code> for antiforgery checks</h2>
<p>This article uses the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser to handle the antiforgery checks by loading pages and parsing the HTML. For testing the endpoints of controller and Razor Pages views at a lower-level, without caring about how they render in the browser, consider using <code>Application Parts</code>. The <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/advanced/app-parts?view=aspnetcore-9.0" data-linktype="relative-path">Application Parts</a> approach injects a controller or Razor Page into the app that can be used to make JSON requests to get the required values. For more information, see the blog <a href="https://blog.martincostello.com/integration-testing-antiforgery-with-application-parts/" data-linktype="external">Integration Testing ASP.NET Core Resources Protected with Antiforgery Using Application Parts</a> and <a href="https://github.com/martincostello/antiforgery-testing-application-part" data-linktype="external">associated GitHub repo</a> by <a href="https://github.com/martincostello" data-linktype="external">Martin Costello</a>. <!--See https://github.com/dotnet/AspNetCore.Docs/issues/18860 --></p>
<h2 id="customize-webapplicationfactory">Customize WebApplicationFactory</h2>
<p>Web host configuration can be created independently of the test classes by inheriting from <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" class="no-loc" data-linktype="absolute-path">WebApplicationFactory&lt;TEntryPoint&gt;</a> to create one or more custom factories:</p>
<ol>
<li><p>Inherit from <code>WebApplicationFactory</code> and override <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost" class="no-loc" data-linktype="absolute-path">ConfigureWebHost</a>. The <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> allows the configuration of the service collection with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder.configureservices" data-linktype="absolute-path"><code>IWebHostBuilder.ConfigureServices</code></a></p>
<pre><code class="lang-csharp">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbContextOptions&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
<p>Database seeding in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/8.x/IntegrationTestsSample" data-linktype="external">sample app</a> is performed by the <code>InitializeDbForTests</code> method. The method is described in the <a href="#test-app-organization" data-linktype="self-bookmark">Integration tests sample: Test app organization</a> section.</p>
<p>The SUT's database context is registered in <code>Program.cs</code>. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Program.cs</code> code is executed. To use a different database for the tests than the app's database, the app's database context must be replaced in <code>builder.ConfigureServices</code>.</p>
<p>The sample app finds the service descriptor for the database context and uses the descriptor to remove the service registration. The factory then adds a new <code>ApplicationDbContext</code> that uses an in-memory database for the tests..</p>
<p>To connect to a different database, change the <code>DbConnection</code>. To use a SQL Server test database:</p>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/" data-linktype="external"><code>Microsoft.EntityFrameworkCore.SqlServer</code></a> NuGet package in the project file.</li>
<li>Call <code>UseInMemoryDatabase</code>.</li>
</ul>
</li>
</ol>
<!--
    [!code-csharp[](~/../AspNetCore.Docs.Samples/test/integration-tests/8.x/IntegrationTestsSample/src/RazorPagesProject/Program.cs?name=snippet_all)]
-->
<ol start="2">
<li><p>Use the custom <code>CustomWebApplicationFactory</code> in test classes. The following example uses the factory in the <code>IndexPageTests</code> class:</p>
<pre><code class="lang-csharp">public class IndexPageTests :
    IClassFixture&lt;CustomWebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly HttpClient _client;
    private readonly CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    public IndexPageTests(
        CustomWebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
        _client = factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }
}
</code></pre>
<p>The sample app's client is configured to prevent the <code>HttpClient</code> from following redirects. As explained later in the <a href="#mock-authentication" data-linktype="self-bookmark">Mock authentication</a> section, this permits tests to check the result of the app's first response. The first response is a redirect in many of these tests with a <code>Location</code> header.</p>
</li>
<li><p>A typical test uses the <code>HttpClient</code> and helper methods to process the request and the response:</p>
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteAllMessagesHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("button[id='deleteAllBtn']"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre></li>
</ol>
<p>Any POST request to the SUT must satisfy the antiforgery check that's automatically made by the app's <a href="../security/data-protection/introduction553c.html?view=aspnetcore-9.0" data-linktype="relative-path">data protection antiforgery system</a>. In order to arrange for a test's POST request, the test app must:</p>
<ol>
<li>Make a request for the page.</li>
<li>Parse the antiforgery cookie and request validation token from the response.</li>
<li>Make the POST request with the antiforgery cookie and request validation token in place.</li>
</ol>
<p>The <code>SendAsync</code> helper extension methods (<code>Helpers/HttpClientExtensions.cs</code>) and the <code>GetDocumentAsync</code> helper method (<code>Helpers/HtmlHelpers.cs</code>) in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/8.x/IntegrationTestsSample/" data-linktype="external">sample app</a> use the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser to handle the antiforgery check with the following methods:</p>
<ul>
<li><code>GetDocumentAsync</code>: Receives the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpresponsemessage" class="no-loc" data-linktype="absolute-path">HttpResponseMessage</a> and returns an <code>IHtmlDocument</code>. <code>GetDocumentAsync</code> uses a factory that prepares a <em>virtual response</em> based on the original <code>HttpResponseMessage</code>. For more information, see the <a href="https://github.com/AngleSharp/AngleSharp#documentation" data-linktype="external">AngleSharp documentation</a>.</li>
<li><code>SendAsync</code> extension methods for the <code>HttpClient</code> compose an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httprequestmessage" class="no-loc" data-linktype="absolute-path">HttpRequestMessage</a> and call <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient.sendasync#system-net-http-httpclient-sendasync(system-net-http-httprequestmessage)" class="no-loc" data-linktype="absolute-path">SendAsync(HttpRequestMessage)</a> to submit requests to the SUT. Overloads for <code>SendAsync</code> accept the HTML form (<code>IHtmlFormElement</code>) and the following:
<ul>
<li>Submit button of the form (<code>IHtmlElement</code>)</li>
<li>Form values collection (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
<li>Submit button (<code>IHtmlElement</code>) and form values (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
</ul>
</li>
</ul>
<p><a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> is a <strong>third-party parsing library used for demonstration purposes</strong> in this article and the sample app. AngleSharp isn't supported or required for integration testing of ASP.NET Core apps. Other parsers can be used, such as the <a href="https://html-agility-pack.net/" data-linktype="external">Html Agility Pack (HAP)</a>. Another approach is to write code to handle the antiforgery system's request verification token and antiforgery cookie directly. See <a href="#asap7" data-linktype="self-bookmark">AngleSharp vs <code>Application Parts</code> for antiforgery checks</a> in this article for more information.</p>
<p>The <a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#in-memory-as-a-database-fake" data-linktype="absolute-path">EF-Core in-memory database provider</a> can be used for limited and basic testing, however the <em><strong><a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#sqlite-as-a-database-fake" data-linktype="absolute-path">SQLite provider</a> is the recommended choice for in-memory testing</strong></em>.</p>
<p>See <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup?view=aspnetcore-9.0#IStartupFilter" data-linktype="relative-path">Extend Startup with startup filters</a> which shows how to configure middleware using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.istartupfilter" class="no-loc" data-linktype="absolute-path">IStartupFilter</a>, which is useful when a test requires a custom service or middleware.</p>
<h2 id="customize-the-client-with-withwebhostbuilder">Customize the client with WithWebHostBuilder</h2>
<p>When additional configuration is required within a test method, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder" class="no-loc" data-linktype="absolute-path">WithWebHostBuilder</a> creates a new <code>WebApplicationFactory</code> with an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> that is further customized by configuration.</p>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/8.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests" data-linktype="external">sample code</a> calls <code>WithWebHostBuilder</code> to replace configured services with test stubs. For more information and example usage, see <a href="#inject-mock-services" data-linktype="self-bookmark">Inject mock services</a> in this article.</p>
<p>The <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> test method of the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/8.x/IntegrationTestsSample" data-linktype="external">sample app</a> demonstrates the use of <code>WithWebHostBuilder</code>. This test performs a record delete in the database by triggering a form submission in the SUT.</p>
<p>Because another test in the <code>IndexPageTests</code> class performs an operation that deletes all of the records in the database and may run before the <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> method, the database is reseeded in this test method to ensure that a record is present for the SUT to delete. Selecting the first delete button of the <code>messages</code> form in the SUT is simulated in the request to the SUT:</p>
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteMessageHandler_ReturnsRedirectToRoot()
{
    // Arrange
    using (var scope = _factory.Services.CreateScope())
    {
        var scopedServices = scope.ServiceProvider;
        var db = scopedServices.GetRequiredService&lt;ApplicationDbContext&gt;();

        Utilities.ReinitializeDbForTests(db);
    }

    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("form[id='messages']")
            .QuerySelector("div[class='panel-body']")
            .QuerySelector("button"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre><h2 id="client-options">Client options</h2>
<p>See the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> page for defaults and available options when creating <code>HttpClient</code> instances.</p>
<p>Create the <code>WebApplicationFactoryClientOptions</code> class and pass it to the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> method:</p>
<pre><code class="lang-csharp">public class IndexPageTests :
    IClassFixture&lt;CustomWebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly HttpClient _client;
    private readonly CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    public IndexPageTests(
        CustomWebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
        _client = factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }
}
</code></pre>
<p><em><strong>NOTE:</strong></em> To avoid HTTPS redirection warnings in logs when using HTTPS Redirection Middleware, set <code>BaseAddress = new Uri("https://localhost")</code></p>
<h2 id="inject-mock-services">Inject mock services</h2>
<p>Services can be overridden in a test with a call to <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> on the host builder. To scope the overridden services to the test itself, the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder" class="no-loc" data-linktype="absolute-path">WithWebHostBuilder</a> method is used to retrieve a host builder. This can be seen in the following tests:</p>
<ul>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/8.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs#L166-L173" data-linktype="external">Get_QuoteService_ProvidesQuoteInPage</a></li>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/8.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs#L35-L38" data-linktype="external">Get_GithubProfilePageCanGetAGithubUser</a></li>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/8.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs#L105-L117" data-linktype="external">Get_SecurePageIsReturnedForAnAuthenticatedUser</a></li>
</ul>
<p>The sample SUT includes a scoped service that returns a quote. The quote is embedded in a hidden field on the Index page when the Index page is requested.</p>
<p><code>Services/IQuoteService.cs</code>:</p>
<pre><code class="lang-csharp">public interface IQuoteService
{
    Task&lt;string&gt; GenerateQuote();
}
</code></pre>
<p><code>Services/QuoteService.cs</code>:</p>
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Dr. Who: Planet of Evil
// https://www.bbc.co.uk/programmes/p00pyrx6
public class QuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult&lt;string&gt;(
            "Come on, Sarah. We've an appointment in London, " +
            "and we're already 30,000 years late.");
    }
}
</code></pre>
<p><code>Program.cs</code>:</p>
<pre><code class="lang-csharp">services.AddScoped&lt;IQuoteService, QuoteService&gt;();
</code></pre>
<p><code>Pages/Index.cshtml.cs</code>:</p>
<pre><code class="lang-csharp" highlight-lines="4,9,20,26">public class IndexModel : PageModel
{
    private readonly ApplicationDbContext _db;
    private readonly IQuoteService _quoteService;

    public IndexModel(ApplicationDbContext db, IQuoteService quoteService)
    {
        _db = db;
        _quoteService = quoteService;
    }

    [BindProperty]
    public Message Message { get; set; }

    public IList&lt;Message&gt; Messages { get; private set; }

    [TempData]
    public string MessageAnalysisResult { get; set; }

    public string Quote { get; private set; }

    public async Task OnGetAsync()
    {
        Messages = await _db.GetMessagesAsync();

        Quote = await _quoteService.GenerateQuote();
    }
</code></pre>
<p><code>Pages/Index.cs</code>:</p>
<pre><code class="lang-cshtml">&lt;input id="quote" type="hidden" value="@Model.Quote"&gt;
</code></pre>
<p>The following markup is generated when the SUT app is run:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Come on, Sarah. We&amp;#x27;ve an appointment in 
    London, and we&amp;#x27;re already 30,000 years late."&gt;
</code></pre>
<p>To test the service and quote injection in an integration test, a mock service is injected into the SUT by the test. The mock service replaces the app's <code>QuoteService</code> with a service provided by the test app, called <code>TestQuoteService</code>:</p>
<p><code>IntegrationTests.IndexPageTests.cs</code>:</p>
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Pyramids of Mars
// https://www.bbc.co.uk/programmes/p00pys55
public class TestQuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult(
            "Something's interfering with time, Mr. Scarman, " +
            "and time is my business.");
    }
}
</code></pre>
<p><code>ConfigureTestServices</code> is called, and the scoped service is registered:</p>
<pre><code class="lang-csharp" highlight-lines="7-10,17,20-21">[Fact]
public async Task Get_QuoteService_ProvidesQuoteInPage()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddScoped&lt;IQuoteService, TestQuoteService&gt;();
            });
        })
        .CreateClient();

    //Act
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);
    var quoteElement = content.QuerySelector("#quote");

    // Assert
    Assert.Equal("Something's interfering with time, Mr. Scarman, " +
        "and time is my business.", quoteElement.Attributes["value"].Value);
}
</code></pre>
<p>The markup produced during the test's execution reflects the quote text supplied by <code>TestQuoteService</code>, thus the assertion passes:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Something&amp;#x27;s interfering with time, 
    Mr. Scarman, and time is my business."&gt;
</code></pre>
<h2 id="mock-authentication">Mock authentication</h2>
<p>Tests in the <code>AuthTests</code> class check that a secure endpoint:</p>
<ul>
<li>Redirects an unauthenticated user to the app's sign in page.</li>
<li>Returns content for an authenticated user.</li>
</ul>
<p>In the SUT, the <code>/SecurePage</code> page uses an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage" class="no-loc" data-linktype="absolute-path">AuthorizePage</a> convention to apply an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter" class="no-loc" data-linktype="absolute-path">AuthorizeFilter</a> to the page. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authorization/razor-pages-authorization?view=aspnetcore-9.0#require-authorization-to-access-a-page" data-linktype="relative-path">Razor Pages authorization conventions</a>.</p>
<pre><code class="lang-csharp">services.AddRazorPages(options =&gt;
{
    options.Conventions.AuthorizePage("/SecurePage");
});
</code></pre>
<p>In the <code>Get_SecurePageRedirectsAnUnauthenticatedUser</code> test, a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> is set to disallow redirects by setting <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect#microsoft-aspnetcore-mvc-testing-webapplicationfactoryclientoptions-allowautoredirect" class="no-loc" data-linktype="absolute-path">AllowAutoRedirect</a> to <code>false</code>:</p>
<pre><code class="lang-csharp">[Fact]
public async Task Get_SecurePageRedirectsAnUnauthenticatedUser()
{
    // Arrange
    var client = _factory.CreateClient(
        new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });

    // Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.StartsWith("http://localhost/Identity/Account/Login",
        response.Headers.Location.OriginalString);
}
</code></pre>
<p>By disallowing the client to follow the redirect, the following checks can be made:</p>
<ul>
<li>The status code returned by the SUT can be checked against the expected <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-redirect" class="no-loc" data-linktype="absolute-path">HttpStatusCode.Redirect</a> result, not the final status code after the redirect to the sign in page, which would be <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-ok" class="no-loc" data-linktype="absolute-path">HttpStatusCode.OK</a>.</li>
<li>The <code>Location</code> header value in the response headers is checked to confirm that it starts with <code>http://localhost/Identity/Account/Login</code>, not the final sign in page response, where the <code>Location</code> header wouldn't be present.</li>
</ul>
<p>The test app can mock an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a> in <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> in order to test aspects of authentication and authorization. A minimal scenario returns an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticateresult.success" class="no-loc" data-linktype="absolute-path">AuthenticateResult.Success</a>:</p>
<pre><code class="lang-csharp" highlight-lines="11-18">public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options,
        ILoggerFactory logger, UrlEncoder encoder)
        : base(options, logger, encoder)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[] { new Claim(ClaimTypes.Name, "Test user") };
        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "TestScheme");

        var result = AuthenticateResult.Success(ticket);

        return Task.FromResult(result);
    }
}
</code></pre>
<p>The <code>TestAuthHandler</code> is called to authenticate a user when the authentication scheme is set to <code>TestScheme</code> where <code>AddAuthentication</code> is registered for <code>ConfigureTestServices</code>. It's important for the <code>TestScheme</code> scheme to match the scheme your app expects. Otherwise, authentication won't work.</p>
<pre><code class="lang-csharp" highlight-lines="7-12">[Fact]
public async Task Get_SecurePageIsReturnedForAnAuthenticatedUser()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddAuthentication(defaultScheme: "TestScheme")
                    .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                        "TestScheme", options =&gt; { });
            });
        })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false,
        });

    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue(scheme: "TestScheme");

    //Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.OK, response.StatusCode);
}
</code></pre>
<p>For more information on <code>WebApplicationFactoryClientOptions</code>, see the <a href="#client-options" data-linktype="self-bookmark">Client options</a> section.</p>
<h3 id="basic-tests-for-authentication-middleware">Basic tests for authentication middleware</h3>
<p>See <a href="https://github.com/blowdart/idunno.Authentication/tree/dev/test/idunno.Authentication.Basic.Test" data-linktype="external">this GitHub repository</a> for basic tests of authentication middleware. It contains a <a href="https://github.com/blowdart/idunno.Authentication/blob/dev/test/idunno.Authentication.Basic.Test/BasicAuthenticationTests.cs#L331" data-linktype="external">test server</a> that’s specific to the test scenario.</p>
<h2 id="set-the-environment">Set the environment</h2>
<p>Set the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-9.0" data-linktype="relative-path">environment</a> in the custom application factory:</p>
<pre><code class="lang-csharp" highlight-lines="36">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbContextOptions&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre><h2 id="how-the-test-infrastructure-infers-the-app-content-root-path">How the test infrastructure infers the app content root path</h2>
<p>The <code>WebApplicationFactory</code> constructor infers the app <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> path by searching for a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryContentRootAttribute</a> on the assembly containing the integration tests with a key equal to the <code>TEntryPoint</code> assembly <code>System.Reflection.Assembly.FullName</code>. In case an attribute with the correct key isn't found, <code>WebApplicationFactory</code> falls back to searching for a solution file (<em>.sln</em>) and appends the <code>TEntryPoint</code> assembly name to the solution directory. The app root directory (the content root path) is used to discover views and content files.</p>
<h2 id="disable-shadow-copying">Disable shadow copying</h2>
<p>Shadow copying causes the tests to execute in a different directory than the output directory. If your tests rely on loading files relative to <code>Assembly.Location</code> and you encounter issues, you might have to disable shadow copying.</p>
<p>To disable shadow copying when using xUnit, create a <code>xunit.runner.json</code> file in your test project directory, with the <a href="https://xunit.net/docs/configuration-files#shadowCopy" data-linktype="external">correct configuration setting</a>:</p>
<pre><code class="lang-json">{
  "shadowCopy": false
}
</code></pre>
<h2 id="disposal-of-objects">Disposal of objects</h2>
<p>After the tests of the <code>IClassFixture</code> implementation are executed, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> are disposed when xUnit disposes of the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path"><code>WebApplicationFactory</code></a>. If objects instantiated by the developer require disposal, dispose of them in the <code>IClassFixture</code> implementation. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose" data-linktype="absolute-path">Implementing a Dispose method</a>.</p>
<h2 id="integration-tests-sample">Integration tests sample</h2>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/8.x/IntegrationTestsSample" data-linktype="external">sample app</a> is composed of two apps:</p>
<table>
<thead>
<tr>
<th>App</th>
<th>Project directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Message app (the SUT)</td>
<td><code>src/RazorPagesProject</code></td>
<td>Allows a user to add, delete one, delete all, and analyze messages.</td>
</tr>
<tr>
<td>Test app</td>
<td><code>tests/RazorPagesProject.Tests</code></td>
<td>Used to integration test the SUT.</td>
</tr>
</tbody>
</table>
<p>The tests can be run using the built-in test features of an IDE, such as <a href="https://visualstudio.microsoft.com/" data-linktype="external">Visual Studio</a>. If using <a href="https://code.visualstudio.com/" data-linktype="external">Visual Studio Code</a> or the command line, execute the following command at a command prompt in the <code>tests/RazorPagesProject.Tests</code> directory:</p>
<pre><code class="lang-console">dotnet test
</code></pre>
<h3 id="message-app-sut-organization">Message app (SUT) organization</h3>
<p>The SUT is a Razor Pages message system with the following characteristics:</p>
<ul>
<li>The Index page of the app (<code>Pages/Index.cshtml</code> and <code>Pages/Index.cshtml.cs</code>) provides a UI and page model methods to control the addition, deletion, and analysis of messages (average words per message).</li>
<li>A message is described by the <code>Message</code> class (<code>Data/Message.cs</code>) with two properties: <code>Id</code> (key) and <code>Text</code> (message). The <code>Text</code> property is required and limited to 200 characters.</li>
<li>Messages are stored using <a href="https://learn.microsoft.com/en-us/ef/core/providers/in-memory/" data-linktype="absolute-path">Entity Framework's in-memory database</a>†.</li>
<li>The app contains a data access layer (DAL) in its database context class, <code>AppDbContext</code> (<code>Data/AppDbContext.cs</code>).</li>
<li>If the database is empty on app startup, the message store is initialized with three messages.</li>
<li>The app includes a <code>/SecurePage</code> that can only be accessed by an authenticated user.</li>
</ul>
<p>†The EF article, <a href="https://learn.microsoft.com/en-us/ef/core/miscellaneous/testing/in-memory" data-linktype="absolute-path">Test with InMemory</a>, explains how to use an in-memory database for tests with MSTest. This topic uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework. Test concepts and test implementations across different test frameworks are similar but not identical.</p>
<p>Although the app doesn't use the repository pattern and isn't an effective example of the <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" data-linktype="external">Unit of Work (UoW) pattern</a>, Razor Pages supports these patterns of development. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design" data-linktype="absolute-path">Designing the infrastructure persistence layer</a> and <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic</a> (the sample implements the repository pattern).</p>
<h3 id="test-app-organization">Test app organization</h3>
<p>The test app is a console app inside the <code>tests/RazorPagesProject.Tests</code> directory.</p>
<table>
<thead>
<tr>
<th>Test app directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuthTests</code></td>
<td>Contains test methods for:<ul><li>Accessing a secure page by an unauthenticated user.</li><li>Accessing a secure page by an authenticated user with a mock <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a>.</li><li>Obtaining a GitHub user profile and checking the profile's user login.</li></ul></td>
</tr>
<tr>
<td><code>BasicTests</code></td>
<td>Contains a test method for routing and content type.</td>
</tr>
<tr>
<td><code>IntegrationTests</code></td>
<td>Contains the integration tests for the Index page using custom <code>WebApplicationFactory</code> class.</td>
</tr>
<tr>
<td><code>Helpers/Utilities</code></td>
<td><ul><li><code>Utilities.cs</code> contains the <code>InitializeDbForTests</code> method used to seed the database with test data.</li><li><code>HtmlHelpers.cs</code> provides a method to return an AngleSharp <code>IHtmlDocument</code> for use by the test methods.</li><li><code>HttpClientExtensions.cs</code> provide overloads for <code>SendAsync</code> to submit requests to the SUT.</li></ul></td>
</tr>
</tbody>
</table>
<p>The test framework is <a href="https://xunit.net/" data-linktype="external">xUnit</a>. Integration tests are conducted using the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost" class="no-loc" data-linktype="absolute-path">Microsoft.AspNetCore.TestHost</a>, which includes the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>. Because the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package is used to configure the test host and test server, the <code>TestHost</code> and <code>TestServer</code> packages don't require direct package references in the test app's project file or developer configuration in the test app.</p>
<p>Integration tests usually require a small dataset in the database prior to the test execution. For example, a delete test calls for a database record deletion, so the database must have at least one record for the delete request to succeed.</p>
<p>The sample app seeds the database with three messages in <code>Utilities.cs</code> that tests can use when they execute:</p>
<pre><code class="lang-csharp">public static void InitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.AddRange(GetSeedingMessages());
    db.SaveChanges();
}

public static void ReinitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.RemoveRange(db.Messages);
    InitializeDbForTests(db);
}

public static List&lt;Message&gt; GetSeedingMessages()
{
    return new List&lt;Message&gt;()
    {
        new Message(){ Text = "TEST RECORD: You're standing on my scarf." },
        new Message(){ Text = "TEST RECORD: Would you like a jelly baby?" },
        new Message(){ Text = "TEST RECORD: To the rational mind, " +
            "nothing is inexplicable; only unexplained." }
    };
}
</code></pre>
<p>The SUT's database context is registered in <code>Program.cs</code>. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Program.cs</code> code is executed. To use a different database for the tests, the app's database context must be replaced in <code>builder.ConfigureServices</code>. For more information, see the <a href="#customize-webapplicationfactory" data-linktype="self-bookmark">Customize WebApplicationFactory</a> section.</p>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">Unit tests</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests in ASP.NET Core</a></li>
<li><a href="../fundamentals/middleware/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">ASP.NET Core Middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic in ASP.NET Core</a></li>
<li><a href="https://github.com/blowdart/idunno.Authentication/tree/dev/test/idunno.Authentication.Basic.Test" data-linktype="external">Basic tests for authentication middleware</a></li>
</ul>
</div>
<div data-moniker="aspnetcore-9.0">
<p>This article assumes a basic understanding of unit tests. If unfamiliar with test concepts, see the <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">Testing in .NET</a> article and its linked content.</p>
<p><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/9.x/IntegrationTestsSample" data-linktype="external">View or download sample code</a> (<a href="../overview553c.html?view=aspnetcore-9.0#how-to-download-a-sample" data-linktype="relative-path">how to download</a>)</p>
<p>The sample app is a Razor Pages app and assumes a basic understanding of Razor Pages. If you're unfamiliar with Razor Pages, see the following articles:</p>
<ul>
<li><a href="../razor-pages/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Introduction to Razor Pages</a></li>
<li><a href="../tutorials/razor-pages/razor-pages-start553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Get started with Razor Pages</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests</a></li>
</ul>
<p><strong>For testing SPAs</strong>, we recommend a tool such as <a href="https://playwright.dev/dotnet/" data-linktype="external">Playwright for .NET</a>, which can automate a browser.</p>
<h2 id="introduction-to-integration-tests">Introduction to integration tests</h2>
<p>Integration tests evaluate an app's components on a broader level than <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/" data-linktype="absolute-path">unit tests</a>. Unit tests are used to test isolated software components, such as individual class methods. Integration tests confirm that two or more app components work together to produce an expected result, possibly including every component required to fully process a request.</p>
<p>These broader tests are used to test the app's infrastructure and whole framework, often including the following components:</p>
<ul>
<li>Database</li>
<li>File system</li>
<li>Network appliances</li>
<li>Request-response pipeline</li>
</ul>
<p>Unit tests use fabricated components, known as <a href="https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-best-practices#lets-speak-the-same-language" data-linktype="absolute-path"><em>fakes</em> or <em>mock objects</em></a>, in place of infrastructure components.</p>
<p>In contrast to unit tests, integration tests:</p>
<ul>
<li>Use the actual components that the app uses in production.</li>
<li>Require more code and data processing.</li>
<li>Take longer to run.</li>
</ul>
<p>Therefore, limit the use of integration tests to the most important infrastructure scenarios. If a behavior can be tested using either a unit test or an integration test, choose the unit test.</p>
<p>In discussions of integration tests, the tested project is frequently called the <em><strong>System Under Test</strong></em>, or "<strong>SUT</strong>" for short. "SUT" is used throughout this article to refer to the ASP.NET Core app being tested.</p>
<p><em><strong>Don't write integration tests for every permutation</strong></em> of data and file access with databases and file systems. Regardless of how many places across an app interact with databases and file systems, a focused set of read, write, update, and delete integration tests are usually capable of adequately testing database and file system components. Use unit tests for routine tests of method logic that interact with these components. In unit tests, the use of infrastructure fakes or mocks result in faster test execution.</p>
<h2 id="aspnet-core-integration-tests">ASP.NET Core integration tests</h2>
<p>Integration tests in ASP.NET Core require the following:</p>
<ul>
<li>A test project is used to contain and execute the tests. The test project has a reference to the SUT.</li>
<li>The test project creates a test web host for the SUT and uses a test server client to handle requests and responses with the SUT.</li>
<li>A test runner is used to execute the tests and report the test results.</li>
</ul>
<p>Integration tests follow a sequence of events that include the usual <em>Arrange</em>, <em>Act</em>, and <em>Assert</em> test steps:</p>
<ol>
<li>The SUT's web host is configured.</li>
<li>A test server client is created to submit requests to the app.</li>
<li>The <em>Arrange</em> test step is executed: The test app prepares a request.</li>
<li>The <em>Act</em> test step is executed: The client submits the request and receives the response.</li>
<li>The <em>Assert</em> test step is executed: The <em>actual</em> response is validated as a <em>pass</em> or <em>fail</em> based on an <em>expected</em> response.</li>
<li>The process continues until all of the tests are executed.</li>
<li>The test results are reported.</li>
</ol>
<p>Usually, the test web host is configured differently than the app's normal web host for the test runs. For example, a different database or different app settings might be used for the tests.</p>
<p>Infrastructure components, such as the test web host and in-memory test server (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>), are provided or managed by the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external">Microsoft.AspNetCore.Mvc.Testing</a> package. Use of this package streamlines test creation and execution.</p>
<p>The <code>Microsoft.AspNetCore.Mvc.Testing</code> package handles the following tasks:</p>
<ul>
<li>Copies the dependencies file (<code>.deps</code>) from the SUT into the test project's <code>bin</code> directory.</li>
<li>Sets the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> to the SUT's project root so that static files and pages/views are found when the tests are executed.</li>
<li>Provides the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path">WebApplicationFactory</a> class to streamline bootstrapping the SUT with <code>TestServer</code>.</li>
</ul>
<p>The <a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">unit tests</a> documentation describes how to set up a test project and test runner, along with detailed instructions on how to run tests and recommendations for how to name tests and test classes.</p>
<p><strong>Separate unit tests from integration tests into different projects</strong>. Separating the tests:</p>
<ul>
<li>Helps ensure that infrastructure testing components aren't accidentally included in the unit tests.</li>
<li>Allows control over which set of tests are run.</li>
</ul>
<p>There's virtually no difference between the configuration for tests of Razor Pages apps and MVC apps. The only difference is in how the tests are named. In a Razor Pages app, tests of page endpoints are usually named after the page model class (for example, <code>IndexPageTests</code> to test component integration for the Index page). In an MVC app, tests are usually organized by controller classes and named after the controllers they test (for example, <code>HomeControllerTests</code> to test component integration for the Home controller).</p>
<h2 id="test-app-prerequisites">Test app prerequisites</h2>
<p>The test project must:</p>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package.</li>
<li>Specify the Web SDK in the project file (<code>&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;</code>).</li>
</ul>
<p>These prerequisites can be seen in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/9.x/IntegrationTestsSample" data-linktype="external">sample app</a>. Inspect the <code>tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj</code> file. The sample app uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework and the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser library, so the sample app also references:</p>
<ul>
<li><a href="https://www.nuget.org/packages/AngleSharp" data-linktype="external"><code>AngleSharp</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit" data-linktype="external"><code>xunit</code></a></li>
<li><a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a></li>
</ul>
<p>In apps that use <a href="https://www.nuget.org/packages/xunit.runner.visualstudio" data-linktype="external"><code>xunit.runner.visualstudio</code></a> version 2.4.2 or later, the test project must reference the <a href="https://www.nuget.org/packages/Microsoft.NET.Test.Sdk" data-linktype="external"><code>Microsoft.NET.Test.Sdk</code></a> package.</p>
<p>Entity Framework Core is also used in the tests. See the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/9.x/IntegrationTestsSample/src/RazorPagesProject/RazorPagesProject.csproj" data-linktype="external">project file in GitHub</a>.</p>
<h2 id="sut-environment">SUT environment</h2>
<p>If the SUT's <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-9.0" data-linktype="relative-path">environment</a> isn't set, the environment defaults to Development.</p>
<h2 id="basic-tests-with-the-default-webapplicationfactory">Basic tests with the default WebApplicationFactory</h2>
<p>Expose the implicitly defined <code>Program</code> class to the test project by doing one of the following:</p>
<ul>
<li><p>Expose internal types from the web app to the test project. This can be done in the SUT project's file (<code>.csproj</code>):</p>
<pre><code class="lang-xml">&lt;ItemGroup&gt;
     &lt;InternalsVisibleTo Include="MyTestProject" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
</li>
<li><p>Make the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/9.x/IntegrationTestsSample/src/RazorPagesProject/Program.cs" data-linktype="external"><code>Program</code> class public using a partial class</a> declaration:</p>
<pre><code class="lang-diff">var builder = WebApplication.CreateBuilder(args);
// ... Configure services, routes, etc.
app.Run();
+ public partial class Program { }
</code></pre>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/9.x/IntegrationTestsSample" data-linktype="external">sample app</a> uses the <code>Program</code> partial class approach.</p>
</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" class="no-loc" data-linktype="absolute-path">WebApplicationFactory&lt;TEntryPoint&gt;</a> is used to create a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> for the integration tests. <code>TEntryPoint</code> is the entry point class of the SUT, usually <code>Program.cs</code>.</p>
<p>Test classes implement a <em>class fixture</em> interface (<a href="https://xunit.net/docs/shared-context#class-fixture" data-linktype="external"><code>IClassFixture</code></a>) to indicate the class contains tests and provide shared object instances across the tests in the class.</p>
<p>The following test class, <code>BasicTests</code>, uses the <code>WebApplicationFactory</code> to bootstrap the SUT and provide an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> to a test method, <code>Get_EndpointsReturnSuccessAndCorrectContentType</code>. The method verifies the response status code is successful (200-299) and the <code>Content-Type</code> header is <code>text/html; charset=utf-8</code> for several app pages.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> creates an instance of <code>HttpClient</code> that automatically follows redirects and handles cookies.</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">public class BasicTests 
    : IClassFixture&lt;WebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly WebApplicationFactory&lt;Program&gt; _factory;

    public BasicTests(WebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
    }

    [Theory]
    [InlineData("/")]
    [InlineData("/Index")]
    [InlineData("/About")]
    [InlineData("/Privacy")]
    [InlineData("/Contact")]
    public async Task Get_EndpointsReturnSuccessAndCorrectContentType(string url)
    {
        // Arrange
        var client = _factory.CreateClient();

        // Act
        var response = await client.GetAsync(url);

        // Assert
        response.EnsureSuccessStatusCode(); // Status Code 200-299
        Assert.Equal("text/html; charset=utf-8", 
            response.Content.Headers.ContentType.ToString());
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestClass]
public class BasicTests
{
    private static CustomWebApplicationFactory&lt;Program&gt; _factory;

    [ClassInitialize]
    public static void AssemblyInitialize(TestContext _)
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
    }

    [ClassCleanup(ClassCleanupBehavior.EndOfClass)]
    public static void AssemblyCleanup(TestContext _)
    {
        _factory.Dispose();
    }

    [TestMethod]
    [DataRow("/")]
    [DataRow("/Index")]
    [DataRow("/About")]
    [DataRow("/Privacy")]
    [DataRow("/Contact")]
    public async Task Get_EndpointsReturnSuccessAndCorrectContentType(string url)
    {
        // Arrange
        var client = _factory.CreateClient();

        // Act
        var response = await client.GetAsync(url);

        // Assert
        response.EnsureSuccessStatusCode(); // Status Code 200-299
        Assert.AreEqual("text/html; charset=utf-8",
            response.Content.Headers.ContentType.ToString());
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">public class BasicTests
{
    private CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [SetUp]
    public void SetUp()
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
    }

    [TearDown]
    public void TearDown()
    {
        _factory.Dispose();
    }

    [DatapointSource]
    public string[] values = ["/", "/Index", "/About", "/Privacy", "/Contact"];

    [Theory]
    public async Task Get_EndpointsReturnSuccessAndCorrectContentType(string url)
    {
        // Arrange
        var client = _factory.CreateClient();

        // Act
        var response = await client.GetAsync(url);

        // Assert
        response.EnsureSuccessStatusCode(); // Status Code 200-299
        Assert.That(response.Content.Headers.ContentType.ToString(), Is.EqualTo("text/html; charset=utf-8"));
    }
}
</code></pre>
</div>
<p>By default, non-essential cookies aren't preserved across requests when the <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0" data-linktype="relative-path">General Data Protection Regulation consent policy</a> is enabled. To preserve non-essential cookies, such as those used by the TempData provider, mark them as essential in your tests. For instructions on marking a cookie as essential, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0#essential-cookies" data-linktype="relative-path">Essential cookies</a>.</p>
<p><a name="asap7"></a></p>
<h2 id="anglesharp-vs-application-parts-for-antiforgery-checks">AngleSharp vs <code>Application Parts</code> for antiforgery checks</h2>
<p>This article uses the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser to handle the antiforgery checks by loading pages and parsing the HTML. For testing the endpoints of controller and Razor Pages views at a lower-level, without caring about how they render in the browser, consider using <code>Application Parts</code>. The <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/advanced/app-parts?view=aspnetcore-9.0" data-linktype="relative-path">Application Parts</a> approach injects a controller or Razor Page into the app that can be used to make JSON requests to get the required values. For more information, see the blog <a href="https://blog.martincostello.com/integration-testing-antiforgery-with-application-parts/" data-linktype="external">Integration Testing ASP.NET Core Resources Protected with Antiforgery Using Application Parts</a> and <a href="https://github.com/martincostello/antiforgery-testing-application-part" data-linktype="external">associated GitHub repo</a> by <a href="https://github.com/martincostello" data-linktype="external">Martin Costello</a>. <!--See https://github.com/dotnet/AspNetCore.Docs/issues/18860 --></p>
<h2 id="customize-webapplicationfactory">Customize WebApplicationFactory</h2>
<p>Web host configuration can be created independently of the test classes by inheriting from <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" class="no-loc" data-linktype="absolute-path">WebApplicationFactory&lt;TEntryPoint&gt;</a> to create one or more custom factories:</p>
<ol>
<li><p>Inherit from <code>WebApplicationFactory</code> and override <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost" class="no-loc" data-linktype="absolute-path">ConfigureWebHost</a>. The <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> allows the configuration of the service collection with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder.configureservices" data-linktype="absolute-path"><code>IWebHostBuilder.ConfigureServices</code></a></p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType == 
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<p>Database seeding in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/9.x/IntegrationTestsSample" data-linktype="external">sample app</a> is performed by the <code>InitializeDbForTests</code> method. The method is described in the <a href="#test-app-organization" data-linktype="self-bookmark">Integration tests sample: Test app organization</a> section.</p>
<p>The SUT's database context is registered in <code>Program.cs</code>. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Program.cs</code> code is executed. To use a different database for the tests than the app's database, the app's database context must be replaced in <code>builder.ConfigureServices</code>.</p>
<p>The sample app finds the service descriptor for the database context and uses the descriptor to remove the service registration. The factory then adds a new <code>ApplicationDbContext</code> that uses an in-memory database for the tests..</p>
<p>To connect to a different database, change the <code>DbConnection</code>. To use a SQL Server test database:</p>
<ul>
<li>Reference the <a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/" data-linktype="external"><code>Microsoft.EntityFrameworkCore.SqlServer</code></a> NuGet package in the project file.</li>
<li>Call <code>UseInMemoryDatabase</code>.</li>
</ul>
</li>
</ol>
<!--
    [!code-csharp[](~/../AspNetCore.Docs.Samples/test/integration-tests/9.x/IntegrationTestsSample/src/RazorPagesProject/Program.cs?name=snippet_all)]
-->
<ol start="2">
<li><p>Use the custom <code>CustomWebApplicationFactory</code> in test classes. The following example uses the factory in the <code>IndexPageTests</code> class:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">public class IndexPageTests :
    IClassFixture&lt;CustomWebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly HttpClient _client;
    private readonly CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    public IndexPageTests(
        CustomWebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
        _client = factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestClass]
public class IndexPageTests
{
    private static HttpClient _client;
    private static CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [ClassInitialize]
    public static void AssemblyInitialize(TestContext _)
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
        _client = _factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }

    [ClassCleanup(ClassCleanupBehavior.EndOfClass)]
    public static void AssemblyCleanup(TestContext _)
    {
        _factory.Dispose();
    }
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">public class IndexPageTests
{

    private HttpClient _client;
    private CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [SetUp]
    public void SetUp()
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
        _client = _factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }

    [TearDown]
    public void TearDown()
    {
        _factory.Dispose();
        _client.Dispose();
    }
</code></pre>
</div>
<p>The sample app's client is configured to prevent the <code>HttpClient</code> from following redirects. As explained later in the <a href="#mock-authentication" data-linktype="self-bookmark">Mock authentication</a> section, this permits tests to check the result of the app's first response. The first response is a redirect in many of these tests with a <code>Location</code> header.</p>
</li>
<li><p>A typical test uses the <code>HttpClient</code> and helper methods to process the request and the response:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteAllMessagesHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("button[id='deleteAllBtn']"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestMethod]
public async Task Post_DeleteAllMessagesHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("button[id='deleteAllBtn']"));

    // Assert
    Assert.AreEqual(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.AreEqual(HttpStatusCode.Redirect, response.StatusCode);
    Assert.AreEqual("/", response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">[Test]
public async Task Post_DeleteAllMessagesHandler_ReturnsRedirectToRoot()
{
    // Arrange
    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("button[id='deleteAllBtn']"));

    // Assert
    Assert.That(defaultPage.StatusCode, Is.EqualTo(HttpStatusCode.OK));
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.Redirect));
    Assert.That(response.Headers.Location.OriginalString, Is.EqualTo("/"));
}
</code></pre>
</div>
</li>
</ol>
<p>Any POST request to the SUT must satisfy the antiforgery check that's automatically made by the app's <a href="../security/data-protection/introduction553c.html?view=aspnetcore-9.0" data-linktype="relative-path">data protection antiforgery system</a>. In order to arrange for a test's POST request, the test app must:</p>
<ol>
<li>Make a request for the page.</li>
<li>Parse the antiforgery cookie and request validation token from the response.</li>
<li>Make the POST request with the antiforgery cookie and request validation token in place.</li>
</ol>
<p>The <code>SendAsync</code> helper extension methods (<code>Helpers/HttpClientExtensions.cs</code>) and the <code>GetDocumentAsync</code> helper method (<code>Helpers/HtmlHelpers.cs</code>) in the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/9.x/IntegrationTestsSample/" data-linktype="external">sample app</a> use the <a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> parser to handle the antiforgery check with the following methods:</p>
<ul>
<li><code>GetDocumentAsync</code>: Receives the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpresponsemessage" class="no-loc" data-linktype="absolute-path">HttpResponseMessage</a> and returns an <code>IHtmlDocument</code>. <code>GetDocumentAsync</code> uses a factory that prepares a <em>virtual response</em> based on the original <code>HttpResponseMessage</code>. For more information, see the <a href="https://github.com/AngleSharp/AngleSharp#documentation" data-linktype="external">AngleSharp documentation</a>.</li>
<li><code>SendAsync</code> extension methods for the <code>HttpClient</code> compose an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httprequestmessage" class="no-loc" data-linktype="absolute-path">HttpRequestMessage</a> and call <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient.sendasync#system-net-http-httpclient-sendasync(system-net-http-httprequestmessage)" class="no-loc" data-linktype="absolute-path">SendAsync(HttpRequestMessage)</a> to submit requests to the SUT. Overloads for <code>SendAsync</code> accept the HTML form (<code>IHtmlFormElement</code>) and the following:
<ul>
<li>Submit button of the form (<code>IHtmlElement</code>)</li>
<li>Form values collection (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
<li>Submit button (<code>IHtmlElement</code>) and form values (<code>IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt;</code>)</li>
</ul>
</li>
</ul>
<p><a href="https://anglesharp.github.io/" data-linktype="external">AngleSharp</a> is a <strong>third-party parsing library used for demonstration purposes</strong> in this article and the sample app. AngleSharp isn't supported or required for integration testing of ASP.NET Core apps. Other parsers can be used, such as the <a href="https://html-agility-pack.net/" data-linktype="external">Html Agility Pack (HAP)</a>. Another approach is to write code to handle the antiforgery system's request verification token and antiforgery cookie directly. See <a href="#asap7" data-linktype="self-bookmark">AngleSharp vs <code>Application Parts</code> for antiforgery checks</a> in this article for more information.</p>
<p>The <a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#in-memory-as-a-database-fake" data-linktype="absolute-path">EF-Core in-memory database provider</a> can be used for limited and basic testing, however the <em><strong><a href="https://learn.microsoft.com/en-us/ef/core/testing/choosing-a-testing-strategy#sqlite-as-a-database-fake" data-linktype="absolute-path">SQLite provider</a> is the recommended choice for in-memory testing</strong></em>.</p>
<p>See <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup?view=aspnetcore-9.0#IStartupFilter" data-linktype="relative-path">Extend Startup with startup filters</a> which shows how to configure middleware using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.istartupfilter" class="no-loc" data-linktype="absolute-path">IStartupFilter</a>, which is useful when a test requires a custom service or middleware.</p>
<h2 id="customize-the-client-with-withwebhostbuilder">Customize the client with WithWebHostBuilder</h2>
<p>When additional configuration is required within a test method, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder" class="no-loc" data-linktype="absolute-path">WithWebHostBuilder</a> creates a new <code>WebApplicationFactory</code> with an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder" class="no-loc" data-linktype="absolute-path">IWebHostBuilder</a> that is further customized by configuration.</p>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/9.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests" data-linktype="external">sample code</a> calls <code>WithWebHostBuilder</code> to replace configured services with test stubs. For more information and example usage, see <a href="#inject-mock-services" data-linktype="self-bookmark">Inject mock services</a> in this article.</p>
<p>The <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> test method of the <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/9.x/IntegrationTestsSample" data-linktype="external">sample app</a> demonstrates the use of <code>WithWebHostBuilder</code>. This test performs a record delete in the database by triggering a form submission in the SUT.</p>
<p>Because another test in the <code>IndexPageTests</code> class performs an operation that deletes all of the records in the database and may run before the <code>Post_DeleteMessageHandler_ReturnsRedirectToRoot</code> method, the database is reseeded in this test method to ensure that a record is present for the SUT to delete. Selecting the first delete button of the <code>messages</code> form in the SUT is simulated in the request to the SUT:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">[Fact]
public async Task Post_DeleteMessageHandler_ReturnsRedirectToRoot()
{
    // Arrange
    using (var scope = _factory.Services.CreateScope())
    {
        var scopedServices = scope.ServiceProvider;
        var db = scopedServices.GetRequiredService&lt;ApplicationDbContext&gt;();

        Utilities.ReinitializeDbForTests(db);
    }

    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("form[id='messages']")
            .QuerySelector("div[class='panel-body']")
            .QuerySelector("button"));

    // Assert
    Assert.Equal(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.Equal("/", response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestMethod]
public async Task Post_DeleteMessageHandler_ReturnsRedirectToRoot()
{
    // Arrange
    using (var scope = _factory.Services.CreateScope())
    {
        var scopedServices = scope.ServiceProvider;
        var db = scopedServices.GetRequiredService&lt;ApplicationDbContext&gt;();

        Utilities.ReinitializeDbForTests(db);
    }

    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("form[id='messages']")
            .QuerySelector("div[class='panel-body']")
            .QuerySelector("button"));

    // Assert
    Assert.AreEqual(HttpStatusCode.OK, defaultPage.StatusCode);
    Assert.AreEqual(HttpStatusCode.Redirect, response.StatusCode);
    Assert.AreEqual("/", response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">[Test]
public async Task Post_DeleteMessageHandler_ReturnsRedirectToRoot()
{
    // Arrange
    using (var scope = _factory.Services.CreateScope())
    {
        var scopedServices = scope.ServiceProvider;
        var db = scopedServices.GetRequiredService&lt;ApplicationDbContext&gt;();

        Utilities.ReinitializeDbForTests(db);
    }

    var defaultPage = await _client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);

    //Act
    var response = await _client.SendAsync(
        (IHtmlFormElement)content.QuerySelector("form[id='messages']"),
        (IHtmlButtonElement)content.QuerySelector("form[id='messages']")
            .QuerySelector("div[class='panel-body']")
            .QuerySelector("button"));

    // Assert
    Assert.That(defaultPage.StatusCode, Is.EqualTo(HttpStatusCode.OK));
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.Redirect));
    Assert.That(response.Headers.Location.OriginalString, Is.EqualTo("/"));
}
</code></pre>
</div>
<h2 id="client-options">Client options</h2>
<p>See the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> page for defaults and available options when creating <code>HttpClient</code> instances.</p>
<p>Create the <code>WebApplicationFactoryClientOptions</code> class and pass it to the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient#microsoft-aspnetcore-mvc-testing-webapplicationfactory-1-createclient" class="no-loc" data-linktype="absolute-path">CreateClient()</a> method:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">public class IndexPageTests :
    IClassFixture&lt;CustomWebApplicationFactory&lt;Program&gt;&gt;
{
    private readonly HttpClient _client;
    private readonly CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    public IndexPageTests(
        CustomWebApplicationFactory&lt;Program&gt; factory)
    {
        _factory = factory;
        _client = factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestClass]
public class IndexPageTests
{
    private static HttpClient _client;
    private static CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [ClassInitialize]
    public static void AssemblyInitialize(TestContext _)
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
        _client = _factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }

    [ClassCleanup(ClassCleanupBehavior.EndOfClass)]
    public static void AssemblyCleanup(TestContext _)
    {
        _factory.Dispose();
    }
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">public class IndexPageTests
{

    private HttpClient _client;
    private CustomWebApplicationFactory&lt;Program&gt;
        _factory;

    [SetUp]
    public void SetUp()
    {
        _factory = new CustomWebApplicationFactory&lt;Program&gt;();
        _client = _factory.CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });
    }

    [TearDown]
    public void TearDown()
    {
        _factory.Dispose();
        _client.Dispose();
    }
</code></pre>
</div>
<p><em><strong>NOTE:</strong></em> To avoid HTTPS redirection warnings in logs when using HTTPS Redirection Middleware, set <code>BaseAddress = new Uri("https://localhost")</code></p>
<h2 id="inject-mock-services">Inject mock services</h2>
<p>Services can be overridden in a test with a call to <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> on the host builder. To scope the overridden services to the test itself, the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder" class="no-loc" data-linktype="absolute-path">WithWebHostBuilder</a> method is used to retrieve a host builder. This can be seen in the following tests:</p>
<ul>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/9.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs#L166-L173" data-linktype="external">Get_QuoteService_ProvidesQuoteInPage</a></li>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/9.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs#L35-L38" data-linktype="external">Get_GithubProfilePageCanGetAGithubUser</a></li>
<li><a href="https://github.com/dotnet/AspNetCore.Docs.Samples/blob/main/test/integration-tests/9.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs#L105-L117" data-linktype="external">Get_SecurePageIsReturnedForAnAuthenticatedUser</a></li>
</ul>
<p>The sample SUT includes a scoped service that returns a quote. The quote is embedded in a hidden field on the Index page when the Index page is requested.</p>
<p><code>Services/IQuoteService.cs</code>:</p>
<pre><code class="lang-csharp">public interface IQuoteService
{
    Task&lt;string&gt; GenerateQuote();
}
</code></pre>
<p><code>Services/QuoteService.cs</code>:</p>
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Dr. Who: Planet of Evil
// https://www.bbc.co.uk/programmes/p00pyrx6
public class QuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult&lt;string&gt;(
            "Come on, Sarah. We've an appointment in London, " +
            "and we're already 30,000 years late.");
    }
}
</code></pre>
<p><code>Program.cs</code>:</p>
<pre><code class="lang-csharp">services.AddScoped&lt;IQuoteService, QuoteService&gt;();
</code></pre>
<p><code>Pages/Index.cshtml.cs</code>:</p>
<pre><code class="lang-csharp" highlight-lines="4,9,20,26">public class IndexModel : PageModel
{
    private readonly ApplicationDbContext _db;
    private readonly IQuoteService _quoteService;

    public IndexModel(ApplicationDbContext db, IQuoteService quoteService)
    {
        _db = db;
        _quoteService = quoteService;
    }

    [BindProperty]
    public Message Message { get; set; }

    public IList&lt;Message&gt; Messages { get; private set; }

    [TempData]
    public string MessageAnalysisResult { get; set; }

    public string Quote { get; private set; }

    public async Task OnGetAsync()
    {
        Messages = await _db.GetMessagesAsync();

        Quote = await _quoteService.GenerateQuote();
    }
</code></pre>
<p><code>Pages/Index.cs</code>:</p>
<pre><code class="lang-cshtml">&lt;input id="quote" type="hidden" value="@Model.Quote"&gt;
</code></pre>
<p>The following markup is generated when the SUT app is run:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Come on, Sarah. We&amp;#x27;ve an appointment in 
    London, and we&amp;#x27;re already 30,000 years late."&gt;
</code></pre>
<p>To test the service and quote injection in an integration test, a mock service is injected into the SUT by the test. The mock service replaces the app's <code>QuoteService</code> with a service provided by the test app, called <code>TestQuoteService</code>:</p>
<p><code>IntegrationTests.IndexPageTests.cs</code>:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Pyramids of Mars
// https://www.bbc.co.uk/programmes/p00pys55
public class TestQuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult(
            "Something's interfering with time, Mr. Scarman, " +
            "and time is my business.");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Pyramids of Mars
// https://www.bbc.co.uk/programmes/p00pys55
public class TestQuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult(
            "Something's interfering with time, Mr. Scarman, " +
            "and time is my business.");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">// Quote ©1975 BBC: The Doctor (Tom Baker); Pyramids of Mars
// https://www.bbc.co.uk/programmes/p00pys55
public class TestQuoteService : IQuoteService
{
    public Task&lt;string&gt; GenerateQuote()
    {
        return Task.FromResult(
            "Something's interfering with time, Mr. Scarman, " +
            "and time is my business.");
    }
}
</code></pre>
</div>
<p><code>ConfigureTestServices</code> is called, and the scoped service is registered:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp" highlight-lines="7-10,17,20-21">[Fact]
public async Task Get_QuoteService_ProvidesQuoteInPage()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddScoped&lt;IQuoteService, TestQuoteService&gt;();
            });
        })
        .CreateClient();

    //Act
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);
    var quoteElement = content.QuerySelector("#quote");

    // Assert
    Assert.Equal("Something's interfering with time, Mr. Scarman, " +
        "and time is my business.", quoteElement.Attributes["value"].Value);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp" highlight-lines="7-10,17,20-21">[TestMethod]
public async Task Get_QuoteService_ProvidesQuoteInPage()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddScoped&lt;IQuoteService, TestQuoteService&gt;();
            });
        })
        .CreateClient();

    //Act
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);
    var quoteElement = content.QuerySelector("#quote");

    // Assert
    Assert.AreEqual("Something's interfering with time, Mr. Scarman, " +
        "and time is my business.", quoteElement.Attributes["value"].Value);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp" highlight-lines="7-10,17,20-22">[Test]
public async Task Get_QuoteService_ProvidesQuoteInPage()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddScoped&lt;IQuoteService, TestQuoteService&gt;();
            });
        })
        .CreateClient();

    //Act
    var defaultPage = await client.GetAsync("/");
    var content = await HtmlHelpers.GetDocumentAsync(defaultPage);
    var quoteElement = content.QuerySelector("#quote");

    // Assert
    Assert.That(quoteElement.Attributes["value"].Value, Is.EqualTo(
        "Something's interfering with time, Mr. Scarman, " +
        "and time is my business."));
}
</code></pre>
</div>
<p>The markup produced during the test's execution reflects the quote text supplied by <code>TestQuoteService</code>, thus the assertion passes:</p>
<pre><code class="lang-html">&lt;input id="quote" type="hidden" value="Something&amp;#x27;s interfering with time, 
    Mr. Scarman, and time is my business."&gt;
</code></pre>
<h2 id="mock-authentication">Mock authentication</h2>
<p>Tests in the <code>AuthTests</code> class check that a secure endpoint:</p>
<ul>
<li>Redirects an unauthenticated user to the app's sign in page.</li>
<li>Returns content for an authenticated user.</li>
</ul>
<p>In the SUT, the <code>/SecurePage</code> page uses an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage" class="no-loc" data-linktype="absolute-path">AuthorizePage</a> convention to apply an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter" class="no-loc" data-linktype="absolute-path">AuthorizeFilter</a> to the page. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authorization/razor-pages-authorization?view=aspnetcore-9.0#require-authorization-to-access-a-page" data-linktype="relative-path">Razor Pages authorization conventions</a>.</p>
<pre><code class="lang-csharp">services.AddRazorPages(options =&gt;
{
    options.Conventions.AuthorizePage("/SecurePage");
});
</code></pre>
<p>In the <code>Get_SecurePageRedirectsAnUnauthenticatedUser</code> test, a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryClientOptions</a> is set to disallow redirects by setting <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect#microsoft-aspnetcore-mvc-testing-webapplicationfactoryclientoptions-allowautoredirect" class="no-loc" data-linktype="absolute-path">AllowAutoRedirect</a> to <code>false</code>:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp">[Fact]
public async Task Get_SecurePageRedirectsAnUnauthenticatedUser()
{
    // Arrange
    var client = _factory.CreateClient(
        new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });

    // Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.Redirect, response.StatusCode);
    Assert.StartsWith("http://localhost/Identity/Account/Login",
        response.Headers.Location.OriginalString);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp">[TestMethod]
public async Task Get_SecurePageRedirectsAnUnauthenticatedUser()
{
    // Arrange
    var client = _factory.CreateClient(
        new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });

    // Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.AreEqual(HttpStatusCode.Redirect, response.StatusCode);
    StringAssert.StartsWith(response.Headers.Location.OriginalString, "http://localhost/Identity/Account/Login");
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp">[Test]
public async Task Get_SecurePageRedirectsAnUnauthenticatedUser()
{
    // Arrange
    var client = _factory.CreateClient(
        new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false
        });

    // Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.Redirect));
    Assert.That(response.Headers.Location.OriginalString, Does.StartWith("http://localhost/Identity/Account/Login"));
}
</code></pre>
</div>
<p>By disallowing the client to follow the redirect, the following checks can be made:</p>
<ul>
<li>The status code returned by the SUT can be checked against the expected <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-redirect" class="no-loc" data-linktype="absolute-path">HttpStatusCode.Redirect</a> result, not the final status code after the redirect to the sign in page, which would be <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode#system-net-httpstatuscode-ok" class="no-loc" data-linktype="absolute-path">HttpStatusCode.OK</a>.</li>
<li>The <code>Location</code> header value in the response headers is checked to confirm that it starts with <code>http://localhost/Identity/Account/Login</code>, not the final sign in page response, where the <code>Location</code> header wouldn't be present.</li>
</ul>
<p>The test app can mock an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a> in <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices" class="no-loc" data-linktype="absolute-path">ConfigureTestServices</a> in order to test aspects of authentication and authorization. A minimal scenario returns an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticateresult.success" class="no-loc" data-linktype="absolute-path">AuthenticateResult.Success</a>:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp" highlight-lines="11-18">public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options,
        ILoggerFactory logger, UrlEncoder encoder)
        : base(options, logger, encoder)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[] { new Claim(ClaimTypes.Name, "Test user") };
        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "TestScheme");

        var result = AuthenticateResult.Success(ticket);

        return Task.FromResult(result);
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp" highlight-lines="11-18">public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options,
        ILoggerFactory logger, UrlEncoder encoder)
        : base(options, logger, encoder)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[] { new Claim(ClaimTypes.Name, "Test user") };
        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "TestScheme");

        var result = AuthenticateResult.Success(ticket);

        return Task.FromResult(result);
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp" highlight-lines="11-18">public class TestAuthHandler : AuthenticationHandler&lt;AuthenticationSchemeOptions&gt;
{
    public TestAuthHandler(IOptionsMonitor&lt;AuthenticationSchemeOptions&gt; options,
        ILoggerFactory logger, UrlEncoder encoder)
        : base(options, logger, encoder)
    {
    }

    protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync()
    {
        var claims = new[] { new Claim(ClaimTypes.Name, "Test user") };
        var identity = new ClaimsIdentity(claims, "Test");
        var principal = new ClaimsPrincipal(identity);
        var ticket = new AuthenticationTicket(principal, "TestScheme");

        var result = AuthenticateResult.Success(ticket);

        return Task.FromResult(result);
    }
}
</code></pre>
</div>
<p>The <code>TestAuthHandler</code> is called to authenticate a user when the authentication scheme is set to <code>TestScheme</code> where <code>AddAuthentication</code> is registered for <code>ConfigureTestServices</code>. It's important for the <code>TestScheme</code> scheme to match the scheme your app expects. Otherwise, authentication won't work.</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp" highlight-lines="7-12">[Fact]
public async Task Get_SecurePageIsReturnedForAnAuthenticatedUser()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
        {
            builder.ConfigureTestServices(services =&gt;
            {
                services.AddAuthentication(defaultScheme: "TestScheme")
                    .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                        "TestScheme", options =&gt; { });
            });
        })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false,
        });

    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue(scheme: "TestScheme");

    //Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.Equal(HttpStatusCode.OK, response.StatusCode);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp" highlight-lines="7-12">[TestMethod]
public async Task Get_SecurePageIsReturnedForAnAuthenticatedUser()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
    {
        builder.ConfigureTestServices(services =&gt;
        {
            services.AddAuthentication(defaultScheme: "TestScheme")
                .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                    "TestScheme", options =&gt; { });
        });
    })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false,
        });

    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue(scheme: "TestScheme");

    //Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.AreEqual(HttpStatusCode.OK, response.StatusCode);
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp" highlight-lines="7-12">[Test]
public async Task Get_SecurePageIsReturnedForAnAuthenticatedUser()
{
    // Arrange
    var client = _factory.WithWebHostBuilder(builder =&gt;
    {
        builder.ConfigureTestServices(services =&gt;
        {
            services.AddAuthentication(defaultScheme: "TestScheme")
                .AddScheme&lt;AuthenticationSchemeOptions, TestAuthHandler&gt;(
                    "TestScheme", options =&gt; { });
        });
    })
        .CreateClient(new WebApplicationFactoryClientOptions
        {
            AllowAutoRedirect = false,
        });

    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue(scheme: "TestScheme");

    //Act
    var response = await client.GetAsync("/SecurePage");

    // Assert
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.OK));
}
</code></pre>
</div>
<p>For more information on <code>WebApplicationFactoryClientOptions</code>, see the <a href="#client-options" data-linktype="self-bookmark">Client options</a> section.</p>
<h3 id="basic-tests-for-authentication-middleware">Basic tests for authentication middleware</h3>
<p>See <a href="https://github.com/blowdart/idunno.Authentication/tree/dev/test/idunno.Authentication.Basic.Test" data-linktype="external">this GitHub repository</a> for basic tests of authentication middleware. It contains a <a href="https://github.com/blowdart/idunno.Authentication/blob/dev/test/idunno.Authentication.Basic.Test/BasicAuthenticationTests.cs#L331" data-linktype="external">test server</a> that’s specific to the test scenario.</p>
<h2 id="set-the-environment">Set the environment</h2>
<p>Set the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-9.0" data-linktype="relative-path">environment</a> in the custom application factory:</p>
<div class="zone has-pivot" data-pivot="xunit">
<pre><code class="lang-csharp" highlight-lines="36">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType == 
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<pre><code class="lang-csharp" highlight-lines="36">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<pre><code class="lang-csharp" highlight-lines="36">public class CustomWebApplicationFactory&lt;TProgram&gt;
    : WebApplicationFactory&lt;TProgram&gt; where TProgram : class
{
    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =&gt;
        {
            var dbContextDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(IDbContextOptionsConfiguration&lt;ApplicationDbContext&gt;));

            services.Remove(dbContextDescriptor);

            var dbConnectionDescriptor = services.SingleOrDefault(
                d =&gt; d.ServiceType ==
                    typeof(DbConnection));

            services.Remove(dbConnectionDescriptor);

            // Create open SqliteConnection so EF won't automatically close it.
            services.AddSingleton&lt;DbConnection&gt;(container =&gt;
            {
                var connection = new SqliteConnection("DataSource=:memory:");
                connection.Open();

                return connection;
            });

            services.AddDbContext&lt;ApplicationDbContext&gt;((container, options) =&gt;
            {
                var connection = container.GetRequiredService&lt;DbConnection&gt;();
                options.UseSqlite(connection);
            });
        });

        builder.UseEnvironment("Development");
    }
}
</code></pre>
</div>
<h2 id="how-the-test-infrastructure-infers-the-app-content-root-path">How the test infrastructure infers the app content root path</h2>
<p>The <code>WebApplicationFactory</code> constructor infers the app <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/?view=aspnetcore-9.0#content-root" data-linktype="relative-path">content root</a> path by searching for a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute" class="no-loc" data-linktype="absolute-path">WebApplicationFactoryContentRootAttribute</a> on the assembly containing the integration tests with a key equal to the <code>TEntryPoint</code> assembly <code>System.Reflection.Assembly.FullName</code>. In case an attribute with the correct key isn't found, <code>WebApplicationFactory</code> falls back to searching for a solution file (<em>.sln</em>) and appends the <code>TEntryPoint</code> assembly name to the solution directory. The app root directory (the content root path) is used to discover views and content files.</p>
<h2 id="disable-shadow-copying">Disable shadow copying</h2>
<p>Shadow copying causes the tests to execute in a different directory than the output directory. If your tests rely on loading files relative to <code>Assembly.Location</code> and you encounter issues, you might have to disable shadow copying.</p>
<p>To disable shadow copying when using xUnit, create a <code>xunit.runner.json</code> file in your test project directory, with the <a href="https://xunit.net/docs/configuration-files#shadowCopy" data-linktype="external">correct configuration setting</a>:</p>
<pre><code class="lang-json">{
  "shadowCopy": false
}
</code></pre>
<h2 id="disposal-of-objects">Disposal of objects</h2>
<div class="zone has-pivot" data-pivot="xunit">
<p>After the tests of the <code>IClassFixture</code> implementation are executed, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> are disposed when xUnit disposes of the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path"><code>WebApplicationFactory</code></a>. If objects instantiated by the developer require disposal, dispose of them in the <code>IClassFixture</code> implementation. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose" data-linktype="absolute-path">Implementing a Dispose method</a>.</p>
</div>
<div class="zone has-pivot" data-pivot="mstest">
<p>After the tests of the <code>TestClass</code> are executed, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> are disposed when MSTest disposes of the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path"><code>WebApplicationFactory</code></a> in the <code>ClassCleanup</code> method. If objects instantiated by the developer require disposal, dispose of them in the <code>ClassCleanup</code> method. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose" data-linktype="absolute-path">Implementing a Dispose method</a>.</p>
</div>
<div class="zone has-pivot" data-pivot="nunit">
<p>After the tests of the test class are executed, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a> and <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient" class="no-loc" data-linktype="absolute-path">HttpClient</a> are disposed when NUnit disposes of the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1" data-linktype="absolute-path"><code>WebApplicationFactory</code></a> in the <code>TearDown</code> method. If objects instantiated by the developer require disposal, dispose of them in the <code>TearDown</code> method. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose" data-linktype="absolute-path">Implementing a Dispose method</a>.</p>
</div>
<h2 id="integration-tests-sample">Integration tests sample</h2>
<p>The <a href="https://github.com/dotnet/AspNetCore.Docs.Samples/tree/main/test/integration-tests/9.x/IntegrationTestsSample" data-linktype="external">sample app</a> is composed of two apps:</p>
<table>
<thead>
<tr>
<th>App</th>
<th>Project directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Message app (the SUT)</td>
<td><code>src/RazorPagesProject</code></td>
<td>Allows a user to add, delete one, delete all, and analyze messages.</td>
</tr>
<tr>
<td>Test app</td>
<td><code>tests/RazorPagesProject.Tests</code></td>
<td>Used to integration test the SUT.</td>
</tr>
</tbody>
</table>
<p>The tests can be run using the built-in test features of an IDE, such as <a href="https://visualstudio.microsoft.com/" data-linktype="external">Visual Studio</a>. If using <a href="https://code.visualstudio.com/" data-linktype="external">Visual Studio Code</a> or the command line, execute the following command at a command prompt in the <code>tests/RazorPagesProject.Tests</code> directory:</p>
<pre><code class="lang-console">dotnet test
</code></pre>
<h3 id="message-app-sut-organization">Message app (SUT) organization</h3>
<p>The SUT is a Razor Pages message system with the following characteristics:</p>
<ul>
<li>The Index page of the app (<code>Pages/Index.cshtml</code> and <code>Pages/Index.cshtml.cs</code>) provides a UI and page model methods to control the addition, deletion, and analysis of messages (average words per message).</li>
<li>A message is described by the <code>Message</code> class (<code>Data/Message.cs</code>) with two properties: <code>Id</code> (key) and <code>Text</code> (message). The <code>Text</code> property is required and limited to 200 characters.</li>
<li>Messages are stored using <a href="https://learn.microsoft.com/en-us/ef/core/providers/in-memory/" data-linktype="absolute-path">Entity Framework's in-memory database</a>†.</li>
<li>The app contains a data access layer (DAL) in its database context class, <code>AppDbContext</code> (<code>Data/AppDbContext.cs</code>).</li>
<li>If the database is empty on app startup, the message store is initialized with three messages.</li>
<li>The app includes a <code>/SecurePage</code> that can only be accessed by an authenticated user.</li>
</ul>
<p>†The EF article, <a href="https://learn.microsoft.com/en-us/ef/core/miscellaneous/testing/in-memory" data-linktype="absolute-path">Test with InMemory</a>, explains how to use an in-memory database for tests with MSTest. This topic uses the <a href="https://xunit.net/" data-linktype="external">xUnit</a> test framework. Test concepts and test implementations across different test frameworks are similar but not identical.</p>
<p>Although the app doesn't use the repository pattern and isn't an effective example of the <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" data-linktype="external">Unit of Work (UoW) pattern</a>, Razor Pages supports these patterns of development. For more information, see <a href="https://learn.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design" data-linktype="absolute-path">Designing the infrastructure persistence layer</a> and <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic</a> (the sample implements the repository pattern).</p>
<h3 id="test-app-organization">Test app organization</h3>
<p>The test app is a console app inside the <code>tests/RazorPagesProject.Tests</code> directory.</p>
<table>
<thead>
<tr>
<th>Test app directory</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuthTests</code></td>
<td>Contains test methods for:<ul><li>Accessing a secure page by an unauthenticated user.</li><li>Accessing a secure page by an authenticated user with a mock <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1" class="no-loc" data-linktype="absolute-path">AuthenticationHandler&lt;TOptions&gt;</a>.</li><li>Obtaining a GitHub user profile and checking the profile's user login.</li></ul></td>
</tr>
<tr>
<td><code>BasicTests</code></td>
<td>Contains a test method for routing and content type.</td>
</tr>
<tr>
<td><code>IntegrationTests</code></td>
<td>Contains the integration tests for the Index page using custom <code>WebApplicationFactory</code> class.</td>
</tr>
<tr>
<td><code>Helpers/Utilities</code></td>
<td><ul><li><code>Utilities.cs</code> contains the <code>InitializeDbForTests</code> method used to seed the database with test data.</li><li><code>HtmlHelpers.cs</code> provides a method to return an AngleSharp <code>IHtmlDocument</code> for use by the test methods.</li><li><code>HttpClientExtensions.cs</code> provide overloads for <code>SendAsync</code> to submit requests to the SUT.</li></ul></td>
</tr>
</tbody>
</table>
<p>The test framework is <a href="https://xunit.net/" data-linktype="external">xUnit</a>. Integration tests are conducted using the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost" class="no-loc" data-linktype="absolute-path">Microsoft.AspNetCore.TestHost</a>, which includes the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver" class="no-loc" data-linktype="absolute-path">TestServer</a>. Because the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing" data-linktype="external"><code>Microsoft.AspNetCore.Mvc.Testing</code></a> package is used to configure the test host and test server, the <code>TestHost</code> and <code>TestServer</code> packages don't require direct package references in the test app's project file or developer configuration in the test app.</p>
<p>Integration tests usually require a small dataset in the database prior to the test execution. For example, a delete test calls for a database record deletion, so the database must have at least one record for the delete request to succeed.</p>
<p>The sample app seeds the database with three messages in <code>Utilities.cs</code> that tests can use when they execute:</p>
<pre><code class="lang-csharp">public static void InitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.AddRange(GetSeedingMessages());
    db.SaveChanges();
}

public static void ReinitializeDbForTests(ApplicationDbContext db)
{
    db.Messages.RemoveRange(db.Messages);
    InitializeDbForTests(db);
}

public static List&lt;Message&gt; GetSeedingMessages()
{
    return new List&lt;Message&gt;()
    {
        new Message(){ Text = "TEST RECORD: You're standing on my scarf." },
        new Message(){ Text = "TEST RECORD: Would you like a jelly baby?" },
        new Message(){ Text = "TEST RECORD: To the rational mind, " +
            "nothing is inexplicable; only unexplained." }
    };
}
</code></pre>
<p>The SUT's database context is registered in <code>Program.cs</code>. The test app's <code>builder.ConfigureServices</code> callback is executed <em>after</em> the app's <code>Program.cs</code> code is executed. To use a different database for the tests, the app's database context must be replaced in <code>builder.ConfigureServices</code>. For more information, see the <a href="#customize-webapplicationfactory" data-linktype="self-bookmark">Customize WebApplicationFactory</a> section.</p>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/dotnet/articles/core/testing/unit-testing-with-dotnet-test" data-linktype="absolute-path">Unit tests</a></li>
<li><a href="razor-pages-tests553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Razor Pages unit tests in ASP.NET Core</a></li>
<li><a href="../fundamentals/middleware/index553c.html?view=aspnetcore-9.0" data-linktype="relative-path">ASP.NET Core Middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/testing?view=aspnetcore-9.0" data-linktype="relative-path">Test controller logic in ASP.NET Core</a></li>
<li><a href="https://github.com/blowdart/idunno.Authentication/tree/dev/test/idunno.Authentication.Basic.Test" data-linktype="external">Basic tests for authentication middleware</a></li>
</ul>
</div>
</div>
					
		<div
			id="ms--inline-notifications"
			class="margin-block-xs"
			data-bi-name="inline-notification"
		></div>
	 
		<div
			id="assertive-live-region"
			role="alert"
			aria-live="assertive"
			class="visually-hidden"
			aria-relevant="additions"
			aria-atomic="true"
		></div>
		<div
			id="polite-live-region"
			role="status"
			aria-live="polite"
			class="visually-hidden"
			aria-relevant="additions"
			aria-atomic="true"
		></div>
	
					
			
		<!-- feedback section -->
		<section
			class="feedback-section position-relative margin-top-lg border border-radius padding-xxs display-none-print"
			data-bi-name="open-source-feedback-section"
			data-open-source-feedback-section
			hidden
		>
			<div class="display-flex flex-direction-column flex-direction-row-tablet">
				<div
					class="width-450-tablet padding-inline-xs padding-inline-xs-tablet padding-top-xs padding-bottom-sm padding-top-xs-tablet background-color-body-medium"
				>
					<div class="display-flex flex-direction-column">
						<div class="padding-bottom-xxs">
							<span class="icon margin-right-xxs" aria-hidden="true">
								<span class="docon docon-brand-github"></span>
							</span>
							<span class="font-weight-semibold">
								Collaborate with us on GitHub
							</span>
						</div>
						<span class="line-height-normal">
							The source for this content can be found on GitHub, where you can also create and review issues and pull requests. For more information, see <a href="https://learn.microsoft.com/contribute/content/dotnet/dotnet-contribute">our contributor guide</a>.
						</span>
					</div>
				</div>
				<div
					class="display-flex gap-xs width-full-tablet flex-direction-column padding-xs justify-content-space-evenly"
				>
					<div class="media">
						
					<div class="media-left">
						<div class="image image-36x36" hidden data-open-source-image-container>
							<img
								class="theme-display is-light"
								src="https://learn.microsoft.com/media/logos/logo_net.svg"
								aria-hidden="true"
								data-open-source-image-light
							/>
							<img
								class="theme-display is-dark is-high-contrast"
								src="https://learn.microsoft.com/media/logos/logo_net.svg"
								aria-hidden="true"
								data-open-source-image-dark
							/>
						</div>
					</div>
			  

						<div class="media-content">
							<p
								class="font-size-xl font-weight-semibold margin-bottom-xxs"
								data-open-source-product-title
							>
								ASP.NET Core
							</p>
							<div class="display-flex gap-xs flex-direction-column">
								<p class="line-height-normal" data-open-source-product-description></p>
								<div class="display-flex gap-xs flex-direction-column">
									<a href="#" data-github-link>
										<span class="icon margin-right-xxs" aria-hidden="true">
											<span class="docon docon-bug"></span>
										</span>
										<span>Open a documentation issue</span>
									</a>
									<a
										href="https://github.com/dotnet/aspnetcore/blob/main/CONTRIBUTING.md"
										class="display-block margin-top-auto font-size-md"
										data-feedback-product-url
									>
										<span class="icon margin-right-xxs" aria-hidden="true">
											<span class="docon docon-feedback"></span>
										</span>
										<span>Provide product feedback</span>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- end feedback section -->
	
			
		<!-- feedback section -->
		<section
			id="site-user-feedback-footer"
			class="font-size-sm margin-top-md display-none-print display-none-desktop"
			data-test-id="site-user-feedback-footer"
			data-bi-name="site-feedback-section"
		>
			<hr class="hr" />
			<h2 id="ms--feedback" class="title is-3">Feedback</h2>
			<div class="display-flex flex-wrap-wrap align-items-center">
				<p class="font-weight-semibold margin-xxs margin-left-none">
					Was this page helpful?
				</p>
				<div class="buttons">
					<button
						class="thumb-rating-button like button button-primary button-sm"
						data-test-id="footer-rating-yes"
						data-binary-rating-response="rating-yes"
						type="button"
						title="This article is helpful"
						data-bi-name="button-rating-yes"
						aria-pressed="false"
					>
						<span class="icon" aria-hidden="true">
							<span class="docon docon-like"></span>
						</span>
						<span>Yes</span>
					</button>
					<button
						class="thumb-rating-button dislike button button-primary button-sm"
						data-test-id="footer-rating-no"
						data-binary-rating-response="rating-no"
						type="button"
						title="This article is not helpful"
						data-bi-name="button-rating-no"
						aria-pressed="false"
					>
						<span class="icon" aria-hidden="true">
							<span class="docon docon-dislike"></span>
						</span>
						<span>No</span>
					</button>
				</div>
			</div>
		</section>
		<!-- end feedback section -->
	
		
				</div>
				
		<div id="ms--additional-resources-mobile" class="display-none-print">
			<hr class="hr" hidden />
			<h2 id="ms--additional-resources-mobile-heading" class="title is-3" hidden>
				Additional resources
			</h2>
			
		<section
			id="right-rail-recommendations-mobile"
			class=""
			data-bi-name="recommendations"
			hidden
		></section>
	 
		<section
			id="right-rail-training-mobile"
			class=""
			data-bi-name="learning-resource-card"
			hidden
		></section>
	 
		<section
			id="right-rail-events-mobile"
			class=""
			data-bi-name="events-card"
			hidden
		></section>
	 
		<section
			id="right-rail-qna-mobile"
			class="margin-top-xxs"
			data-bi-name="qna-link-card"
			hidden
		></section>
	
		</div>
	
			</div>
			
		<div
			id="action-panel"
			role="region"
			aria-label="Action Panel"
			class="action-panel"
			tabindex="-1"
		></div>
	
		
				</main>
				<aside
					id="layout-body-aside"
					class="layout-body-aside "
					data-bi-name="aside"
			  >
					
		<div
			id="ms--additional-resources"
			class="right-container padding-sm display-none display-block-desktop height-full"
			data-bi-name="pageactions"
			role="complementary"
			aria-label="Additional resources"
		>
			<div id="affixed-right-container" data-bi-name="right-column">
				
		<nav
			id="side-doc-outline"
			class="doc-outline border-bottom padding-bottom-xs margin-bottom-xs"
			data-bi-name="intopic toc"
			aria-label="In this article"
		>
			<h3>In this article</h3>
		</nav>
	
				<!-- Feedback -->
				
		<section
			id="ms--site-user-feedback-right-rail"
			class="font-size-sm display-none-print"
			data-test-id="site-user-feedback-right-rail"
			data-bi-name="site-feedback-right-rail"
		>
			<p class="font-weight-semibold margin-bottom-xs">Was this page helpful?</p>
			<div class="buttons">
				<button
					class="thumb-rating-button like button button-primary button-sm"
					data-test-id="right-rail-rating-yes"
					data-binary-rating-response="rating-yes"
					type="button"
					title="This article is helpful"
					data-bi-name="button-rating-yes"
					aria-pressed="false"
				>
					<span class="icon" aria-hidden="true">
						<span class="docon docon-like"></span>
					</span>
					<span>Yes</span>
				</button>
				<button
					class="thumb-rating-button dislike button button-primary button-sm"
					data-test-id="right-rail-rating-no"
					data-binary-rating-response="rating-no"
					type="button"
					title="This article is not helpful"
					data-bi-name="button-rating-no"
					aria-pressed="false"
				>
					<span class="icon" aria-hidden="true">
						<span class="docon docon-dislike"></span>
					</span>
					<span>No</span>
				</button>
			</div>
		</section>
	
			</div>
		</div>
	
			  </aside> <section
					id="layout-body-flyout"
					class="layout-body-flyout "
					data-bi-name="flyout"
			  >
					 <div
	class="height-full border-left background-color-body-medium"
	id="ask-learn-flyout"
></div>
			  </section> <div class="layout-body-footer " data-bi-name="layout-footer">
		<footer
			id="footer"
			data-test-id="footer"
			data-bi-name="footer"
			class="footer-layout has-padding has-default-focus border-top  uhf-container"
			role="contentinfo"
		>
			<div class="display-flex gap-xs flex-wrap-wrap is-full-height padding-right-lg-desktop">
				
		<a
			data-mscc-ic="false"
			href="#"
			data-bi-name="select-locale"
			class="locale-selector-link flex-shrink-0 button button-sm button-clear external-link-indicator"
			id=""
			title=""
			><span class="icon" aria-hidden="true"
				><span class="docon docon-world"></span></span
			><span class="local-selector-link-text">en-us</span></a
		>
	
				<div class="ccpa-privacy-link" data-ccpa-privacy-link hidden>
		
		<a
			data-mscc-ic="false"
			href="https://aka.ms/yourcaliforniaprivacychoices"
			data-bi-name="your-privacy-choices"
			class="button button-sm button-clear flex-shrink-0 external-link-indicator"
			id=""
			title=""
			>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			viewBox="0 0 30 14"
			xml:space="preserve"
			height="16"
			width="43"
			aria-hidden="true"
			focusable="false"
		>
			<path
				d="M7.4 12.8h6.8l3.1-11.6H7.4C4.2 1.2 1.6 3.8 1.6 7s2.6 5.8 5.8 5.8z"
				style="fill-rule:evenodd;clip-rule:evenodd;fill:#fff"
			></path>
			<path
				d="M22.6 0H7.4c-3.9 0-7 3.1-7 7s3.1 7 7 7h15.2c3.9 0 7-3.1 7-7s-3.2-7-7-7zm-21 7c0-3.2 2.6-5.8 5.8-5.8h9.9l-3.1 11.6H7.4c-3.2 0-5.8-2.6-5.8-5.8z"
				style="fill-rule:evenodd;clip-rule:evenodd;fill:#06f"
			></path>
			<path
				d="M24.6 4c.2.2.2.6 0 .8L22.5 7l2.2 2.2c.2.2.2.6 0 .8-.2.2-.6.2-.8 0l-2.2-2.2-2.2 2.2c-.2.2-.6.2-.8 0-.2-.2-.2-.6 0-.8L20.8 7l-2.2-2.2c-.2-.2-.2-.6 0-.8.2-.2.6-.2.8 0l2.2 2.2L23.8 4c.2-.2.6-.2.8 0z"
				style="fill:#fff"
			></path>
			<path
				d="M12.7 4.1c.2.2.3.6.1.8L8.6 9.8c-.1.1-.2.2-.3.2-.2.1-.5.1-.7-.1L5.4 7.7c-.2-.2-.2-.6 0-.8.2-.2.6-.2.8 0L8 8.6l3.8-4.5c.2-.2.6-.2.9 0z"
				style="fill:#06f"
			></path>
		</svg>
	
			<span>Your Privacy Choices</span></a
		>
	
	</div>
				<div class="flex-shrink-0">
		<div class="dropdown has-caret-up">
			<button
				data-test-id="theme-selector-button"
				class="dropdown-trigger button button-clear button-sm has-inner-focus theme-dropdown-trigger"
				aria-controls="{{ themeMenuId }}"
				aria-expanded="false"
				title="Theme"
				data-bi-name="theme"
			>
				<span class="icon">
					<span class="docon docon-sun" aria-hidden="true"></span>
				</span>
				<span>Theme</span>
				<span class="icon expanded-indicator" aria-hidden="true">
					<span class="docon docon-chevron-down-light"></span>
				</span>
			</button>
			<div class="dropdown-menu" id="{{ themeMenuId }}" role="menu">
				<ul class="theme-selector padding-xxs" data-test-id="theme-dropdown-menu">
					<li class="theme display-block">
						<button
							class="button button-clear button-sm theme-control button-block justify-content-flex-start text-align-left"
							data-theme-to="light"
						>
							<span class="theme-light margin-right-xxs">
								<span
									class="theme-selector-icon border display-inline-block has-body-background"
									aria-hidden="true"
								>
									<svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 14">
										<rect width="22" height="14" class="has-fill-body-background" />
										<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
										<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
										<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
										<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
										<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
									</svg>
								</span>
							</span>
							<span role="menuitem"> Light </span>
						</button>
					</li>
					<li class="theme display-block">
						<button
							class="button button-clear button-sm theme-control button-block justify-content-flex-start text-align-left"
							data-theme-to="dark"
						>
							<span class="theme-dark margin-right-xxs">
								<span
									class="border theme-selector-icon display-inline-block has-body-background"
									aria-hidden="true"
								>
									<svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 14">
										<rect width="22" height="14" class="has-fill-body-background" />
										<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
										<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
										<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
										<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
										<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
									</svg>
								</span>
							</span>
							<span role="menuitem"> Dark </span>
						</button>
					</li>
					<li class="theme display-block">
						<button
							class="button button-clear button-sm theme-control button-block justify-content-flex-start text-align-left"
							data-theme-to="high-contrast"
						>
							<span class="theme-high-contrast margin-right-xxs">
								<span
									class="border theme-selector-icon display-inline-block has-body-background"
									aria-hidden="true"
								>
									<svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 14">
										<rect width="22" height="14" class="has-fill-body-background" />
										<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
										<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
										<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
										<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
										<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
									</svg>
								</span>
							</span>
							<span role="menuitem"> High contrast </span>
						</button>
					</li>
				</ul>
			</div>
		</div>
	</div>
			</div>
			<ul class="links" data-bi-name="footerlinks">
				<li class="manage-cookies-holder" hidden=""></li>
				<li>
		
		<a
			data-mscc-ic="false"
			href="https://learn.microsoft.com/en-us/principles-for-ai-generated-content"
			data-bi-name="aiDisclaimer"
			class=" external-link-indicator"
			id=""
			title=""
			>AI Disclaimer</a
		>
	
	</li><li>
		
		<a
			data-mscc-ic="false"
			href="https://learn.microsoft.com/en-us/previous-versions/"
			data-bi-name="archivelink"
			class=" external-link-indicator"
			id=""
			title=""
			>Previous Versions</a
		>
	
	</li> <li>
		
		<a
			data-mscc-ic="false"
			href="https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog"
			data-bi-name="bloglink"
			class=" external-link-indicator"
			id=""
			title=""
			>Blog</a
		>
	
	</li> <li>
		
		<a
			data-mscc-ic="false"
			href="https://learn.microsoft.com/en-us/contribute"
			data-bi-name="contributorGuide"
			class=" external-link-indicator"
			id=""
			title=""
			>Contribute</a
		>
	
	</li><li>
		
		<a
			data-mscc-ic="false"
			href="https://go.microsoft.com/fwlink/?LinkId=521839"
			data-bi-name="privacy"
			class=" external-link-indicator"
			id=""
			title=""
			>Privacy</a
		>
	
	</li><li>
		
		<a
			data-mscc-ic="false"
			href="https://learn.microsoft.com/en-us/legal/termsofuse"
			data-bi-name="termsofuse"
			class=" external-link-indicator"
			id=""
			title=""
			>Terms of Use</a
		>
	
	</li><li>
		
		<a
			data-mscc-ic="false"
			href="https://www.microsoft.com/legal/intellectualproperty/Trademarks/"
			data-bi-name="trademarks"
			class=" external-link-indicator"
			id=""
			title=""
			>Trademarks</a
		>
	
	</li>
				<li>&copy; Microsoft 2025</li>
			</ul>
		</footer>
	</footer>
			</body>
		
<!-- Mirrored from learn.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-9.0 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 06 Aug 2025 14:53:03 GMT -->
</html>