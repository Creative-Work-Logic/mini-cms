 <!DOCTYPE html>
		<html
			class="layout layout-holy-grail   show-table-of-contents conceptual show-breadcrumb default-focus"
			lang="en-us"
			dir="ltr"
			data-authenticated="false"
			data-auth-status-determined="false"
			data-target="docs"
			x-ms-format-detection="none"
		>
			
		
<!-- Mirrored from learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-9.0 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 06 Aug 2025 14:53:03 GMT -->
<head>
			<title>ASP.NET Core Middleware | Microsoft Learn</title>
			<meta charset="utf-8" />
			<meta name="viewport" content="width=device-width, initial-scale=1.0" />
			<meta name="color-scheme" content="light dark" />

			<meta name="description" content="Learn about ASP.NET Core middleware and the request pipeline." />
			<link rel="canonical" href="index553c.html?view=aspnetcore-9.0" /> 

			<!-- Non-customizable open graph and sharing-related metadata -->
			<meta name="twitter:card" content="summary" />
			<meta name="twitter:site" content="@MicrosoftLearn" />
			<meta property="og:type" content="website" />
			<meta property="og:image:alt" content="ASP.NET Core Middleware | Microsoft Learn" />
			<meta property="og:image" content="https://learn.microsoft.com/dotnet/media/dotnet-logo.png" />
			<!-- Page specific open graph and sharing-related metadata -->
			<meta property="og:title" content="ASP.NET Core Middleware" />
			<meta property="og:url" content="index553c.html?view=aspnetcore-9.0" />
			<meta property="og:description" content="Learn about ASP.NET Core middleware and the request pipeline." />
			<meta name="platform_id" content="56794c42-f3e4-3dbf-e8f3-572f7aba4f9b" /> <meta name="scope" content="ASP.NET Core" />
			<meta name="locale" content="en-us" />
			 <meta name="adobe-target" content="true" />
			<meta name="uhfHeaderId" content="MSDocsHeader-AspNet" />

			<meta name="page_type" content="conceptual" />

			<!--page specific meta tags-->
			

			<!-- custom meta tags -->
			
		<meta name="breadcrumb_path" content="/aspnet/core/breadcrumb/toc.json" />
	
		<meta name="feedback_system" content="OpenSource" />
	
		<meta name="feedback_product_url" content="https://github.com/dotnet/aspnetcore/blob/main/CONTRIBUTING.md" />
	
		<meta name="ms.service" content="aspnet-core" />
	
		<meta name="ms.topic" content="conceptual" />
	
		<meta name="ms.subservice" content="fundamentals" />
	
		<meta name="author" content="tdykstra" />
	
		<meta name="monikerRange" content="&gt;= aspnetcore-3.0" />
	
		<meta name="ms.author" content="tdykstra" />
	
		<meta name="ms.custom" content="mvc" />
	
		<meta name="ms.date" content="2025-06-21T00:00:00Z" />
	
		<meta name="uid" content="fundamentals/middleware/index" />
	
		<meta name="ms.ai" content="assisted" />
	
		<meta name="document_id" content="9898482c-fa54-7ce2-1716-d14fbe03990d" />
	
		<meta name="document_version_independent_id" content="3926c686-0ccc-f9fe-ca52-0134612a1623" />
	
		<meta name="updated_at" content="2025-07-15T17:50:00Z" />
	
		<meta name="original_content_git_url" content="https://github.com/dotnet/AspNetCore.Docs/blob/live/aspnetcore/fundamentals/middleware/index.md" />
	
		<meta name="gitcommit" content="https://github.com/dotnet/AspNetCore.Docs/blob/83af984daff0cf0dbbf055e64d75c2d1ce83459a/aspnetcore/fundamentals/middleware/index.md" />
	
		<meta name="git_commit_id" content="83af984daff0cf0dbbf055e64d75c2d1ce83459a" />
	
		<meta name="monikers" content="aspnetcore-3.0" />
	
		<meta name="monikers" content="aspnetcore-3.1" />
	
		<meta name="monikers" content="aspnetcore-5.0" />
	
		<meta name="monikers" content="aspnetcore-6.0" />
	
		<meta name="monikers" content="aspnetcore-7.0" />
	
		<meta name="monikers" content="aspnetcore-8.0" />
	
		<meta name="monikers" content="aspnetcore-9.0" />
	
		<meta name="monikers" content="aspnetcore-10.0" />
	
		<meta name="default_moniker" content="aspnetcore-9.0" />
	
		<meta name="site_name" content="Docs" />
	
		<meta name="depot_name" content="MSDN.aspnet-core-conceptual" />
	
		<meta name="schema" content="Conceptual" />
	
		<meta name="toc_rel" content="../../toc.json" />
	
		<meta name="pdf_url_template" content="https://learn.microsoft.com/pdfstore/en-us/MSDN.aspnet-core-conceptual/{branchName}{pdfName}" />
	
		<meta name="feedback_help_link_type" content="" />
	
		<meta name="feedback_help_link_url" content="" />
	
		<meta name="word_count" content="11451" />
	
		<meta name="config_moniker_range" content="&gt;= aspnetcore-1.0" />
	
		<meta name="asset_id" content="fundamentals/middleware/index" />
	
		<meta name="moniker_range_name" content="baeba9fa90d1bd6d351857ae16d477a8" />
	
		<meta name="item_type" content="Content" />
	
		<meta name="source_path" content="aspnetcore/fundamentals/middleware/index.md" />
	
		<meta name="previous_tlsh_hash" content="FD1C2D63850DF968BF004E0A48AABE5298F0D05FADE0BFA413319AE2F7093F67072579E6D3977A483361C29521D1769E07E6EF5BD07D33A609608CED878D35C2419E2BB1D5" />
	
		<meta name="github_feedback_content_git_url" content="https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/fundamentals/middleware/index.md" />
	 
		<meta name="cmProducts" content="https://authoring-docs-microsoft.poolparty.biz/devrel/d452572f-6212-498f-9050-ca4a9e50a425" data-source="generated" />
	
		<meta name="cmProducts" content="https://microsoft-devrel.poolparty.biz/DevRelOfferingOntology/e72e5f83-fd84-4f1d-88e0-dec3350a8a10" data-source="generated" />
	
		<meta name="spProducts" content="https://authoring-docs-microsoft.poolparty.biz/devrel/a12e40b7-59a2-4437-96e2-166ce622b864" data-source="generated" />
	
		<meta name="spProducts" content="https://microsoft-devrel.poolparty.biz/DevRelOfferingOntology/81a11282-2f1c-4a63-95c5-6e6f262fea55" data-source="generated" />
	

			<!-- assets and js globals -->
			
			<link rel="stylesheet" href="https://learn.microsoft.com/static/assets/0.4.03137.7032-e8b681c0/styles/site-ltr.css" />
			<link rel="preconnect" href="http://mscom.demdex.net/" crossorigin />
						<link rel="dns-prefetch" href="http://target.microsoft.com/" />
						<link rel="dns-prefetch" href="http://microsoftmscompoc.tt.omtrdc.net/" />
						<link
							rel="preload"
							as="script"
							href="https://learn.microsoft.com/static/third-party/adobe-target/at-js/2.9.0/at.js"
							integrity="sha384-1/viVM50hgc33O2gOgkWz3EjiD/Fy/ld1dKYXJRUyjNYVEjSUGcSN+iPiQF7e4cu"
							crossorigin="anonymous"
							id="adobe-target-script"
							type="application/javascript"
						/>
			<script src="https://wcpstatic.microsoft.com/mscc/lib/v2/wcp-consent.js"></script>
			<script src="https://js.monitor.azure.com/scripts/c/ms.jsll-4.min.js"></script>
			<script src="https://learn.microsoft.com/_themes/docs.theme/master/en-us/_themes/global/deprecation.js"></script>

			<!-- msdocs global object -->
			<script id="msdocs-script">
		var msDocs = {
  "environment": {
    "accessLevel": "online",
    "azurePortalHostname": "portal.azure.com",
    "reviewFeatures": false,
    "supportLevel": "production",
    "systemContent": true,
    "siteName": "learn",
    "legacyHosting": false
  },
  "data": {
    "contentLocale": "en-us",
    "contentDir": "ltr",
    "userLocale": "en-us",
    "userDir": "ltr",
    "pageTemplate": "Conceptual",
    "brand": "",
    "context": {},
    "standardFeedback": false,
    "showFeedbackReport": false,
    "feedbackHelpLinkType": "",
    "feedbackHelpLinkUrl": "",
    "feedbackSystem": "OpenSource",
    "feedbackGitHubRepo": "dotnet/AspNetCore.Docs",
    "feedbackProductUrl": "https://github.com/dotnet/aspnetcore/blob/main/CONTRIBUTING.md",
    "extendBreadcrumb": false,
    "isEditDisplayable": true,
    "isPrivateUnauthorized": false,
    "hideViewSource": false,
    "isPermissioned": false,
    "hasRecommendations": true,
    "contributors": [
      {
        "name": "tdykstra",
        "url": "https://github.com/tdykstra"
      },
      {
        "name": "wadepickett",
        "url": "https://github.com/wadepickett"
      },
      {
        "name": "twsouthwick",
        "url": "https://github.com/twsouthwick"
      },
      {
        "name": "guardrex",
        "url": "https://github.com/guardrex"
      },
      {
        "name": "Jessuhh",
        "url": "https://github.com/Jessuhh"
      },
      {
        "name": "Tratcher",
        "url": "https://github.com/Tratcher"
      },
      {
        "name": "Rick-Anderson",
        "url": "https://github.com/Rick-Anderson"
      },
      {
        "name": "sebastienros",
        "url": "https://github.com/sebastienros"
      },
      {
        "name": "BrennanConroy",
        "url": "https://github.com/BrennanConroy"
      },
      {
        "name": "serpent5",
        "url": "https://github.com/serpent5"
      },
      {
        "name": "sanchit154",
        "url": "https://github.com/sanchit154"
      },
      {
        "name": "scottaddie",
        "url": "https://github.com/scottaddie"
      },
      {
        "name": "rahulpnath",
        "url": "https://github.com/rahulpnath"
      },
      {
        "name": "analogrelay",
        "url": "https://github.com/analogrelay"
      },
      {
        "name": "WindOfMind",
        "url": "https://github.com/WindOfMind"
      },
      {
        "name": "cuperman007",
        "url": "https://github.com/cuperman007"
      },
      {
        "name": "vnextcoder",
        "url": "https://github.com/vnextcoder"
      },
      {
        "name": "Jaxelr",
        "url": "https://github.com/Jaxelr"
      }
    ],
    "openSourceFeedbackIssueUrl": "https://github.com/dotnet/aspnetcore.docs/issues/new?template=customer-feedback.yml",
    "openSourceFeedbackIssueTitle": "",
    "openSourceFeedbackIssueLabels": "Source - Docs.ms,:watch: Not Triaged"
  },
  "functions": {}
};;
	</script>

			<!-- base scripts, msdocs global should be before this -->
			<script src="https://learn.microsoft.com/static/assets/0.4.03137.7032-e8b681c0/scripts/en-us/index-docs.js"></script>
			

			<!-- json-ld -->
			
		</head>
	
			<body
				id="body"
				data-bi-name="body"
				class="layout-body "
				lang="en-us"
				dir="ltr"
			>
				<header class="layout-body-header">
		<div class="header-holder has-default-focus">
			
		<a
			href="#main"
			
			style="z-index: 1070"
			class="outline-color-text visually-hidden-until-focused position-fixed inner-focus focus-visible top-0 left-0 right-0 padding-xs text-align-center background-color-body"
			
		>
			Skip to main content
		</a>
	
		<a
			href="#"
			data-skip-to-ask-learn
			style="z-index: 1070"
			class="outline-color-text visually-hidden-until-focused position-fixed inner-focus focus-visible top-0 left-0 right-0 padding-xs text-align-center background-color-body"
			hidden
		>
			Skip to Ask Learn chat experience
		</a>
	

			<div hidden id="cookie-consent-holder" data-test-id="cookie-consent-container"></div>
			<!-- Unsupported browser warning -->
			<div
				id="unsupported-browser"
				style="background-color: white; color: black; padding: 16px; border-bottom: 1px solid grey;"
				hidden
			>
				<div style="max-width: 800px; margin: 0 auto;">
					<p style="font-size: 24px">This browser is no longer supported.</p>
					<p style="font-size: 16px; margin-top: 16px;">
						Upgrade to Microsoft Edge to take advantage of the latest features, security updates, and technical support.
					</p>
					<div style="margin-top: 12px;">
						<a
							href="https://go.microsoft.com/fwlink/p/?LinkID=2092881"
							style="background-color: #0078d4; border: 1px solid #0078d4; color: white; padding: 6px 12px; border-radius: 2px; display: inline-block;"
						>
							Download Microsoft Edge
						</a>
						<a
							href="https://learn.microsoft.com/en-us/lifecycle/faq/internet-explorer-microsoft-edge"
							style="background-color: white; padding: 6px 12px; border: 1px solid #505050; color: #171717; border-radius: 2px; display: inline-block;"
						>
							More info about Internet Explorer and Microsoft Edge
						</a>
					</div>
				</div>
			</div>
			<!-- site header -->
			<header
				id="ms--site-header"
				data-test-id="site-header-wrapper"
				role="banner"
				itemscope="itemscope"
				itemtype="http://schema.org/Organization"
			>
				<div
					id="ms--mobile-nav"
					class="site-header display-none-tablet padding-inline-none gap-none"
					data-bi-name="mobile-header"
					data-test-id="mobile-header"
				></div>
				<div
					id="ms--primary-nav"
					class="site-header display-none display-flex-tablet"
					data-bi-name="L1-header"
					data-test-id="primary-header"
				></div>
				<div
					id="ms--secondary-nav"
					class="site-header display-none display-flex-tablet"
					data-bi-name="L2-header"
					data-test-id="secondary-header"
				></div>
			</header>
			
		<!-- banner -->
		<div data-banner>
			<div id="disclaimer-holder"></div>
			
		</div>
		<!-- banner end -->
	
		</div>
	</header>
				 <section
					id="layout-body-menu"
					class="layout-body-menu display-flex"
					data-bi-name="menu"
			  >
					<div
		id="left-container"
		class="left-container display-none display-block-tablet padding-inline-sm padding-bottom-sm width-full"
	>
		<nav
			id="affixed-left-container"
			class="margin-top-sm-tablet position-sticky display-flex flex-direction-column"
			aria-label="Primary"
		></nav>
	</div>
			  </section>

				<main
					id="main"
					role="main"
					class="layout-body-main "
					data-bi-name="content"
					lang="en-us"
					dir="ltr"
				>
					
			<div
		id="ms--content-header"
		class="content-header default-focus border-bottom-none"
		data-bi-name="content-header"
	>
		<div class="content-header-controls margin-xxs margin-inline-sm-tablet">
			<button
				type="button"
				class="contents-button button button-sm margin-right-xxs"
				data-bi-name="contents-expand"
				aria-haspopup="true"
				data-contents-button
			>
				<span class="icon" aria-hidden="true"><span class="docon docon-menu"></span></span>
				<span class="contents-expand-title"> Table of contents </span>
			</button>
			<button
				type="button"
				class="ap-collapse-behavior ap-expanded button button-sm"
				data-bi-name="ap-collapse"
				aria-controls="action-panel"
			>
				<span class="icon" aria-hidden="true"><span class="docon docon-exit-mode"></span></span>
				<span>Exit editor mode</span>
			</button>
		</div>
	</div>
			<div data-main-column class="padding-sm padding-top-none padding-top-sm-tablet">
				<div>
					
		<div id="article-header" class="background-color-body margin-bottom-xs display-none-print">
			<div class="display-flex align-items-center justify-content-space-between">
				
		<details
			id="article-header-breadcrumbs-overflow-popover"
			class="popover"
			data-for="article-header-breadcrumbs"
		>
			<summary
				class="button button-clear button-primary button-sm inner-focus"
				aria-label="All breadcrumbs"
			>
				<span class="icon">
					<span class="docon docon-more"></span>
				</span>
			</summary>
			<div id="article-header-breadcrumbs-overflow" class="popover-content padding-none"></div>
		</details>

		<bread-crumbs
			id="article-header-breadcrumbs"
			data-test-id="article-header-breadcrumbs"
			class="overflow-hidden flex-grow-1 margin-right-sm margin-right-md-tablet margin-right-lg-desktop margin-left-negative-xxs padding-left-xxs"
		></bread-crumbs>
	 
		<div
			id="article-header-page-actions"
			class="opacity-none margin-left-auto display-flex flex-wrap-no-wrap align-items-stretch"
		>
			
		<button
			class="button button-sm border-none inner-focus display-none-tablet flex-shrink-0 "
			data-bi-name="ask-learn-assistant-entry"
			data-test-id="ask-learn-assistant-modal-entry-mobile"
			data-ask-learn-modal-entry
			type="button"
			style="min-width: max-content;"
			aria-expanded="false"
			aria-label="Ask Learn"
			hidden
		>
			<span class="icon font-size-lg" aria-hidden="true">
				<span class="docon docon-chat-sparkle-fill gradient-ask-learn-logo"></span>
			</span>
		</button>
		<button
			class="button button-sm display-none display-inline-flex-tablet display-none-desktop flex-shrink-0 margin-right-xxs border-color-ask-learn "
			data-bi-name="ask-learn-assistant-entry"
			data-test-id="ask-learn-assistant-modal-entry-tablet"
			data-ask-learn-modal-entry
			type="button"
			style="min-width: max-content;"
			aria-expanded="false"
			hidden
		>
			<span class="icon font-size-lg" aria-hidden="true">
				<span class="docon docon-chat-sparkle-fill gradient-ask-learn-logo"></span>
			</span>
			<span>Ask Learn</span>
		</button>
		<button
			class="button button-sm display-none flex-shrink-0 display-inline-flex-desktop margin-right-xxs	border-color-ask-learn "
			data-bi-name="ask-learn-assistant-entry"
			data-test-id="ask-learn-assistant-flyout-entry"
			data-ask-learn-flyout-entry
			data-flyout-button="toggle"
			type="button"
			style="min-width: max-content;"
			aria-expanded="false"
			aria-controls="ask-learn-flyout"
			hidden
		>
			<span class="icon font-size-lg" aria-hidden="true">
				<span class="docon docon-chat-sparkle-fill gradient-ask-learn-logo"></span>
			</span>
			<span>Ask Learn</span>
		</button>
	 
		<button
			type="button"
			id="ms--focus-mode-button"
			data-focus-mode
			data-bi-name="focus-mode-entry"
			class="button button-sm flex-shrink-0 margin-right-xxs display-none display-inline-flex-desktop"
		>
			<span class="icon font-size-lg" aria-hidden="true">
				<span class="docon docon-glasses"></span>
			</span>
			<span>Focus mode</span>
		</button>
	 

			<details class="popover popover-right" id="article-header-page-actions-overflow">
				<summary
					class="justify-content-flex-start button button-clear button-sm button-primary inner-focus"
					aria-label="More actions"
					title="More actions"
				>
					<span class="icon" aria-hidden="true">
						<span class="docon docon-more-vertical"></span>
					</span>
				</summary>
				<div class="popover-content">
					
		<button
			data-page-action-item="overflow-mobile"
			type="button"
			class="button-block button-sm has-inner-focus button button-clear display-none-tablet justify-content-flex-start text-align-left"
			data-bi-name="contents-expand"
			data-contents-button
			data-popover-close
		>
			<span class="icon">
				<span class="docon docon-editor-list-bullet" aria-hidden="true"></span>
			</span>
			<span class="contents-expand-title">Table of contents</span>
		</button>
	 
		<a
			id="lang-link-overflow"
			class="button-sm has-inner-focus button button-clear button-block justify-content-flex-start text-align-left"
			data-bi-name="language-toggle"
			data-page-action-item="overflow-all"
			data-check-hidden="true"
			data-read-in-link
			href="#"
			hidden
		>
			<span class="icon" aria-hidden="true" data-read-in-link-icon>
				<span class="docon docon-locale-globe"></span>
			</span>
			<span data-read-in-link-text>Read in English</span>
		</a>
	 
		<button
			type="button"
			class="collection button button-clear button-sm button-block justify-content-flex-start text-align-left inner-focus"
			data-list-type="collection"
			data-bi-name="collection"
			data-page-action-item="overflow-all"
			data-check-hidden="true"
			data-popover-close
		>
			<span class="icon" aria-hidden="true">
				<span class="docon docon-circle-addition"></span>
			</span>
			<span class="collection-status">Add</span>
		</button>
	
					
		<button
			type="button"
			class="collection button button-block button-clear button-sm justify-content-flex-start text-align-left inner-focus"
			data-list-type="plan"
			data-bi-name="plan"
			data-page-action-item="overflow-all"
			data-check-hidden="true"
			data-popover-close
			hidden
		>
			<span class="icon" aria-hidden="true">
				<span class="docon docon-circle-addition"></span>
			</span>
			<span class="plan-status">Add to plan</span>
		</button>
	  
		<a
			data-contenteditbtn
			class="button button-clear button-block button-sm inner-focus justify-content-flex-start text-align-left text-decoration-none"
			data-bi-name="edit"
			
			href="https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/fundamentals/middleware/index.md"
			data-original_content_git_url="https://github.com/dotnet/AspNetCore.Docs/blob/live/aspnetcore/fundamentals/middleware/index.md"
			data-original_content_git_url_template="{repo}/blob/{branch}/aspnetcore/fundamentals/middleware/index.md"
			data-pr_repo=""
			data-pr_branch=""
		>
			<span class="icon" aria-hidden="true">
				<span class="docon docon-edit-outline"></span>
			</span>
			<span>Edit</span>
		</a>
	
					
		<hr class="margin-block-xxs" />
		<h4 class="font-size-sm padding-left-xxs">Share via</h4>
		
					<a
						class="button button-clear button-sm inner-focus button-block justify-content-flex-start text-align-left text-decoration-none share-facebook"
						data-bi-name="facebook"
						data-page-action-item="overflow-all"
						href="#"
					>
						<span class="icon color-primary" aria-hidden="true">
							<span class="docon docon-facebook-share"></span>
						</span>
						<span>Facebook</span>
					</a>

					<a
						href="#"
						class="button button-clear button-sm inner-focus button-block justify-content-flex-start text-align-left text-decoration-none share-twitter"
						data-bi-name="twitter"
						data-page-action-item="overflow-all"
					>
						<span class="icon color-text" aria-hidden="true">
							<span class="docon docon-xlogo-share"></span>
						</span>
						<span>x.com</span>
					</a>

					<a
						href="#"
						class="button button-clear button-sm inner-focus button-block justify-content-flex-start text-align-left text-decoration-none share-linkedin"
						data-bi-name="linkedin"
						data-page-action-item="overflow-all"
					>
						<span class="icon color-primary" aria-hidden="true">
							<span class="docon docon-linked-in-logo"></span>
						</span>
						<span>LinkedIn</span>
					</a>
					<a
						href="#"
						class="button button-clear button-sm inner-focus button-block justify-content-flex-start text-align-left text-decoration-none share-email"
						data-bi-name="email"
						data-page-action-item="overflow-all"
					>
						<span class="icon color-primary" aria-hidden="true">
							<span class="docon docon-mail-message"></span>
						</span>
						<span>Email</span>
					</a>
			  
	 
		<hr class="margin-block-xxs" />
		<button
			class="button button-block button-clear button-sm justify-content-flex-start text-align-left inner-focus"
			type="button"
			data-bi-name="print"
			data-page-action-item="overflow-all"
			data-popover-close
			data-print-page
			data-check-hidden="true"
		>
			<span class="icon color-primary" aria-hidden="true">
				<span class="docon docon-print"></span>
			</span>
			<span>Print</span>
		</button>
	
				</div>
			</details>
		</div>
	
			</div>
		</div>
	
					<!-- azure disclaimer -->
					
					<!-- privateUnauthorizedTemplate is hidden by default -->
					
		<div unauthorized-private-section data-bi-name="permission-content-unauthorized-private" hidden>
			<hr class="hr margin-top-xs margin-bottom-sm" />
			<div class="notification notification-info">
				<div class="notification-content">
					<p class="margin-top-none notification-title">
						<span class="icon">
							<span class="docon docon-exclamation-circle-solid" aria-hidden="true"></span>
						</span>
						<span>Note</span>
					</p>
					<p class="margin-top-none authentication-determined not-authenticated">
						Access to this page requires authorization. You can try <a class="docs-sign-in" href="#" data-bi-name="permission-content-sign-in">signing in</a> or <a  class="docs-change-directory" data-bi-name="permisson-content-change-directory">changing directories</a>.
					</p>
					<p class="margin-top-none authentication-determined authenticated">
						Access to this page requires authorization. You can try <a class="docs-change-directory" data-bi-name="permisson-content-change-directory">changing directories</a>.
					</p>
				</div>
			</div>
		</div>
	
					<div class="content"><h1 id="aspnet-core-middleware">ASP.NET Core Middleware</h1></div>
					
		<div
			id="article-metadata"
			class="page-metadata-container display-flex gap-xxs justify-content-space-between align-items-center flex-wrap-wrap"
		>
			
		<div class="margin-block-xxs">
			<ul class="metadata page-metadata" data-bi-name="page info" lang="en-us" dir="ltr">
				  <li class="visibility-hidden-visual-diff">
			<local-time
				format="twoDigitNumeric"
				datetime="2025-06-21T08:00:00.000Z"
				data-article-date-source="calculated"
				class="is-invisible"
			>
				2025-06-21
			</local-time>
		</li>  
			</ul>
		</div>
	 
				<div
					id="user-feedback"
					class="margin-block-xxs display-none display-none-print"
					hidden
					data-hide-on-archived
				>
					
		<button
			id="user-feedback-button"
			data-test-id="conceptual-feedback-button"
			class="button button-sm button-clear button-primary display-none"
			type="button"
			data-bi-name="user-feedback-button"
			data-user-feedback-button
			hidden
		>
			<span class="icon" aria-hidden="true">
				<span class="docon docon-like"></span>
			</span>
			<span>Feedback</span>
		</button>
	
				</div>
		  
		</div>
	 
		<nav
			id="center-doc-outline"
			class="doc-outline is-hidden-desktop display-none-print margin-bottom-sm"
			data-bi-name="intopic toc"
			aria-label="In this article"
		>
			<h2 id="ms--in-this-article" class="title is-6 margin-block-xs">
				In this article
			</h2>
		</nav>
	
					<div class="content"><div data-moniker="aspnetcore-3.0 aspnetcore-3.1 aspnetcore-5.0 aspnetcore-6.0 aspnetcore-7.0 aspnetcore-8.0">
<div class="NOTE">
<p>Note</p>
<p>This isn't the latest version of this article. For the current release, see the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-9.0&amp;preserve-view=true" data-linktype="relative-path">.NET 9 version of this article</a>.</p>
</div>
</div>
<div data-moniker="aspnetcore-3.0 aspnetcore-3.1 aspnetcore-5.0 aspnetcore-7.0">
<div class="WARNING">
<p>Warning</p>
<p>This version of ASP.NET Core is no longer supported. For more information, see the <a href="https://dotnet.microsoft.com/platform/support/policy/dotnet-core" data-linktype="external">.NET and .NET Core Support Policy</a>. For the current release, see the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-9.0&amp;preserve-view=true" data-linktype="relative-path">.NET 9 version of this article</a>.</p>
</div>
</div>
<div data-moniker="aspnetcore-10.0">
<div class="IMPORTANT">
<p>Important</p>
<p>This information relates to a pre-release product that may be substantially modified before it's commercially released. Microsoft makes no warranties, express or implied, with respect to the information provided here.</p>
<p>For the current release, see the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-9.0&amp;preserve-view=true" data-linktype="relative-path">.NET 9 version of this article</a>.</p>
</div>
</div>
<!--
Include either this file or 'not-latest-version-without-not-supported-content.md' at the top 
of articles.

'not-latest-version.md' (this file): Includes not-supported content.
'not-latest-version-without-not-supported-content.md': Doesn't include not-supported content.

Use this file in articles that target >=7.0. For articles that target >=8.0 prior to 9.0
reaching EOL, 'not-latest-version-without-not-supported-content.md' must be used to avoid
a zone/file moniker range mismatch error.

When a new version is released, it might be necessary to temporarily comment out the current 
version moniker range section until the new moniker is created.

Markdown to include this file:

[!INCLUDE[](~/includes/not-latest-version.md)]
-->
<div data-moniker="aspnetcore-10.0 aspnetcore-8.0 aspnetcore-9.0">
<p>By <a href="https://twitter.com/RickAndMSFT" data-linktype="external">Rick Anderson</a> and <a href="https://ardalis.com/" data-linktype="external">Steve Smith</a></p>
<p>Middleware is software that's assembled into an app pipeline to handle requests and responses. Each component:</p>
<ul>
<li>Chooses whether to pass the request to the next component in the pipeline.</li>
<li>Can perform work before and after the next component in the pipeline.</li>
</ul>
<p>Request delegates are used to build the request pipeline. The request delegates handle each HTTP request.</p>
<p>Request delegates are configured using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.runextensions.run" class="no-loc" data-linktype="absolute-path">Run</a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" class="no-loc" data-linktype="absolute-path">Map</a>, and <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" class="no-loc" data-linktype="absolute-path">Use</a> extension methods. An individual request delegate can be specified in-line as an anonymous method (called in-line middleware), or it can be defined in a reusable class. These reusable classes and in-line anonymous methods are <em>middleware</em>, also called <em>middleware components</em>. Each middleware component in the request pipeline is responsible for invoking the next component in the pipeline or short-circuiting the pipeline. When a middleware short-circuits, it's called a <em>terminal middleware</em> because it prevents further middleware from processing the request.</p>
<p><a href="https://learn.microsoft.com/en-us/aspnet/core/migration/fx-to-core/areas/http-modules?view=aspnetcore-9.0" data-linktype="relative-path">Migrate HTTP modules to ASP.NET Core middleware</a> explains the difference between request pipelines in ASP.NET Core and ASP.NET 4.x and provides additional middleware samples.</p>
<h2 id="the-role-of-middleware-by-app-type">The role of middleware by app type</h2>
<p>Blazor Web Apps, Razor Pages, and MVC process browser requests on the server with middleware. The guidance in this article applies to these types of apps.</p>
<p>Standalone Blazor WebAssembly apps run entirely on the client and don't process requests with a middleware pipeline. The guidance in this article doesn't apply to standalone Blazor WebAssembly apps.</p>
<h2 id="middleware-code-analysis">Middleware code analysis</h2>
<p>ASP.NET Core includes many compiler platform analyzers that inspect application code for quality. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/diagnostics/code-analysis?view=aspnetcore-9.0" data-linktype="relative-path">Code analysis in ASP.NET Core apps</a></p>
<h2 id="create-a-middleware-pipeline-with-webapplication">Create a middleware pipeline with <code>WebApplication</code></h2>
<p>The ASP.NET Core request pipeline consists of a sequence of request delegates, called one after the other. The following diagram demonstrates the concept. The thread of execution follows the black arrows.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/request-delegate-pipeline.png?view=aspnetcore-9.0" alt="Request processing pattern showing a request arriving, processing through three middlewares, and the response leaving the app. Each middleware runs its logic and hands off the request to the next middleware at the next() statement. After the third middleware processes the request, the request passes back through the prior two middlewares in reverse order for additional processing after their next() statements before leaving the app as a response to the client." data-linktype="relative-path"></p>
<p>Each delegate can perform operations before and after the next delegate. Exception-handling delegates should be called early in the pipeline, so they can catch exceptions that occur in later stages of the pipeline.</p>
<p>The simplest possible ASP.NET Core app sets up a single request delegate that handles all requests. This case doesn't include an actual request pipeline. Instead, a single anonymous function is called in response to every HTTP request.</p>
<pre><code class="lang-csharp">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello world!");
});

app.Run();
</code></pre>
<p>Chain multiple request delegates together with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" class="no-loc" data-linktype="absolute-path">Use</a>. The <code>next</code> parameter represents the next delegate in the pipeline. You can short-circuit the pipeline by <em>not</em> calling the <code>next</code> parameter. You can typically perform actions both before and after the <code>next</code> delegate, as the following example demonstrates:</p>
<pre><code class="lang-csharp" highlight-lines="4-9">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Use(async (context, next) =&gt;
{
    // Do work that can write to the Response.
    await next.Invoke();
    // Do logging or other work that doesn't write to the Response.
});

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from 2nd delegate.");
});

app.Run();
</code></pre><h3 id="short-circuiting-the-request-pipeline">Short-circuiting the request pipeline</h3>
<p>When a delegate doesn't pass a request to the next delegate, it's called <em>short-circuiting the request pipeline</em>. Short-circuiting is often desirable because it avoids unnecessary work. For example, <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static File Middleware</a> can act as a <em>terminal middleware</em> by processing a request for a static file and short-circuiting the rest of the pipeline. Middleware added to the pipeline before the middleware that terminates further processing still processes code after their <code>next.Invoke</code> statements. However, see the following warning about attempting to write to a response that has already been sent.</p>
<div class="WARNING">
<p>Warning</p>
<p>Don't call <code>next.Invoke</code> during or after the response has been sent to the client. After an <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpresponse" class="no-loc" data-linktype="absolute-path">HttpResponse</a> has started, changes result in an exception. For example, <a href="../best-practices553c.html?view=aspnetcore-9.0#do-not-modify-the-status-code-or-headers-after-the-response-body-has-started" data-linktype="relative-path">setting headers and a status code throw an exception</a> after the response starts. Writing to the response body after calling <code>next</code>:</p>
<ul>
<li>May cause a protocol violation, such as writing more than the stated <code>Content-Length</code>.</li>
<li>May corrupt the body format, such as writing an HTML footer to a CSS file.</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpresponse.hasstarted" class="no-loc" data-linktype="absolute-path">HasStarted</a> is a useful hint to indicate if headers have been sent or the body has been written to.</p>
</div>
<p>For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-9.0#short-circuit-middleware-after-routing" data-linktype="relative-path">Short-circuit middleware after routing</a>.</p>
<h3 id="run-delegates"><code>Run</code> delegates</h3>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.runextensions.run" class="no-loc" data-linktype="absolute-path">Run</a> delegates don't receive a <code>next</code> parameter. The first <code>Run</code> delegate is always terminal and terminates the pipeline. <code>Run</code> is a convention. Some middleware components may expose <code>Run[Middleware]</code> methods that run at the end of the pipeline:</p>
<pre><code class="lang-csharp" highlight-lines="11-14">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Use(async (context, next) =&gt;
{
    // Do work that can write to the Response.
    await next.Invoke();
    // Do logging or other work that doesn't write to the Response.
});

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from 2nd delegate.");
});

app.Run();
</code></pre><p>If you would like to see code comments translated to languages other than English, let us know in <a href="https://github.com/MicrosoftDocs/feedback/issues/2515" data-linktype="external">this GitHub discussion issue</a>.</p>
<p>In the preceding example, the <code>Run</code> delegate writes <code>"Hello from 2nd delegate."</code> to the response and then terminates the pipeline. If another <code>Use</code> or <code>Run</code> delegate is added after the <code>Run</code> delegate, it's not called.</p>
<h3 id="prefer-appuse-overload-that-requires-passing-the-context-to-next">Prefer app.Use overload that requires passing the context to next</h3>
<!-- TODO, a minimum, provide a sample usage. Better, use this overload in the 6.0 version -->
<p>The non-allocating <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder.use" data-linktype="absolute-path">app.Use</a> extension method:</p>
<ul>
<li>Requires passing the context to <code>next</code>.</li>
<li>Saves two internal per-request allocations that are required when using the other overload.</li>
</ul>
<p>For more information, see <a href="https://github.com/dotnet/aspnetcore/pull/31784" data-linktype="external">this GitHub issue</a>.</p>
<p><a name="order"></a></p>
<h2 id="middleware-order">Middleware order</h2>
<p>The following diagram shows the complete request processing pipeline for ASP.NET Core MVC and Razor Pages apps. You can see how, in a typical app, existing middlewares are ordered and where custom middlewares are added. You have full control over how to reorder existing middlewares or inject new custom middlewares as necessary for your scenarios.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/middleware-pipeline.svg?view=aspnetcore-9.0" alt="ASP.NET Core middleware pipeline" data-linktype="relative-path"></p>
<!-- 
See mermaid diagrams in https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/middleware/index/includes

Install CLI mermaid to make SVGs
npm install -g mermaid-cli

remove ```mermaid and closing ```
mermaid -s x.md
preceding creates the x.md.svg file

![ASP.NET SVG  middleware pipeline](~/fundamentals/middleware/index/includes/x.md.svg)
Line 85: [Warning] File 'fundamentals/middleware/index/includes/x.md.svg' referenced by link '~/fundamentals/middleware/index/includes/x.md.svg' will not be built because it is not included in build scope.
-->
<p>The <strong>Endpoint</strong> middleware in the preceding diagram executes the filter pipeline for the corresponding app type—MVC or Razor Pages.</p>
<p>The <strong>Routing</strong> middleware in the preceding diagram is shown following <strong>Static Files</strong>. This is the order that the project templates implement by explicitly calling <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.userouting" data-linktype="absolute-path">app.UseRouting</a>. If you don't call <code>app.UseRouting</code>, the <strong>Routing</strong> middleware runs at the beginning of the pipeline by default. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-9.0" data-linktype="relative-path">Routing</a>.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/mvc-endpoint.svg?view=aspnetcore-9.0" alt="ASP.NET Core filter pipeline" data-linktype="relative-path"></p>
<p>The order that middleware components are added in the <code>Program.cs</code> file defines the order in which the middleware components are invoked on requests and the reverse order for the response. The order is <strong>critical</strong> for security, performance, and functionality.</p>
<p>The following highlighted code in <code>Program.cs</code> adds security-related middleware components in the typical recommended order:</p>
<pre><code class="lang-csharp" highlight-lines="19-44">using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using WebMiddleware.Data;

var builder = WebApplication.CreateBuilder(args);

var connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
    ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");
builder.Services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;
    options.UseSqlServer(connectionString));
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

builder.Services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true)
    .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();
builder.Services.AddRazorPages();
builder.Services.AddControllersWithViews();

var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseMigrationsEndPoint();
}
else
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();
// app.UseCookiePolicy();

app.UseRouting();
// app.UseRateLimiter();
// app.UseRequestLocalization();
// app.UseCors();

app.UseAuthentication();
app.UseAuthorization();
// app.UseSession();
// app.UseResponseCompression();
// app.UseResponseCaching();

app.MapRazorPages();
app.MapDefaultControllerRoute();

app.Run();
</code></pre>
<p>In the preceding code:</p>
<ul>
<li>Middleware that is not added when creating a new web app with <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-9.0" data-linktype="relative-path">individual users accounts</a> is commented out.</li>
<li>Not every middleware appears in this exact order, but many do. For example:
<ul>
<li><code>UseCors</code>, <code>UseAuthentication</code>, and <code>UseAuthorization</code> must appear in the order shown.</li>
<li><code>UseCors</code> currently must appear before <code>UseResponseCaching</code>. This requirement is explained in <a href="https://github.com/dotnet/aspnetcore/issues/23218" data-linktype="external">GitHub issue dotnet/aspnetcore #23218</a>.</li>
<li><code>UseRequestLocalization</code> must appear before any middleware that might check the request culture, for example, <code>app.UseStaticFiles()</code>.</li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.ratelimiterapplicationbuilderextensions.useratelimiter" class="no-loc" data-linktype="absolute-path">UseRateLimiter</a> must be called after <code>UseRouting</code> when rate limiting endpoint specific APIs are used. For example, if the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.ratelimiting.enableratelimitingattribute" data-linktype="absolute-path"><code>[EnableRateLimiting]</code></a> attribute is used, <code>UseRateLimiter</code> must be called after <code>UseRouting</code>. When calling only global limiters, <code>UseRateLimiter</code> can be called before <code>UseRouting</code>.</li>
</ul>
</li>
</ul>
<p>In some scenarios, middleware has different ordering. For example, caching and compression ordering is scenario specific, and there are multiple valid orderings. For example:</p>
<pre><code class="lang-csharp">app.UseResponseCaching();
app.UseResponseCompression();
</code></pre>
<p>With the preceding code, CPU usage could be reduced by caching the compressed response, but you might end up caching multiple representations of a resource using different compression algorithms such as Gzip or Brotli.</p>
<p>The following ordering combines static files to allow caching compressed static files:</p>
<pre><code class="lang-csharp">app.UseResponseCaching();
app.UseResponseCompression();
app.UseStaticFiles();
</code></pre>
<p>The following <code>Program.cs</code> code adds middleware components for common app scenarios:</p>
<ol>
<li>Exception/error handling
<ul>
<li>When the app runs in the Development environment:
<ul>
<li>Developer Exception Page Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.developerexceptionpageextensions.usedeveloperexceptionpage" class="no-loc" data-linktype="absolute-path">UseDeveloperExceptionPage</a>) reports app runtime errors.</li>
<li>Database Error Page Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.databaseerrorpageextensions.usedatabaseerrorpage" class="no-loc" data-linktype="absolute-path">UseDatabaseErrorPage</a>) reports database runtime errors.</li>
</ul>
</li>
<li>When the app runs in the Production environment:
<ul>
<li>Exception Handler Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" class="no-loc" data-linktype="absolute-path">UseExceptionHandler</a>) catches exceptions thrown in the following middlewares.</li>
<li>HTTP Strict Transport Security Protocol (HSTS) Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.hstsbuilderextensions.usehsts" class="no-loc" data-linktype="absolute-path">UseHsts</a>) adds the <code>Strict-Transport-Security</code> header.</li>
</ul>
</li>
</ul>
</li>
<li>HTTPS Redirection Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.httpspolicybuilderextensions.usehttpsredirection" class="no-loc" data-linktype="absolute-path">UseHttpsRedirection</a>) redirects HTTP requests to HTTPS.</li>
<li>Static File Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.staticfileextensions.usestaticfiles" class="no-loc" data-linktype="absolute-path">UseStaticFiles</a>) returns static files and short-circuits further request processing.</li>
<li>Cookie Policy Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.cookiepolicyappbuilderextensions.usecookiepolicy" class="no-loc" data-linktype="absolute-path">UseCookiePolicy</a>) conforms the app to the EU General Data Protection Regulation (GDPR) regulations.</li>
<li>Routing Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.userouting" class="no-loc" data-linktype="absolute-path">UseRouting</a>) to route requests.</li>
<li>Authentication Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" class="no-loc" data-linktype="absolute-path">UseAuthentication</a>) attempts to authenticate the user before they're allowed access to secure resources.</li>
<li>Authorization Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization" class="no-loc" data-linktype="absolute-path">UseAuthorization</a>) authorizes a user to access secure resources.</li>
<li>Session Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.sessionmiddlewareextensions.usesession" class="no-loc" data-linktype="absolute-path">UseSession</a>) establishes and maintains session state. If the app uses session state, call Session Middleware after Cookie Policy Middleware and before MVC Middleware.</li>
<li>Endpoint Routing Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.useendpoints" class="no-loc" data-linktype="absolute-path">UseEndpoints</a> with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.razorpagesendpointroutebuilderextensions.maprazorpages" class="no-loc" data-linktype="absolute-path">MapRazorPages</a>) to add Razor Pages endpoints to the request pipeline.</li>
</ol>
<pre><code class="lang-csharp">if (env.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
    app.UseDatabaseErrorPage();
}
else
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}
app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseCookiePolicy();
app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();
app.UseSession();
app.MapRazorPages();
</code></pre>
<p>In the preceding example code, each middleware extension method is exposed on <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder" class="no-loc" data-linktype="absolute-path">WebApplicationBuilder</a> through the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder" class="no-loc" data-linktype="absolute-path">Microsoft.AspNetCore.Builder</a> namespace.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" class="no-loc" data-linktype="absolute-path">UseExceptionHandler</a> is the first middleware component added to the pipeline. Therefore, the Exception Handler Middleware catches any exceptions that occur in later calls.</p>
<p>Static File Middleware is called early in the pipeline so that it can handle requests and short-circuit without going through the remaining components. The Static File Middleware provides <strong>no</strong> authorization checks. Any files served by Static File Middleware, including those under <em>wwwroot</em>, are publicly available. For an approach to secure static files, see <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static files in ASP.NET Core</a>.</p>
<p>If the request isn't handled by the Static File Middleware, it's passed on to the Authentication Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" class="no-loc" data-linktype="absolute-path">UseAuthentication</a>), which performs authentication. Authentication doesn't short-circuit unauthenticated requests. Although Authentication Middleware authenticates requests, authorization (and rejection) occurs only after MVC selects a specific Razor Page or MVC controller and action.</p>
<p>The following example demonstrates a middleware order where requests for static files are handled by Static File Middleware before Response Compression Middleware. Static files aren't compressed with this middleware order. The Razor Pages responses can be compressed.</p>
<pre><code class="lang-csharp">// Static files aren't compressed by Static File Middleware.
app.UseStaticFiles();

app.UseRouting();

app.UseResponseCompression();

app.MapRazorPages();
</code></pre>
<p>For information about Single Page Applications, see <a href="https://learn.microsoft.com/en-us/aspnet/core/client-side/spa/intro?view=aspnetcore-9.0" data-linktype="relative-path">Overview of Single Page Apps (SPAs) in ASP.NET Core</a>.</p>
<h2 id="usecors-and-usestaticfiles-order">UseCors and UseStaticFiles order</h2>
<p>The order for calling <code>UseCors</code> and <code>UseStaticFiles</code> depends on the app. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0#uc1" data-linktype="relative-path">UseCors and UseStaticFiles order</a></p>
<h3 id="forwarded-headers-middleware-order">Forwarded Headers Middleware order</h3>
<p>Forwarded Headers Middleware should run before other middleware. This ordering ensures that the middleware relying on forwarded headers information can consume the header values for processing. To run Forwarded Headers Middleware after diagnostics and error handling middleware, see <a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-9.0#fhmo" data-linktype="relative-path">Forwarded Headers Middleware order</a>.</p>
<h2 id="branch-the-middleware-pipeline">Branch the middleware pipeline</h2>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" class="no-loc" data-linktype="absolute-path">Map</a> extensions are used as a convention for branching the pipeline. <code>Map</code> branches the request pipeline based on matches of the given request path. If the request path starts with the given path, the branch is executed.</p>
<pre><code class="lang-csharp">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Map("/map1", HandleMapTest1);

app.Map("/map2", HandleMapTest2);

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

static void HandleMapTest1(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        await context.Response.WriteAsync("Map Test 1");
    });
}

static void HandleMapTest2(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        await context.Response.WriteAsync("Map Test 2");
    });
}
</code></pre>
<p>The following table shows the requests and responses from <code>http://localhost:1234</code> using the preceding code.</p>
<table>
<thead>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td>localhost:1234</td>
<td>Hello from non-Map delegate.</td>
</tr>
<tr>
<td>localhost:1234/map1</td>
<td>Map Test 1</td>
</tr>
<tr>
<td>localhost:1234/map2</td>
<td>Map Test 2</td>
</tr>
<tr>
<td>localhost:1234/map3</td>
<td>Hello from non-Map delegate.</td>
</tr>
</tbody>
</table>
<p>When <code>Map</code> is used, the matched path segments are removed from <code>HttpRequest.Path</code> and appended to <code>HttpRequest.PathBase</code> for each request.</p>
<p><code>Map</code> supports nesting, for example:</p>
<pre><code class="lang-csharp">app.Map("/level1", level1App =&gt; {
    level1App.Map("/level2a", level2AApp =&gt; {
        // "/level1/level2a" processing
    });
    level1App.Map("/level2b", level2BApp =&gt; {
        // "/level1/level2b" processing
    });
});
</code></pre>
<p><code>Map</code> can also match multiple segments at once:</p>
<pre><code class="lang-csharp" highlight-lines="4">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Map("/map1/seg1", HandleMultiSeg);

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

static void HandleMultiSeg(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        await context.Response.WriteAsync("Map Test 1");
    });
}
</code></pre>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapwhenextensions.mapwhen" class="no-loc" data-linktype="absolute-path">MapWhen</a> branches the request pipeline based on the result of the given predicate. Any predicate of type <code>Func&lt;HttpContext, bool&gt;</code> can be used to map requests to a new branch of the pipeline. In the following example, a predicate is used to detect the presence of a query string variable <code>branch</code>:</p>
<pre><code class="lang-csharp" highlight-lines="4">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.MapWhen(context =&gt; context.Request.Query.ContainsKey("branch"), HandleBranch);

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

static void HandleBranch(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        var branchVer = context.Request.Query["branch"];
        await context.Response.WriteAsync($"Branch used = {branchVer}");
    });
}
</code></pre>
<p>The following table shows the requests and responses from <code>http://localhost:1234</code> using the previous code:</p>
<table>
<thead>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>localhost:1234</code></td>
<td><code>Hello from non-Map delegate.</code></td>
</tr>
<tr>
<td><code>localhost:1234/?branch=main</code></td>
<td><code>Branch used = main</code></td>
</tr>
</tbody>
</table>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.usewhenextensions.usewhen" class="no-loc" data-linktype="absolute-path">UseWhen</a> also branches the request pipeline based on the result of the given predicate. Unlike with <code>MapWhen</code>, this branch is rejoined to the main pipeline if it doesn't contain a terminal middleware:</p>
<pre><code class="lang-csharp" highlight-lines="4-5">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.UseWhen(context =&gt; context.Request.Query.ContainsKey("branch"),
    appBuilder =&gt; HandleBranchAndRejoin(appBuilder));

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

void HandleBranchAndRejoin(IApplicationBuilder app)
{
    var logger = app.ApplicationServices.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;(); 

    app.Use(async (context, next) =&gt;
    {
        var branchVer = context.Request.Query["branch"];
        logger.LogInformation("Branch used = {branchVer}", branchVer);

        // Do work that doesn't write to the Response.
        await next();
        // Do other work that doesn't write to the Response.
    });
}
</code></pre>
<p>In the preceding example, a response of <code>Hello from non-Map delegate.</code> is written for all requests. If the request includes a query string variable <code>branch</code>, its value is logged before the main pipeline is rejoined.</p>
<h2 id="built-in-middleware">Built-in middleware</h2>
<p>ASP.NET Core ships with the following middleware components. The <em>Order</em> column provides notes on middleware placement in the request processing pipeline and under what conditions the middleware may terminate request processing. When a middleware short-circuits the request processing pipeline and prevents further downstream middleware from processing a request, it's called a <em>terminal middleware</em>. For more information on short-circuiting, see the <a href="#create-a-middleware-pipeline-with-webapplication" data-linktype="self-bookmark">Create a middleware pipeline with WebApplication</a> section.</p>
<table>
<thead>
<tr>
<th>Middleware</th>
<th>Description</th>
<th>Order</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-9.0" data-linktype="relative-path">Antiforgery</a></td>
<td>Provides anti-request-forgery support.</td>
<td>After authentication and authorization, before endpoints.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-9.0" data-linktype="relative-path">Authentication</a></td>
<td>Provides authentication support.</td>
<td>Before <code>HttpContext.User</code> is needed. Terminal for OAuth callbacks.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization" data-linktype="absolute-path">Authorization</a></td>
<td>Provides authorization support.</td>
<td>Immediately after the Authentication Middleware.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0" data-linktype="relative-path">Cookie Policy</a></td>
<td>Tracks consent from users for storing personal information and enforces minimum standards for cookie fields, such as <code>secure</code> and <code>SameSite</code>.</td>
<td>Before middleware that issues cookies. Examples: Authentication, Session, MVC (TempData).</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0" data-linktype="relative-path">CORS</a></td>
<td>Configures Cross-Origin Resource Sharing.</td>
<td>Before components that use CORS. <code>UseCors</code> currently must go before <code>UseResponseCaching</code> due to <a href="https://github.com/dotnet/aspnetcore/issues/23218" data-linktype="external">this bug</a>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.diagnostics.developerexceptionpagemiddleware" data-linktype="absolute-path">DeveloperExceptionPage</a></td>
<td>Generates a page with error information that is intended for use only in the Development environment.</td>
<td>Before components that generate errors. The project templates automatically register this middleware as the first middleware in the pipeline when the environment is Development.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/error-handling?view=aspnetcore-9.0" data-linktype="relative-path">Diagnostics</a></td>
<td>Several separate middlewares that provide a developer exception page, exception handling, status code pages, and the default web page for new apps.</td>
<td>Before components that generate errors. Terminal for exceptions or serving the default web page for new apps.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-9.0" data-linktype="relative-path">Forwarded Headers</a></td>
<td>Forwards proxied headers onto the current request.</td>
<td>Before components that consume the updated fields. Examples: scheme, host, client IP, method.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-9.0" data-linktype="relative-path">Health Check</a></td>
<td>Checks the health of an ASP.NET Core app and its dependencies, such as checking database availability.</td>
<td>Terminal if a request matches a health check endpoint.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-requests?view=aspnetcore-9.0#header-propagation-middleware" data-linktype="relative-path">Header Propagation</a></td>
<td>Propagates HTTP headers from the incoming request to the outgoing HTTP Client requests.</td>
<td></td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-logging/?view=aspnetcore-9.0" data-linktype="relative-path">HTTP Logging</a></td>
<td>Logs HTTP Requests and Responses.</td>
<td>At the beginning of the middleware pipeline.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.httpmethodoverrideextensions" data-linktype="absolute-path">HTTP Method Override</a></td>
<td>Allows an incoming POST request to override the method.</td>
<td>Before components that consume the updated method.</td>
</tr>
<tr>
<td><a href="../../security/enforcing-ssl553c.html?view=aspnetcore-9.0#require-https" data-linktype="relative-path">HTTPS Redirection</a></td>
<td>Redirect all HTTP requests to HTTPS.</td>
<td>Before components that consume the URL.</td>
</tr>
<tr>
<td><a href="../../security/enforcing-ssl553c.html?view=aspnetcore-9.0#http-strict-transport-security-protocol-hsts" data-linktype="relative-path">HTTP Strict Transport Security (HSTS)</a></td>
<td>Security enhancement middleware that adds a special response header.</td>
<td>Before responses are sent and after components that modify requests. Examples: Forwarded Headers, URL Rewriting.</td>
</tr>
<tr>
<td><a href="../../mvc/overview553c.html?view=aspnetcore-9.0" data-linktype="relative-path">MVC</a></td>
<td>Processes requests with MVC/Razor Pages.</td>
<td>Terminal if a request matches a route.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/owin?view=aspnetcore-9.0" data-linktype="relative-path">OWIN</a></td>
<td>Interop with OWIN-based apps, servers, and middleware.</td>
<td>Terminal if the OWIN Middleware fully processes the request.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/output?view=aspnetcore-9.0" data-linktype="relative-path">Output Caching</a></td>
<td>Provides support for caching responses based on configuration.</td>
<td>Before components that require caching. <code>UseRouting</code> must come before <code>UseOutputCaching</code>. <code>UseCORS</code> must come before <code>UseOutputCaching</code>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/middleware?view=aspnetcore-9.0" data-linktype="relative-path">Response Caching</a></td>
<td>Provides support for caching responses. This requires client participation to work. Use output caching for complete server control.</td>
<td>Before components that require caching. <code>UseCORS</code> must come before <code>UseResponseCaching</code>. Is typically not beneficial for UI apps such as Razor Pages because browsers generally set request headers that prevent caching. <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/output?view=aspnetcore-9.0" data-linktype="relative-path">Output caching</a> benefits UI apps.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/request-decompression?view=aspnetcore-9.0" data-linktype="relative-path">Request Decompression</a></td>
<td>Provides support for decompressing requests.</td>
<td>Before components that read the request body.</td>
</tr>
<tr>
<td><a href="../../performance/response-compression553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Response Compression</a></td>
<td>Provides support for compressing responses.</td>
<td>Before components that require compression.</td>
</tr>
<tr>
<td><a href="../localization553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Request Localization</a></td>
<td>Provides localization support.</td>
<td>Before localization sensitive components. Must appear after Routing Middleware when using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.localization.routing.routedatarequestcultureprovider" class="no-loc" data-linktype="absolute-path">RouteDataRequestCultureProvider</a>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/performance/timeouts?view=aspnetcore-9.0" data-linktype="relative-path">Request Timeouts</a></td>
<td>Provides support for configuring request timeouts, global and per endpoint.</td>
<td><code>UseRequestTimeouts</code> must come after <code>UseExceptionHandler</code>, <code>UseDeveloperExceptionPage</code>, and <code>UseRouting</code>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-9.0" data-linktype="relative-path">Endpoint Routing</a></td>
<td>Defines and constrains request routes.</td>
<td>Terminal for matching routes.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.spaapplicationbuilderextensions.usespa" data-linktype="absolute-path">SPA</a></td>
<td>Handles all requests from this point in the middleware chain by returning the default page for the Single Page Application (SPA)</td>
<td>Late in the chain, so that other middleware for serving static files, MVC actions, etc., takes precedence.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/app-state?view=aspnetcore-9.0" data-linktype="relative-path">Session</a></td>
<td>Provides support for managing user sessions.</td>
<td>Before components that require Session.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static Files</a></td>
<td>Provides support for serving static files and directory browsing.</td>
<td>Terminal if a request matches a file.</td>
</tr>
<tr>
<td><a href="../url-rewriting553c.html?view=aspnetcore-9.0" data-linktype="relative-path">URL Rewrite</a></td>
<td>Provides support for rewriting URLs and redirecting requests.</td>
<td>Before components that consume the URL.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/w3c-logger/?view=aspnetcore-9.0" data-linktype="relative-path">W3CLogging</a></td>
<td>Generates server access logs in the <a href="https://www.w3.org/TR/WD-logfile.html" data-linktype="external">W3C Extended Log File Format</a>.</td>
<td>At the beginning of the middleware pipeline.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/websockets?view=aspnetcore-9.0" data-linktype="relative-path">WebSockets</a></td>
<td>Enables the WebSockets protocol.</td>
<td>Before components that are required to accept WebSocket requests.</td>
</tr>
</tbody>
</table>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-9.0#lifetime-and-registration-options" data-linktype="relative-path">Lifetime and registration options</a> contains a complete sample of middleware with <em>scoped</em>, <em>transient</em>, and <em>singleton</em> lifetime services.</li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write?view=aspnetcore-9.0" data-linktype="relative-path">Write custom ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/test/middleware?view=aspnetcore-9.0" data-linktype="relative-path">Test ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/grpc/browser?view=aspnetcore-9.0#configure-grpc-web-in-aspnet-core" data-linktype="relative-path">Configure gRPC-Web in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/migration/fx-to-core/areas/http-modules?view=aspnetcore-9.0" data-linktype="relative-path">Migrate HTTP modules to ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup?view=aspnetcore-9.0" data-linktype="relative-path">App startup in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/request-features?view=aspnetcore-9.0" data-linktype="relative-path">Request Features in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/extensibility?view=aspnetcore-9.0" data-linktype="relative-path">Factory-based middleware activation in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/extensibility-third-party-container?view=aspnetcore-9.0" data-linktype="relative-path">Middleware activation with a third-party container in ASP.NET Core</a></li>
</ul>
</div>
<div data-moniker="aspnetcore-7.0">
<p>By <a href="https://twitter.com/RickAndMSFT" data-linktype="external">Rick Anderson</a> and <a href="https://ardalis.com/" data-linktype="external">Steve Smith</a></p>
<p>Middleware is software that's assembled into an app pipeline to handle requests and responses. Each component:</p>
<ul>
<li>Chooses whether to pass the request to the next component in the pipeline.</li>
<li>Can perform work before and after the next component in the pipeline.</li>
</ul>
<p>Request delegates are used to build the request pipeline. The request delegates handle each HTTP request.</p>
<p>Request delegates are configured using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.runextensions.run" class="no-loc" data-linktype="absolute-path">Run</a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" class="no-loc" data-linktype="absolute-path">Map</a>, and <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" class="no-loc" data-linktype="absolute-path">Use</a> extension methods. An individual request delegate can be specified in-line as an anonymous method (called in-line middleware), or it can be defined in a reusable class. These reusable classes and in-line anonymous methods are <em>middleware</em>, also called <em>middleware components</em>. Each middleware component in the request pipeline is responsible for invoking the next component in the pipeline or short-circuiting the pipeline. When a middleware short-circuits, it's called a <em>terminal middleware</em> because it prevents further middleware from processing the request.</p>
<p><a href="https://learn.microsoft.com/en-us/aspnet/core/migration/fx-to-core/areas/http-modules?view=aspnetcore-9.0" data-linktype="relative-path">Migrate HTTP modules to ASP.NET Core middleware</a> explains the difference between request pipelines in ASP.NET Core and ASP.NET 4.x and provides additional middleware samples.</p>
<h2 id="the-role-of-middleware-by-app-type">The role of middleware by app type</h2>
<p>Razor Pages, MVC, Blazor Server, and the server-side project of a hosted Blazor WebAssembly solution process browser requests on the server with middleware. The guidance in this article applies to these types of apps.</p>
<p>Standalone Blazor WebAssembly apps run entirely on the client and don't process requests with a middleware pipeline. The guidance in this article doesn't apply to standalone Blazor WebAssembly apps.</p>
<h2 id="middleware-code-analysis">Middleware code analysis</h2>
<p>ASP.NET Core includes many compiler platform analyzers that inspect application code for quality. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/diagnostics/code-analysis?view=aspnetcore-9.0" data-linktype="relative-path">Code analysis in ASP.NET Core apps</a></p>
<h2 id="create-a-middleware-pipeline-with-webapplication">Create a middleware pipeline with <code>WebApplication</code></h2>
<p>The ASP.NET Core request pipeline consists of a sequence of request delegates, called one after the other. The following diagram demonstrates the concept. The thread of execution follows the black arrows.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/request-delegate-pipeline.png?view=aspnetcore-9.0" alt="Request processing pattern showing a request arriving, processing through three middlewares, and the response leaving the app. Each middleware runs its logic and hands off the request to the next middleware at the next() statement. After the third middleware processes the request, the request passes back through the prior two middlewares in reverse order for additional processing after their next() statements before leaving the app as a response to the client." data-linktype="relative-path"></p>
<p>Each delegate can perform operations before and after the next delegate. Exception-handling delegates should be called early in the pipeline, so they can catch exceptions that occur in later stages of the pipeline.</p>
<p>The simplest possible ASP.NET Core app sets up a single request delegate that handles all requests. This case doesn't include an actual request pipeline. Instead, a single anonymous function is called in response to every HTTP request.</p>
<pre><code class="lang-csharp">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello world!");
});

app.Run();
</code></pre>
<p>Chain multiple request delegates together with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" class="no-loc" data-linktype="absolute-path">Use</a>. The <code>next</code> parameter represents the next delegate in the pipeline. You can short-circuit the pipeline by <em>not</em> calling the <code>next</code> parameter. You can typically perform actions both before and after the <code>next</code> delegate, as the following example demonstrates:</p>
<pre><code class="lang-csharp" highlight-lines="4-9">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Use(async (context, next) =&gt;
{
    // Do work that can write to the Response.
    await next.Invoke();
    // Do logging or other work that doesn't write to the Response.
});

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from 2nd delegate.");
});

app.Run();
</code></pre>
<p>When a delegate doesn't pass a request to the next delegate, it's called <em>short-circuiting the request pipeline</em>. Short-circuiting is often desirable because it avoids unnecessary work. For example, <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static File Middleware</a> can act as a <em>terminal middleware</em> by processing a request for a static file and short-circuiting the rest of the pipeline. Middleware added to the pipeline before the middleware that terminates further processing still processes code after their <code>next.Invoke</code> statements. However, see the following warning about attempting to write to a response that has already been sent.</p>
<div class="WARNING">
<p>Warning</p>
<p>Don't call <code>next.Invoke</code> after the response has been sent to the client. Changes to <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpresponse" class="no-loc" data-linktype="absolute-path">HttpResponse</a> after the response has started throw an exception. For example, <a href="../best-practices553c.html?view=aspnetcore-9.0#do-not-modify-the-status-code-or-headers-after-the-response-body-has-started" data-linktype="relative-path">setting headers and a status code throw an exception</a>. Writing to the response body after calling <code>next</code>:</p>
<ul>
<li>May cause a protocol violation. For example, writing more than the stated <code>Content-Length</code>.</li>
<li>May corrupt the body format. For example, writing an HTML footer to a CSS file.</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpresponse.hasstarted" class="no-loc" data-linktype="absolute-path">HasStarted</a> is a useful hint to indicate if headers have been sent or the body has been written to.</p>
</div>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.runextensions.run" class="no-loc" data-linktype="absolute-path">Run</a> delegates don't receive a <code>next</code> parameter. The first <code>Run</code> delegate is always terminal and terminates the pipeline. <code>Run</code> is a convention. Some middleware components may expose <code>Run[Middleware]</code> methods that run at the end of the pipeline:</p>
<pre><code class="lang-csharp" highlight-lines="11-14">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Use(async (context, next) =&gt;
{
    // Do work that can write to the Response.
    await next.Invoke();
    // Do logging or other work that doesn't write to the Response.
});

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from 2nd delegate.");
});

app.Run();
</code></pre><p>If you would like to see code comments translated to languages other than English, let us know in <a href="https://github.com/MicrosoftDocs/feedback/issues/2515" data-linktype="external">this GitHub discussion issue</a>.</p>
<p>In the preceding example, the <code>Run</code> delegate writes <code>"Hello from 2nd delegate."</code> to the response and then terminates the pipeline. If another <code>Use</code> or <code>Run</code> delegate is added after the <code>Run</code> delegate, it's not called.</p>
<h3 id="prefer-appuse-overload-that-requires-passing-the-context-to-next">Prefer app.Use overload that requires passing the context to next</h3>
<!-- TODO, a minimum, provide a sample usage. Better, use this overload in the 6.0 version -->
<p>The non-allocating <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder.use" data-linktype="absolute-path">app.Use</a> extension method:</p>
<ul>
<li>Requires passing the context to <code>next</code>.</li>
<li>Saves two internal per-request allocations that are required when using the other overload.</li>
</ul>
<p>For more information, see <a href="https://github.com/dotnet/aspnetcore/pull/31784" data-linktype="external">this GitHub issue</a>.</p>
<p><a name="order"></a></p>
<h2 id="middleware-order">Middleware order</h2>
<p>The following diagram shows the complete request processing pipeline for ASP.NET Core MVC and Razor Pages apps. You can see how, in a typical app, existing middlewares are ordered and where custom middlewares are added. You have full control over how to reorder existing middlewares or inject new custom middlewares as necessary for your scenarios.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/middleware-pipeline.svg?view=aspnetcore-9.0" alt="ASP.NET Core middleware pipeline" data-linktype="relative-path"></p>
<p>The <strong>Endpoint</strong> middleware in the preceding diagram executes the filter pipeline for the corresponding app type—MVC or Razor Pages.</p>
<p>The <strong>Routing</strong> middleware in the preceding diagram is shown following <strong>Static Files</strong>. This is the order that the project templates implement by explicitly calling <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.userouting" data-linktype="absolute-path">app.UseRouting</a>. If you don't call <code>app.UseRouting</code>, the <strong>Routing</strong> middleware runs at the beginning of the pipeline by default. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-9.0" data-linktype="relative-path">Routing</a>.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/mvc-endpoint.svg?view=aspnetcore-9.0" alt="ASP.NET Core filter pipeline" data-linktype="relative-path"></p>
<p>The order that middleware components are added in the <code>Program.cs</code> file defines the order in which the middleware components are invoked on requests and the reverse order for the response. The order is <strong>critical</strong> for security, performance, and functionality.</p>
<p>The following highlighted code in <code>Program.cs</code> adds security-related middleware components in the typical recommended order:</p>
<pre><code class="lang-csharp" highlight-lines="19-44">using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using WebMiddleware.Data;

var builder = WebApplication.CreateBuilder(args);

var connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
    ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");
builder.Services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;
    options.UseSqlServer(connectionString));
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

builder.Services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true)
    .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();
builder.Services.AddRazorPages();
builder.Services.AddControllersWithViews();

var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseMigrationsEndPoint();
}
else
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();
// app.UseCookiePolicy();

app.UseRouting();
// app.UseRateLimiter();
// app.UseRequestLocalization();
// app.UseCors();

app.UseAuthentication();
app.UseAuthorization();
// app.UseSession();
// app.UseResponseCompression();
// app.UseResponseCaching();

app.MapRazorPages();
app.MapDefaultControllerRoute();

app.Run();
</code></pre>
<p>In the preceding code:</p>
<ul>
<li>Middleware that is not added when creating a new web app with <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-9.0" data-linktype="relative-path">individual users accounts</a> is commented out.</li>
<li>Not every middleware appears in this exact order, but many do. For example:
<ul>
<li><code>UseCors</code>, <code>UseAuthentication</code>, and <code>UseAuthorization</code> must appear in the order shown.</li>
<li><code>UseCors</code> currently must appear before <code>UseResponseCaching</code>. This requirement is explained in <a href="https://github.com/dotnet/aspnetcore/issues/23218" data-linktype="external">GitHub issue dotnet/aspnetcore #23218</a>.</li>
<li><code>UseRequestLocalization</code> must appear before any middleware that might check the request culture, for example, <code>app.UseStaticFiles()</code>.</li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.ratelimiterapplicationbuilderextensions.useratelimiter" class="no-loc" data-linktype="absolute-path">UseRateLimiter</a> must be called after <code>UseRouting</code> when rate limiting endpoint specific APIs are used. For example, if the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.ratelimiting.enableratelimitingattribute" data-linktype="absolute-path"><code>[EnableRateLimiting]</code></a> attribute is used, <code>UseRateLimiter</code> must be called after <code>UseRouting</code>. When calling only global limiters, <code>UseRateLimiter</code> can be called before <code>UseRouting</code>.</li>
</ul>
</li>
</ul>
<p>In some scenarios, middleware has different ordering. For example, caching and compression ordering is scenario specific, and there are multiple valid orderings. For example:</p>
<pre><code class="lang-csharp">app.UseResponseCaching();
app.UseResponseCompression();
</code></pre>
<p>With the preceding code, CPU usage could be reduced by caching the compressed response, but you might end up caching multiple representations of a resource using different compression algorithms such as Gzip or Brotli.</p>
<p>The following ordering combines static files to allow caching compressed static files:</p>
<pre><code class="lang-csharp">app.UseResponseCaching();
app.UseResponseCompression();
app.UseStaticFiles();
</code></pre>
<p>The following <code>Program.cs</code> code adds middleware components for common app scenarios:</p>
<ol>
<li>Exception/error handling
<ul>
<li>When the app runs in the Development environment:
<ul>
<li>Developer Exception Page Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.developerexceptionpageextensions.usedeveloperexceptionpage" class="no-loc" data-linktype="absolute-path">UseDeveloperExceptionPage</a>) reports app runtime errors.</li>
<li>Database Error Page Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.databaseerrorpageextensions.usedatabaseerrorpage" class="no-loc" data-linktype="absolute-path">UseDatabaseErrorPage</a>) reports database runtime errors.</li>
</ul>
</li>
<li>When the app runs in the Production environment:
<ul>
<li>Exception Handler Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" class="no-loc" data-linktype="absolute-path">UseExceptionHandler</a>) catches exceptions thrown in the following middlewares.</li>
<li>HTTP Strict Transport Security Protocol (HSTS) Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.hstsbuilderextensions.usehsts" class="no-loc" data-linktype="absolute-path">UseHsts</a>) adds the <code>Strict-Transport-Security</code> header.</li>
</ul>
</li>
</ul>
</li>
<li>HTTPS Redirection Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.httpspolicybuilderextensions.usehttpsredirection" class="no-loc" data-linktype="absolute-path">UseHttpsRedirection</a>) redirects HTTP requests to HTTPS.</li>
<li>Static File Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.staticfileextensions.usestaticfiles" class="no-loc" data-linktype="absolute-path">UseStaticFiles</a>) returns static files and short-circuits further request processing.</li>
<li>Cookie Policy Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.cookiepolicyappbuilderextensions.usecookiepolicy" class="no-loc" data-linktype="absolute-path">UseCookiePolicy</a>) conforms the app to the EU General Data Protection Regulation (GDPR) regulations.</li>
<li>Routing Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.userouting" class="no-loc" data-linktype="absolute-path">UseRouting</a>) to route requests.</li>
<li>Authentication Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" class="no-loc" data-linktype="absolute-path">UseAuthentication</a>) attempts to authenticate the user before they're allowed access to secure resources.</li>
<li>Authorization Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization" class="no-loc" data-linktype="absolute-path">UseAuthorization</a>) authorizes a user to access secure resources.</li>
<li>Session Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.sessionmiddlewareextensions.usesession" class="no-loc" data-linktype="absolute-path">UseSession</a>) establishes and maintains session state. If the app uses session state, call Session Middleware after Cookie Policy Middleware and before MVC Middleware.</li>
<li>Endpoint Routing Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.useendpoints" class="no-loc" data-linktype="absolute-path">UseEndpoints</a> with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.razorpagesendpointroutebuilderextensions.maprazorpages" class="no-loc" data-linktype="absolute-path">MapRazorPages</a>) to add Razor Pages endpoints to the request pipeline.</li>
</ol>
<pre><code class="lang-csharp">if (env.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
    app.UseDatabaseErrorPage();
}
else
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}
app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseCookiePolicy();
app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();
app.UseSession();
app.MapRazorPages();
</code></pre>
<p>In the preceding example code, each middleware extension method is exposed on <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder" class="no-loc" data-linktype="absolute-path">WebApplicationBuilder</a> through the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder" class="no-loc" data-linktype="absolute-path">Microsoft.AspNetCore.Builder</a> namespace.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" class="no-loc" data-linktype="absolute-path">UseExceptionHandler</a> is the first middleware component added to the pipeline. Therefore, the Exception Handler Middleware catches any exceptions that occur in later calls.</p>
<p>Static File Middleware is called early in the pipeline so that it can handle requests and short-circuit without going through the remaining components. The Static File Middleware provides <strong>no</strong> authorization checks. Any files served by Static File Middleware, including those under <em>wwwroot</em>, are publicly available. For an approach to secure static files, see <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static files in ASP.NET Core</a>.</p>
<p>If the request isn't handled by the Static File Middleware, it's passed on to the Authentication Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" class="no-loc" data-linktype="absolute-path">UseAuthentication</a>), which performs authentication. Authentication doesn't short-circuit unauthenticated requests. Although Authentication Middleware authenticates requests, authorization (and rejection) occurs only after MVC selects a specific Razor Page or MVC controller and action.</p>
<p>The following example demonstrates a middleware order where requests for static files are handled by Static File Middleware before Response Compression Middleware. Static files aren't compressed with this middleware order. The Razor Pages responses can be compressed.</p>
<pre><code class="lang-csharp">// Static files aren't compressed by Static File Middleware.
app.UseStaticFiles();

app.UseRouting();

app.UseResponseCompression();

app.MapRazorPages();
</code></pre>
<p>For information about Single Page Applications, see the guides for the <a href="https://learn.microsoft.com/en-us/aspnet/core/client-side/spa/react?view=aspnetcore-9.0" data-linktype="relative-path">React</a> and <a href="https://learn.microsoft.com/en-us/aspnet/core/client-side/spa/angular?view=aspnetcore-9.0" data-linktype="relative-path">Angular</a> project templates.</p>
<h2 id="usecors-and-usestaticfiles-order">UseCors and UseStaticFiles order</h2>
<p>The order for calling <code>UseCors</code> and <code>UseStaticFiles</code> depends on the app. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0#uc1" data-linktype="relative-path">UseCors and UseStaticFiles order</a></p>
<h3 id="forwarded-headers-middleware-order">Forwarded Headers Middleware order</h3>
<p>Forwarded Headers Middleware should run before other middleware. This ordering ensures that the middleware relying on forwarded headers information can consume the header values for processing. To run Forwarded Headers Middleware after diagnostics and error handling middleware, see <a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-9.0#fhmo" data-linktype="relative-path">Forwarded Headers Middleware order</a>.</p>
<h2 id="branch-the-middleware-pipeline">Branch the middleware pipeline</h2>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" class="no-loc" data-linktype="absolute-path">Map</a> extensions are used as a convention for branching the pipeline. <code>Map</code> branches the request pipeline based on matches of the given request path. If the request path starts with the given path, the branch is executed.</p>
<pre><code class="lang-csharp">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Map("/map1", HandleMapTest1);

app.Map("/map2", HandleMapTest2);

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

static void HandleMapTest1(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        await context.Response.WriteAsync("Map Test 1");
    });
}

static void HandleMapTest2(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        await context.Response.WriteAsync("Map Test 2");
    });
}
</code></pre>
<p>The following table shows the requests and responses from <code>http://localhost:1234</code> using the preceding code.</p>
<table>
<thead>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td>localhost:1234</td>
<td>Hello from non-Map delegate.</td>
</tr>
<tr>
<td>localhost:1234/map1</td>
<td>Map Test 1</td>
</tr>
<tr>
<td>localhost:1234/map2</td>
<td>Map Test 2</td>
</tr>
<tr>
<td>localhost:1234/map3</td>
<td>Hello from non-Map delegate.</td>
</tr>
</tbody>
</table>
<p>When <code>Map</code> is used, the matched path segments are removed from <code>HttpRequest.Path</code> and appended to <code>HttpRequest.PathBase</code> for each request.</p>
<p><code>Map</code> supports nesting, for example:</p>
<pre><code class="lang-csharp">app.Map("/level1", level1App =&gt; {
    level1App.Map("/level2a", level2AApp =&gt; {
        // "/level1/level2a" processing
    });
    level1App.Map("/level2b", level2BApp =&gt; {
        // "/level1/level2b" processing
    });
});
</code></pre>
<p><code>Map</code> can also match multiple segments at once:</p>
<pre><code class="lang-csharp" highlight-lines="4">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Map("/map1/seg1", HandleMultiSeg);

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

static void HandleMultiSeg(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        await context.Response.WriteAsync("Map Test 1");
    });
}
</code></pre>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapwhenextensions.mapwhen" class="no-loc" data-linktype="absolute-path">MapWhen</a> branches the request pipeline based on the result of the given predicate. Any predicate of type <code>Func&lt;HttpContext, bool&gt;</code> can be used to map requests to a new branch of the pipeline. In the following example, a predicate is used to detect the presence of a query string variable <code>branch</code>:</p>
<pre><code class="lang-csharp" highlight-lines="4">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.MapWhen(context =&gt; context.Request.Query.ContainsKey("branch"), HandleBranch);

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

static void HandleBranch(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        var branchVer = context.Request.Query["branch"];
        await context.Response.WriteAsync($"Branch used = {branchVer}");
    });
}
</code></pre>
<p>The following table shows the requests and responses from <code>http://localhost:1234</code> using the previous code:</p>
<table>
<thead>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>localhost:1234</code></td>
<td><code>Hello from non-Map delegate.</code></td>
</tr>
<tr>
<td><code>localhost:1234/?branch=main</code></td>
<td><code>Branch used = main</code></td>
</tr>
</tbody>
</table>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.usewhenextensions.usewhen" class="no-loc" data-linktype="absolute-path">UseWhen</a> also branches the request pipeline based on the result of the given predicate. Unlike with <code>MapWhen</code>, this branch is rejoined to the main pipeline if it doesn't short-circuit or contain a terminal middleware:</p>
<pre><code class="lang-csharp" highlight-lines="4-5">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.UseWhen(context =&gt; context.Request.Query.ContainsKey("branch"),
    appBuilder =&gt; HandleBranchAndRejoin(appBuilder));

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

void HandleBranchAndRejoin(IApplicationBuilder app)
{
    var logger = app.ApplicationServices.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;(); 

    app.Use(async (context, next) =&gt;
    {
        var branchVer = context.Request.Query["branch"];
        logger.LogInformation("Branch used = {branchVer}", branchVer);

        // Do work that doesn't write to the Response.
        await next();
        // Do other work that doesn't write to the Response.
    });
}
</code></pre>
<p>In the preceding example, a response of <code>Hello from non-Map delegate.</code> is written for all requests. If the request includes a query string variable <code>branch</code>, its value is logged before the main pipeline is rejoined.</p>
<h2 id="built-in-middleware">Built-in middleware</h2>
<p>ASP.NET Core ships with the following middleware components. The <em>Order</em> column provides notes on middleware placement in the request processing pipeline and under what conditions the middleware may terminate request processing. When a middleware short-circuits the request processing pipeline and prevents further downstream middleware from processing a request, it's called a <em>terminal middleware</em>. For more information on short-circuiting, see the <a href="#create-a-middleware-pipeline-with-webapplication" data-linktype="self-bookmark">Create a middleware pipeline with WebApplication</a> section.</p>
<table>
<thead>
<tr>
<th>Middleware</th>
<th>Description</th>
<th>Order</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-9.0" data-linktype="relative-path">Authentication</a></td>
<td>Provides authentication support.</td>
<td>Before <code>HttpContext.User</code> is needed. Terminal for OAuth callbacks.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization" data-linktype="absolute-path">Authorization</a></td>
<td>Provides authorization support.</td>
<td>Immediately after the Authentication Middleware.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0" data-linktype="relative-path">Cookie Policy</a></td>
<td>Tracks consent from users for storing personal information and enforces minimum standards for cookie fields, such as <code>secure</code> and <code>SameSite</code>.</td>
<td>Before middleware that issues cookies. Examples: Authentication, Session, MVC (TempData).</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0" data-linktype="relative-path">CORS</a></td>
<td>Configures Cross-Origin Resource Sharing.</td>
<td>Before components that use CORS. <code>UseCors</code> currently must go before <code>UseResponseCaching</code> due to <a href="https://github.com/dotnet/aspnetcore/issues/23218" data-linktype="external">this bug</a>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.diagnostics.developerexceptionpagemiddleware" data-linktype="absolute-path">DeveloperExceptionPage</a></td>
<td>Generates a page with error information that is intended for use only in the Development environment.</td>
<td>Before components that generate errors. The project templates automatically register this middleware as the first middleware in the pipeline when the environment is Development.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/error-handling?view=aspnetcore-9.0" data-linktype="relative-path">Diagnostics</a></td>
<td>Several separate middlewares that provide a developer exception page, exception handling, status code pages, and the default web page for new apps.</td>
<td>Before components that generate errors. Terminal for exceptions or serving the default web page for new apps.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-9.0" data-linktype="relative-path">Forwarded Headers</a></td>
<td>Forwards proxied headers onto the current request.</td>
<td>Before components that consume the updated fields. Examples: scheme, host, client IP, method.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-9.0" data-linktype="relative-path">Health Check</a></td>
<td>Checks the health of an ASP.NET Core app and its dependencies, such as checking database availability.</td>
<td>Terminal if a request matches a health check endpoint.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-requests?view=aspnetcore-9.0#header-propagation-middleware" data-linktype="relative-path">Header Propagation</a></td>
<td>Propagates HTTP headers from the incoming request to the outgoing HTTP Client requests.</td>
<td></td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-logging/?view=aspnetcore-9.0" data-linktype="relative-path">HTTP Logging</a></td>
<td>Logs HTTP Requests and Responses.</td>
<td>At the beginning of the middleware pipeline.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.httpmethodoverrideextensions" data-linktype="absolute-path">HTTP Method Override</a></td>
<td>Allows an incoming POST request to override the method.</td>
<td>Before components that consume the updated method.</td>
</tr>
<tr>
<td><a href="../../security/enforcing-ssl553c.html?view=aspnetcore-9.0#require-https" data-linktype="relative-path">HTTPS Redirection</a></td>
<td>Redirect all HTTP requests to HTTPS.</td>
<td>Before components that consume the URL.</td>
</tr>
<tr>
<td><a href="../../security/enforcing-ssl553c.html?view=aspnetcore-9.0#http-strict-transport-security-protocol-hsts" data-linktype="relative-path">HTTP Strict Transport Security (HSTS)</a></td>
<td>Security enhancement middleware that adds a special response header.</td>
<td>Before responses are sent and after components that modify requests. Examples: Forwarded Headers, URL Rewriting.</td>
</tr>
<tr>
<td><a href="../../mvc/overview553c.html?view=aspnetcore-9.0" data-linktype="relative-path">MVC</a></td>
<td>Processes requests with MVC/Razor Pages.</td>
<td>Terminal if a request matches a route.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/owin?view=aspnetcore-9.0" data-linktype="relative-path">OWIN</a></td>
<td>Interop with OWIN-based apps, servers, and middleware.</td>
<td>Terminal if the OWIN Middleware fully processes the request.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/output?view=aspnetcore-9.0" data-linktype="relative-path">Output Caching</a></td>
<td>Provides support for caching responses based on configuration.</td>
<td>Before components that require caching. <code>UseRouting</code> must come before <code>UseOutputCaching</code>. <code>UseCORS</code> must come before <code>UseOutputCaching</code>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/middleware?view=aspnetcore-9.0" data-linktype="relative-path">Response Caching</a></td>
<td>Provides support for caching responses. This requires client participation to work. Use output caching for complete server control.</td>
<td>Before components that require caching. <code>UseCORS</code> must come before <code>UseResponseCaching</code>. Is typically not beneficial for UI apps such as Razor Pages because browsers generally set request headers that prevent caching. <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/output?view=aspnetcore-9.0" data-linktype="relative-path">Output caching</a> benefits UI apps.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/request-decompression?view=aspnetcore-9.0" data-linktype="relative-path">Request Decompression</a></td>
<td>Provides support for decompressing requests.</td>
<td>Before components that read the request body.</td>
</tr>
<tr>
<td><a href="../../performance/response-compression553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Response Compression</a></td>
<td>Provides support for compressing responses.</td>
<td>Before components that require compression.</td>
</tr>
<tr>
<td><a href="../localization553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Request Localization</a></td>
<td>Provides localization support.</td>
<td>Before localization sensitive components. Must appear after Routing Middleware when using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.localization.routing.routedatarequestcultureprovider" class="no-loc" data-linktype="absolute-path">RouteDataRequestCultureProvider</a>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-9.0" data-linktype="relative-path">Endpoint Routing</a></td>
<td>Defines and constrains request routes.</td>
<td>Terminal for matching routes.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.spaapplicationbuilderextensions.usespa" data-linktype="absolute-path">SPA</a></td>
<td>Handles all requests from this point in the middleware chain by returning the default page for the Single Page Application (SPA)</td>
<td>Late in the chain, so that other middleware for serving static files, MVC actions, etc., takes precedence.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/app-state?view=aspnetcore-9.0" data-linktype="relative-path">Session</a></td>
<td>Provides support for managing user sessions.</td>
<td>Before components that require Session.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static Files</a></td>
<td>Provides support for serving static files and directory browsing.</td>
<td>Terminal if a request matches a file.</td>
</tr>
<tr>
<td><a href="../url-rewriting553c.html?view=aspnetcore-9.0" data-linktype="relative-path">URL Rewrite</a></td>
<td>Provides support for rewriting URLs and redirecting requests.</td>
<td>Before components that consume the URL.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/w3c-logger/?view=aspnetcore-9.0" data-linktype="relative-path">W3CLogging</a></td>
<td>Generates server access logs in the <a href="https://www.w3.org/TR/WD-logfile.html" data-linktype="external">W3C Extended Log File Format</a>.</td>
<td>At the beginning of the middleware pipeline.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/websockets?view=aspnetcore-9.0" data-linktype="relative-path">WebSockets</a></td>
<td>Enables the WebSockets protocol.</td>
<td>Before components that are required to accept WebSocket requests.</td>
</tr>
</tbody>
</table>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-9.0#lifetime-and-registration-options" data-linktype="relative-path">Lifetime and registration options</a> contains a complete sample of middleware with <em>scoped</em>, <em>transient</em>, and <em>singleton</em> lifetime services.</li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write?view=aspnetcore-9.0" data-linktype="relative-path">Write custom ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/test/middleware?view=aspnetcore-9.0" data-linktype="relative-path">Test ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/grpc/browser?view=aspnetcore-9.0#configure-grpc-web-in-aspnet-core" data-linktype="relative-path">Configure gRPC-Web in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/migration/fx-to-core/areas/http-modules?view=aspnetcore-9.0" data-linktype="relative-path">Migrate HTTP modules to ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup?view=aspnetcore-9.0" data-linktype="relative-path">App startup in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/request-features?view=aspnetcore-9.0" data-linktype="relative-path">Request Features in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/extensibility?view=aspnetcore-9.0" data-linktype="relative-path">Factory-based middleware activation in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/extensibility-third-party-container?view=aspnetcore-9.0" data-linktype="relative-path">Middleware activation with a third-party container in ASP.NET Core</a></li>
</ul>
</div>
<div data-moniker="aspnetcore-6.0">
<p>By <a href="https://twitter.com/RickAndMSFT" data-linktype="external">Rick Anderson</a> and <a href="https://ardalis.com/" data-linktype="external">Steve Smith</a></p>
<p>Middleware is software that's assembled into an app pipeline to handle requests and responses. Each component:</p>
<ul>
<li>Chooses whether to pass the request to the next component in the pipeline.</li>
<li>Can perform work before and after the next component in the pipeline.</li>
</ul>
<p>Request delegates are used to build the request pipeline. The request delegates handle each HTTP request.</p>
<p>Request delegates are configured using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.runextensions.run" class="no-loc" data-linktype="absolute-path">Run</a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" class="no-loc" data-linktype="absolute-path">Map</a>, and <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" class="no-loc" data-linktype="absolute-path">Use</a> extension methods. An individual request delegate can be specified in-line as an anonymous method (called in-line middleware), or it can be defined in a reusable class. These reusable classes and in-line anonymous methods are <em>middleware</em>, also called <em>middleware components</em>. Each middleware component in the request pipeline is responsible for invoking the next component in the pipeline or short-circuiting the pipeline. When a middleware short-circuits, it's called a <em>terminal middleware</em> because it prevents further middleware from processing the request.</p>
<p><a href="https://learn.microsoft.com/en-us/aspnet/core/migration/fx-to-core/areas/http-modules?view=aspnetcore-9.0" data-linktype="relative-path">Migrate HTTP modules to ASP.NET Core middleware</a> explains the difference between request pipelines in ASP.NET Core and ASP.NET 4.x and provides additional middleware samples.</p>
<h2 id="middleware-code-analysis-1">Middleware code analysis</h2>
<p>ASP.NET Core includes many compiler platform analyzers that inspect application code for quality. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/diagnostics/code-analysis?view=aspnetcore-9.0" data-linktype="relative-path">Code analysis in ASP.NET Core apps</a></p>
<h2 id="create-a-middleware-pipeline-with-webapplication-1">Create a middleware pipeline with <code>WebApplication</code></h2>
<p>The ASP.NET Core request pipeline consists of a sequence of request delegates, called one after the other. The following diagram demonstrates the concept. The thread of execution follows the black arrows.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/request-delegate-pipeline.png?view=aspnetcore-9.0" alt="Request processing pattern showing a request arriving, processing through three middlewares, and the response leaving the app. Each middleware runs its logic and hands off the request to the next middleware at the next() statement. After the third middleware processes the request, the request passes back through the prior two middlewares in reverse order for additional processing after their next() statements before leaving the app as a response to the client." data-linktype="relative-path"></p>
<p>Each delegate can perform operations before and after the next delegate. Exception-handling delegates should be called early in the pipeline, so they can catch exceptions that occur in later stages of the pipeline.</p>
<p>The simplest possible ASP.NET Core app sets up a single request delegate that handles all requests. This case doesn't include an actual request pipeline. Instead, a single anonymous function is called in response to every HTTP request.</p>
<pre><code class="lang-csharp">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello world!");
});

app.Run();
</code></pre>
<p>Chain multiple request delegates together with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" class="no-loc" data-linktype="absolute-path">Use</a>. The <code>next</code> parameter represents the next delegate in the pipeline. You can short-circuit the pipeline by <em>not</em> calling the <code>next</code> parameter. You can typically perform actions both before and after the <code>next</code> delegate, as the following example demonstrates:</p>
<pre><code class="lang-csharp" highlight-lines="4-9">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Use(async (context, next) =&gt;
{
    // Do work that can write to the Response.
    await next.Invoke();
    // Do logging or other work that doesn't write to the Response.
});

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from 2nd delegate.");
});

app.Run();
</code></pre>
<p>When a delegate doesn't pass a request to the next delegate, it's called <em>short-circuiting the request pipeline</em>. Short-circuiting is often desirable because it avoids unnecessary work. For example, <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static File Middleware</a> can act as a <em>terminal middleware</em> by processing a request for a static file and short-circuiting the rest of the pipeline. Middleware added to the pipeline before the middleware that terminates further processing still processes code after their <code>next.Invoke</code> statements. However, see the following warning about attempting to write to a response that has already been sent.</p>
<div class="WARNING">
<p>Warning</p>
<p>Don't call <code>next.Invoke</code> after the response has been sent to the client. Changes to <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpresponse" class="no-loc" data-linktype="absolute-path">HttpResponse</a> after the response has started throw an exception. For example, <a href="../best-practices553c.html?view=aspnetcore-9.0#do-not-modify-the-status-code-or-headers-after-the-response-body-has-started" data-linktype="relative-path">setting headers and a status code throw an exception</a>. Writing to the response body after calling <code>next</code>:</p>
<ul>
<li>May cause a protocol violation. For example, writing more than the stated <code>Content-Length</code>.</li>
<li>May corrupt the body format. For example, writing an HTML footer to a CSS file.</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpresponse.hasstarted" class="no-loc" data-linktype="absolute-path">HasStarted</a> is a useful hint to indicate if headers have been sent or the body has been written to.</p>
</div>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.runextensions.run" class="no-loc" data-linktype="absolute-path">Run</a> delegates don't receive a <code>next</code> parameter. The first <code>Run</code> delegate is always terminal and terminates the pipeline. <code>Run</code> is a convention. Some middleware components may expose <code>Run[Middleware]</code> methods that run at the end of the pipeline:</p>
<pre><code class="lang-csharp" highlight-lines="11-14">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Use(async (context, next) =&gt;
{
    // Do work that can write to the Response.
    await next.Invoke();
    // Do logging or other work that doesn't write to the Response.
});

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from 2nd delegate.");
});

app.Run();
</code></pre><p>If you would like to see code comments translated to languages other than English, let us know in <a href="https://github.com/MicrosoftDocs/feedback/issues/2515" data-linktype="external">this GitHub discussion issue</a>.</p>
<p>In the preceding example, the <code>Run</code> delegate writes <code>"Hello from 2nd delegate."</code> to the response and then terminates the pipeline. If another <code>Use</code> or <code>Run</code> delegate is added after the <code>Run</code> delegate, it's not called.</p>
<h3 id="prefer-appuse-overload-that-requires-passing-the-context-to-next-1">Prefer app.Use overload that requires passing the context to next</h3>
<!-- TODO, a minimum, provide a sample usage. Better, use this overload in the 6.0 version -->
<p>The non-allocating <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder.use" data-linktype="absolute-path">app.Use</a> extension method:</p>
<ul>
<li>Requires passing the context to <code>next</code>.</li>
<li>Saves two internal per-request allocations that are required when using the other overload.</li>
</ul>
<p>For more information, see <a href="https://github.com/dotnet/aspnetcore/pull/31784" data-linktype="external">this GitHub issue</a>.</p>
<p><a name="order"></a></p>
<h2 id="middleware-order-1">Middleware order</h2>
<p>The following diagram shows the complete request processing pipeline for ASP.NET Core MVC and Razor Pages apps. You can see how, in a typical app, existing middlewares are ordered and where custom middlewares are added. You have full control over how to reorder existing middlewares or inject new custom middlewares as necessary for your scenarios.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/middleware-pipeline.svg?view=aspnetcore-9.0" alt="ASP.NET Core middleware pipeline" data-linktype="relative-path"></p>
<p>The <strong>Endpoint</strong> middleware in the preceding diagram executes the filter pipeline for the corresponding app type—MVC or Razor Pages.</p>
<p>The <strong>Routing</strong> middleware in the preceding diagram is shown following <strong>Static Files</strong>. This is the order that the project templates implement by explicitly calling <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.userouting" data-linktype="absolute-path">app.UseRouting</a>. If you don't call <code>app.UseRouting</code>, the <strong>Routing</strong> middleware runs at the beginning of the pipeline by default. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-9.0" data-linktype="relative-path">Routing</a>.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/mvc-endpoint.svg?view=aspnetcore-9.0" alt="ASP.NET Core filter pipeline" data-linktype="relative-path"></p>
<p>The order that middleware components are added in the <code>Program.cs</code> file defines the order in which the middleware components are invoked on requests and the reverse order for the response. The order is <strong>critical</strong> for security, performance, and functionality.</p>
<p>The following highlighted code in <code>Program.cs</code> adds security-related middleware components in the typical recommended order:</p>
<pre><code class="lang-csharp" highlight-lines="19-43">using IndividualAccountsExample.Data;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");
builder.Services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;
    options.UseSqlServer(connectionString));
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

builder.Services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true)
    .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();
builder.Services.AddRazorPages();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseMigrationsEndPoint();
}
else
{
    app.UseExceptionHandler("/Error");
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();
// app.UseCookiePolicy();

app.UseRouting();
// app.UseRequestLocalization();
// app.UseCors();

app.UseAuthentication();
app.UseAuthorization();
// app.UseSession();
// app.UseResponseCompression();
// app.UseResponseCaching();

app.MapRazorPages();
app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}");

app.Run();
</code></pre>
<p>In the preceding code:</p>
<ul>
<li>Middleware that is not added when creating a new web app with <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-9.0" data-linktype="relative-path">individual users accounts</a> is commented out.</li>
<li>Not every middleware appears in this exact order, but many do. For example:
<ul>
<li><code>UseCors</code>, <code>UseAuthentication</code>, and <code>UseAuthorization</code> must appear in the order shown.</li>
<li><code>UseCors</code> currently must appear before <code>UseResponseCaching</code>. This requirement is explained in <a href="https://github.com/dotnet/aspnetcore/issues/23218" data-linktype="external">GitHub issue dotnet/aspnetcore #23218</a>.</li>
<li><code>UseRequestLocalization</code> must appear before any middleware that might check the request culture (for example, <code>app.UseMvcWithDefaultRoute()</code>).</li>
</ul>
</li>
</ul>
<p>In some scenarios, middleware has different ordering. For example, caching and compression ordering is scenario specific, and there are multiple valid orderings. For example:</p>
<pre><code class="lang-csharp">app.UseResponseCaching();
app.UseResponseCompression();
</code></pre>
<p>With the preceding code, CPU usage could be reduced by caching the compressed response, but you might end up caching multiple representations of a resource using different compression algorithms such as Gzip or Brotli.</p>
<p>The following ordering combines static files to allow caching compressed static files:</p>
<pre><code class="lang-csharp">app.UseResponseCaching();
app.UseResponseCompression();
app.UseStaticFiles();
</code></pre>
<p>The following <code>Program.cs</code> code adds middleware components for common app scenarios:</p>
<ol>
<li>Exception/error handling
<ul>
<li>When the app runs in the Development environment:
<ul>
<li>Developer Exception Page Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.developerexceptionpageextensions.usedeveloperexceptionpage" class="no-loc" data-linktype="absolute-path">UseDeveloperExceptionPage</a>) reports app runtime errors.</li>
<li>Database Error Page Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.databaseerrorpageextensions.usedatabaseerrorpage" class="no-loc" data-linktype="absolute-path">UseDatabaseErrorPage</a>) reports database runtime errors.</li>
</ul>
</li>
<li>When the app runs in the Production environment:
<ul>
<li>Exception Handler Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" class="no-loc" data-linktype="absolute-path">UseExceptionHandler</a>) catches exceptions thrown in the following middlewares.</li>
<li>HTTP Strict Transport Security Protocol (HSTS) Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.hstsbuilderextensions.usehsts" class="no-loc" data-linktype="absolute-path">UseHsts</a>) adds the <code>Strict-Transport-Security</code> header.</li>
</ul>
</li>
</ul>
</li>
<li>HTTPS Redirection Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.httpspolicybuilderextensions.usehttpsredirection" class="no-loc" data-linktype="absolute-path">UseHttpsRedirection</a>) redirects HTTP requests to HTTPS.</li>
<li>Static File Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.staticfileextensions.usestaticfiles" class="no-loc" data-linktype="absolute-path">UseStaticFiles</a>) returns static files and short-circuits further request processing.</li>
<li>Cookie Policy Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.cookiepolicyappbuilderextensions.usecookiepolicy" class="no-loc" data-linktype="absolute-path">UseCookiePolicy</a>) conforms the app to the EU General Data Protection Regulation (GDPR) regulations.</li>
<li>Routing Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.userouting" class="no-loc" data-linktype="absolute-path">UseRouting</a>) to route requests.</li>
<li>Authentication Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" class="no-loc" data-linktype="absolute-path">UseAuthentication</a>) attempts to authenticate the user before they're allowed access to secure resources.</li>
<li>Authorization Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization" class="no-loc" data-linktype="absolute-path">UseAuthorization</a>) authorizes a user to access secure resources.</li>
<li>Session Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.sessionmiddlewareextensions.usesession" class="no-loc" data-linktype="absolute-path">UseSession</a>) establishes and maintains session state. If the app uses session state, call Session Middleware after Cookie Policy Middleware and before MVC Middleware.</li>
<li>Endpoint Routing Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.useendpoints" class="no-loc" data-linktype="absolute-path">UseEndpoints</a> with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.razorpagesendpointroutebuilderextensions.maprazorpages" class="no-loc" data-linktype="absolute-path">MapRazorPages</a>) to add Razor Pages endpoints to the request pipeline.</li>
</ol>
<pre><code class="lang-csharp">if (env.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
    app.UseDatabaseErrorPage();
}
else
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}
app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseCookiePolicy();
app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();
app.UseSession();
app.MapRazorPages();
</code></pre>
<p>In the preceding example code, each middleware extension method is exposed on <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder" class="no-loc" data-linktype="absolute-path">WebApplicationBuilder</a> through the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder" class="no-loc" data-linktype="absolute-path">Microsoft.AspNetCore.Builder</a> namespace.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" class="no-loc" data-linktype="absolute-path">UseExceptionHandler</a> is the first middleware component added to the pipeline. Therefore, the Exception Handler Middleware catches any exceptions that occur in later calls.</p>
<p>Static File Middleware is called early in the pipeline so that it can handle requests and short-circuit without going through the remaining components. The Static File Middleware provides <strong>no</strong> authorization checks. Any files served by Static File Middleware, including those under <em>wwwroot</em>, are publicly available. For an approach to secure static files, see <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static files in ASP.NET Core</a>.</p>
<p>If the request isn't handled by the Static File Middleware, it's passed on to the Authentication Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" class="no-loc" data-linktype="absolute-path">UseAuthentication</a>), which performs authentication. Authentication doesn't short-circuit unauthenticated requests. Although Authentication Middleware authenticates requests, authorization (and rejection) occurs only after MVC selects a specific Razor Page or MVC controller and action.</p>
<p>The following example demonstrates a middleware order where requests for static files are handled by Static File Middleware before Response Compression Middleware. Static files aren't compressed with this middleware order. The Razor Pages responses can be compressed.</p>
<pre><code class="lang-csharp">// Static files aren't compressed by Static File Middleware.
app.UseStaticFiles();

app.UseRouting();

app.UseResponseCompression();

app.MapRazorPages();
</code></pre>
<p>For information about Single Page Applications, see the guides for the <a href="https://learn.microsoft.com/en-us/aspnet/core/client-side/spa/react?view=aspnetcore-9.0" data-linktype="relative-path">React</a> and <a href="https://learn.microsoft.com/en-us/aspnet/core/client-side/spa/angular?view=aspnetcore-9.0" data-linktype="relative-path">Angular</a> project templates.</p>
<h2 id="usecors-and-usestaticfiles-order-1">UseCors and UseStaticFiles order</h2>
<p>The order for calling <code>UseCors</code> and <code>UseStaticFiles</code> depends on the app. For more information, see <a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0#uc1" data-linktype="relative-path">UseCors and UseStaticFiles order</a></p>
<h3 id="forwarded-headers-middleware-order-1">Forwarded Headers Middleware order</h3>
<p>Forwarded Headers Middleware should run before other middleware. This ordering ensures that the middleware relying on forwarded headers information can consume the header values for processing. To run Forwarded Headers Middleware after diagnostics and error handling middleware, see <a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-9.0#fhmo" data-linktype="relative-path">Forwarded Headers Middleware order</a>.</p>
<h2 id="branch-the-middleware-pipeline-1">Branch the middleware pipeline</h2>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" class="no-loc" data-linktype="absolute-path">Map</a> extensions are used as a convention for branching the pipeline. <code>Map</code> branches the request pipeline based on matches of the given request path. If the request path starts with the given path, the branch is executed.</p>
<pre><code class="lang-csharp">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Map("/map1", HandleMapTest1);

app.Map("/map2", HandleMapTest2);

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

static void HandleMapTest1(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        await context.Response.WriteAsync("Map Test 1");
    });
}

static void HandleMapTest2(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        await context.Response.WriteAsync("Map Test 2");
    });
}
</code></pre>
<p>The following table shows the requests and responses from <code>http://localhost:1234</code> using the preceding code.</p>
<table>
<thead>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td>localhost:1234</td>
<td>Hello from non-Map delegate.</td>
</tr>
<tr>
<td>localhost:1234/map1</td>
<td>Map Test 1</td>
</tr>
<tr>
<td>localhost:1234/map2</td>
<td>Map Test 2</td>
</tr>
<tr>
<td>localhost:1234/map3</td>
<td>Hello from non-Map delegate.</td>
</tr>
</tbody>
</table>
<p>When <code>Map</code> is used, the matched path segments are removed from <code>HttpRequest.Path</code> and appended to <code>HttpRequest.PathBase</code> for each request.</p>
<p><code>Map</code> supports nesting, for example:</p>
<pre><code class="lang-csharp">app.Map("/level1", level1App =&gt; {
    level1App.Map("/level2a", level2AApp =&gt; {
        // "/level1/level2a" processing
    });
    level1App.Map("/level2b", level2BApp =&gt; {
        // "/level1/level2b" processing
    });
});
</code></pre>
<p><code>Map</code> can also match multiple segments at once:</p>
<pre><code class="lang-csharp" highlight-lines="4">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Map("/map1/seg1", HandleMultiSeg);

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

static void HandleMultiSeg(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        await context.Response.WriteAsync("Map Test 1");
    });
}
</code></pre>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapwhenextensions.mapwhen" class="no-loc" data-linktype="absolute-path">MapWhen</a> branches the request pipeline based on the result of the given predicate. Any predicate of type <code>Func&lt;HttpContext, bool&gt;</code> can be used to map requests to a new branch of the pipeline. In the following example, a predicate is used to detect the presence of a query string variable <code>branch</code>:</p>
<pre><code class="lang-csharp" highlight-lines="4">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.MapWhen(context =&gt; context.Request.Query.ContainsKey("branch"), HandleBranch);

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

static void HandleBranch(IApplicationBuilder app)
{
    app.Run(async context =&gt;
    {
        var branchVer = context.Request.Query["branch"];
        await context.Response.WriteAsync($"Branch used = {branchVer}");
    });
}
</code></pre>
<p>The following table shows the requests and responses from <code>http://localhost:1234</code> using the previous code:</p>
<table>
<thead>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>localhost:1234</code></td>
<td><code>Hello from non-Map delegate.</code></td>
</tr>
<tr>
<td><code>localhost:1234/?branch=main</code></td>
<td><code>Branch used = main</code></td>
</tr>
</tbody>
</table>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.usewhenextensions.usewhen" class="no-loc" data-linktype="absolute-path">UseWhen</a> also branches the request pipeline based on the result of the given predicate. Unlike with <code>MapWhen</code>, this branch is rejoined to the main pipeline if it doesn't short-circuit or contain a terminal middleware:</p>
<pre><code class="lang-csharp" highlight-lines="4-5">var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.UseWhen(context =&gt; context.Request.Query.ContainsKey("branch"),
    appBuilder =&gt; HandleBranchAndRejoin(appBuilder));

app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello from non-Map delegate.");
});

app.Run();

void HandleBranchAndRejoin(IApplicationBuilder app)
{
    var logger = app.ApplicationServices.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;(); 

    app.Use(async (context, next) =&gt;
    {
        var branchVer = context.Request.Query["branch"];
        logger.LogInformation("Branch used = {branchVer}", branchVer);

        // Do work that doesn't write to the Response.
        await next();
        // Do other work that doesn't write to the Response.
    });
}
</code></pre>
<p>In the preceding example, a response of <code>Hello from non-Map delegate.</code> is written for all requests. If the request includes a query string variable <code>branch</code>, its value is logged before the main pipeline is rejoined.</p>
<h2 id="built-in-middleware-1">Built-in middleware</h2>
<p>ASP.NET Core ships with the following middleware components. The <em>Order</em> column provides notes on middleware placement in the request processing pipeline and under what conditions the middleware may terminate request processing. When a middleware short-circuits the request processing pipeline and prevents further downstream middleware from processing a request, it's called a <em>terminal middleware</em>. For more information on short-circuiting, see the <a href="#create-a-middleware-pipeline-with-webapplication" data-linktype="self-bookmark">Create a middleware pipeline with WebApplication</a> section.</p>
<table>
<thead>
<tr>
<th>Middleware</th>
<th>Description</th>
<th>Order</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-9.0" data-linktype="relative-path">Authentication</a></td>
<td>Provides authentication support.</td>
<td>Before <code>HttpContext.User</code> is needed. Terminal for OAuth callbacks.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization" data-linktype="absolute-path">Authorization</a></td>
<td>Provides authorization support.</td>
<td>Immediately after the Authentication Middleware.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0" data-linktype="relative-path">Cookie Policy</a></td>
<td>Tracks consent from users for storing personal information and enforces minimum standards for cookie fields, such as <code>secure</code> and <code>SameSite</code>.</td>
<td>Before middleware that issues cookies. Examples: Authentication, Session, MVC (TempData).</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0" data-linktype="relative-path">CORS</a></td>
<td>Configures Cross-Origin Resource Sharing.</td>
<td>Before components that use CORS. <code>UseCors</code> currently must go before <code>UseResponseCaching</code> due to <a href="https://github.com/dotnet/aspnetcore/issues/23218" data-linktype="external">this bug</a>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.diagnostics.developerexceptionpagemiddleware" data-linktype="absolute-path">DeveloperExceptionPage</a></td>
<td>Generates a page with error information that is intended for use only in the Development environment.</td>
<td>Before components that generate errors. The project templates automatically register this middleware as the first middleware in the pipeline when the environment is Development.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/error-handling?view=aspnetcore-9.0" data-linktype="relative-path">Diagnostics</a></td>
<td>Several separate middlewares that provide a developer exception page, exception handling, status code pages, and the default web page for new apps.</td>
<td>Before components that generate errors. Terminal for exceptions or serving the default web page for new apps.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-9.0" data-linktype="relative-path">Forwarded Headers</a></td>
<td>Forwards proxied headers onto the current request.</td>
<td>Before components that consume the updated fields. Examples: scheme, host, client IP, method.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-9.0" data-linktype="relative-path">Health Check</a></td>
<td>Checks the health of an ASP.NET Core app and its dependencies, such as checking database availability.</td>
<td>Terminal if a request matches a health check endpoint.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-requests?view=aspnetcore-9.0#header-propagation-middleware" data-linktype="relative-path">Header Propagation</a></td>
<td>Propagates HTTP headers from the incoming request to the outgoing HTTP Client requests.</td>
<td></td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-logging/?view=aspnetcore-9.0" data-linktype="relative-path">HTTP Logging</a></td>
<td>Logs HTTP Requests and Responses.</td>
<td>At the beginning of the middleware pipeline.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.httpmethodoverrideextensions" data-linktype="absolute-path">HTTP Method Override</a></td>
<td>Allows an incoming POST request to override the method.</td>
<td>Before components that consume the updated method.</td>
</tr>
<tr>
<td><a href="../../security/enforcing-ssl553c.html?view=aspnetcore-9.0#require-https" data-linktype="relative-path">HTTPS Redirection</a></td>
<td>Redirect all HTTP requests to HTTPS.</td>
<td>Before components that consume the URL.</td>
</tr>
<tr>
<td><a href="../../security/enforcing-ssl553c.html?view=aspnetcore-9.0#http-strict-transport-security-protocol-hsts" data-linktype="relative-path">HTTP Strict Transport Security (HSTS)</a></td>
<td>Security enhancement middleware that adds a special response header.</td>
<td>Before responses are sent and after components that modify requests. Examples: Forwarded Headers, URL Rewriting.</td>
</tr>
<tr>
<td><a href="../../mvc/overview553c.html?view=aspnetcore-9.0" data-linktype="relative-path">MVC</a></td>
<td>Processes requests with MVC/Razor Pages.</td>
<td>Terminal if a request matches a route.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/owin?view=aspnetcore-9.0" data-linktype="relative-path">OWIN</a></td>
<td>Interop with OWIN-based apps, servers, and middleware.</td>
<td>Terminal if the OWIN Middleware fully processes the request.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/request-decompression?view=aspnetcore-9.0" data-linktype="relative-path">Request Decompression</a></td>
<td>Provides support for decompressing requests.</td>
<td>Before components that read the request body.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/middleware?view=aspnetcore-9.0" data-linktype="relative-path">Response Caching</a></td>
<td>Provides support for caching responses.</td>
<td>Before components that require caching. <code>UseCORS</code> must come before <code>UseResponseCaching</code>.</td>
</tr>
<tr>
<td><a href="../../performance/response-compression553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Response Compression</a></td>
<td>Provides support for compressing responses.</td>
<td>Before components that require compression.</td>
</tr>
<tr>
<td><a href="../localization553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Request Localization</a></td>
<td>Provides localization support.</td>
<td>Before localization sensitive components. Must appear after Routing Middleware when using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.localization.routing.routedatarequestcultureprovider" class="no-loc" data-linktype="absolute-path">RouteDataRequestCultureProvider</a>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-9.0" data-linktype="relative-path">Endpoint Routing</a></td>
<td>Defines and constrains request routes.</td>
<td>Terminal for matching routes.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.spaapplicationbuilderextensions.usespa" data-linktype="absolute-path">SPA</a></td>
<td>Handles all requests from this point in the middleware chain by returning the default page for the Single Page Application (SPA)</td>
<td>Late in the chain, so that other middleware for serving static files, MVC actions, etc., takes precedence.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/app-state?view=aspnetcore-9.0" data-linktype="relative-path">Session</a></td>
<td>Provides support for managing user sessions.</td>
<td>Before components that require Session.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static Files</a></td>
<td>Provides support for serving static files and directory browsing.</td>
<td>Terminal if a request matches a file.</td>
</tr>
<tr>
<td><a href="../url-rewriting553c.html?view=aspnetcore-9.0" data-linktype="relative-path">URL Rewrite</a></td>
<td>Provides support for rewriting URLs and redirecting requests.</td>
<td>Before components that consume the URL.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/w3c-logger/?view=aspnetcore-9.0" data-linktype="relative-path">W3CLogging</a></td>
<td>Generates server access logs in the <a href="https://www.w3.org/TR/WD-logfile.html" data-linktype="external">W3C Extended Log File Format</a>.</td>
<td>At the beginning of the middleware pipeline.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/websockets?view=aspnetcore-9.0" data-linktype="relative-path">WebSockets</a></td>
<td>Enables the WebSockets protocol.</td>
<td>Before components that are required to accept WebSocket requests.</td>
</tr>
</tbody>
</table>
<h2 id="additional-resources-1">Additional resources</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-9.0#lifetime-and-registration-options" data-linktype="relative-path">Lifetime and registration options</a> contains a complete sample of middleware with <em>scoped</em>, <em>transient</em>, and <em>singleton</em> lifetime services.</li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write?view=aspnetcore-9.0" data-linktype="relative-path">Write custom ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/test/middleware?view=aspnetcore-9.0" data-linktype="relative-path">Test ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/grpc/browser?view=aspnetcore-9.0#configure-grpc-web-in-aspnet-core" data-linktype="relative-path">Configure gRPC-Web in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/migration/fx-to-core/areas/http-modules?view=aspnetcore-9.0" data-linktype="relative-path">Migrate HTTP modules to ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup?view=aspnetcore-9.0" data-linktype="relative-path">App startup in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/request-features?view=aspnetcore-9.0" data-linktype="relative-path">Request Features in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/extensibility?view=aspnetcore-9.0" data-linktype="relative-path">Factory-based middleware activation in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/extensibility-third-party-container?view=aspnetcore-9.0" data-linktype="relative-path">Middleware activation with a third-party container in ASP.NET Core</a></li>
</ul>
</div>
<div data-moniker="aspnetcore-3.0 aspnetcore-3.1 aspnetcore-5.0">
<p>By <a href="https://twitter.com/RickAndMSFT" data-linktype="external">Rick Anderson</a> and <a href="https://ardalis.com/" data-linktype="external">Steve Smith</a></p>
<p>Middleware is software that's assembled into an app pipeline to handle requests and responses. Each component:</p>
<ul>
<li>Chooses whether to pass the request to the next component in the pipeline.</li>
<li>Can perform work before and after the next component in the pipeline.</li>
</ul>
<p>Request delegates are used to build the request pipeline. The request delegates handle each HTTP request.</p>
<p>Request delegates are configured using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.runextensions.run" class="no-loc" data-linktype="absolute-path">Run</a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" class="no-loc" data-linktype="absolute-path">Map</a>, and <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" class="no-loc" data-linktype="absolute-path">Use</a> extension methods. An individual request delegate can be specified in-line as an anonymous method (called in-line middleware), or it can be defined in a reusable class. These reusable classes and in-line anonymous methods are <em>middleware</em>, also called <em>middleware components</em>. Each middleware component in the request pipeline is responsible for invoking the next component in the pipeline or short-circuiting the pipeline. When a middleware short-circuits, it's called a <em>terminal middleware</em> because it prevents further middleware from processing the request.</p>
<p><a href="https://learn.microsoft.com/en-us/aspnet/core/migration/fx-to-core/areas/http-modules?view=aspnetcore-9.0" data-linktype="relative-path">Migrate HTTP modules to ASP.NET Core middleware</a> explains the difference between request pipelines in ASP.NET Core and ASP.NET 4.x and provides additional middleware samples.</p>
<h2 id="create-a-middleware-pipeline-with-iapplicationbuilder">Create a middleware pipeline with IApplicationBuilder</h2>
<p>The ASP.NET Core request pipeline consists of a sequence of request delegates, called one after the other. The following diagram demonstrates the concept. The thread of execution follows the black arrows.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/request-delegate-pipeline.png?view=aspnetcore-9.0" alt="Request processing pattern showing a request arriving, processing through three middlewares, and the response leaving the app. Each middleware runs its logic and hands off the request to the next middleware at the next() statement. After the third middleware processes the request, the request passes back through the prior two middlewares in reverse order for additional processing after their next() statements before leaving the app as a response to the client." data-linktype="relative-path"></p>
<p>Each delegate can perform operations before and after the next delegate. Exception-handling delegates should be called early in the pipeline, so they can catch exceptions that occur in later stages of the pipeline.</p>
<p>The simplest possible ASP.NET Core app sets up a single request delegate that handles all requests. This case doesn't include an actual request pipeline. Instead, a single anonymous function is called in response to every HTTP request.</p>
<pre><code class="lang-csharp">public class Startup
{
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Hello, World!");
        });
    }
}
</code></pre>
<p>Chain multiple request delegates together with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" class="no-loc" data-linktype="absolute-path">Use</a>. The <code>next</code> parameter represents the next delegate in the pipeline. You can short-circuit the pipeline by <em>not</em> calling the <em>next</em> parameter. You can typically perform actions both before and after the next delegate, as the following example demonstrates:</p>
<pre><code class="lang-csharp" highlight-lines="5-10">public class Startup
{
    public void Configure(IApplicationBuilder app)
    {
        app.Use(async (context, next) =&gt;
        {
            // Do work that doesn't write to the Response.
            await next.Invoke();
            // Do logging or other work that doesn't write to the Response.
        });

        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Hello from 2nd delegate.");
        });
    }
}
</code></pre>
<p>When a delegate doesn't pass a request to the next delegate, it's called <em>short-circuiting the request pipeline</em>. Short-circuiting is often desirable because it avoids unnecessary work. For example, <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static File Middleware</a> can act as a <em>terminal middleware</em> by processing a request for a static file and short-circuiting the rest of the pipeline. Middleware added to the pipeline before the middleware that terminates further processing still processes code after their <code>next.Invoke</code> statements. However, see the following warning about attempting to write to a response that has already been sent.</p>
<div class="WARNING">
<p>Warning</p>
<p>Don't call <code>next.Invoke</code> after the response has been sent to the client. Changes to <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpresponse" class="no-loc" data-linktype="absolute-path">HttpResponse</a> after the response has started throw an exception. For example, <a href="../best-practices553c.html?view=aspnetcore-9.0#do-not-modify-the-status-code-or-headers-after-the-response-body-has-started" data-linktype="relative-path">setting headers and a status code throw an exception</a>. Writing to the response body after calling <code>next</code>:</p>
<ul>
<li>May cause a protocol violation. For example, writing more than the stated <code>Content-Length</code>.</li>
<li>May corrupt the body format. For example, writing an HTML footer to a CSS file.</li>
</ul>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpresponse.hasstarted" class="no-loc" data-linktype="absolute-path">HasStarted</a> is a useful hint to indicate if headers have been sent or the body has been written to.</p>
</div>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.runextensions.run" class="no-loc" data-linktype="absolute-path">Run</a> delegates don't receive a <code>next</code> parameter. The first <code>Run</code> delegate is always terminal and terminates the pipeline. <code>Run</code> is a convention. Some middleware components may expose <code>Run[Middleware]</code> methods that run at the end of the pipeline:</p>
<pre><code class="lang-csharp" highlight-lines="12-15">public class Startup
{
    public void Configure(IApplicationBuilder app)
    {
        app.Use(async (context, next) =&gt;
        {
            // Do work that doesn't write to the Response.
            await next.Invoke();
            // Do logging or other work that doesn't write to the Response.
        });

        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Hello from 2nd delegate.");
        });
    }
}
</code></pre><p>If you would like to see code comments translated to languages other than English, let us know in <a href="https://github.com/MicrosoftDocs/feedback/issues/2515" data-linktype="external">this GitHub discussion issue</a>.</p>
<p>In the preceding example, the <code>Run</code> delegate writes <code>"Hello from 2nd delegate."</code> to the response and then terminates the pipeline. If another <code>Use</code> or <code>Run</code> delegate is added after the <code>Run</code> delegate, it's not called.</p>
<p><a name="order"></a></p>
<h2 id="middleware-order-2">Middleware order</h2>
<p>The following diagram shows the complete request processing pipeline for ASP.NET Core MVC and Razor Pages apps. You can see how, in a typical app, existing middlewares are ordered and where custom middlewares are added. You have full control over how to reorder existing middlewares or inject new custom middlewares as necessary for your scenarios.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/middleware-pipeline.svg?view=aspnetcore-9.0" alt="ASP.NET Core middleware pipeline" data-linktype="relative-path"></p>
<p>The <strong>Endpoint</strong> middleware in the preceding diagram executes the filter pipeline for the corresponding app type—MVC or Razor Pages.</p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index/_static/mvc-endpoint.svg?view=aspnetcore-9.0" alt="ASP.NET Core filter pipeline" data-linktype="relative-path"></p>
<p>The order that middleware components are added in the <code>Startup.Configure</code> method defines the order in which the middleware components are invoked on requests and the reverse order for the response. The order is <strong>critical</strong> for security, performance, and functionality.</p>
<p>The following <code>Startup.Configure</code> method adds security-related middleware components in the typical recommended order:</p>
<pre><code class="lang-csharp">public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
        app.UseDatabaseErrorPage();
    }
    else
    {
        app.UseExceptionHandler("/Error");
        app.UseHsts();
    }

    app.UseHttpsRedirection();
    app.UseStaticFiles();
    // app.UseCookiePolicy();

    app.UseRouting();
    // app.UseRequestLocalization();
    // app.UseCors();

    app.UseAuthentication();
    app.UseAuthorization();
    // app.UseSession();
    // app.UseResponseCompression();
    // app.UseResponseCaching();

    app.UseEndpoints(endpoints =&gt;
    {
        endpoints.MapRazorPages();
        endpoints.MapControllerRoute(
            name: "default",
            pattern: "{controller=Home}/{action=Index}/{id?}");
    });
}
</code></pre>
<p>In the preceding code:</p>
<ul>
<li>Middleware that is not added when creating a new web app with <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-9.0" data-linktype="relative-path">individual users accounts</a> is commented out.</li>
<li>Not every middleware appears in this exact order, but many do. For example:
<ul>
<li><code>UseCors</code>, <code>UseAuthentication</code>, and <code>UseAuthorization</code> must appear in the order shown.</li>
<li><code>UseCors</code> currently must appear before <code>UseResponseCaching</code> due to <a href="https://github.com/dotnet/aspnetcore/issues/23218" data-linktype="external">this bug</a>.</li>
<li><code>UseRequestLocalization</code> must appear before any middleware that might check the request culture (for example, <code>app.UseMvcWithDefaultRoute()</code>).</li>
</ul>
</li>
</ul>
<p>In some scenarios, middleware has different ordering. For example, caching and compression ordering is scenario specific, and there's multiple valid orderings. For example:</p>
<pre><code class="lang-csharp">app.UseResponseCaching();
app.UseResponseCompression();
</code></pre>
<p>With the preceding code, CPU could be saved by caching the compressed response, but you might end up caching multiple representations of a resource using different compression algorithms such as Gzip or Brotli.</p>
<p>The following ordering combines static files to allow caching compressed static files:</p>
<pre><code class="lang-csharp">app.UseResponseCaching();
app.UseResponseCompression();
app.UseStaticFiles();
</code></pre>
<p>The following <code>Startup.Configure</code> method adds middleware components for common app scenarios:</p>
<ol>
<li>Exception/error handling
<ul>
<li>When the app runs in the Development environment:
<ul>
<li>Developer Exception Page Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.developerexceptionpageextensions.usedeveloperexceptionpage" class="no-loc" data-linktype="absolute-path">UseDeveloperExceptionPage</a>) reports app runtime errors.</li>
<li>Database Error Page Middleware reports database runtime errors.</li>
</ul>
</li>
<li>When the app runs in the Production environment:
<ul>
<li>Exception Handler Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" class="no-loc" data-linktype="absolute-path">UseExceptionHandler</a>) catches exceptions thrown in the following middlewares.</li>
<li>HTTP Strict Transport Security Protocol (HSTS) Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.hstsbuilderextensions.usehsts" class="no-loc" data-linktype="absolute-path">UseHsts</a>) adds the <code>Strict-Transport-Security</code> header.</li>
</ul>
</li>
</ul>
</li>
<li>HTTPS Redirection Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.httpspolicybuilderextensions.usehttpsredirection" class="no-loc" data-linktype="absolute-path">UseHttpsRedirection</a>) redirects HTTP requests to HTTPS.</li>
<li>Static File Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.staticfileextensions.usestaticfiles" class="no-loc" data-linktype="absolute-path">UseStaticFiles</a>) returns static files and short-circuits further request processing.</li>
<li>Cookie Policy Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.cookiepolicyappbuilderextensions.usecookiepolicy" class="no-loc" data-linktype="absolute-path">UseCookiePolicy</a>) conforms the app to the EU General Data Protection Regulation (GDPR) regulations.</li>
<li>Routing Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.userouting" class="no-loc" data-linktype="absolute-path">UseRouting</a>) to route requests.</li>
<li>Authentication Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" class="no-loc" data-linktype="absolute-path">UseAuthentication</a>) attempts to authenticate the user before they're allowed access to secure resources.</li>
<li>Authorization Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization" class="no-loc" data-linktype="absolute-path">UseAuthorization</a>) authorizes a user to access secure resources.</li>
<li>Session Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.sessionmiddlewareextensions.usesession" class="no-loc" data-linktype="absolute-path">UseSession</a>) establishes and maintains session state. If the app uses session state, call Session Middleware after Cookie Policy Middleware and before MVC Middleware.</li>
<li>Endpoint Routing Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.useendpoints" class="no-loc" data-linktype="absolute-path">UseEndpoints</a> with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.razorpagesendpointroutebuilderextensions.maprazorpages" class="no-loc" data-linktype="absolute-path">MapRazorPages</a>) to add Razor Pages endpoints to the request pipeline.</li>
</ol>
<pre><code class="lang-csharp">public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
        app.UseDatabaseErrorPage();
    }
    else
    {
        app.UseExceptionHandler("/Error");
        app.UseHsts();
    }

    app.UseHttpsRedirection();
    app.UseStaticFiles();
    app.UseCookiePolicy();
    app.UseRouting();
    app.UseAuthentication();
    app.UseAuthorization();
    app.UseSession();

    app.UseEndpoints(endpoints =&gt;
    {
        endpoints.MapRazorPages();
    });
}
</code></pre>
<p>In the preceding example code, each middleware extension method is exposed on <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder" class="no-loc" data-linktype="absolute-path">IApplicationBuilder</a> through the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder" class="no-loc" data-linktype="absolute-path">Microsoft.AspNetCore.Builder</a> namespace.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" class="no-loc" data-linktype="absolute-path">UseExceptionHandler</a> is the first middleware component added to the pipeline. Therefore, the Exception Handler Middleware catches any exceptions that occur in later calls.</p>
<p>Static File Middleware is called early in the pipeline so that it can handle requests and short-circuit without going through the remaining components. The Static File Middleware provides <strong>no</strong> authorization checks. Any files served by Static File Middleware, including those under <em>wwwroot</em>, are publicly available. For an approach to secure static files, see <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static files in ASP.NET Core</a>.</p>
<p>If the request isn't handled by the Static File Middleware, it's passed on to the Authentication Middleware (<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" class="no-loc" data-linktype="absolute-path">UseAuthentication</a>), which performs authentication. Authentication doesn't short-circuit unauthenticated requests. Although Authentication Middleware authenticates requests, authorization (and rejection) occurs only after MVC selects a specific Razor Page or MVC controller and action.</p>
<p>The following example demonstrates a middleware order where requests for static files are handled by Static File Middleware before Response Compression Middleware. Static files aren't compressed with this middleware order. The Razor Pages responses can be compressed.</p>
<pre><code class="lang-csharp">public void Configure(IApplicationBuilder app)
{
    // Static files aren't compressed by Static File Middleware.
    app.UseStaticFiles();

    app.UseRouting();

    app.UseResponseCompression();

    app.UseEndpoints(endpoints =&gt;
    {
        endpoints.MapRazorPages();
    });
}
</code></pre>
<p>For Single Page Applications (SPAs), the SPA middleware <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.spastaticfilesextensions.usespastaticfiles" class="no-loc" data-linktype="absolute-path">UseSpaStaticFiles</a> usually comes last in the middleware pipeline. The SPA middleware comes last:</p>
<ul>
<li>To allow all other middlewares to respond to matching requests first.</li>
<li>To allow SPAs with client-side routing to run for all routes that are unrecognized by the server app.</li>
</ul>
<p>For more details on SPAs, see the guides for the <a href="https://learn.microsoft.com/en-us/aspnet/core/client-side/spa/react?view=aspnetcore-9.0" data-linktype="relative-path">React</a> and <a href="https://learn.microsoft.com/en-us/aspnet/core/client-side/spa/angular?view=aspnetcore-9.0" data-linktype="relative-path">Angular</a> project templates.</p>
<h3 id="forwarded-headers-middleware-order-2">Forwarded Headers Middleware order</h3>
<p>Forwarded Headers Middleware should run before other middleware. This ordering ensures that the middleware relying on forwarded headers information can consume the header values for processing. To run Forwarded Headers Middleware after diagnostics and error handling middleware, see <a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-9.0#fhmo" data-linktype="relative-path">Forwarded Headers Middleware order</a>.</p>
<h2 id="branch-the-middleware-pipeline-2">Branch the middleware pipeline</h2>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" class="no-loc" data-linktype="absolute-path">Map</a> extensions are used as a convention for branching the pipeline. <code>Map</code> branches the request pipeline based on matches of the given request path. If the request path starts with the given path, the branch is executed.</p>
<pre><code class="lang-csharp">public class Startup
{
    private static void HandleMapTest1(IApplicationBuilder app)
    {
        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Map Test 1");
        });
    }

    private static void HandleMapTest2(IApplicationBuilder app)
    {
        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Map Test 2");
        });
    }

    public void Configure(IApplicationBuilder app)
    {
        app.Map("/map1", HandleMapTest1);

        app.Map("/map2", HandleMapTest2);

        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Hello from non-Map delegate.");
        });
    }
}
</code></pre>
<p>The following table shows the requests and responses from <code>http://localhost:1234</code> using the previous code.</p>
<table>
<thead>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td>localhost:1234</td>
<td>Hello from non-Map delegate.</td>
</tr>
<tr>
<td>localhost:1234/map1</td>
<td>Map Test 1</td>
</tr>
<tr>
<td>localhost:1234/map2</td>
<td>Map Test 2</td>
</tr>
<tr>
<td>localhost:1234/map3</td>
<td>Hello from non-Map delegate.</td>
</tr>
</tbody>
</table>
<p>When <code>Map</code> is used, the matched path segments are removed from <code>HttpRequest.Path</code> and appended to <code>HttpRequest.PathBase</code> for each request.</p>
<p><code>Map</code> supports nesting, for example:</p>
<pre><code class="lang-csharp">app.Map("/level1", level1App =&gt; {
    level1App.Map("/level2a", level2AApp =&gt; {
        // "/level1/level2a" processing
    });
    level1App.Map("/level2b", level2BApp =&gt; {
        // "/level1/level2b" processing
    });
});
</code></pre>
<p><code>Map</code> can also match multiple segments at once:</p>
<pre><code class="lang-csharp" highlight-lines="13">public class Startup
{
    private static void HandleMultiSeg(IApplicationBuilder app)
    {
        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Map multiple segments.");
        });
    }

    public void Configure(IApplicationBuilder app)
    {
        app.Map("/map1/seg1", HandleMultiSeg);

        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Hello from non-Map delegate.");
        });
    }
}
</code></pre>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.mapwhenextensions.mapwhen" class="no-loc" data-linktype="absolute-path">MapWhen</a> branches the request pipeline based on the result of the given predicate. Any predicate of type <code>Func&lt;HttpContext, bool&gt;</code> can be used to map requests to a new branch of the pipeline. In the following example, a predicate is used to detect the presence of a query string variable <code>branch</code>:</p>
<pre><code class="lang-csharp" highlight-lines="14-15">public class Startup
{
    private static void HandleBranch(IApplicationBuilder app)
    {
        app.Run(async context =&gt;
        {
            var branchVer = context.Request.Query["branch"];
            await context.Response.WriteAsync($"Branch used = {branchVer}");
        });
    }

    public void Configure(IApplicationBuilder app)
    {
        app.MapWhen(context =&gt; context.Request.Query.ContainsKey("branch"),
                               HandleBranch);

        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Hello from non-Map delegate.");
        });
    }
}
</code></pre>
<p>The following table shows the requests and responses from <code>http://localhost:1234</code> using the previous code:</p>
<table>
<thead>
<tr>
<th>Request</th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td>localhost:1234</td>
<td>Hello from non-Map delegate.</td>
</tr>
<tr>
<td>localhost:1234/?branch=main</td>
<td>Branch used = main</td>
</tr>
</tbody>
</table>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.usewhenextensions.usewhen" class="no-loc" data-linktype="absolute-path">UseWhen</a> also branches the request pipeline based on the result of the given predicate. Unlike with <code>MapWhen</code>, this branch is rejoined to the main pipeline if it doesn't short-circuit or contain a terminal middleware:</p>
<pre><code class="lang-csharp" highlight-lines="18-19">public class Startup
{
    private void HandleBranchAndRejoin(IApplicationBuilder app, ILogger&lt;Startup&gt; logger)
    {
        app.Use(async (context, next) =&gt;
        {
            var branchVer = context.Request.Query["branch"];
            logger.LogInformation("Branch used = {branchVer}", branchVer);

            // Do work that doesn't write to the Response.
            await next();
            // Do other work that doesn't write to the Response.
        });
    }

    public void Configure(IApplicationBuilder app, ILogger&lt;Startup&gt; logger)
    {
        app.UseWhen(context =&gt; context.Request.Query.ContainsKey("branch"),
                               appBuilder =&gt; HandleBranchAndRejoin(appBuilder, logger));

        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync("Hello from main pipeline.");
        });
    }
}
</code></pre>
<p>In the preceding example, a response of "Hello from main pipeline." is written for all requests. If the request includes a query string variable <code>branch</code>, its value is logged before the main pipeline is rejoined.</p>
<h2 id="built-in-middleware-2">Built-in middleware</h2>
<p>ASP.NET Core ships with the following middleware components. The <em>Order</em> column provides notes on middleware placement in the request processing pipeline and under what conditions the middleware may terminate request processing. When a middleware short-circuits the request processing pipeline and prevents further downstream middleware from processing a request, it's called a <em>terminal middleware</em>. For more information on short-circuiting, see the <a href="#create-a-middleware-pipeline-with-iapplicationbuilder" data-linktype="self-bookmark">Create a middleware pipeline with IApplicationBuilder</a> section.</p>
<table>
<thead>
<tr>
<th>Middleware</th>
<th>Description</th>
<th>Order</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-9.0" data-linktype="relative-path">Antiforgery</a></td>
<td>Provides anti-request-forgery support.</td>
<td>After authentication and authorization, before endpoints.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-9.0" data-linktype="relative-path">Authentication</a></td>
<td>Provides authentication support.</td>
<td>Before <code>HttpContext.User</code> is needed. Terminal for OAuth callbacks.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization" data-linktype="absolute-path">Authorization</a></td>
<td>Provides authorization support.</td>
<td>Immediately after the Authentication Middleware.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-9.0" data-linktype="relative-path">Cookie Policy</a></td>
<td>Tracks consent from users for storing personal information and enforces minimum standards for cookie fields, such as <code>secure</code> and <code>SameSite</code>.</td>
<td>Before middleware that issues cookies. Examples: Authentication, Session, MVC (TempData).</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0" data-linktype="relative-path">CORS</a></td>
<td>Configures Cross-Origin Resource Sharing.</td>
<td>Before components that use CORS. <code>UseCors</code> currently must go before <code>UseResponseCaching</code> due to <a href="https://github.com/dotnet/aspnetcore/issues/23218" data-linktype="external">this bug</a>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/error-handling?view=aspnetcore-9.0" data-linktype="relative-path">Diagnostics</a></td>
<td>Several separate middlewares that provide a developer exception page, exception handling, status code pages, and the default web page for new apps.</td>
<td>Before components that generate errors. Terminal for exceptions or serving the default web page for new apps.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/proxy-load-balancer?view=aspnetcore-9.0" data-linktype="relative-path">Forwarded Headers</a></td>
<td>Forwards proxied headers onto the current request.</td>
<td>Before components that consume the updated fields. Examples: scheme, host, client IP, method.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-9.0" data-linktype="relative-path">Health Check</a></td>
<td>Checks the health of an ASP.NET Core app and its dependencies, such as checking database availability.</td>
<td>Terminal if a request matches a health check endpoint.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-requests?view=aspnetcore-9.0#header-propagation-middleware" data-linktype="relative-path">Header Propagation</a></td>
<td>Propagates HTTP headers from the incoming request to the outgoing HTTP Client requests.</td>
<td></td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.httpmethodoverrideextensions" data-linktype="absolute-path">HTTP Method Override</a></td>
<td>Allows an incoming POST request to override the method.</td>
<td>Before components that consume the updated method.</td>
</tr>
<tr>
<td><a href="../../security/enforcing-ssl553c.html?view=aspnetcore-9.0#require-https" data-linktype="relative-path">HTTPS Redirection</a></td>
<td>Redirect all HTTP requests to HTTPS.</td>
<td>Before components that consume the URL.</td>
</tr>
<tr>
<td><a href="../../security/enforcing-ssl553c.html?view=aspnetcore-9.0#http-strict-transport-security-protocol-hsts" data-linktype="relative-path">HTTP Strict Transport Security (HSTS)</a></td>
<td>Security enhancement middleware that adds a special response header.</td>
<td>Before responses are sent and after components that modify requests. Examples: Forwarded Headers, URL Rewriting.</td>
</tr>
<tr>
<td><a href="../../mvc/overview553c.html?view=aspnetcore-9.0" data-linktype="relative-path">MVC</a></td>
<td>Processes requests with MVC/Razor Pages.</td>
<td>Terminal if a request matches a route.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/owin?view=aspnetcore-9.0" data-linktype="relative-path">OWIN</a></td>
<td>Interop with OWIN-based apps, servers, and middleware.</td>
<td>Terminal if the OWIN Middleware fully processes the request.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/middleware?view=aspnetcore-9.0" data-linktype="relative-path">Response Caching</a></td>
<td>Provides support for caching responses.</td>
<td>Before components that require caching. <code>UseCORS</code> must come before <code>UseResponseCaching</code>.</td>
</tr>
<tr>
<td><a href="../../performance/response-compression553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Response Compression</a></td>
<td>Provides support for compressing responses.</td>
<td>Before components that require compression.</td>
</tr>
<tr>
<td><a href="../localization553c.html?view=aspnetcore-9.0" data-linktype="relative-path">Request Localization</a></td>
<td>Provides localization support.</td>
<td>Before localization sensitive components. Must appear after Routing Middleware when using <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.localization.routing.routedatarequestcultureprovider" class="no-loc" data-linktype="absolute-path">RouteDataRequestCultureProvider</a>.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-9.0" data-linktype="relative-path">Endpoint Routing</a></td>
<td>Defines and constrains request routes.</td>
<td>Terminal for matching routes.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.spaapplicationbuilderextensions.usespa" data-linktype="absolute-path">SPA</a></td>
<td>Handles all requests from this point in the middleware chain by returning the default page for the Single Page Application (SPA)</td>
<td>Late in the chain, so that other middleware for serving static files, MVC actions, etc., takes precedence.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/app-state?view=aspnetcore-9.0" data-linktype="relative-path">Session</a></td>
<td>Provides support for managing user sessions.</td>
<td>Before components that require Session.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-9.0" data-linktype="relative-path">Static Files</a></td>
<td>Provides support for serving static files and directory browsing.</td>
<td>Terminal if a request matches a file.</td>
</tr>
<tr>
<td><a href="../url-rewriting553c.html?view=aspnetcore-9.0" data-linktype="relative-path">URL Rewrite</a></td>
<td>Provides support for rewriting URLs and redirecting requests.</td>
<td>Before components that consume the URL.</td>
</tr>
<tr>
<td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/websockets?view=aspnetcore-9.0" data-linktype="relative-path">WebSockets</a></td>
<td>Enables the WebSocket protocol.</td>
<td>Before components that are required to accept WebSocket requests.</td>
</tr>
</tbody>
</table>
<h2 id="additional-resources-2">Additional resources</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-9.0#lifetime-and-registration-options" data-linktype="relative-path">Lifetime and registration options</a> contains a complete sample of middleware with <em>scoped</em>, <em>transient</em>, and <em>singleton</em> lifetime services.</li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write?view=aspnetcore-9.0" data-linktype="relative-path">Write custom ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/test/middleware?view=aspnetcore-9.0" data-linktype="relative-path">Test ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/migration/fx-to-core/areas/http-modules?view=aspnetcore-9.0" data-linktype="relative-path">Migrate HTTP modules to ASP.NET Core middleware</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/startup?view=aspnetcore-9.0" data-linktype="relative-path">App startup in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/request-features?view=aspnetcore-9.0" data-linktype="relative-path">Request Features in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/extensibility?view=aspnetcore-9.0" data-linktype="relative-path">Factory-based middleware activation in ASP.NET Core</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/extensibility-third-party-container?view=aspnetcore-9.0" data-linktype="relative-path">Middleware activation with a third-party container in ASP.NET Core</a></li>
</ul>
</div>
</div>
					
		<div
			id="ms--inline-notifications"
			class="margin-block-xs"
			data-bi-name="inline-notification"
		></div>
	 
		<div
			id="assertive-live-region"
			role="alert"
			aria-live="assertive"
			class="visually-hidden"
			aria-relevant="additions"
			aria-atomic="true"
		></div>
		<div
			id="polite-live-region"
			role="status"
			aria-live="polite"
			class="visually-hidden"
			aria-relevant="additions"
			aria-atomic="true"
		></div>
	
					
			
		<!-- feedback section -->
		<section
			class="feedback-section position-relative margin-top-lg border border-radius padding-xxs display-none-print"
			data-bi-name="open-source-feedback-section"
			data-open-source-feedback-section
			hidden
		>
			<div class="display-flex flex-direction-column flex-direction-row-tablet">
				<div
					class="width-450-tablet padding-inline-xs padding-inline-xs-tablet padding-top-xs padding-bottom-sm padding-top-xs-tablet background-color-body-medium"
				>
					<div class="display-flex flex-direction-column">
						<div class="padding-bottom-xxs">
							<span class="icon margin-right-xxs" aria-hidden="true">
								<span class="docon docon-brand-github"></span>
							</span>
							<span class="font-weight-semibold">
								Collaborate with us on GitHub
							</span>
						</div>
						<span class="line-height-normal">
							The source for this content can be found on GitHub, where you can also create and review issues and pull requests. For more information, see <a href="https://learn.microsoft.com/contribute/content/dotnet/dotnet-contribute">our contributor guide</a>.
						</span>
					</div>
				</div>
				<div
					class="display-flex gap-xs width-full-tablet flex-direction-column padding-xs justify-content-space-evenly"
				>
					<div class="media">
						
					<div class="media-left">
						<div class="image image-36x36" hidden data-open-source-image-container>
							<img
								class="theme-display is-light"
								src="https://learn.microsoft.com/media/logos/logo_net.svg"
								aria-hidden="true"
								data-open-source-image-light
							/>
							<img
								class="theme-display is-dark is-high-contrast"
								src="https://learn.microsoft.com/media/logos/logo_net.svg"
								aria-hidden="true"
								data-open-source-image-dark
							/>
						</div>
					</div>
			  

						<div class="media-content">
							<p
								class="font-size-xl font-weight-semibold margin-bottom-xxs"
								data-open-source-product-title
							>
								ASP.NET Core
							</p>
							<div class="display-flex gap-xs flex-direction-column">
								<p class="line-height-normal" data-open-source-product-description></p>
								<div class="display-flex gap-xs flex-direction-column">
									<a href="#" data-github-link>
										<span class="icon margin-right-xxs" aria-hidden="true">
											<span class="docon docon-bug"></span>
										</span>
										<span>Open a documentation issue</span>
									</a>
									<a
										href="https://github.com/dotnet/aspnetcore/blob/main/CONTRIBUTING.md"
										class="display-block margin-top-auto font-size-md"
										data-feedback-product-url
									>
										<span class="icon margin-right-xxs" aria-hidden="true">
											<span class="docon docon-feedback"></span>
										</span>
										<span>Provide product feedback</span>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- end feedback section -->
	
			
		<!-- feedback section -->
		<section
			id="site-user-feedback-footer"
			class="font-size-sm margin-top-md display-none-print display-none-desktop"
			data-test-id="site-user-feedback-footer"
			data-bi-name="site-feedback-section"
		>
			<hr class="hr" />
			<h2 id="ms--feedback" class="title is-3">Feedback</h2>
			<div class="display-flex flex-wrap-wrap align-items-center">
				<p class="font-weight-semibold margin-xxs margin-left-none">
					Was this page helpful?
				</p>
				<div class="buttons">
					<button
						class="thumb-rating-button like button button-primary button-sm"
						data-test-id="footer-rating-yes"
						data-binary-rating-response="rating-yes"
						type="button"
						title="This article is helpful"
						data-bi-name="button-rating-yes"
						aria-pressed="false"
					>
						<span class="icon" aria-hidden="true">
							<span class="docon docon-like"></span>
						</span>
						<span>Yes</span>
					</button>
					<button
						class="thumb-rating-button dislike button button-primary button-sm"
						data-test-id="footer-rating-no"
						data-binary-rating-response="rating-no"
						type="button"
						title="This article is not helpful"
						data-bi-name="button-rating-no"
						aria-pressed="false"
					>
						<span class="icon" aria-hidden="true">
							<span class="docon docon-dislike"></span>
						</span>
						<span>No</span>
					</button>
				</div>
			</div>
		</section>
		<!-- end feedback section -->
	
		
				</div>
				
		<div id="ms--additional-resources-mobile" class="display-none-print">
			<hr class="hr" hidden />
			<h2 id="ms--additional-resources-mobile-heading" class="title is-3" hidden>
				Additional resources
			</h2>
			
		<section
			id="right-rail-recommendations-mobile"
			class=""
			data-bi-name="recommendations"
			hidden
		></section>
	 
		<section
			id="right-rail-training-mobile"
			class=""
			data-bi-name="learning-resource-card"
			hidden
		></section>
	 
		<section
			id="right-rail-events-mobile"
			class=""
			data-bi-name="events-card"
			hidden
		></section>
	 
		<section
			id="right-rail-qna-mobile"
			class="margin-top-xxs"
			data-bi-name="qna-link-card"
			hidden
		></section>
	
		</div>
	
			</div>
			
		<div
			id="action-panel"
			role="region"
			aria-label="Action Panel"
			class="action-panel"
			tabindex="-1"
		></div>
	
		
				</main>
				<aside
					id="layout-body-aside"
					class="layout-body-aside "
					data-bi-name="aside"
			  >
					
		<div
			id="ms--additional-resources"
			class="right-container padding-sm display-none display-block-desktop height-full"
			data-bi-name="pageactions"
			role="complementary"
			aria-label="Additional resources"
		>
			<div id="affixed-right-container" data-bi-name="right-column">
				
		<nav
			id="side-doc-outline"
			class="doc-outline border-bottom padding-bottom-xs margin-bottom-xs"
			data-bi-name="intopic toc"
			aria-label="In this article"
		>
			<h3>In this article</h3>
		</nav>
	
				<!-- Feedback -->
				
		<section
			id="ms--site-user-feedback-right-rail"
			class="font-size-sm display-none-print"
			data-test-id="site-user-feedback-right-rail"
			data-bi-name="site-feedback-right-rail"
		>
			<p class="font-weight-semibold margin-bottom-xs">Was this page helpful?</p>
			<div class="buttons">
				<button
					class="thumb-rating-button like button button-primary button-sm"
					data-test-id="right-rail-rating-yes"
					data-binary-rating-response="rating-yes"
					type="button"
					title="This article is helpful"
					data-bi-name="button-rating-yes"
					aria-pressed="false"
				>
					<span class="icon" aria-hidden="true">
						<span class="docon docon-like"></span>
					</span>
					<span>Yes</span>
				</button>
				<button
					class="thumb-rating-button dislike button button-primary button-sm"
					data-test-id="right-rail-rating-no"
					data-binary-rating-response="rating-no"
					type="button"
					title="This article is not helpful"
					data-bi-name="button-rating-no"
					aria-pressed="false"
				>
					<span class="icon" aria-hidden="true">
						<span class="docon docon-dislike"></span>
					</span>
					<span>No</span>
				</button>
			</div>
		</section>
	
			</div>
		</div>
	
			  </aside> <section
					id="layout-body-flyout"
					class="layout-body-flyout "
					data-bi-name="flyout"
			  >
					 <div
	class="height-full border-left background-color-body-medium"
	id="ask-learn-flyout"
></div>
			  </section> <div class="layout-body-footer " data-bi-name="layout-footer">
		<footer
			id="footer"
			data-test-id="footer"
			data-bi-name="footer"
			class="footer-layout has-padding has-default-focus border-top  uhf-container"
			role="contentinfo"
		>
			<div class="display-flex gap-xs flex-wrap-wrap is-full-height padding-right-lg-desktop">
				
		<a
			data-mscc-ic="false"
			href="#"
			data-bi-name="select-locale"
			class="locale-selector-link flex-shrink-0 button button-sm button-clear external-link-indicator"
			id=""
			title=""
			><span class="icon" aria-hidden="true"
				><span class="docon docon-world"></span></span
			><span class="local-selector-link-text">en-us</span></a
		>
	
				<div class="ccpa-privacy-link" data-ccpa-privacy-link hidden>
		
		<a
			data-mscc-ic="false"
			href="https://aka.ms/yourcaliforniaprivacychoices"
			data-bi-name="your-privacy-choices"
			class="button button-sm button-clear flex-shrink-0 external-link-indicator"
			id=""
			title=""
			>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			viewBox="0 0 30 14"
			xml:space="preserve"
			height="16"
			width="43"
			aria-hidden="true"
			focusable="false"
		>
			<path
				d="M7.4 12.8h6.8l3.1-11.6H7.4C4.2 1.2 1.6 3.8 1.6 7s2.6 5.8 5.8 5.8z"
				style="fill-rule:evenodd;clip-rule:evenodd;fill:#fff"
			></path>
			<path
				d="M22.6 0H7.4c-3.9 0-7 3.1-7 7s3.1 7 7 7h15.2c3.9 0 7-3.1 7-7s-3.2-7-7-7zm-21 7c0-3.2 2.6-5.8 5.8-5.8h9.9l-3.1 11.6H7.4c-3.2 0-5.8-2.6-5.8-5.8z"
				style="fill-rule:evenodd;clip-rule:evenodd;fill:#06f"
			></path>
			<path
				d="M24.6 4c.2.2.2.6 0 .8L22.5 7l2.2 2.2c.2.2.2.6 0 .8-.2.2-.6.2-.8 0l-2.2-2.2-2.2 2.2c-.2.2-.6.2-.8 0-.2-.2-.2-.6 0-.8L20.8 7l-2.2-2.2c-.2-.2-.2-.6 0-.8.2-.2.6-.2.8 0l2.2 2.2L23.8 4c.2-.2.6-.2.8 0z"
				style="fill:#fff"
			></path>
			<path
				d="M12.7 4.1c.2.2.3.6.1.8L8.6 9.8c-.1.1-.2.2-.3.2-.2.1-.5.1-.7-.1L5.4 7.7c-.2-.2-.2-.6 0-.8.2-.2.6-.2.8 0L8 8.6l3.8-4.5c.2-.2.6-.2.9 0z"
				style="fill:#06f"
			></path>
		</svg>
	
			<span>Your Privacy Choices</span></a
		>
	
	</div>
				<div class="flex-shrink-0">
		<div class="dropdown has-caret-up">
			<button
				data-test-id="theme-selector-button"
				class="dropdown-trigger button button-clear button-sm has-inner-focus theme-dropdown-trigger"
				aria-controls="{{ themeMenuId }}"
				aria-expanded="false"
				title="Theme"
				data-bi-name="theme"
			>
				<span class="icon">
					<span class="docon docon-sun" aria-hidden="true"></span>
				</span>
				<span>Theme</span>
				<span class="icon expanded-indicator" aria-hidden="true">
					<span class="docon docon-chevron-down-light"></span>
				</span>
			</button>
			<div class="dropdown-menu" id="{{ themeMenuId }}" role="menu">
				<ul class="theme-selector padding-xxs" data-test-id="theme-dropdown-menu">
					<li class="theme display-block">
						<button
							class="button button-clear button-sm theme-control button-block justify-content-flex-start text-align-left"
							data-theme-to="light"
						>
							<span class="theme-light margin-right-xxs">
								<span
									class="theme-selector-icon border display-inline-block has-body-background"
									aria-hidden="true"
								>
									<svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 14">
										<rect width="22" height="14" class="has-fill-body-background" />
										<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
										<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
										<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
										<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
										<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
									</svg>
								</span>
							</span>
							<span role="menuitem"> Light </span>
						</button>
					</li>
					<li class="theme display-block">
						<button
							class="button button-clear button-sm theme-control button-block justify-content-flex-start text-align-left"
							data-theme-to="dark"
						>
							<span class="theme-dark margin-right-xxs">
								<span
									class="border theme-selector-icon display-inline-block has-body-background"
									aria-hidden="true"
								>
									<svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 14">
										<rect width="22" height="14" class="has-fill-body-background" />
										<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
										<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
										<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
										<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
										<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
									</svg>
								</span>
							</span>
							<span role="menuitem"> Dark </span>
						</button>
					</li>
					<li class="theme display-block">
						<button
							class="button button-clear button-sm theme-control button-block justify-content-flex-start text-align-left"
							data-theme-to="high-contrast"
						>
							<span class="theme-high-contrast margin-right-xxs">
								<span
									class="border theme-selector-icon display-inline-block has-body-background"
									aria-hidden="true"
								>
									<svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 14">
										<rect width="22" height="14" class="has-fill-body-background" />
										<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
										<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
										<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
										<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
										<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
										<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
									</svg>
								</span>
							</span>
							<span role="menuitem"> High contrast </span>
						</button>
					</li>
				</ul>
			</div>
		</div>
	</div>
			</div>
			<ul class="links" data-bi-name="footerlinks">
				<li class="manage-cookies-holder" hidden=""></li>
				<li>
		
		<a
			data-mscc-ic="false"
			href="https://learn.microsoft.com/en-us/principles-for-ai-generated-content"
			data-bi-name="aiDisclaimer"
			class=" external-link-indicator"
			id=""
			title=""
			>AI Disclaimer</a
		>
	
	</li><li>
		
		<a
			data-mscc-ic="false"
			href="https://learn.microsoft.com/en-us/previous-versions/"
			data-bi-name="archivelink"
			class=" external-link-indicator"
			id=""
			title=""
			>Previous Versions</a
		>
	
	</li> <li>
		
		<a
			data-mscc-ic="false"
			href="https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog"
			data-bi-name="bloglink"
			class=" external-link-indicator"
			id=""
			title=""
			>Blog</a
		>
	
	</li> <li>
		
		<a
			data-mscc-ic="false"
			href="https://learn.microsoft.com/en-us/contribute"
			data-bi-name="contributorGuide"
			class=" external-link-indicator"
			id=""
			title=""
			>Contribute</a
		>
	
	</li><li>
		
		<a
			data-mscc-ic="false"
			href="https://go.microsoft.com/fwlink/?LinkId=521839"
			data-bi-name="privacy"
			class=" external-link-indicator"
			id=""
			title=""
			>Privacy</a
		>
	
	</li><li>
		
		<a
			data-mscc-ic="false"
			href="https://learn.microsoft.com/en-us/legal/termsofuse"
			data-bi-name="termsofuse"
			class=" external-link-indicator"
			id=""
			title=""
			>Terms of Use</a
		>
	
	</li><li>
		
		<a
			data-mscc-ic="false"
			href="https://www.microsoft.com/legal/intellectualproperty/Trademarks/"
			data-bi-name="trademarks"
			class=" external-link-indicator"
			id=""
			title=""
			>Trademarks</a
		>
	
	</li>
				<li>&copy; Microsoft 2025</li>
			</ul>
		</footer>
	</footer>
			</body>
		
<!-- Mirrored from learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-9.0 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 06 Aug 2025 14:53:03 GMT -->
</html>